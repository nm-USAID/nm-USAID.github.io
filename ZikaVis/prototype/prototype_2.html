<!DOCTYPE html>
<meta charset="utf-8">
<title>Zika Mapping - prototype 2</title>
<link rel="stylesheet" type="text/css" href="style.css">
<style>
</style>

<body>
	<div id="container"></div>	
</body>

<svg class="patternFill"><defs><pattern id="diagonalHatch" width="0.2" height="0.2" patternUnits="userSpaceOnUse">
  <path d="M-0.05,0.05 l0.1,-0.1
           M0,0.2 l0.2,-0.2
           M0.15,0.25 l0.1,-0.1"/>
</pattern></defs></svg>

<script src="d3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="topojson.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<script>	
	
var ht = false;	
var colors = ["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99", "#e31a1c","#fdbf6f","#ff7f00","#cab2d6"];

//set up divs
d3.select("#container").append("div")
	.attr("id","banner");

d3.select("#container").append("div")
	.attr("id","menu");

d3.select("#container").append("div")
	.attr("id","middleView");

d3.select("#container").append("div")
	.attr("id","chartview");
	
//middle column
//load title on load country	
d3.select("#middleView").append("div")
	.attr("id","mapheader");

d3.select("#middleView").append("div")
	.attr("id","mapview");
	
d3.select("#middleView").append("div")
	.attr("id","awardview");
	
//chartview
d3.select("#chartview").append("div")
	.attr("id","censusDataTitle")
	.attr("class","chartTitle")
	.append("text")
	.text("CENSUS DATA");	
	
d3.select("#chartview").append("div")
	.attr("id","censusData");		
	
d3.select("#chartview").append("div")
	.attr("id","epiData");
	
d3.select("#epiData").append("div")
	.attr("id","epiDataTitle")
	.attr("class","chartTitle")
	.append("text")
	.text("WEEKLY EPIDEMIOLOGICAL DATA");	
	
d3.select("#epiData").append("div")
	.attr("id","nationalData")
	.append("text")
	.text("NATIONAL")
	.attr("class","subtitle");
	
d3.select("#epiData").append("div")
	.attr("id","subnationalData")
	.append("text")
	.text("SUBNATIONAL")
	.attr("class","subtitle");
	

//banner
d3.select("#banner").append("h1")
	.attr("class","banner")
	.text("ZikaVis");
	
d3.select("#banner").append("h2")
	.attr("class","banner")
	.text("VISUALIZING USAID EFFORTS TO COMBAT ZIKA");	

//title with tabs, buttons
d3.select("#mapheader").append("div")
	.attr("id","maptitle")
	.append("text")
	.text("EL SALVADOR");
	
d3.select("#mapheader").append("div")
	.attr("id","tabs");
	
var overview_tab = d3.select("#tabs").append("div")
	.attr("class","tab")
	.attr("id","overview_tab")
	.append("text")
	.text("overview");
	
var temporalview_tab = d3.select("#tabs").append("div")
	.attr("class","tab")
	.attr("id","temporal_view_tab")
	.append("text")
	.text("temporal view");		
	
	
d3.select("#mapheader").append("div")
	.attr("id","buttons");
	
var tot_btn = d3.select("#buttons").append("button")
	.text("total cases");
var pht_btn = d3.select("#buttons").append("button")
	.text("per H.T.");
				
//awards data
d3.select("#awardview").append("div")
	.attr("id","awardData")
	.append("text")
	.text("USAID AWARDS");	
	
//svgs for overview + small multiples
//maybe just one svg...
var mapview_svg = d3.select("#mapview").append("svg")
	.attr("class","mapview_svg");

	var land;
	var features;
	var awards_shp;
	var clinics_pts;	
	
var width = 500,
    height = 400;
	
var sm_width = 125,
	sm_height = 125;		
	
//setup topojson stuff -- paths and projections
	
//popup projection //need to automate this!
var projection_census = d3.geoMercator()
    .scale(2400)
    .center([0,0]) //projection center
    .translate([600/2+3475,625])
	
//Generate paths based on projection
var path_census = d3.geoPath()
    .projection(projection_census);
	
//sm projection	
var projection_sm = d3.geoMercator()
    .scale(2700)
    .center([0,0]) //projection center
    .translate([width/2+3950,650])

var path_sm = d3.geoPath()
	.projection(projection_sm);				
	
//Map projection
var projection = d3.geoMercator()
    .scale(450)
    .center([0,0]) //projection center
    .translate([width/2+600,height/2+100]);
	//.translate([width/2,height/2]) //translate to center the map in view	

//Generate paths based on projection
var path = d3.geoPath()
    .projection(projection);
	
var clinicSymbol = d3.symbol().size(10).type(d3.symbolCross);	
/******end topo setup******/	
	
			
//enable zoom
var zoom = d3.zoom()
    .scaleExtent([0.3, Infinity])
    .on("zoom",zoomed);	
				
	
//load data
queue()
	.defer(d3.json, "admin_0_countries.json")
	.defer(d3.json, "admin_1_states_provinces.json")
    .defer(d3.json, "el_salvador_epi.json")
	.defer(d3.json, "countryData.json")
	.defer(d3.json, "populated_places2.json")
	.defer(d3.json, "poverty.json")
	.defer(d3.json, "usaidawards.json")
	.defer(d3.json,"IPPFClinics.json")
	.defer(d3.json, "globalData.json")
    .await(ready);	
		
function ready(error, geodata_admin0/*admin0data*/, geodata_admin1/*adm1data*/, epidata/*SVLdata*/, censusdata/*countrydata*/, pop_pls, poverty, awards, IPPFclinics, globaldata){	
	  if (error) throw error;	
	  
	  
	  /***************format data************/
	  var parseTime = d3.timeParse("%m/%e/%y");
	  var parseYear = d3.timeFormat("%y");
  
	  epidata.forEach(function(d,i){
		  d.report_date = parseTime(d.report_date);
		  d.year = parseYear(d.report_date);
		  //console.log(parseYear(d.report_date));
	  });
	  
	  //sort by report data
	  epidata.sort(function(a,b){return a.report_date - b.report_date;});
	  
	  //nest data upfront
	  var byRegion = d3.nest()
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata);
  
	  var totalbyRegionbyYear = d3.nest()
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .key(function(d){return d.year;})
	  .rollup(function(d){return d3.max(d,function(v){return v.value;})})
	  .entries(epidata);
	  
	  var byDatebyRegion = d3.nest()
	  .key(function(d){return d.report_date;})
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata);
	  

	  var povertyByCountryByRegion = d3.nest()
	  .key(function(d){
	  	var code = d.Country_Code.split("_");
		return code[0];
	  })
	  .key(function(d){
		  var code = d.Country_Code.split("_");
		  var n = d.Country_Code.indexOf(".");
		  if(n == -1){
		  	return code[code.length-1];
		  }else{
		  return  d.Country_Code.substring(n-2,n+3); }
	  	  })
		  .rollup(function(d){
			  var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var year;
			  var latest_stat;
			  stats.forEach(function(l,i){
				  if(l!=undefined){
					  year = 1996+i;
					  latest_stat = l;
				  }
			  })
			  return {
				  all: d,
				  stats:stats,
				  latest: latest_stat,
				  latest_stat_year: year
			  }
		  })	  
		  .entries(poverty)
		  .sort(function(a, b){ return d3.descending(a.values[0].value.latest, b.values[0].value.latest); });
		  
		  //console.log(povertyByCountryByRegion.filter(function(d){return d.key == "SLV"})[0].values.sort(function(a, b){ return d3.descending(a.value.latest,b.value.latest);}));
	  
	  
	  //nest poverty data
	  var povertyByFips = d3.nest()
	  .key(function(d){
		  var code = d.Country_Code.split("_");
		  var n = d.Country_Code.indexOf(".");
		  if(n == -1){
		  	return code[code.length-1];
		  }else{
		  return  d.Country_Code.substring(n-2,n+3); }
	  	  })
		  .key(function(d){return d.Indicator_Name;})  
		  .rollup(function(d){
			  var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var year;
			  var latest_stat;
			  stats.forEach(function(l,i){
				  if(l!=undefined){
					  year = 1996+i;
					  latest_stat = l;
				  }
			  })
			  return {
				  all: d,
				  stats:stats,
				  latest: latest_stat,
				  latest_stat_year: year
			  }
		  })	  
		  .entries(poverty)
		  .sort(function(a, b){ return d3.descending(a.values[0].value.latest, b.values[0].value.latest); });
	  
	  
		  //console.log(povertyByFips);
		  
	  //change this later - back to original data
		  //need to add actual cumulative
		  byRegion.forEach(function(d){
		  	d.values.forEach(function(e){
		  	  e.values.forEach(function(f,i){
				  if(i == 0){
					  f.new_cases = f.value;
					  f.cum_cases = f.value;
					  tot_prev_years = 0;
				  }else if(i > 0){
					  if(f.year == prev_yr){//if in same year
				  
						  /*if(f.value+tot_last_year < cum_cases){
							  console.log(f.report_date)
							  console.log(f.value + " " +tot_last_year+" "+cum_cases);}*/
				  
						  f.new_cases = (f.value != null) ? f.value+tot_prev_years-cum_cases : 0; //calc number of new cases
					  	  f.cum_cases = (f.value != "NA") ? f.value + tot_prev_years : tot_prev_years;
					  }else{//else across years
						  tot_prev_years = cum_cases;			  
					  	  f.new_cases = (f.value != null) ? f.value : 0;
						  f.cum_cases = (f.value != "NA") ? f.value + tot_prev_years : tot_prev_years;
					  }
				  }
				  //num = f.value;
				  prev_yr = f.year;
				  cum_cases = f.cum_cases; 
		  	  })
			  	e.max_cum_cases = d3.max(e.values, function(f){return f.cum_cases;});
				//hopefully not too expensive
				e.values.forEach(function(f,i){
					f.max_cum_cases = e.max_cum_cases;
				});
			   	//console.log(max_cum_cases);
			   	//d3.max(d,function(f){return f.cum_cases;
		  	});
		  });
		  
		  var totalByRegion = d3.nest()
		  .key(function(d){return d.fips;})
		  .rollup(function(v){
			  var t = byRegion.filter(function(e){return e.key == v[0].fips;});
			  var _pop = censusdata.filter(function(j){return j.fips == v[0].fips});
			  var pop = (_pop[0]!=undefined) ? _pop[0].population/100000 : 1;
			  //console.log(pop);
			  var max = 0;
			  var m = 0;
			  t.forEach(function(f,i){
				  //console.log(f.values);
				  f.values.forEach(function(g){
					  //console.log(g.values);
					  m = d3.max(g.values,function(h){return h.new_cases;});
					  max = (max > m) ? max : m;
				  })
			  })
	  
			  return {
				  //this is actually inaccurate because numbers reset each year
			    max_val: d3.max(v,function(f){return f.value;}),
				max_cumulative: d3.max(v,function(f){return f.cum_cases;}),
				max_new: max,
				cum_ht: d3.max(v,function(f){return f.cum_cases;})/pop,
				new_ht: max/pop,
				  _pop: pop    
			  };
		  })
		  .entries(epidata);	  
	  
	  
	  
	  
	  /***********end format data************/ 
	  
	  
	  //country variable
	  var ADM0 = "SLV";
	  var country_adm1_features; //prev el_salvador
	  var country_centroid;
	  var country_pop;
	  var country_pov;
	  var country_awards;
	  var country_povbyfips;
	  //global variables
	  var regions;
	  var sm_maps;	
	  var efforts;
	  var clinics;
	  var country_indicators;
	  var valueLine3;
	  var domains;
	  var mx = d3.max(epidata, function(v) { return v.value; });
	  var selection = false;
	  
	 var max_pop;
	 var min_pop;
	 var pop_range;
	 
	 //for zooming
	 var dx;
	 var dy;
	  
	  
  	choropleth4 = d3.scaleLog()
  	.domain([1,mx])
  	.range(['#fee8c8','#b30000'])
	  
	  
	  setCountry(ADM0);

//setup based on country
	  function setCountry(adm0){
		  //filter data to country
		  country_adm1_features = geodata_admin1.features.filter(function(d){return d.properties.adm0_a3 == adm0;}) //prev el_salvador
		  country_centroid = geodata_admin0.features.filter(function(d){return d.properties.ADM0_A3 == adm0;})
		  country_pop = pop_pls.features.filter(function(d){return d.properties.ADM0_A3 == adm0;})
		  country_pov = poverty.filter(function(d){return d.Country_Code.indexOf(adm0) != -1;})
		  country_awards = topojson.feature(awards,awards.objects.usaidawards).features.filter(function(d){return d.properties.ISO == adm0;});
		  country_povbyfips = povertyByCountryByRegion.filter(function(d){return d.key == adm0;})[0].values.sort(function(a, b){ return d3.descending(a.value.latest,b.value.latest);});
		  
		  //console.log(country_povbyfips);
		  
  		//set zoom to centroid
  	    dx = path.centroid(country_centroid[0])[0];
  	    dy = path.centroid(country_centroid[0])[1];
		  
	  	//start with overview  	  
	  	drawOverview();
		//drawTemporalView();
	  	drawChartView();
  
	  //mapview_svg.call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(15).translate(-dx,-dy)); 
	  //mapview_svg.call(zoom);
	  
	  //zoom to in small multiples
	  //add this in!		
	   	
		
	  }
	
	
//functions!	
	function drawOverview(){
		mapview_svg.selectAll("*").remove();
		//build view
		drawBasemap();
		drawRegions();
		layerAwards();
		layerClinics();
		
  	  mapview_svg.call(zoom.transform,d3.zoomIdentity.translate(width/2,height/2).scale(15).translate(-dx,-dy)); 
  	  mapview_svg.call(zoom);
		
	}				
	
	function drawTemporalView(){
		mapview_svg.selectAll("*").remove();
		//build view
		/*mapview_svg.append("text")
		.attr("x","20px")
		.attr("y","20px")
		.text("small multiples!");*/
		drawSmallMultiples();
		
	}
	
	function drawChartView(){
		censusCharts();
		nationalCharts();
		subnationalCharts();
		awardsCharts();
	}
	
	
//subfunctions - overview
	function drawBasemap(){
	land = mapview_svg.append("g")
	    .attr("class","land");
		
	  var countries = land.selectAll("path")
	      .data(geodata_admin0.features) //generate features from TopoJSON
	  	.enter()
	      .append("path")
	      .attr("id",function(d){return "country"+d.properties.ADM0_A3;})
	      .attr("class","country_paths")
	    .attr("d",path)
	    .style("fill","rgba(220,220,220,1)");	
	}
	
	function drawRegions(){
	  features = mapview_svg.append("g")
	    	.attr("class","features");
		
	  regions = features.selectAll("path")
	    .data(country_adm1_features)
		.enter()
	    .append("path")
		.attr("id",function(d){return "region"+d.properties.code_hasc.replace(".","");})
	    .attr("class","region")
	    .attr("d",path)
		.attr("basecolor",function(d){
			var max = totalByRegion.filter(function(v){return v.key == d.properties.fips;});
			if(ht){
				//return d3.interpolateOrRd(scale_cases(max[0].value.cum_ht));
				return choropleth4(max[0].value.cum_ht);
				//return choropleth(x3(max[0].value.cum_ht));
			}else{
				//choropleth1 is actually is ineffective, because we need to see finer grain differences
				//return d3.interpolateOrRd(scale_cases(max[0].value.max_cumulative));
				return choropleth4(max[0].value.max_cumulative);
			}
		})
		.style("fill", function(d){return d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");})
	    .on("click", function(d){
			d.selected = !d.selected;
			var color = (d.selected) ? "tomato": d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");
			d3.select(this).style("fill",color);
			show_charts2(d);
		
			//only allow one at a time? for now
			selection = d.selected;
	  })
		.on("mouseover",function(d){
			if(!selection){
			d3.select(this).style("fill","tomato");
			//console.log(d.properties.code_hasc);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill","tomato");
			show_charts2(d);
			}
		})
		.on("mouseout",function(d){
			if(!selection){
			d3.select(this).style("fill",function(d){
				return d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");
			})
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",d3.select("#bb"+d.properties.code_hasc.replace(".","")).attr("basecolor"));
			dists_charts_mout(d);
			}
			//show_charts(d);
		});
	}
	
	function layerClinics(){
	clinics_pts = mapview_svg.append("g")
		.attr("class","clinics");
		
	    clinics = clinics_pts.selectAll("path")
	     .data(topojson.feature(IPPFclinics,IPPFclinics.objects.IPPFClinics).features)
	     .enter()
	     .append("path")
		.style("fill","steelblue")
		.style("stroke","white")
		.style("stroke-width","0.05")
		.attr("transform", function(d) { return "translate(" + projection(d.geometry.coordinates) + ")"; })
	    //.attr("d",path.pointRadius(0.2))
		.attr("d",d3.symbol().size(0.10).type(d3.symbolCross))
		.on("mouseover",function(d){
			d3.select(this).style("stroke-width","0.1");
		})
		.on("mouseout",function(d){
			d3.select(this).style("stroke-width","0.05");
		});	
	}
	
	
	function layerAwards(){
		awards_shp = mapview_svg.append("g")
			.attr("class","awards_shp");
			
		efforts = awards_shp.selectAll("path")
		.data(country_awards)
		.enter()
		.append("path")
		.attr("id", function(d){return "award"+d.properties.OBJECTID;})
		.attr("d",path)
		.style("stroke","white")
		.style("stroke-width","0.01")
		.style("fill","url(#diagonalHatch)")		
		//.style("opacity","0.5")
		.on("click", function(d){
			console.log(d);	
		})
		.on("mouseover",function(d){
			d3.select(this).style("fill","tomato");
		} )
		.on("mouseout",function(d){
			d3.select(this).style("fill","url(#diagonalHatch)");
		})	
	}

//subfunctions - temporal view
	/*function drawBasemap(){
		
	}
	function drawRegions(){
		
	}
	function layerClinics(){
		
	}
	function layerAwards(){
		
	}*/	

//chartview functions
function censusCharts(){
	
	var x_pov = d3.scaleLinear()
	    .domain([1, 100]) //domain to be mapped
	    .rangeRound([1, 10]); //range to be mapped to
	
	var color_pov = d3.scaleThreshold()
	    .domain(d3.range(1, 10))
	    .range(d3.schemeBlues[9]);	
		
	//pop map
	 max_pop = d3.max(country_pop,function(f){return f.properties.POP_MAX;});
	 min_pop = d3.min(country_pop,function(f){return f.properties.POP_MAX;});
	 pop_range = d3.scaleLinear().domain([min_pop,max_pop]).range([0.2,1]); 
	 
	 popMap();
	 povMap(color_pov,x_pov);
	 povChart(color_pov,x_pov);	
		   
	}
	
	//census subfunctions
function popMap(){
   var pop_map = d3.select("#censusData").append("div")
		.attr("class","minimap")
		.attr("id","popmap");
		
		var pop_map_svg = pop_map.append("svg")
		//.attr("class","minimap");				
   
		var pop_land = pop_map_svg.append("g");
	   
   pop_land.selectAll("path")
	   .data(country_adm1_features)
	   .enter()
	   .append("path")
	   .attr("id",function(d){return "country"+d.properties.fips;})
	   .attr("d",path_census)
	   .style("fill","rgba(220,220,220,1)");
	
	   var pop_places = pop_map_svg.append("g");
	
	pop_places.selectAll("path")
	     .data(country_pop)
	     .enter()
	     .append("path")
	    .attr("d",path_census.pointRadius(3))
	    .attr("fill","rgb(150,150,150)")
	    .attr("opacity",function(d){
	  	  return pop_range(d.properties.POP_MAX);
	    })
	    .attr("path.pointRadius","2");	
	}
	
function povMap(color_pov, x_pov){
	var pov_map = d3.select("#censusData").append("div")
		.attr("class","minimap")
		.attr("id","povmap");
	   
     pov_map.append("svg")
		//.attr("class","minimap")
		.selectAll("path")
		.data(country_adm1_features)
		.enter()
       .append("path")
       .attr("id",function(d){return "pov_map"+d.properties.ADM0_A3;})
       .attr("d",path_census)
       .style("fill", function(d){
       	//var latest = povertyByFips.filter(function(v){return v.key.replace(".","") == d.properties.code_hasc.replace(".","");});
     	var latest = country_povbyfips.filter(function(v){ return v.key.replace(".","") == d.properties.code_hasc.replace(".","");});
		//console.log(latest[0].value.latest);
		//return color_pov(x_pov(latest[0].values[0].value.latest));
		return color_pov(x_pov(latest[0].value.latest));
       });
	}
	
function povChart(color_pov,x_pov){
var c_margin = {top: 20, right: 10, bottom: 10, left: 20},
		c_width = 175 - c_margin.left - c_margin.right,
	 	c_height = 75 - c_margin.top - c_margin.bottom;
	
	 var pov_chart = d3.select("#censusData").append("div")
 	   .attr("class","minimap")
 	   .attr("id","povchart");
	      
     var pc_svg = d3.select("#povchart").append("svg")
     .attr("width", c_width + c_margin.left + c_margin.right)
     .attr("height", c_height + c_margin.top + c_margin.bottom)
 	   .append("g")
     .attr("transform",
        "translate(" + c_margin.left + "," + c_margin.top + ")");
	    
  	  pc_svg.append("text")
  	  .attr("class", "axis")
  	  .attr("x",-20)
  	  .attr("y",-10)
  	  .text("% Population over national poverty line");
	   
   var x = d3.scaleBand().rangeRound([0, c_width]).padding(0.1),
       y = d3.scaleLinear().rangeRound([c_height, 0]);
	  
 	x.domain(country_povbyfips.filter(function(d){return d.key.indexOf(".") != -1;}).map(function(d) { return d.key; }));  
 	y.domain([0, d3.max(country_povbyfips,function(d){return d.value.latest})]);
	  
   pc_svg.append("g")
         .attr("class", "axis")
         .call(d3.axisLeft(y)
   		.ticks(5))
       .append("text")
         .attr("transform", "rotate(-90)")
         .attr("dy", "0.71em")
   	.attr("text-anchor", "end");  
	
   	pc_svg.selectAll(".bar")
 	.data(country_povbyfips.filter(function(d){return d.key.indexOf(".") != -1;}))
   	.enter().append("rect")
   	.attr("id",function(d){//console.log("bb"+d.key.replace(".","")); 
   		return "bb"+d.key.replace(".","");})
 	.attr("x", function(d){return x(d.key);}) 
 	.attr("y", function(d){return y(d.value.latest)})
 	.attr("width", x.bandwidth())
 	.style("fill","steelblue")
   	.attr("x", function(d){return x(d.key);})
 		.attr("y", function(d){return y(d.value.latest)})
 		.attr("basecolor",function(d){
   			return color_pov(x_pov(d.value.latest));})
   	.style("fill",function(d){
   			return d3.select("#bb"+d.key.replace(".","")).attr("basecolor");
   	})	
   	.attr("width", x.bandwidth())
   	.attr("height",function(d){return c_height - y(d.value.latest);})
   	.on("mouseover", function(d){ //console.log(this); 
   		if(!selection){
   		d3.select(this).style("fill","tomato");
   		d3.select("#region"+d.key.replace(".","")).dispatch("mouseover");//style("fill","tomato");
   		}
   	})
   	.on("mouseout", function(d){if(!selection){
   		d3.select(this).style("fill",
   		function(d){return d3.select("#bb"+d.key.replace(".","")).attr("basecolor");});
   		d3.select("#region"+d.key.replace(".","")).dispatch("mouseout");
   		}
   	});
	}
	
//national charts	
	function nationalCharts(){
		var graph3_margin = {top: 10, right: 20, bottom: 20, left: 40},
      		graph3_width = 150 - graph3_margin.left - graph3_margin.right,
      		graph3_height = 100 - graph3_margin.top - graph3_margin.bottom;
			
      	  //all indicators with cumulative unchecked
		  var all_inds = d3.select("#nationalData").append("div")
			.attr("class","epichart");
		  
		  country_indicators = all_inds.append("svg")
  	   .attr("class","country_inds")
			.attr("id","countryinds")	  
     	   .attr("width", graph3_width + graph3_margin.left + graph3_margin.right)
     	   .attr("height", graph3_height + graph3_margin.top + graph3_margin.bottom)
   		 .append("g")
     	   .attr("transform",
            "translate(" + graph3_margin.left + "," + graph3_margin.top + ")");
			
  		  // set the ranges
  		  var x = d3.scaleTime().range([0, graph3_width]);
  		  var y = d3.scaleLinear().range([graph3_height, 0]);  		  
		  
  	  //line charts
  	  valueline3 = d3.line()
  	    	.x(function(d) { return x(d.report_date); })
  	    	.y(function(d) { //console.log(d.report_date+" "+d.cum_cases); 
  				return y(d.cum_cases); });
				
				var dd = byRegion.filter(function(v){return v.key == "ES00";});	

				//scale domain		
				var max = totalByRegion.filter(function(v){return v.key == "ES00";});		
		
				x.domain(d3.extent(epidata, function(v) { return v.report_date; }));
				y.domain([0,max[0].value.max_cumulative+10]);

				//console.log(dd[0].values);
				//have to redraw the map. that's fine. 

				domains = [];
				dd[0].values.forEach(function(v,i){
					domains.push(v.max_cum_cases);
				})		
				
		drawCountryLines(dd, x, y, graph3_height); 				
		  
		  var key = all_inds.append("svg")
			.attr("id","countryChartKey");
			
	var key_labels = key.selectAll("g")
			.data(dd[0].values, function(d,i){//console.log(d.key); 
				return d;})
			.enter()
				.append("g");
				//.attr("class","ind_keys");
		
			key_labels.append("text")
			.attr("id",function(d){return "label"+d.key})
			.attr("class","key_labels")
			.attr("x",10)
			.attr("y",function(d,i){return i*10+10;})
			.text(function(d){return d.key;});
			
			key_labels.append("circle")
				.attr("id",function(d){return "circle"+d.key})
				.attr("cx",5)
				.attr("cy",function(d,i){return i*10+8;})
				.attr("r",2)
				.attr("fill",function(d,i){
					if(d.selected){
						return grey;
					}else{
						return colors[i%colors.length];
					}
				});	
		
				key_labels.on("click",function(d,i){
					d.selected = !d.selected;
					var op = (d.selected)?0:1;
					var opL = (d.selected)?0.25:1;
				
					d3.select("#circle"+d.key).style("opacity",opL);
					d3.select("#label"+d.key).style("opacity",opL);
				
					d3.select("#line"+d.key).style("opacity",op);
					//redraw graph with new axis
					if(d.selected){
						//console.log(d.max_cum_cases);
						domains[i] = 0;
						//console.log(domains[i]);
						y.domain([0,d3.max(domains,function(v){return v;})])
						drawCountryLines(dd, x, y, graph3_height);
					}else{
						domains[i] = d.max_cum_cases;
						y.domain([0,d3.max(domains,function(v){return v;})])
						drawCountryLines(dd, x, y, graph3_height);
					}
				})
				.on("mouseover", function(d){
						d3.select("#line"+d.key).dispatch("mouseover");
					})
				.on("mouseout", function(d){
						d3.select("#line"+d.key).dispatch("mouseout");
					})	
			
		  //new confirmed cases (if available)
		  var new_confirmed = d3.select("#nationalData").append("div")
		  .attr("class","epichart");
		  
		  var conf_cases = new_confirmed.append("svg")
		  .attr("id","conf_cases");	
		
	}
	
	function drawCountryLines(dd, x, y, graph3_height){
	
		country_indicators.selectAll("*").remove();
		//console.log(dd);
	
		linegraph3 = country_indicators.selectAll("path")
		.data(dd[0].values, function(d,i){return d.values;})
		.enter()
		.append("path")
		.attr("id",function(d,i){return "line"+d.key})
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")	
		.style("opacity",function(d,i){
			if(domains[i]==0){
				return 0;
			}else{
				return 1;
			}
		})
		.attr("d", function(d){
			//console.log(d.key); 
			return valueline3(d.values);})
			.on("mouseover",function(d){
				d3.select(this).style("stroke-width",3);
			})
			.on("mouseout",function(d){
				d3.select(this).style("stroke-width",0.75);
			});	
	
		// Add the X Axis
		  var xaxis = country_indicators.append("g")
			.attr("class","axis")	
		      .attr("transform", "translate(0,"+graph3_height+")")
			  //.tickFormat(d3.timeFormat("%B"))
			.call(d3.axisBottom(x)
				. tickFormat(d3.timeFormat("%b %y")))
				.selectAll("text")	
		          .style("text-anchor", "end")
		          .attr("dx", "-.8em")
		          .attr("dy", ".15em")
		          .attr("transform", function(d) {
		              return "rotate(-65)" 
		              });

		  // Add the Y Axis
		  var yaxis = country_indicators.append("g")
			.attr("class","axis")
		      .call(d3.axisLeft(y)
					  .ticks(5));
	  
		linegraph3.append("title")
				.text(function(d){return d.key;});
	
	}
	
	function subnationalCharts(){
		
		
	}
	
	function awardsCharts(){
		
	}
	
	function dists_charts_mout(d){
		d.hover = false;
		d3.select("#subnationalData").selectAll("*").remove();
		d3.select("#subnationalData").append("text")
		.text("SUBNATIONAL")
		.attr("class","subtitle"); //may have to do this separately. This is overkill
	}
	
	
	function show_charts2(d){
	var graph_margin = {top: 20, right: 20, bottom: 50, left: 35},
	    graph_width = 150 - graph_margin.left - graph_margin.right,
	    graph_height = 150 - graph_margin.top - graph_margin.bottom;
		
		var fips = d.properties.fips;
	
		//d3.select("#subnationalData").selectAll("*").remove();
		d3.select("#subnationalData").selectAll("*").remove();
		
		d3.select("#subnationalData").append("text")
		.text("SUBNATIONAL")
		.attr("class","subtitle");
	
		var dd = byRegion.filter(function(v){return v.key == d.properties.fips;});
	
		var max = totalByRegion.filter(function(v){return v.key == d.properties.fips;});
		
		var x = d3.scaleTime().range([0, graph_width]);
		var y = d3.scaleLinear().range([graph_height, 0]);
		
		x.domain(d3.extent(epidata, function(v) { return v.report_date; }));
	
	
		var m1 = d3.max(dd[0].values[0].values, function(v){return v.max_cum_cases;});
		var m2 = d3.max(dd[0].values[1].values, function(v){return v.max_cum_cases;})
		//var yt = d3.scaleLinear().range([graph_height, 0]);
		//console.log();
		var y1 = d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(dd[0].values[0].values, function(v){return v.max_cum_cases;})]);
		var y2 = d3.scaleLinear().range([graph_height, 0]).domain([0,m2]);
		
		
	var valueline_dists = d3.line()
	  	.x(function(d) { return x(d.report_date); })
	  	.y(function(d) { 
			//console.log(d.max_cum_cases);
			y.domain([0,d.max_cum_cases]);
			//d3.max(d.values,function(f){return f.cum_cases;})
			return y(d.cum_cases); });
	
		//d3.scaleLinear().range([graph_height, 0]).domain([0,max[0].value.max_cumulative+10])
		var doms = [];
		dd[0].values.forEach(function(v){
			doms.push(
				d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values, function(v){return v.max_cum_cases;})])
			);
		})
		
		d3.select("#subnationalData").append("div")
		.attr("id","districtData");
		
		//move this earlier to save compute time. 
		dist_charts = d3.select("#districtData")
		.selectAll("svg")
		.data(dd[0].values, function(d,i,j){return d;})
		.enter()
		.append("svg")
		//.attr("id",function(d,i){return fips+"_"+d.key;})
		.attr("class","distCharts")
	    .attr("width", graph_width + graph_margin.left + graph_margin.right)
	    .attr("height", graph_height + graph_margin.top + graph_margin.bottom)
	  .append("g")
		.attr("id",function(d,i){return fips+"_"+d.key;})
	    .attr("transform",
		"translate(" + graph_margin.left + "," + graph_margin.top + ")");
	
	
	dist_charts.append("text")
		.attr("class","chart_labels")
		.attr("x",-10)
		.attr("y",-10)
		.text(function(d){return d.key;});
		
	var buttons = dist_charts.append("button")
		.attr("x",-10)
		.attr("y",-10)
		.attr("id", function(d,i){return "toggle_"+d.key})
		.text("");
	
	
		linegraph = dist_charts.append("path")
		.attr("class","line")
		.style("stroke","steelblue")
		.style("fill","none")
		.attr("d", function(d){return valueline_dists(d.values);});
		
		dist_charts.append("g")
			.attr("class","axis")	
	        .attr("transform", "translate(0,"+graph_height+")")
			.call(d3.axisBottom(x)
				.tickFormat(d3.timeFormat("%b %y"))
				.ticks(8))
				.selectAll("text")	
	            .style("text-anchor", "end")
	            .attr("dx", "-.8em")
	            .attr("dy", ".15em")
	            .attr("transform", function(d) {return "rotate(-65)" 
	                });	
				
		var axis1 = [d3.axisLeft(doms[0]).ticks(5),d3.axisLeft(doms[1]).ticks(5)];
		
			//the solution!!
			dd[0].values.forEach(function(v){
				var yy = d3.scaleLinear().range([graph_height, 0]).domain([0,v.max_cum_cases]);
			
			  d3.select("#"+fips+"_"+v.key).append("g")
				.attr("class","axis")
				.call(d3.axisLeft(yy).ticks(5));
			})
	}

	function getY(d){
		//console.log(d);
		return d3.axisLeft(d3.scaleLinear().range([graph_height, 0]).domain([0,10]))
		.ticks(5);
	}		
	
	
//button functionality
	overview_tab.on("click",function(){
		d3.select(this).style("background","#ccc");
		temporalview_tab.style("background","none");
		
		drawOverview();
	});
	temporalview_tab.on("click",function(){
		d3.select(this).style("background","#ccc");
		overview_tab.style("background","none");
		
		drawTemporalView();
	});
	
	tot_btn.on("click",function(){
		ht = false;
	//updateRegions();
 	});
 
 	pht_btn.on("click",function(){
 	   ht = true;
 	  //updateRegions();
 	 //updateSMs();
 	});		


	function drawSmallMultiples(){	
	
	d3.select("#mapview").append("div")
		.attr("id","smview");
	
	sm_multiples = d3.select("#smview")
		.selectAll("svg")
		.data(byDatebyRegion)
		.enter()
		.append("svg")
		.attr("id",function(d,i){return i;})
		//.attr("class","sm_mults")
		.attr("class","sm_mults")
		.attr("width", 150)
		.attr("height", 100);
		
		var formatDate = d3.timeFormat("%m/%e/%y");

		
		sm_multiples.append("text")
		.attr("class","date_labels")
		.attr("x",5)
		.attr("y",95)
		.text(function(d){ return formatDate(new Date(""+d.key+""));});
		
	sm_maps = sm_multiples.selectAll("path")
		.data(country_adm1_features, function(d,i,j){return d;})	
		.enter()
	    .append("path")
		.attr("id",function(d,i,j){ //console.log(j[i].parentNode.id); 
			return "sm_region"+d.properties.adm1_code+j[i].parentNode.id;})
	    .attr("class","region_sm")
	    .attr("d",path_sm)
		.attr("basecolor",function(d,i,j){
			var c = +j[i].parentNode.id;
			
			var num = byDatebyRegion[c].values.filter(function(v){return v.key == d.properties.fips;})[0].values.filter(function(v){return v.key == "cumulative_suspected_total";})[0].values[0].value;
			//console.log(choropleth2(num));
			return choropleth4(num);
			//console.log(d3.stratify.parentId(d));
		})
		.style("fill", function(d,i,j){return d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id).attr("basecolor");})
		.on("mouseover",function(d){
			d3.select(this).style("fill","tomato");
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill","tomato");
			if(!selection){
				show_charts(d); //add date
			}
			
		})
		.on("mouseout",function(d,i,j){
			d3.select(this).style("fill",function(d){
				return d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id).attr("basecolor");
			})
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill","steelblue");
			if(!selection){
				charts_mout(d);
			}
		});
	}




	
//end ready
}	

function zoomed() {
	//console.log(zoom.translate()+" "+zoom.scale());
	features.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );
	  
	  land.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );	  
	  
	  awards_shp.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );	
	  
	  clinics_pts.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );		  
	
	/*up_land.attr("transform", d3.event.transform)
      .selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );*/  
}	


</script>