<!DOCTYPE html>
<meta charset="utf-8">
<title>Zika Mapping - Footnotes</title>
<link rel="stylesheet" type="text/css" href="style6.css">

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCukYnSkgIttWhAzy_U2YpbhsxU6wS0pbY" async defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src="https://d3js.org/d3-timer.v1.min.js"></script>

<link rel="stylesheet" href="../src/leaflet/leaflet.draw.css"/>
<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.serializeObject/2.0.3/jquery.serializeObject.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="../src/textures/dist/textures.js"></script>
<script src="../dist/leaflet.markercluster-src.js"></script>
<link rel="stylesheet" href="../dist/MarkerCluster.css" />
<link rel="stylesheet" href="../dist/MarkerCluster.Default.css" />
<script src="../src/leaflet.featuregroup.subgroup.js"></script>


<script src='google-sheet.js'></script>

<style>
</style>

<svg class="patternFill" id="p1"><defs><pattern id="diagonalHatch2" width="0.2" height="0.2" patternUnits="userSpaceOnUse" patternTransform="scale(5)">
  <path d="M-0.05,0.05 l0.1,-0.1
           M0,0.2 l0.2,-0.2
           M0.15,0.25 l0.1,-0.1"/>
</pattern></defs></svg>

<svg class="patternFill" id="elsePattern"><defs><pattern id="diagonalHatch" width="0.6" height="0.6" patternUnits="userSpaceOnUse" patternTransform="scale(5)">
  <path d="M-0.15,0.15 l0.3,-0.3
           M0,0.6 l0.6,-0.6
           M0.45,1 l0.3,-0.3"/>
</pattern></defs></svg>

<svg class="patternFill" id="assistPattern"><defs><pattern id="pattern2"
           x="0" y="0" width="0.6" height="0.6"
           patternUnits="userSpaceOnUse" patternTransform="scale(5)">
<circle cx="0.3" cy="0.3" r="0.15" style="stroke: none; fill:grey" /></pattern></defs></svg>

<script src="d3.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="topojson.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>


	<script src="../src/leaflet/Leaflet.draw.js"></script>
    <script src="../src/leaflet/Leaflet.Draw.Event.js"></script>

    <script src="../src/leaflet/Toolbar.js"></script>
    <script src="../src/leaflet/Tooltip.js"></script>

    <script src="../src/leaflet/ext/GeometryUtil.js"></script>
    <script src="../src/leaflet/ext/LatLngUtil.js"></script>
    <script src="../src/leaflet/ext/LineUtil.Intersect.js"></script>
    <script src="../src/leaflet/ext/Polygon.Intersect.js"></script>
    <script src="../src/leaflet/ext/Polyline.Intersect.js"></script>
    <script src="../src/leaflet/ext/TouchEvents.js"></script>

    <script src="../src/leaflet/draw/DrawToolbar.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Feature.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.SimpleShape.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Polyline.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Circle.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Marker.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Polygon.js"></script>
    <script src="../src/leaflet/draw/handler/Draw.Rectangle.js"></script>


    <script src="../src/leaflet/edit/EditToolbar.js"></script>
    <script src="../src/leaflet/edit/handler/EditToolbar.Edit.js"></script>
    <script src="../src/leaflet/edit/handler/EditToolbar.Delete.js"></script>

    <script src="../src/leaflet/Control.Draw.js"></script>

    <script src="../src/leaflet/edit/handler/Edit.Poly.js"></script>
    <script src="../src/leaflet/edit/handler/Edit.SimpleShape.js"></script>
    <script src="../src/leaflet/edit/handler/Edit.Circle.js"></script>
    <script src="../src/leaflet/edit/handler/Edit.Rectangle.js"></script>
    <script src="../src/leaflet/edit/handler/Edit.Marker.js"></script>


<body>	
	<div id="global_container"></div>
<script>

//d3.select("#global_container").append("div")
//.attr("id","chart");

//progress bar
/*var width = 960,
    height = 500,
    twoPi = 2 * Math.PI,
    progress = 0,
    total = 1308573, // must be hard-coded if server doesn't report Content-Length
    formatPercent = d3.format(".0%");

var arc = d3.arc()
    .startAngle(0)
    .innerRadius(180)
    .outerRadius(240);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var meter = svg.append("g")
    .attr("class", "progress-meter");

meter.append("path")
    .attr("class", "background")
    .attr("d", arc.endAngle(twoPi));

var foreground = meter.append("path")
    .attr("class", "foreground");

var text = meter.append("text")
    .attr("text-anchor", "middle")
    .attr("dy", ".35em");*/
//end progress bar



/*<div id="container"></div>*/

//leaflet!
//var map = new L.Map("map", {center: [37.8, -96.9], zoom: 4})
  //  .addLayer(new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));	
  
  var texcolor = "white";

var t1 = textures.lines()
  .size(8)
  .stroke(texcolor)
  .thicker()
  .strokeWidth(0.5);
 
var t5 = textures.lines()
  .size(8)
  .lighter()
  .stroke(texcolor);  
 
var t4 = textures.lines()
  .size(4)
  .orientation("vertical")
  .strokeWidth(0.5)
  .stroke(texcolor)
  .shapeRendering("crispEdges");
  
var t2 = textures.circles()
  .size(8)
  .thicker()
  .radius(1)
  .fill(texcolor);
  
var t3 = textures.paths()
  .size(12)
  .d("caps")
  .lighter()
  .stroke(texcolor);
  //.strokeWidth(0.5);
  
 var t6 = textures.paths()
  .size(8)
  .d("crosses")
  .lighter()
  .thicker()
  .strokeWidth(0.5)
  .stroke(texcolor);   
  
  
var t1b = textures.lines()
  .size(7)
  .thicker()
  .strokeWidth(0.5)
  .shapeRendering("crispEdges");
 
var t5b = textures.lines()
  .size(7)
  .lighter();  
 
var t4b = textures.lines()
  .size(1.5)
  .orientation("vertical")
  .strokeWidth(0.5)
  .shapeRendering("crispEdges");
  
var t2b = textures.circles()
  .size(5)
  .thicker()
  .radius(0.75);
  
var t3b = textures.paths()
  .size(5)
  .d("caps")
  .lighter()
  .thicker();
  
 var t6b = textures.paths()
  //.size(4)
  .d("crosses")
  .lighter()
  .thicker();   
  
  
  var fills_t = [t1,t2,t3,t4,t5,t6];
  var fills_tb = [t1b,t2b,t3b,t4b,t5b,t6b];
  
  var textures = d3.select("#global_container").append("svg").style("width", "100%").style("height", "100%").style("position","absolute");
          
  for(var x=0;x<6;x++){
	  textures.call(fills_t[x]);
	  textures.call(fills_tb[x]);
  }
 
var l_o_efs = ["SBCC","Service Delivery","Vector Control","Community Engagement","Research and Innovation"];  
	
var glegend;
var glegend_ht;
var legend_all;	
	
//zoomval variables	
var _g = 1; //global
var _c = 0; //country
var _r = 0;	//regional
	
var choropleth_date;
var c_choropleth_date;
var c_d_data;
var clegend;
var clegend_ht;	
var infoImage2;
var infoImage3;
var zoomVal;
var zoomLevel = 2;
var mapcolor = "#d4dadc";//"#d0cfd4";
var divmode;
	
var ht = false;
	
//var bchart_colors =["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"];	
var bchart_colors = ["#e7298a","#377eb8","#4daf4a","#984ea3","#ffff99"];
//var level_colors = ["#252525","#636363","#d9d9d9","#253494"];	
var level_colors = ["#252525","#636363","#bfbfbf","#253494"];
	
var colors = ["#3a44c7","#1f78b4",/*"#b2df8a"*/"#335317","#33a02c","#fb9a99", "#e31a1c","#fdbf6f","#ff7f00","#cab2d6"];
//var dcolors = [/*"#a6cee3",*/"#377eb8","#4daf4a","#ff7f00","#984ea3"];
var dcolors = ["#1b9e77",
"#d95f02",
"#7570b3",
"#e7298a",
"#66a61e"];

var d2colors = ["#1b9e77",
"#d95f02",
"#7570b3",
"#e7298a",
"#66a61e"];

var dstrokecolors=[
"#126b50",
"#a64902",
"#535080",
"#b5216d",
	"#477315"];

//[/*"rgba(166, 205, 227, 0.8)",*/"rgba(55, 126, 184, 0.8)","rgba(77, 175, 74, 0.8)","rgba(255, 127, 0, 0.8)","rgba(152, 78, 163, 0.8)"];
//var dstrokecolors = [/*"#048bb4",*/"rgba(0,  50,  108, 1)","rgba(1,  99,  0, 1)","rgba(179,  51,  0, 1)","rgba(76,  2,  87, 1)"];
/*var colors = ["#db8869",
"#7566c9",
"#55b14b",
"#c25abc",
"#8a9d43",
"#cc436e",
"#4aab8b",
"#d04d34",
"#6992cf",
"#d29f3b",
"#bd6e96",
"#93632b"];*/


var priority_countries = ["Belize","Haiti","El Salvador","Dominican Republic", "Honduras","Guatemala","Colombia", "Nicaragua", "Peru", "Ecuador", "Jamaica", "Venezuela","Guyana","Paraguay","Brazil","Panama","Costa Rica","Barbados","Dominica","Antigua and Barbuda","Guyana","Grenada","Saint Vincent and the Grenadines","Saint Lucia","Trinidad and Tobago","Saint Kitts and Nevis"];//"Cuba","French Guiana","Guadeloupe","Martinique"/*,"Puerto Rico"*/,"Saint Barthelemy","Saint Martin"];

//var got_data = ["Haiti","El Salvador","Dominican Republic", "Honduras","Guatemala",
// "Colombia", "Nicaragua", "Peru", "Ecuador", "Jamaica", "Venezuela"];
 
 var got_data = [ 
// "Colombia",
 "Dominican Republic",
 "Ecuador",
 "El Salvador",
 "Guatemala",
 "Haiti",
 "Honduras",
 "Jamaica",
 "Nicaragua",
 "Peru",
 "Venezuela"];
 
 
 var got_data2 = [  
 "Colombia",
 "Dominican Republic",
	 "Ecuador",
 "El Salvador",
 "Guatemala",
 "Haiti",
 "Honduras",
 "Jamaica",
 "Nicaragua",
 "Peru",
 "Venezuela"];
 

//var country_labels = [{country:"Haiti",dx:-15,dy:-10,t_align:"left",inline:false},{country:"El Salvador",dx:-40,dy:20,t_align:"left",inline:false},{country:"Dominican Republic",dx:10,dy:0,t_align:"right",inline:false},{country:"Honduras",dx:0,dy:-10,t_align:"left",inline:false},
//{country:"Guatemala",dx:-50,dy:5,t_align:"left",inline:false},{country:"Colombia",dx:-15,dy:0,t_align:"left",inline:false},{country:"Nicaragua",dx:0,dy:10,t_align:"left",inline:false},{country:"Peru",dx:-20,dy:0,t_align:"left",inline:false},{country:"Ecuador",dx:-15,dy:0,t_align:"left",inline:false},
//{country:"Jamaica",dx:-15,dy:-10,t_align:"left",inline:false},{country:"Venezuela",dx:-15,dy:0,t_align:"left",inline:false},{country:"Paraguay",dx:-15,dy:0,t_align:"left",inline:false},{country:"Guyana",dx:-15,dy:0,t_align:"left",inline:false},{country:"Belize",dx:0,dy:-10,t_align:"left",inline:false},
//{country:"Brazil",dx:-15,dy:0,t_align:"left",inline:false},{country:"Panama",dx:-20,dy:20,t_align:"left",inline:false},{country:"Costa Rica",dx:-45,dy:10,t_align:"left",inline:false},{country:"Caribbean Regional",dx:0,dy:0,t_align:"left",inline:false},
//{country:"Barbados",dx:5,dy:-3,t_align:"left",inline:true, lngth:45},{country:"Dominica",dx:5,dy:-2,t_align:"left",inline:true,lngth:40},{country:"Antigua and Barbuda",dx:5,dy:5,t_align:"left",inline:true,lngth:84},{country:"Grenada",dx:15,dy:6,t_align:"left",inline:true,lngth:40},
//{country:"Saint Vincent and the Grenadines",dx:15,dy:6,t_align:"left",inline:true,lngth:142},{country:"Saint Lucia",dx:8,dy:-6,t_align:"left",inline:true,lngth:50},{country:"Trinidad and Tobago",dx:5,dy:0,t_align:"left",inline:true,lngth:82},{country:"Saint Kitts and Nevis",dx:10,dy:-5,t_align:"left",inline:true,lngth:83},
 //{country:"E/S Caribbean",dx:0,dy:0,t_align:"left",inline:false},{country:"Surinam",dx:0,dy:0,t_align:"left",inline:false}];

var country_labels = [{country:"Haiti",dx:-15,dy:-10,t_align:"left",inline:false},{country:"El Salvador",dx:-40,dy:20,t_align:"left",inline:false},{country:"Dominican Republic",dx:10,dy:0,t_align:"right",inline:false},{country:"Honduras",dx:0,dy:-10,t_align:"left",inline:false},
{country:"Guatemala",dx:-50,dy:5,t_align:"left",inline:false},{country:"Colombia",dx:-15,dy:0,t_align:"left",inline:false},{country:"Nicaragua",dx:0,dy:10,t_align:"left",inline:false},{country:"Peru",dx:-20,dy:0,t_align:"left",inline:false},{country:"Ecuador",dx:-15,dy:0,t_align:"left",inline:false},
{country:"Jamaica",dx:-15,dy:-10,t_align:"left",inline:false},{country:"Venezuela",dx:-15,dy:0,t_align:"left",inline:false},{country:"Paraguay",dx:-15,dy:0,t_align:"left",inline:false},{country:"Guyana",dx:-15,dy:0,t_align:"left",inline:false},{country:"Belize",dx:0,dy:-10,t_align:"left",inline:false},
{country:"Brazil",dx:-15,dy:0,t_align:"left",inline:false},{country:"Panama",dx:-20,dy:20,t_align:"left",inline:false},{country:"Costa Rica",dx:-45,dy:10,t_align:"left",inline:false},{country:"Caribbean Regional",dx:0,dy:0,t_align:"left",inline:false},
{country:"Barbados",dx:5,dy:-3,t_align:"left",inline:true, lngth:0},{country:"Dominica",dx:5,dy:-2,t_align:"left",inline:true,lngth:0},{country:"Antigua and Barbuda",dx:5,dy:5,t_align:"left",inline:true,lngth:0},{country:"Grenada",dx:15,dy:6,t_align:"left",inline:true,lngth:0},
{country:"Saint Vincent and the Grenadines",dx:15,dy:6,t_align:"left",inline:true,lngth:0},{country:"Saint Lucia",dx:8,dy:-6,t_align:"left",inline:true,lngth:0},{country:"Trinidad and Tobago",dx:5,dy:0,t_align:"left",inline:true,lngth:0},{country:"Saint Kitts and Nevis",dx:10,dy:-5,t_align:"left",inline:true,lngth:0},
 {country:"E/S Caribbean",dx:0,dy:0,t_align:"left",inline:false},{country:"Surinam",dx:0,dy:0,t_align:"left",inline:false}];

var central = ["El Salvador", "Honduras","Guatemala", "Nicaragua", "Ecuador"];
var south = ["Colombia", "Peru", "Venezuela"];
var caribbean = ["Dominican Republic", "Jamaica", "Haiti"];

var Caribbean_regional = ["Cuba","Dominican Republic","French Guiana","Guadeloupe","Haiti","Martinique","Puerto Rico","Saint Barthelemy","Saint Martin"];

var CR = ["Barbados","Dominica","Antigua and Barbuda","Grenada","Saint Vincent and the Grenadines","Saint Lucia","Trinidad and Tobago","Saint Kitts and Nevis"];
var CR_ADM0 = ["BRB","DMA","ATG","GRD","VCT","Saint Lucia","TTO","KNA"];

//var regional_assoc = [{key:"HN"}]
var hover_color = "#536878";//"#a1d99b";//"tomato";


var ADM0_A3_lookup = [
{key:"Haiti",value:"HTI"},
{key:"El Salvador",value:"SLV"},
{key:"Dominican Republic",value:"DOM"},
{key:"Honduras",value:"HND"},
{key:"Guatemala",value:"GTM"},
{key:"Colombia",value:"COL"},
{key:"Nicaragua",value:"NIC"},
{key:"Peru",value:"PER"},
{key:"Ecuador",value:"ECU"},
{key:"Jamaica",value:"JAM"},
{key:"Venezuela",value:"VEN"},
{key:"Caribbean Regional",value:""},
{key:"Paraguay",value:"PRY"},
{key:"Costa Rica",value:"CRI"},
{key:"Panama",value:"PAN"},
{key:"Guyana",value:"GUY"},
{key:"Belize",value:"BLZ"},
{key:"Brazil",value:"BRA"}];

var ADM1_lookup = [
{key:"Haiti",value:"HTI",region:"caribbean", zoom:7.5,lat: 17.4031029048337, lng: -71.74585331724751, lat2:18.971187,	lng2:-72.285215},
{key:"El Salvador",value:"SLV",region:"central", zoom:7.75,	lat: 12.49122871217691, lng: -87.85241694454625, lat2:13.794185,	lng2:-88.89653},
{key:"Dominican Republic",region:"caribbean",value:"DOM", zoom:7.5,	lat: 17.492035992023744, lng: -69.39199566063652, lat2:18.735693,	lng2:-70.162651},
{key:"Honduras",value:"HND",region:"central", zoom:6.75,	lat: 11.769542307727331, lng: -84.75600730550717, lat2:15.199999,	lng2:-86.241905 },
{key:"Guatemala",value:"GTM",region:"central", zoom:6.75,	lat: 12.803554527856953, lng: -88.37501772750642, lat2:15.783471,	lng2:-90.230759},
{key:"Colombia",value:"COL",region:"south",zoom:5.25,	lat: -2.623061546938762, lng: -67.4028203344599, lat2:4.570868,	lng2:-74.297333},
{key:"Nicaragua",value:"NIC",region:"central",zoom:6.75,	lat: 9.7545238741867, lng: -83.13594487833062, lat2:12.865416,	lng2:-85.207229},
{key:"Peru",value:"PER",zoom:5,region:"south",	lat: -15.496032414238622, lng: -67.36816406250001, lat2:-9.189967,	lng2:-75.015152},
{key:"Ecuador",value:"ECU",region:"central", zoom:5.25,	lat: -8.468573976249251, lng: -77.82369485552398, lat2:-1.831239,	lng2:-78.183406},
{key:"Jamaica",value:"JAM",region:"caribbean", zoom:8.5,	lat: 17.273331276585754, lng: -76.74877190093554, lat2:18.109581,	lng2:-77.297508},
{key:"Venezuela",value:"VEN",region:"south", zoom:5.25,	lat: 0.8126658260707518, lng: -61.305500135964955, lat2:6.42375, lng2:-66.58973},
{key:"Caribbean Regional",region:"caribbean",value:""},
{key:"Paraguay",value:"PRY",region:"south", zoom:5.75,	lat: -28.745445051887184, lng: -53.687390758524465, lat2:-23.442503,	lng2:-58.443832},
{key:"Costa Rica",value:"CRI",region:"central", zoom:7,	lat: 7.612997502224103, lng: -82.52929687500001, lat2:9.748917,	lng2:-83.753428},
{key:"Panama",value:"PAN",region:"central", zoom:6.75,	lat: 6.326862626903991, lng: -78.6938382231691, lat2:8.537981,	lng2:-80.782127},
{key:"Guyana",value:"GUY",region:"south", zoom:6.75, lat: 3.21553085623219, lng: -57.071230828191624, lat2:4.860416,	lng2:-58.93018},
{key:"Belize",value:"BLZ",region:"central", zoom:7.75,	lat: 16.236826251708347, lng: -87.68257169008419, lat2:17.189877,	lng2:-88.49765},
{key:"Brazil",value:"BRA",region:"south", zoom:4.25,	lat: -23.447596306682456, lng: -45.19379342963887, lat2:-14.235004,	lng2:-51.92528}];

var glMapView;
var countryZoomVal = 6.25;
var gl_choroplethIndicator = "autochthonous_cases_confirmed";
var c_choroplethIndicator;

var global_map;
var wait = false;
var country_map;
var footnote_data;
var footnotes;	
var global_data;
var nested_annotation_data;
var country_featureGroup;
var global_featureGroup;
var country_drawControl;
var global_drawControl;
var comments_data;
var gl_countries;
var gl_subregions;
var global_subregions;
var d_points;
var footnote_symbols;
var gl_symbols;
var gl_scatterpoints;
var x_l_scatter;
var y_gl_scatter;
var commentsOn_btn;
var commentsOff_btn;
var commentsCheckbox;
var awardsCheckbox;
var awardsOn = true;
var discrepanciesOn = true;
var perTotal_btn;
var perHT_btn;
var perState = true;
var commentsState = true;
var gl_selection = false;
var gl_selection_id = "";
var gl_op = 0.75;
var tabColor;
var tot_btn;
var pht_btn;
var cview = false;
var gview = true;
var rview = false;
var discrepancyMode = 0;
var discrepancy_histogram;
var dptMode = "truevalue";
var PAHO_global_footnotes;
var marker_layers;
var PAHO_global_footnotes_objs = [];
var discrepancyTrueValue;
var discrepancyPipeline;
var discrepancyType;
var placeMarker = false;
var underlyingRegion;
var global_indicators_template;
var country_indicators_template;
var gl_choroplethIndicator;



//icons
var greenIcon;
var blueIcon;
var violetIcon;
var redIcon;
var organIcon;
var greyIcon;

var iDiv = d3.select("body").append("div")
	.attr("class","tooltip")
	.style("opacity",0);
var iDiv1 = d3.select("body").append("div")
	.attr("class","tooltip")
	.style("opacity",0);
var iDiv2 = d3.select("body").append("div")
	.attr("class","tooltip")
	.style("opacity",0);	

	


function retrieveComments(_callback,prevLength){
	console.log("retrieving comments");
	//console.log(prevLength);
	var new_comments_data = [];
	var t = d3.timer(function(elapsed){
		//console.log(elapsed);
		d3.csv("https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/export?format=csv", function(error,data){
		new_comments_data = data;
		});
		
		//console.log(new_comments_data.length);
		if(new_comments_data.length>prevLength || elapsed > 2000){
			t.stop();
			_callback(new_comments_data);
		}
	},150);	
}

var data_info;
var comments_data;


var inter = setInterval(function() {
                updateData();
        }, 5000); 

function updateData() {
	console.log("checking");
	var new_comments_data = [];
	d3.csv("https://docs.google.com/spreadsheets/d/126Bf_7QZ-_KiUERy8ktQhH7UavD27IrpT4z8IiGuDnc/export?format=csv", function(error,data){
	new_annotations = data;
	
	if(global_data!=undefined){
	if(data.length > global_data.length){
		console.log("another!");
		updateMarkers(data);
		global_featureGroup.clearLayers();
		
	}
}
	
	});
	
}


//retrieveComments();	

function initGlobalView(){
//set up global view divs	
d3.select("#global_container").append("div")
	.attr("id","gl_mapview");

/*d3.select("#global_container").append("div")
	.attr("id","gl_mapLeaflet");*/	
	
glMapview = document.getElementById("gl_mapview");	
	
d3.select("#global_container").append("div")
.attr("id","gl_middleview");	

d3.select("#gl_middleview").append("div")
	.attr("id","gl_banner");	
	
d3.select("#gl_banner").append("h1")
	.attr("class","banner")
	.text("VISUALIZING USAID EFFORTS TO COMBAT ZIKA");
	
d3.select("#gl_middleview").append("div")
	.attr("id","viewtabs");		

d3.select("#gl_middleview").append("div")
	.attr("id","gl_awardview");		

d3.select("#global_container").append("div")
	.attr("id","gl_chartview");
	
d3.select("#global_container").append("div")
	.attr("id","gl_comments");
	
/*d3.select("#global_container").append("div")
	.attr("id","commentsOn");
	
d3.select("#global_container").append("div")
	.attr("id","commentsOff");*/

/*d3.select("#gl_comments").append("div")
	.attr("id","gl_messageBoard");	
	
d3.select("#gl_comments").append("div")
	.attr("id","gl_postMessage");*/	
	
d3.select("#gl_chartview").append("div")
	.attr("id","gl_epiData");
	
d3.select("#global_container").append("div")
	.attr("id","discrepancyView");	
		
divmode = d3.select("#discrepancyView").append("div")
	.attr("id","mode");			
	
var DiscTitle = d3.select("#discrepancyView").append("div")
	.attr("id","discrTitle")
	.attr("class","chartTitle");
	
	DiscTitle.append("text")
	.attr("class","chartTitleText")
	.text("DISCREPANCY DATA");
		
	
var WEDtitle = d3.select("#gl_epiData").append("div")
	.attr("id","epiDataTitle")
	.attr("class","chartTitle");
	
	
	WEDtitle.append("text")
	.attr("class","chartTitleText")
	.text("WEEKLY EPIDEMIOLOGICAL DATA");	
	
	var infoImage = WEDtitle.append("svg")
	.attr("width",15)
	.attr("height",15);
	
	infoImage.append("image")
	.attr("xlink:href","./images/infoIcon2.png")
	.attr("width",15)
	.attr("height",15)
	.on("mouseover",function(d){
		d3.select(this).attr("cursor","pointer");
		iDiv.moveToFront();
		
		iDiv.transition()		
        .duration(200)		
        .style("opacity", .9);		
  	  	
		iDiv.html(function(){
			var txt = data_info.filter(function(v){return v.info_id=="globalWeeklyEpi";})[0];
			return txt.src+"<br>"+txt.link;
		})	
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");
	})
	.on("mouseout",function(d){
		d3.select(this).attr("cursor","default");
		iDiv.transition()		
        .duration(300)		
        .style("opacity", 0);		
	});	
		
	/*infoImage.append("title")
		.html(function(){
					var txt = data_info.filter(function(v){return v.info_id=="globalWeeklyEpi";})[0];
					return txt.src+"<br>"+txt.link;
				});	*/
	
	tabColor = "#b8bec0";//"#97bbc5";

d3.select("#gl_epiData").append("div")
	.attr("class","epiTab")
	.style("background",tabColor)
	.attr("id","confCases")
	.text("CONFIRMED ZIKA CASES");
	
	/*.on("click",function(d){
		gl_epi_tab = 0;
		console.log(gl_epi_tab);
		d3.select("#byIndicator").attr("active",false);
		d3.select(this).attr("active",true);
		draw_global_chartview();
	});	*/	
	
d3.select("#gl_epiData").append("div")
	.attr("class","epiTab")
	.style("background","none")
	.attr("id","byIndicator")
	.text("ADDITIONAL INDICATORS");
	/*.on("click",function(d){
		gl_epi_tab = 1;
		console.log(gl_epi_tab);
		d3.select("#confCases").attr("active",false);
		d3.select(this).attr("active",true);
		draw_global_chartview();
	});*/	
	
d3.select("#gl_epiData").append("div")
	.attr("id","newConfirmedData");
	//.text("CONFIRMED ZIKA CASES")
	//.attr("class","subtitle");
	
d3.select("#newConfirmedData").append("div")
	.attr("id","new_conf");
	
d3.select("#newConfirmedData").append("div")
	.attr("id","cum_conf");	
	
d3.select("#newConfirmedData").append("div")
	.attr("id","gl_scatter");			
	
d3.select("#gl_epiData").append("div")
	.attr("id","byIndicatorData");	
	
//move new confirmed to fron
	d3.select("#newConfirmedData").moveToFront();	
	
}	


var overview_tab;
var temporalview_tab;
var lbl_o;
var lbl_t;
var close_btn;
var gl_epi_tab = 0;	
var c_cum_confirmed;

function initCountryViewMerged(){
d3.select("#global_container").append("div")
	.attr("id","rsView");
	
d3.select("#rsView").append("div")
	.attr("id","chartview");
	
d3.select("#global_container").append("div")
	.attr("id","awardview");	
	
	d3.select("#awardview").style("pointer-events","none");	
	
var censusData = d3.select("#chartview").append("div")
	.attr("id","censusDataTitle")
	.attr("class","chartTitle");
	
	censusData.append("text")
	.attr("class","chartTitleText")
	.text("CENSUS DATA");	
	
	infoImage2 = censusData.append("svg")
	.attr("width",15)
	.attr("height",15);
	
	infoImage2.append("image")
	.attr("xlink:href","./images/infoIcon2.png")
	.attr("width",15)
	.attr("height",15);
	
	
d3.select("#chartview").append("div")
	.attr("id","censusData");		
	
d3.select("#chartview").append("div")
	.attr("id","epiData");
	
var weeklyEpiData = d3.select("#epiData").append("div")
	.attr("id","epiDataTitle")
	.attr("class","chartTitle_tab");
	
	weeklyEpiData.append("text")
	.attr("class","chartTitleText")
	.text("WEEKLY EPIDEMIOLOGICAL DATA");	
	
	infoImage3 = weeklyEpiData.append("svg")
	.attr("width",15)
	.attr("height",15);
	
	infoImage3.append("image")
	.attr("xlink:href","./images/infoIcon2.png")
	.attr("width",15)
	.attr("height",15);
	
var pahoTab = d3.select("#epiData").append("div")
	.attr("id","pahoDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("PAHO");	

var nationalTab = d3.select("#epiData").append("div")
	.attr("id","nationalDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("NATIONAL");		

var subNatTab = d3.select("#epiData").append("div")
	.attr("id","subnationalDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("SUBNATIONAL");		

d3.select("#epiData").append("div")
	.attr("id","pahoData");
	
d3.select("#epiData").append("div")
	.attr("id","nationalData");
	
d3.select("#epiData").append("div")
	.attr("id","subnationalData");	
	

pahoTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","white");
	d3.select("#nationalDataTab").style("background","none");
	d3.select("#subnationalDataTab").style("background","none");
	
	d3.select("#pahoData").moveToFront();
	
});

nationalTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","none");
	d3.select("#nationalDataTab").style("background","white");
	d3.select("#subnationalDataTab").style("background","none");
	
	d3.select("#nationalData").moveToFront();
	
});

subNatTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","none");
	d3.select("#nationalDataTab").style("background","none");
	d3.select("#subnationalDataTab").style("background","white");
	
	d3.select("#subnationalData").moveToFront();
});

subNatTab.dispatch("click");	

d3.select("#awardview").append("div")
	.attr("id","awardData")
	.append("text")
	.text("USAID Partnerships")
	.attr("class","awardsTitle");	

}

function initCountryView(){
//set up country view divs
d3.select("body").append("div")
	.attr("id","popup");	
	
/*d3.select("#container").append("div")
	.attr("id","banner");*/	
	
	
//country view
/*d3.select("#container").append("div")
	.attr("id","menu");*/
	
 close_btn = d3.select("#popup").append("div")
	.attr("id","closeBtn")
	.append("text")
	.text("close")
	.style("stroke","white")
	.attr("class","cl_btn");

	d3.select("#popup").append("div")
	.attr("id","container");	
	//append("text")
	//.text("X")
	//.attr("x",500)
	//.attr("y",10);	

d3.select("#container").append("div")
	.attr("id","middleView");	

d3.select("#container").append("div")
	.attr("id","rsView");
	
d3.select("#rsView").append("div")
	.attr("id","chartview");
	
d3.select("#rsView").append("div")
	.attr("id","messageBoard");
	
d3.select("#rsView").append("div")
	.attr("id","postMessage");
	
//middle column
//load title on load country	
d3.select("#middleView").append("div")
	.attr("id","mapheader");

d3.select("#middleView").append("div")
	.attr("id","mapview");	
	
/*d3.select("#middleView").append("div")
	.attr("id","awardview");*/
	
//chartview
var censusData = d3.select("#chartview").append("div")
	.attr("id","censusDataTitle")
	.attr("class","chartTitle");
	
	censusData.append("text")
	.attr("class","chartTitleText")
	.text("CENSUS DATA");	
	
	infoImage2 = censusData.append("svg")
	.attr("width",15)
	.attr("height",15);
	
	infoImage2.append("image")
	.attr("xlink:href","./images/infoIcon2.png")
	.attr("width",15)
	.attr("height",15);
	
	
d3.select("#chartview").append("div")
	.attr("id","censusData");		
	
d3.select("#chartview").append("div")
	.attr("id","epiData");
	
var weeklyEpiData = d3.select("#epiData").append("div")
	.attr("id","epiDataTitle")
	.attr("class","chartTitle_tab");
	
	weeklyEpiData.append("text")
	.attr("class","chartTitleText")
	.text("WEEKLY EPIDEMIOLOGICAL DATA");	
	
	infoImage3 = weeklyEpiData.append("svg")
	.attr("width",15)
	.attr("height",15);
	
	infoImage3.append("image")
	.attr("xlink:href","./images/infoIcon2.png")
	.attr("width",15)
	.attr("height",15);
	
var pahoTab = d3.select("#epiData").append("div")
	.attr("id","pahoDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("PAHO");	

var nationalTab = d3.select("#epiData").append("div")
	.attr("id","nationalDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("NATIONAL");		

var subNatTab = d3.select("#epiData").append("div")
	.attr("id","subnationalDataTab")
	.attr("class","chartTab")
	.append("text")
	.text("SUBNATIONAL");		

d3.select("#epiData").append("div")
	.attr("id","pahoData");
	
d3.select("#epiData").append("div")
	.attr("id","nationalData");
	
d3.select("#epiData").append("div")
	.attr("id","subnationalData");	
	

pahoTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","white");
	d3.select("#nationalDataTab").style("background","none");
	d3.select("#subnationalDataTab").style("background","none");
	
	d3.select("#pahoData").moveToFront();
	
});

nationalTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","none");
	d3.select("#nationalDataTab").style("background","white");
	d3.select("#subnationalDataTab").style("background","none");
	
	d3.select("#nationalData").moveToFront();
	
});

subNatTab.on("click",function(d){
	d3.select("#pahoDataTab").style("background","none");
	d3.select("#nationalDataTab").style("background","none");
	d3.select("#subnationalDataTab").style("background","white");
	
	d3.select("#subnationalData").moveToFront();
});

nationalTab.dispatch("click");

	
	
//d3.select("#epiData").append("div")
//	.attr("id","subnationalData");
	

//banner
/*d3.select("#banner").append("h1")
	.attr("class","banner")
	.text("ZikaVis");*/
	
/*d3.select("#banner").append("h2")
	.attr("class","banner")
	.text("VISUALIZING USAID EFFORTS TO COMBAT ZIKA");*/
//title with tabs, buttons
d3.select("#mapheader").append("div")
	.attr("id","maptitle")
	//.append("text")
	//.text("EL SALVADOR");
	
d3.select("#mapheader").append("div")
	.attr("id","tabs");
	
overview_tab = d3.select("#tabs").append("div")
	.attr("class","tab")
	.attr("id","overview_tab")
	.on("mouseover",function(d){
		//d3.select(this).style("background","#ccc");
	})
	.on("mouseout",function(d){
		/*if(!d3.select(this).selected){
		d3.select(this).style("background","none");
		}*/
	});
	
lbl_o = overview_tab.append("text")
	.text("overview");
	
temporalview_tab = d3.select("#tabs").append("div")
	.attr("class","tab")
	.attr("id","temporal_view_tab")
	.on("mouseover",function(d){
		//d3.select(this).style("background","#ccc");
	})
	.on("mouseout",function(d){
		/*console.log(d3.select(this).selected);
		if(!d3.select(this).selected){
		d3.select(this).style("background","none");
		}*/
	})
	
lbl_t = temporalview_tab.append("text")
	.text("temporal view");		
	
	
d3.select("#mapheader").append("div")
	.attr("id","buttons");
	
/*tot_btn = d3.select("#buttons").append("div")
	.attr("class","toggle_button");
	
	tot_btn.append("text")
	.text("total cases");

pht_btn = d3.select("#buttons").append("div")
	.attr("class","toggle_button");
	
	pht_btn.text("per H.T.");*/	
				
//awards data
d3.select("#awardview").append("div")
	.attr("id","awardData")
	.append("text")
	.text("USAID Partnerships")
	.attr("class","awardsTitle");	
	
	
}

/*var update_cv = d3.select("#banner").append("button")
	.attr("class","banner_btn")
	.text("Update Data");	*/
	
//banner global view
/*d3.select("#gl_banner").append("h1")
	.attr("class","banner")
	.text("ZikaVis");*/	
	
/*var update_gl = d3.select("#gl_banner").append("button")
	.attr("class","banner_btn")
	.text("Update Data");*/		


	
//svgs for overview + small multiples
//maybe just one svg...
	var mapview_svg;
	var over_view;
	//var country_map;
	//var footnotes;
	var sm_view;
	var sm_multiples;
	var sm_NAdiv;
	var sm_legend;
	// = d3.select("#mapview").append("svg")
	//.attr("class","mapview_svg");

	var land;
	var features;
	var regions;
	var subfeatures;
	var subregions;
	var awards_shp;
	var clinics_pts;
	var places;	
	var key;
	
	var country_features;
	var country_regions;
	
	
//global variables
	var width;
    var height;
	
	var sm_width;
	var sm_height;		

	var gl_width;
	var gl_height;//glMapview.clientHeight;	
	var global_projection;
	var global_path;	
	var global_svg;
	var legend_svg;	
	var global_land;
	var global_features;
	var global_awards;		
	var global_bcharts;	
	var global_labels;	
	
	
	
	
	//discrepancy stuff
	var discrepancyByType;
	var discrepancyByPipeline;
	var discrepancyByTrueValue;
	var discrepancy_nodes;
	var globalbycountry;
	var globalbyDatebyCountry;
	var discrepancy_data_filtered;
	var discrepancy_points;
	
	//var global_map;
	//var footnote_data;	
	//var global_data;
	
//country variables	
	var path_leaflet;
	var projection_census;
	var path_census;	
	var projection_sm;
	var path_sm;				
	var projection;
	var path;
	var clinicSymbol;
	var dist_charts;	
	var efforts;
	
	
function globalProjections(){	
	
	width = 500,
    height = 400;
	
	sm_width = 125,
	sm_height = 125;		

	gl_width = glMapview.clientWidth;
	gl_height = 800;//glMapview.clientHeight;	
	
//setup topojson stuff -- paths and projections
/************global projection**************/	
	
//Map projection
global_projection = d3.geoMercator()
    .scale(500)
	//.scale(100)
    .center([0,0]) //projection center
	.translate([1025,350]) //translate to center the map in view	
	//.translate([width/2,height/2]);

//Generate paths based on projection
global_path = d3.geoPath()
    .projection(global_projection);	
	
	//.attr("class","toggle");	
	
	//commentsOff_btn.text("off");	



//Create an SVG
/*global_svg = d3.select("#gl_mapview").append("svg")
	.attr("class","gl_mapview")
    .attr("width", gl_width-1)
    .attr("height", gl_height-1);

//Group for the map features
global_land = global_svg.append("g")
    .attr("class","gl_land")
	.attr("id","gl_regions");
	
//Group for the map features
global_features = global_svg.append("g")
    .attr("class","gl_features");
	
//Group for the map features
global_awards = global_svg.append("g")
	.attr("class","gl_awards");		
	
global_bcharts = global_svg.append("g")
	.attr("class","gl_bcharts");	
	
	global_labels = global_svg.append("g");	*/		
	
/************end global projection**************/
}

function countryProjections(){
//popup projection //need to automate this!
	projection_census = d3.geoMercator();
	path_census = d3.geoPath()
    	.projection(projection_census);	
/*var projection_census = d3.geoMercator()
    .scale(2400)
    .center([0,0]) //projection center
    .translate([600/2+3475,625])
	
//Generate paths based on projection
var path_census = d3.geoPath()
    .projection(projection_census);*/
	
//sm projection	
projection_sm = d3.geoMercator()
    .scale(2700)
    .center([0,0]) //projection center
    .translate([width/2+4000,700])

path_sm = d3.geoPath()
	.projection(projection_sm);				
	
//Map projection
	projection = d3.geoMercator();
    //.scale(450)
    //.center([0,0]) //projection center
    //.translate([width/2+600,height/2+100]);
	//.translate([width/2,height/2]) //translate to center the map in view	

//Generate paths based on projection
path = d3.geoPath()
    .projection(projection);
	
clinicSymbol = d3.symbol().size(10).type(d3.symbolCross);	
/******end topo setup******/
}	
	
var show_awards;
var s_a = true;			
//enable zoom
var zoom = d3.zoom()
    .scaleExtent([0.3, Infinity])
    .on("zoom",zoomed);
	
//enable zoom
var gl_zoom = d3.zoom()
    .scaleExtent([0.3, Infinity])
    .on("zoom",gl_zoomed);		
				
	//var lat_longs - just enter manually SVL:14, 89; 
//	var footnote_data;	
//	var global_data;
//enable zoom
var popmap_zoom = d3.zoom()
    .scaleExtent([0.3, Infinity])
    .on("zoom",popmap_zoomed);	
	
	
	var publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/18xaJk0uObdu5WNgd2yMSxzgyS3Oz2oJ5qBMEkR0z1QI/pubhtml';
	var publicSpreadsheetUrl2 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0s8uAHDAqWdg1Kb3iK4rFbFuXOW2IjVtD3WV_RLSb5PDfvc0f2UA8YIbbn3ZYq3ve8AooO-nuIwjY/pubhtml';
	
	
	function init() {
		console.log("initing");
		retrieveFootnotes();
		
	    /*Tabletop.init( { key: publicSpreadsheetUrl,
	                     callback: initMarkers,
	                     simpleSheet: true })*/	
	  }
	  
	  function initMarkers(data,tabletop){
		  addMarkers(data);
		  //console.log(data);
	  }
	  
	  /*function initComments(data,tabletop){
		  console.log(data);
	  }*/
		  
	function addMarkers(data) {
			console.log("DATA");
			global_data = data;//discrepancy_data_filtered;//data;
			//console.log(data);
			
			/*nested_annotation_data = d3.nest()
			.key(function(d){return d.subregion;})
			.key(function(d){return d.country;})
			.key(function(d){return d.zoomL;})
			.entries(data);*/
			
			nad = d3.nest()
			.key(function(d){return d.zoomLevel;})
			.entries(data);
			
			
			//console.log(nad);
		
			greenIcon = new L.Icon({
			  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  //iconSize: [25, 41],
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});	
			
			redIcon = new L.Icon({
			  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  //iconSize: [25, 41],
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});	
			
			blueIcon = new L.Icon({
			  iconUrl: 'images/marker-icon-2x-blue.png',
			  //shadowUrl: './images/marker-shadow.png',
			  //iconSize: [25, 41],
  			  //iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
  			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});
			
			violetIcon = new L.Icon({
			  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  //iconSize: [25, 41],
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});	
			
			orangeIcon = new L.Icon({
			  iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  //iconSize: [25, 41],
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});	
			greyIcon = new L.Icon({
			  iconUrl: 'images/marker-icon-2x-grey.png',
			  //shadowUrl: './images/marker-shadow.png',
			  //iconSize: [25, 41],
  			  //iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
  			  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
			  iconSize: [20, 32],
			  iconAnchor: [12, 32],
			  popupAnchor: [1, -27],
			  shadowSize: [32, 32]
			});	
			
		
			global_footnotes = new L.LayerGroup();//L.FeatureGroup();
			for(i=0;i<global_data.length;i++){
				//console.log(global_data[i]);
				var popupContent="<strong>Region: </strong>"+global_data[i].region+"<br>"+
				"<strong>Description: </strong>"+global_data[i].description+"<br>"+
				"<strong>Affected indicators: </strong>"+global_data[i].indicators+"<br>"+
				"<strong>Error type: </strong>"+global_data[i].stype+"<br>"+
				"<strong>Discrepancy type: </strong>"+global_data[i].discrepancy_type+"<br>"+
				"<strong>Where in the pipeline: </strong>"+global_data[i].pipeline+"<br>"+
				"<strong>Which epi report(s) does this error impact? </strong>all reports<br>"+
				"<strong>How should the values be adjusted: </strong> value(s) should be <strong>"+global_data[i].true_value+"</strong><br>"+
				"<strong>Level of confidence in the error </strong>just a hunch<br>";
				
				
			  	if(global_data[i].lat != "" && global_data[i].lng != "" && global_data[i].description != ""){
					_marker = L.marker([+global_data[i].lat,+global_data[i].lng],{icon:blueIcon}).bindPopup(popupContent);
				//console.log(_marker);
				global_footnotes.addLayer(_marker);
				}
			}
			//global_footnotes.addTo(global_map);
			
			
			marker_layers = [];
			for(i=0;i<nad.length;i++){
				marker_layers.push(new L.LayerGroup());
				for(j=0;j<nad[i].values.length;j++){
					var popupContent="<strong>Region: </strong>"+nad[i].values[j].region+"<br>"+
					"<strong>Description: </strong>"+nad[i].values[j].description+"<br>"+
					"<strong>Affected indicators: </strong>"+nad[i].values[j].indicators+"<br>"+
					"<strong>Error type: </strong>"+nad[i].values[j].stype+"<br>"+
					"<strong>Discrepancy type: </strong>"+nad[i].values[j].discrepancy_type+"<br>"+
					"<strong>where in the pipeline: </strong>"+nad[i].values[j].pipeline+"<br>"+
					"<strong>Which epi report(s) does this error impact? </strong>all reports<br>"+
					"<strong>How should the values be adjusted: </strong> value(s) should be <strong>"+nad[i].values[j].true_value+"</strong><br>"+
					"<strong>Level of confidence around this error: </strong>"+nad[i].values[j].certainty+"</strong><br>";
					if(nad[i].values[j].lat != "" && nad[i].values[j].lng != ""){
						_marker = L.marker([+nad[i].values[j].lat,+nad[i].values[j].lng],{icon:blueIcon}).bindPopup(popupContent);
						marker_layers[i].addLayer(_marker);
					}	
				}
				//marker_layers[i].addTo(global_map);
			}
			if(cview){
				marker_layers[3].addTo(global_map);
			}
			if(gview){
				marker_layers[0].addTo(global_map);
			}
			if(rview){
				marker_layers[1].addTo(global_map);
			}
			
			/*global_footnotes = L.MarkerClusterGroup();//L.FeatureGroup();
						for(i=0;i<global_data.length;i++){
							//console.log(global_data[i]);
						  	if(global_data[i].lat != "" && global_data[i].lng != "" && global_data[i].description != ""){
								_marker = L.marker([+global_data[i].lat,+global_data[i].lng],{icon:blueIcon}).bindPopup(global_data[i].description);
							//console.log(_marker);
							global_footnotes.addLayer(_marker);
							}
						}
						global_map.addLayer(global_footnotes);*/
			
			
			
			
			
			/*global_footnotes = L.markerClusterGroup();
			for(i=0;i<global_data.length;i++){
			  	if(global_data[i].lat != "" && global_data[i].lng != "" && global_data[i].description != ""){
					_marker = L.marker([+global_data[i].lat,+global_data[i].lng],{icon:blueIcon}).bindPopup(global_data[i].description);
				global_footnotes.addLayer(_marker);
				}
			}
			global_map.addLayer(global_footnotes);*/
			
			
			var formatDate = d3.timeFormat("%m/%e/%y");
			//add PAHO footnotes
  		  var choropleth_date_formatted = formatDate(choropleth_date);
		  //console.log(choropleth_date_formatted);
		  //console.log(choropleth_date);
		  //console.log(globalbyDatebyCountry);
		  
		  /*globalbyDatebyCountry.forEach(function(e,i){
		  	//create featuregroup for each date
			  i = new L.FeatureGroup();
			  console.log(e);
			  e.values.forEach(function(f){
				  var dd = ADM1_lookup.filter(function(f){return f.key==f.key;})[0];
  					if(dd!=undefined && f.values[0].footnotes.length>0){
  					_marker = L.marker([+dd.lat2,+dd.lng2],{icon:greyIcon}).bindPopup("<strong>"+f.key+"</strong>"+"<br>"+f.values[0].footnotes[0][0].note);
  					i.addLayer(_marker);
  				}
			  });
			  
			  PAHO_global_footnotes_objs.push({date:e.key, featureGroup:i});
		  });
		  //console.log(PAHO_global_footnotes_objs);
		  
		  PAHO_global_footnotes_objs[PAHO_global_footnotes_objs.length-1].featureGroup.addTo(global_map);*/
		  
		  
			//no clusters!!!
			PAHO_global_footnotes = new L.FeatureGroup();
			var current = globalbyDatebyCountry.filter(function(e){return e.key==choropleth_date;})[0].values.filter(function(e){return e.values[0].footnotes.length > 0;});
			//console.log(current);
			
			//FIX
			current.forEach(function(e){
				var dd = ADM1_lookup.filter(function(f){return f.key==e.key;})[0];
				if(dd!=undefined){
					_marker = L.marker([+dd.lat2,+dd.lng2],{icon:greyIcon}).bindPopup("<strong>"+e.key+"</strong>"+": "+e.values[0].date+"<br>"+e.values[0].footnotes[0][0].note);
					PAHO_global_footnotes.addLayer(_marker);
					discrepancy_histogram[0].values.filter(function(f){return f.name == "adjustment";})[0].count++;
				}
			});
			PAHO_global_footnotes.addTo(global_map);
			
			
			//custers!!!
			/*var current = globalbyDatebyCountry.filter(function(e){return e.key==choropleth_date;})[0].values.filter(function(e){return e.values[0].footnotes.length > 0;});
			//FIX
			PAHO_global_footnotes = L.markerClusterGroup();
			current.forEach(function(e){
				var dd = ADM1_lookup.filter(function(f){return f.key==e.key;})[0];
				if(dd!=undefined){
					_marker = L.marker([+dd.lat2,+dd.lng2],{icon:greyIcon}).bindPopup("<strong>"+e.key+"</strong>"+": "+e.values[0].date+"<br>"+e.values[0].footnotes[0][0].note);
					PAHO_global_footnotes.addLayer(_marker);
					discrepancy_histogram[0].values.filter(function(f){return f.name == "adjustment";})[0].count++;
				}
			});
			global_map.addLayer(PAHO_global_footnotes);*/
			
			
				
		}	  
		
		
		
		function updateMarkers(data) {
				console.log("DATA");
				global_data = data;//discrepancy_data_filtered;//data;
				//console.log(data);
			
				nad = d3.nest()
				.key(function(d){return d.zoomLevel;})
				.entries(data);
			
				//console.log(nested_annotation_data);
		
				//global_footnotes = new L.LayerGroup();//L.FeatureGroup();
				/*global_footnotes.clearLayers();
				
				for(i=0;i<global_data.length;i++){
					//console.log(global_data[i]);
					var popupContent="<strong>Region: </strong>"+global_data[i].region+"<br>"+
					"<strong>Description: </strong>"+global_data[i].description+"<br>"+
					"<strong>Error type: </strong>"+global_data[i].stype+"<br>"+
					"<strong>Discrepancy type: </strong>"+global_data[i].discrepancy_type+"<br>"+
					"<strong>Affected indicators: </strong>"+global_data[i].indicators+"<br>"+
					"<strong>where in the pipeline: </strong>"+global_data[i].pipeline+"<br>"+
					"<strong>How should the values be adjusted: </strong> value(s) should be <strong>"+global_data[i].true_value+"</strong><br>";
				
				
				  	if(global_data[i].lat != "" && global_data[i].lng != "" && global_data[i].description != ""){
						_marker = L.marker([+global_data[i].lat,+global_data[i].lng],{icon:blueIcon}).bindPopup(popupContent);
					//console.log(_marker);
					global_footnotes.addLayer(_marker);
					}
				}
				global_footnotes.addTo(global_map);*/
				marker_layers = [];
				for(i=0;i<nad.length;i++){
					marker_layers.push(new L.LayerGroup());
					for(j=0;j<nad[i].values.length;j++){
						var popupContent="<strong>Region: </strong>"+nad[i].values[j].region+"<br>"+
						"<strong>Description: </strong>"+nad[i].values[j].description+"<br>"+
						"<strong>Error type: </strong>"+nad[i].values[j].stype+"<br>"+
						"<strong>Discrepancy type: </strong>"+nad[i].values[j].discrepancy_type+"<br>"+
						"<strong>Affected indicators: </strong>"+nad[i].values[j].indicators+"<br>"+
						"<strong>where in the pipeline: </strong>"+nad[i].values[j].pipeline+"<br>"+
						"<strong>How should the values be adjusted: </strong> value(s) should be <strong>"+nad[i].values[j].true_value+"</strong><br>"+
						"<strong>Level of certainty around this error: </strong>"+nad[i].values[j].certainty+"</strong><br>";
						if(nad[i].values[j].lat != "" && nad[i].values[j].lng != ""){
							_marker = L.marker([+nad[i].values[j].lat,+nad[i].values[j].lng],{icon:blueIcon}).bindPopup(popupContent);
							marker_layers[i].addLayer(_marker);
						}	
					}
					//marker_layers[i].addTo(global_map);
				}
				if(cview){
					marker_layers[1].addTo(global_map);
				}
				if(gview){
					marker_layers[0].addTo(global_map);
				}
				if(rview){
					marker_layers[2].addTo(global_map);
				}
		

		}	
		
		  
		  

	  function addMarkers2(data) {
	    //alert('Successfully processed!')
		//console.log("adding markers");
		console.log("DATA");
		//console.log(data.filter(function(d){return d.country!="ALL";}));
		//console.log(data.filter(function(d){return d.country=="ALL";}));
		//console.log(data.length);
		footnote_data = data.filter(function(d){return d.country!="ALL";});
		global_data = data.filter(function(d){return d.country=="ALL";});
		
		
		//L.Icon.Default.prototype.options.iconSize = "[20,20]";
		
		//add country-level footnotes
		footnotes = new L.FeatureGroup();
		for(i=0;i<footnote_data.length;i++){
			//console.log(footnote_data[i]);
		  	if(footnote_data[i].lat != "" && footnote_data[i].lng != "" && footnote_data[i].comment != ""){
			_marker = L.marker([+footnote_data[i].lat,+footnote_data[i].lng]/*,{icon:L.icon({iconSize:[20,20]})}*/).bindPopup(footnote_data[i].comment);
			//console.log(_marker);
			footnotes.addLayer(_marker);
			}
		}
		//console.log("break");
		//console.log(country_map);
		if(country_map != undefined){
		footnotes.addTo(country_map);
		}
		//add global footnotes
		
		global_footnotes = new L.FeatureGroup();
		for(i=0;i<global_data.length;i++){
			//console.log(footnote_data[i]);
		  	if(global_data[i].lat != "" && global_data[i].lng != "" && global_data[i].comment != ""){
			_marker = L.marker([+global_data[i].lat,+global_data[i].lng]).bindPopup(global_data[i].comment);
			//console.log(_marker);
			global_footnotes.addLayer(_marker);
			}
		}
		global_footnotes.addTo(global_map);
	  }
	 
	  function hideGlobalFootnotes(){
		if(commentsState)hideGlobal();
	  }
	  
	  function showGlobalFootnotes(){
	  	if(commentsState)showGlobal();
	  } 
	  
	  
	  function hideFootnotes(){
		  //hideCountry();
		  hideGlobal();
	  }
	  
	  function showFootnotes(){
		  //showCountry();
		  showGlobal();
	  }
	  
	  function showGlobal(){
  		//global_footnotes.addTo(global_map);
		if(cview){marker_layers[1].addTo(global_map);}
		if(gview){marker_layers[0].addTo(global_map);PAHO_global_footnotes.addTo(global_map);}
		if(rview){marker_layers[2].addTo(global_map);}	
		
		
		//PAHO_global_footnotes.addTo(global_map);
  		global_featureGroup.addTo(global_map);
  		global_drawControl.addTo(global_map);
	  }
	  
	  function showCountry(){
  	  	footnotes.addTo(country_map);
  		country_featureGroup.addTo(country_map);
  		country_drawControl.addTo(country_map);
	  }
	  
	  function hideGlobal(){
		//PAHO_global_footnotes.removeFrom(global_map);
		if(cview){marker_layers[1].removeFrom(global_map);}
		if(gview){marker_layers[0].removeFrom(global_map);}
		if(rview){marker_layers[2].removeFrom(global_map);}
		
		PAHO_global_footnotes.removeFrom(global_map);
  		global_featureGroup.removeFrom(global_map);
  		global_drawControl.remove();
	  }
	  
	  function hideCountry(){	
  		footnotes.removeFrom(country_map);
  		country_featureGroup.removeFrom(country_map);
  		country_drawControl.remove();
	  }
	  
	  //window.addEventListener('DOMContentLoaded', init);
	
	/*var url = "https://docs.google.com/spreadsheet/pub?key=0ApMOA8U0y53_dGJpUzdMTGYyLWVGckZMOWRGNXB1Vnc&output=csv";
	d3.csv(url, function(data, error) {
			console.log(data);
		});*/	
//load data
	function convert_PAHO(d){
		d.autochthonous_cases_suspected = +d.autochthonous_cases_suspected;
		d.autochthonous_cases_confirmed = +d.autochthonous_cases_confirmed;
		d.incidence_rate = + d.incidence_rate;
		d.death_among_zika_cases = +d.death_among_zika_cases;
		d.confirmed_congenital_syndrome = +d.confirmed_congenital_syndrome;
		d.pop_x_1000 = +d.pop_x_1000;
		return d; 
	}
	
	function convert_MOH(d){
		if(d.value == "NA"){
			d.value = null;
		}
		d.value = +d.value;
		return d; 
	}
	
	function census(d){
		d.population = +d.population;
		return d; 
	}
	
	
	//https://docs.google.com/spreadsheets/d/1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA/export?format=csv&id=1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA&gid=0
	
	
queue()
	.defer(d3.json, "data_info.json")
	.defer(d3.json, "admin_0_countries_filtered.json")
	.defer(d3.json, "admin_1_states_provinces_filtered.json")
    //.defer(d3.json, "el_salvador_epi.json")
	.defer(d3.csv, "https://docs.google.com/spreadsheets/d/1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc/export?format=csv&id=1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc&gid=102970676")
	//.defer(d3.json, "countryData.json")
	.defer(d3.json, "populated_places_filtered.json")
	.defer(d3.json, "poverty4.json")
	.defer(d3.json, "usaidawards.json")
	.defer(d3.json,"IPPFClinics.json")
	//.defer(d3.json, "globalData10_14.json")
	.defer(d3.csv,"https://docs.google.com/spreadsheets/d/1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA/export?format=csv&id=1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA&gid=0")
	//.defer(d3.csv,"https://docs.google.com/spreadsheets/d/1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc/export?format=csv&id=1")
	.defer(d3.csv,"https://docs.google.com/spreadsheets/d/1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc/export?format=csv&id=1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc&gid=1338770452")
	//.defer(d3.json, "Partners10_17.json")
	.defer(d3.json, "PAHO_subnational_cleaned2.json")
	.defer(d3.json, "award_info_assist.json")
	.defer(d3.json, "adm2_shapes.json")
	.defer(d3.csv,"https://docs.google.com/spreadsheets/d/1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc/export?format=csv&id=1I1jlaXgUaFGCC2RO6d9bbfDcWDwxj1Dl9kmUFIlxyEc&gid=1237068263")
	//.defer(d3.json, "epidata10_17b.json")
	.defer(d3.json, "fips_2.json")
	.defer(d3.csv,"https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/export?format=csv")
	.defer(d3.json, "rainfall_national.json")
	.defer(d3.json, "award_info7.json")
	.defer(d3.json, "adm2_all.json")
	.defer(d3.csv, "https://docs.google.com/spreadsheets/d/1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA/export?format=csv&id=1AZfbEiYCuLqbNUr2rd-WdmAsS6qZ5x8LsTkg7EusxjA&gid=268608510")
	.defer(d3.json, "regions.json")
	.defer(d3.csv,"https://docs.google.com/spreadsheets/d/126Bf_7QZ-_KiUERy8ktQhH7UavD27IrpT4z8IiGuDnc/export?format=csv")
	//.defer(d3.json, "adm0.json")
	//.defer(d3.json, "adm1.json")
	//.defer(d3.json, "adm2.json")
	.defer(d3.json, "adm0_t.json")
	.defer(d3.json, "adm1_t.json")
	.defer(d3.json, "adm2_t.json")
	/*.defer(function(f){
		d3.json("rainfall_national.json").on("progress",function(p){
			console.log('progress');
			var i = d3.interpolate(progress, ProgressEvent.loaded / total);
			console.log(i);
			d3.transition().tween("progress", function() {
			          return function(t) {
			            progress = i(t);
			            foreground.attr("d", arc.endAngle(twoPi * progress));
			            text.text(formatPercent(progress));
			          };	
				  });
			  })
			  .get(function(){
			          return true;
			  });
		  })*/
	.await(ready);	
		
function ready(error, dat_info, geodata_admin0/*admin0data*/, geodata_admin1/*adm1data*/, /*epidataSVLdata,*/ censusdata, pop_pls, poverty, awards, IPPFclinics, globaldata, partners, paho_sub, award_info, adm2_shapes,epidata_all,fips,comments_data,rainfall,awards_detail,adm2_all,footnoteData, regional_adm, discrepancy_data,/*adm0g,adm1g,adm2g,*/adm0t,adm1t,adm2t){	
	  if (error) throw error;	
	   
	  
	  
	  data_info = dat_info;
	  
	  //console.log(discrepancy_data);
	  
	  //console.log(geodata_admin0);
	  //console.log(regional_adm);
	  //console.log(adm2_shapes);
	  
	  var adm0g = topojson.feature(adm0t,adm0t.objects.adm0);
	  var adm1g = topojson.feature(adm1t,adm1t.objects.adm1);
	  var adm2g = topojson.feature(adm2t,adm2t.objects.adm2);
	  
	  //console.log(adm0g);
	  //console.log("topo");
	  //console.log(AF);
	  
	  //topojson.feature(adm2_shapes,adm2_shapes.objects.COL_adm2).features
	  
	  //console.log(adm1g);
	  //console.log(fips);
	  //console.log(adm2g);
	  //console.log(geodata_admin1);
	  //console.log(paho_sub);
	  
	  //console.log(adm2_shapes);
	  //console.log(adm2_all);
	  
	  adm1g.features.forEach(function(d,i){
		  var n = fips.filter(function(e,j){return e.country_name == d.properties.NAME_0 && e.ID_1 == d.properties.ID_1 ;})[0];
		  if(n!=undefined){
		  d.properties.fips = n.fips;
		  d.properties.code_hasc = n.HASC; 
	  	  }else{
			  //console.log("hasc1");
			  //console.log(d.properties.HASC_1);
			  d.properties.fips = "";
			  d.properties.code_hasc = d.properties.HASC_1;
	  	  }
		  
	  });
	  
	  //console.log(adm1g);
	  
	  
	  var footnotesbydate = d3.nest()
	  .key(function(d){return d.date;})
	  .key(function(d){return d.fn_id;})
	  .entries(footnoteData);
	  
	  var footnotesbyNote = d3.nest()
	  .key(function(d){return d.note;})
	  .entries(footnoteData);
	  
	  //console.log(footnotesbyNote);
	  
	  globaldata.forEach(function(d,i){
		  d = convert_PAHO(d);
		  //sync footnotes
		  var fns = d.footnotes.split(",");
		  var notes = [];
		  var dd = footnotesbydate.filter(function(e,j){
			  return e.key == d.date;
		  })[0];
		  if(dd != undefined){
		  fns.forEach(function(f,k){
			  if(f!=""){
			  //console.log(f);
			  //console.log(f);
			  var dat = dd.values.filter(function(g){return g.key == f;})[0];
			  if(dat != undefined){
				  //console.log(dat.values);
			 notes.push(dat.values);
	  		}
		}
	  	});
		//console.log(notes);
		}
		d.footnotes = notes;
	  });
	  
	  
	  var paho_discrepancies = globaldata.filter(function(d){return d.footnotes.length>0;});
	  //console.log(paho_discrepancies);
	  //console.log(discrepancy_data);
	  
	  paho_discrepancies.forEach(function(d){
		 //console.log(d);
		  var dd = ADM1_lookup.filter(function(e){return e.key==d.country;})[0];  
		if(dd!=undefined){
			//console.log(dd);
			  //dd = dd[0];
			  
	  	discrepancy_data.push(
	  	{
	  		Timestamp:"",
			description:d.footnotes[0][0].note,
			discrepancy_type:"adjustment",
			lat:dd.lat2,
			lng:dd.lng2,
			pipeline:"reporting",
			region_name:dd.value,
			time_period:"",
			true_value:"",
			stype:"",
			when:"",
			which_indicators:"",
			zoom_level:"5",
			date:d.date,
			zoomLevel:2
	  	});
		}
	  });
	  
	  
	  epidata_all.forEach(function(d,i){
		  d = convert_MOH(d);
	  });
	  censusdata.forEach(function(d,i){
		  d = census(d);
	  });
	  
	  
	  
	  //console.log(epidata_all);
	  
	  //console.log(awards_detail);
	  //console.log(geodata_admin0);
	  
	 // console.log(regional_adm);
	  //console.log(globaldata);
	 
	  
	 //build award shapes and add details
	  /*awards_detail.forEach(function(d,i){
		  d.shape = 
	  });*/
	  
		  //epidata_all = epidata_all.filter(function(d){return d.fips != undefined;});
		  epidata_all = epidata_all.filter(function(d){return d.location.split("-").length < 3;});
		  
		  //console.log(epidata_all.filter(function(d){return d.}));
	  
	  
	function initComments(){
		console.log("retrieving comments");
		var new_comments_data = [];
		var t = d3.timer(function(elapsed){
			//console.log(elapsed);
			d3.csv("https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/export?format=csv", function(error,data){
			new_comments_data = data;
			});
	
			//console.log(new_comments_data.length);
			if(new_comments_data.length>0){
				comments_data = new_comments_data;
				t.stop();
			}else if(elapsed > 2000){
				console.log("ERORR: google docs timeout");
				t.stop();
			}
		},150);	
	}
	
	
	
	function initComments(){
		console.log("checking for comments");
		var new_comments_data = [];
		var t = d3.timer(function(elapsed){
			//console.log(elapsed);
			d3.csv("https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/export?format=csv", function(error,data){
			new_comments_data = data;
			});
	
			//console.log(new_comments_data.length);
			if(new_comments_data.length>0){
				comments_data = new_comments_data;
				t.stop();
			}else if(elapsed > 2000){
				console.log("ERORR: google docs timeout");
				t.stop();
			}
		},150);	
	}
		
	  
	  
	  
	  /*{key:"Haiti",value:"HTI", zoom:7.5,lat: 17.4031029048337, lng: -71.74585331724751},
{key:"El Salvador",value:"SLV", zoom:7.75,	lat: 12.49122871217691, lng: -87.85241694454625},
{key:"Dominican Republic",value:"DOM", zoom:7.5,	lat: 17.492035992023744, lng: -69.39199566063652},
{key:"Honduras",value:"HND", zoom:6.75,	lat: 11.769542307727331, lng: -84.75600730550717},
{key:"Guatemala",value:"GTM", zoom:6.75,	lat: 12.803554527856953, lng: -88.37501772750642},
{key:"Colombia",value:"COL",zoom:5.25,	lat: -2.623061546938762, lng: -67.4028203344599},
{key:"Nicaragua",value:"NIC",zoom:6.75,	lat: 9.7545238741867, lng: -83.13594487833062},
{key:"Peru",value:"PER",zoom:5,	lat: -15.496032414238622, lng: -67.36816406250001},
{key:"Ecuador",value:"ECU", zoom:5.25,	lat: -8.468573976249251, lng: -77.82369485552398},
{key:"Jamaica",value:"JAM", zoom:8.5,	lat: 17.273331276585754, lng: -76.74877190093554},
{key:"Venezuela",value:"VEN", zoom:5.25,	lat: 0.8126658260707518, lng: -61.305500135964955},
{key:"Caribbean Regional",value:""},
{key:"Paraguay",value:"PRY", zoom:5.75,	lat: -28.745445051887184, lng: -53.687390758524465},
{key:"Costa Rica",value:"CRI", zoom:7,	lat: 7.612997502224103, lng: -82.52929687500001},
{key:"Panama",value:"PAN", zoom:6.75,	lat: 6.326862626903991, lng: -78.6938382231691},
{key:"Guyana",value:"GUY", zoom:6.75, lat: 3.21553085623219, lng: -57.071230828191624},
{key:"Belize",value:"BLZ", zoom:7.75,	lat: 16.236826251708347, lng: -87.68257169008419},
{key:"Brazil",value:"BRA", zoom:4.25,	lat: -23.447596306682456, lng: -45.19379342963887}];*/
	  
	  /*var subregions_shapes = [
	  	{key:"Caribbean", value:topojson.feature(regional_adm,regional_adm.objects.ne_10m_admin_0_countries).features},
		{key:"South", value:topojson.feature(regional_adm,regional_adm.objects.ne_10m_admin_0_countries2).features},
		{key:"Central", value:topojson.feature(regional_adm,regional_adm.objects.ne_10m_admin_0_countries3).features},
	  ];*/
		  
		  //console.log(regional_adm);
		  
		  var subregions_shapes = topojson.feature(regional_adm,regional_adm.objects.ne_10m_admin_0_countries).features;
	  
	  //console.log(subregions);
	  
	  var adm2_shapes2 = [
	  {key:"COL", value:topojson.feature(adm2_shapes,adm2_shapes.objects.COL_adm2).features},
	  {key:"DOM", value:topojson.feature(adm2_shapes,adm2_shapes.objects.DOM_adm2).features},
	  {key:"ECU", value:topojson.feature(adm2_shapes,adm2_shapes.objects.ECU_adm2).features},
	  {key:"GTM", value:topojson.feature(adm2_shapes,adm2_shapes.objects.GTM_adm2).features},
	  {key:"HND", value:topojson.feature(adm2_shapes,adm2_shapes.objects.HND_adm2).features},
	  {key:"HTI", value:topojson.feature(adm2_shapes,adm2_shapes.objects.HTI_adm2).features},
	  {key:"NIC", value:topojson.feature(adm2_shapes,adm2_shapes.objects.NIC_adm2).features},
	  {key:"PER", value:topojson.feature(adm2_shapes,adm2_shapes.objects.PER_adm2).features},
	  {key:"SLV", value:topojson.feature(adm2_shapes,adm2_shapes.objects.SLV_adm2).features},
	  {key:"VEN", value:topojson.feature(adm2_shapes,adm2_shapes.objects.VEN_adm2).features},];
	  
	  
	  
	  
	  
	 var filtered_awards = [];
	 var filtered_awards_detail = [];
	  
	 //console.log(adm2_shapes2); 
	  
   	 var awards_byCountry2 = d3.nest()
   	 .key(function(d){return d.Country;})
   	 .entries(awards_detail);
	 
 	  awards_byCountry2.forEach(function(d){
		  //console.log(d);
		  var c = adm2_shapes2.filter(function(e){return e.value[0].properties.NAME_0==d.key;});
		  if(c[0]!=undefined){
		  d.values.forEach(function(e,i){
			  //console.log(e);
			  //e.shape = c[0].value.filter(function(g){return e.HASC == g.properties.HASC_2;})[0];
			  //console.log(c[0].value.filter(function(g){return e.HASC == g.properties.HASC_2;}));
			  var award = c[0].value.filter(function(g){return e.HASC == g.properties.HASC_2 && e.program_level=="adm2";})[0];
			  if(award!=undefined){  
			  filtered_awards.push(award);
			  filtered_awards_detail.push(e);
			  //filtered_awards.push(award);
		  	  }else{
				  //console.log(e);
		  	  }	
		  });
	  	}
 	  });
	  //console.log(awards_detail);
	  //console.log(filtered_awards);
	  
	  //console.log(filtered_awards);
	  //console.log(awards_byCountry2);
	  //console.log(adm2_shapes2);
	  
 	 var award_shapes = [];
 	 var award_info2 = [];
	 
 	 var award_infobyc = d3.nest()
 	 .key(function(d){return d.ADM0;})
 	 .entries(award_info); 
	 
 	 function strip(string){
 		if(string == undefined){return string;}
 	 	return string.toLowerCase().replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e"); 		
 	 };
	 
	 
 	 award_infobyc.forEach(function(e,i){
 		 //console.log(d);
 		 var shapes = adm2_shapes2.filter(function(c){return c.key == e.key;})[0].value; 
 		 e.values.forEach(function(d,j){
 			 var res = shapes.filter(function(v){return (strip(v.properties.NAME_0) == strip(d.Country)) && (strip(v.properties.NAME_1) == strip(d.Department)) && ((strip(v.properties.NAME_2) == strip(d.Municipality)) || (strip(v.properties.VARNAME_2) == strip(d.Municipality)));});
		 
 			 if(res[0] == undefined){//console.log(d);
			 }else{
 				// award_shapes.push({shape:res[0],awardInfo:d});
 				award_shapes.push(res[0]);
 				award_info2.push(d);
 			 }
 		 })
 	 });
	 
	 //footnotes
	 //console.log("footnote_data");
	 //console.log(footnote_data);
	  
	  /***************format data************/
	  var parseTime = d3.timeParse("%m/%e/%y");
	  var parseYear = d3.timeFormat("%y");
	  var parseMonth = d3.timeFormat("%B");
	  var parseMonth_n = d3.timeFormat("%-m");
	  
	  var parseTime2 = d3.utcParse("%Y-%m-%dT%H:%M:%S.%LZ");
  
	  /*epidata.forEach(function(d,i){
		  d.report_date = parseTime(d.report_date);
		  d.year = parseYear(d.report_date);
		  //console.log(parseYear(d.report_date));
	  });*/
	  
	  epidata_all.forEach(function(d,i){
		  d.report_date = parseTime(d.report_date);
		  d.year = parseYear(d.report_date);
		  d.month = parseMonth(d.report_date);
		  //console.log(parseYear(d.report_date));
	  });
	  
	  
	  //sort by report data
	  //epidata.sort(function(a,b){return a.report_date - b.report_date;});
	  
	  epidata_all.sort(function(a,b){return a.report_date - b.report_date;});
	  
	  globaldata.forEach(function(d,i){
	  		  d.date = parseTime(d.date);
	  		  d.year = parseYear(d.date);
			  d.month = parseMonth_n(d.date);
			  
			  
			  //set subregions
			  if(d.region == "Non-Latin Caribbean" || d.region == "Latin Caribbean"){
				  d.subregion = "Caribbean";
			  }else if(d.region == "Andean Area" || d.region == "Southern Cone"){
				  d.subregion = "South America";
			  }else if(d.region == "Central American Isthmus"){
			  	  d.subregion = "Central America";
			  }else{
				  d.subregion = "";
			  }
	  		  //console.log(parseYear(d.report_date));
	  	  });
		  
	globaldata.sort(function(a,b){return a.date - b.date;}); 
	
	//console.log("globaldata");
	//console.log(globaldata);
	
	//console.log(gl_countries);
	var priorityCountryData = globaldata.filter(function(v){return priority_countries.indexOf(v.country) != -1;});
	
	
	var regionalData = d3.nest()
	.key(function(d){return d.subregion;})
	.key(function(d){return d.date;})
	.rollup(function(d){return {
			autochthonous_cases_confirmed:d3.sum(d,function(e){return e.autochthonous_cases_confirmed;}),
			autochthonous_cases_suspected:d3.sum(d,function(e){return e.autochthonous_cases_suspected;}),
			confirmed_congenital_syndrome:d3.sum(d,function(e){return e.confirmed_congenital_syndrome;}),
			death_among_zika_cases:d3.sum(d,function(e){return e.death_among_zika_cases;}),
			imported_cases:d3.sum(d,function(e){return e.imported_cases;}),
			incidence_rate:d3.sum(d,function(e){return e.incidence_rate;}),
			pop_x_1000:d3.sum(d,function(e){return e.pop_x_1000;}),
			new_autochthonous_cases_confirmed:d3.sum(d,function(e){return e.new_autochthonous_cases_confirmed;}),
			new_autochthonous_cases_suspected:d3.sum(d,function(e){return e.new_autochthonous_cases_suspected;})
		}})
	.entries(priorityCountryData);
	
	/*var regionalData2 = d3.nest()
	.key(function(d){return d.subregion;})
	.key(function(d){return d.date;})
	.entries(priorityCountryData);
	
	console.log(regionalData2);*/
	
	
	var globalbyregion = [];
	var regionaldataF = [];
	regionalData.forEach(function(d){
		var t = [];
		d.values.forEach(function(e,i){
			t.push({
				date:new Date(e.key),
				region:d.key,
				autochthonous_cases_confirmed:e.value.autochthonous_cases_confirmed,
				autochthonous_cases_suspected:e.value.autochthonous_cases_suspected,
				confirmed_congenital_syndrome:e.value.confirmed_congenital_syndrome,
				death_among_zika_cases:e.value.death_among_zika_cases,
				imported_cases:e.value.imported_cases,
				incidence_rate:e.value.incidence_rate,
				pop_x_1000:e.value.pop_x_1000,
				new_autochthonous_cases_confirmed:e.value.new_autochthonous_cases_confirmed,
				new_autochthonous_cases_suspected:e.value.new_autochthonous_cases_suspected	
			});
			regionaldataF.push(t[i]);
		});
		globalbyregion.push({
			key:d.key,
			values:t
		});
	});
	
	
	var last = 0;
	var last_suspected = 0;
  globalbyregion.forEach(function(d){
	  d.values.forEach(function(e,i){
		  if(i==0){
			  last = 0;
			  last_suspected = 0;
			  e.new_autochthonous_cases_confirmed = 0;//e.autochthonous_cases_confirmed - last;
			  e.new_autochthonous_cases_suspected = 0;
		  }else if(i > 0){
		    e.new_autochthonous_cases_confirmed = e.autochthonous_cases_confirmed - last;
			e.new_autochthonous_cases_suspected = e.autochthonous_cases_suspected - last_suspected;	
		  }
		 last = e.autochthonous_cases_confirmed;
		 last_suspected = e.autochthonous_cases_suspected;
		})
  })
	
	globalbyregion.sort(function(a, b){return a.date - b.date; });
	
	//console.log(globalbyregion);
	
	choropleth_date = priorityCountryData[priorityCountryData.length-1].date;
	
	
  var formatDate = d3.timeFormat("%m/%e/%y");
  var parseTime = d3.timeParse("%m/%e/%y");
  
  
  var discrepancy_data_filtered = discrepancy_data.filter(function(e){return e.date=="" || formatDate(parseTime(e.date))==formatDate(choropleth_date); });
  
  //console.log(discrepancy_data_filtered);
	
	//console.log(globaldata.filter(function(d){return d.country == "El Salvador";}));  
	  //var globaldataF = globaldata.filter(function(d){return priority_countries.indexOf(d.country) != -1;}).sort(function(a, b){ return d3.descending(a.country, b.country);});
	  //console.log(epidata);
	  
	  //console.log(fips.filter(function(d){return strip(d.subnational_name) == strip("Usulutan");}));
	  
	  //console.log(fips);
	  
	 epidata_all.forEach(function(d,i){
		  var s = d.location.split("-");
		  d.country = s[0].replace(/_/g," ");
		  //d.amd1_name = if(s[1]!=undefined) ? s[1].replace("_"," ") : s[0].replace("_"," ");
		  if(s[1]!=undefined){
			  d.amd1_name = s[1].replace(/_/g," ");
		  }else{
		  	 d.amd1_name = s[0].replace(/_/g," ");
		  }
		  
		  //if(d.country=="Dominican Republic"){
		  //console.log("--");
		  //console.log(strip(d.country));
		  //console.log(strip(d.amd1_name));
		  //}
		  //console.log(fips.filter(function(v){return strip(v.subnational_name) == strip(d.amd1_name);}));
		  
		  var c = fips.filter(function(v){return strip(v.country_name) == strip(d.country) && strip(v.subnational_name) == strip(d.amd1_name);})[0];
			   
			   //if(d.country=="Dominican Republic"){
				   //console.log(c);   
				   //}
			  
			  if(c!=undefined){
				  d.fips = c.fips;
				  d.pop = c.population;
				  if(c.population != undefined){
				  d.p_ht = d.value/(c.population/100000);
			  	  }else{
					 d.p_ht = null;
			  	  }
			  }else{
				  d.fips = null;
				  d.p_ht=null;
				  //loads not showing up
				  //console.log(strip(d.country)+" "+strip(d.amd1_name));
			  }
			 
	  });
	  
	  epidata_all = epidata_all.filter(function(d){return d.fips != null;});
	  
	  
	  var epibycountrybyfips = d3.nest()
	  .key(function(d){return d.country;})
	  .key(function(d){return d.fips;})
	  .entries(epidata_all);
	  
	  
	  //console.log(epibycountrybyfips);
	  
	  //var epi_bycountry = d3.nest()
	  //.key()
	  
	  
	  var pahobycountry = d3.nest()
	  .key(function(d){return d.CNTRY_CODE;})
	  .key(function(d){return d.ADM1_CODE;})
	  .entries(paho_sub);
	  
	  
	  var partnersbyLine = d3.nest()
	  .key(function(d){return d.line_of_effort;})
	  .key(function(d){return d.country;})
	  .entries(partners);
	  
	  var partnersbyLinebyPartner = d3.nest()
	  .key(function(d){return d.line_of_effort;})
	  .key(function(d){return d.partner;})
	  .key(function(d){return d.country;})
	  .entries(partners);
	  
	  var partnersbyCountrybyLinebyPartner = d3.nest()
	  .key(function(d){return d.country;})
	  .key(function(d){return d.line_of_effort;})
	  .key(function(d){return d.partner;})
	  .key(function(d){return d.country;})
	  .entries(partners);
	  
	  var partnersbyCountrybyLinebyPartner_country = d3.nest()
	  .key(function(d){return d.Country;})
	  .key(function(d){return d.line_of_effort;})
	  .key(function(d){return d.program;})
	  .key(function(d){return d.Country;})
	  .entries(filtered_awards_detail);
	  
	  //console.log(partnersbyCountrybyLinebyPartner_country);
	  
	  //console.log(partnersbyCountrybyLinebyPartner);
	  
	  //console.log(partnersbyLinebyPartner2);
	  
	  //console.log(rainfall);
	  var rainfall = rainfall;
	  
	   //console.log(partnersbyLine);
	  
	  var globaldataF = globaldata.filter(function(d){return priority_countries.indexOf(d.country) != -1;});//.sort(function(a, b){ return d3.ascending(a.autochthonous_cases_confirmed, b.autochthonous_cases_confirmed);});
	  
	  //console.log(globaldataF);
	  
	  //console.log(regionaldataF);
	  
	  var globaldataFS = globaldata.filter(function(d){return priority_countries.indexOf(d.country) != -1;}).sort(function(a, b){ return d3.ascending(a.autochthonous_cases_confirmed, b.autochthonous_cases_confirmed);});
	  
	  
	  
	  globalbycountry = d3.nest()
	  .key(function(d){return d.country;})
	  .entries(globaldataF)
	  .sort(function(a, b){return a.date - b.date; });
	  
	  
	  
	  
	  //console.log(globalbycountry);
	  
	  globalbyDatebyCountry = d3.nest()
	  .key(function(d){return d.date;})
	  .key(function(d){return d.country;})
	  .entries(globaldataF);
	  //.sort(function(a, b){return a.date - b.date; });
	  
	  //console.log(globalbyDatebyCountry);
	  //console.log(globalbycountry);
	  
	  var globalbycountryS = d3.nest()
	  .key(function(d){return d.country;})
	  .entries(globaldataFS);
	  
	  //add new cases
	  var last = 0;
	  var last_suspected = 0;
	  globalbycountry.forEach(function(d){
		  d.values.forEach(function(e,i){
			  if(i==0){
				  last = 0;
				  last_suspected = 0;
				  e.new_autochthonous_cases_confirmed = 0;//e.autochthonous_cases_confirmed - last;
				  e.new_autochthonous_cases_suspected = 0;
			  }else if(i > 0){
			    e.new_autochthonous_cases_confirmed = e.autochthonous_cases_confirmed - last;
				e.new_autochthonous_cases_suspected = e.autochthonous_cases_suspected - last_suspected;	
			  }
			 last = e.autochthonous_cases_confirmed;
			 last_suspected = e.autochthonous_cases_suspected;
	  	})
	  })
	  
	  //console.log(globalbycountry);
	  
	  //console.log(globalbycountry);
	  
	  //this will vary!!
	  global_indicators = ["autochthonous_cases_confirmed","autochthonous_cases_suspected","confirmed_congenital_syndrome","death_among_zika_cases","imported_cases","incidence_rate"];
	  
	  global_indicators_template = ["all","cumulative_confirmed_cases","autochthonous_cases_confirmed","autochthonous_cases_suspected","confirmed_congenital_syndrome","death_among_zika_cases","imported_cases","incidence_rate"];
	  
	  var awards_topo = topojson.feature(awards,awards.objects.usaidawards).features;
	  
	  //var places_topo = topojson.features(places, places.objects.ne_10m_populated_places).features;
	  
	  //console.log(awards_topo);
	  
	  //console.log(globalbycountry);
	  
	  //awards by partners
	  
	  
	  var awardsbyPartner = d3.nest()
	  .key(function(d){return d.properties.Partner;})
	  .entries(awards_topo);
	  
	  var awardsAssistbyCountry = d3.nest()
	  .key(function(d){return d.properties.ASSIST;})
	  .key(function(d){return d.properties.Country;})
	  .entries(awards_topo);
	  
	  var awardsbyISO = d3.nest()
	  .key(function(d){return d.properties.ISO;})
	  .entries(awards_topo);
	  
	  var awardsbyCountry = d3.nest()
	  .key(function(d){return d.properties.Country;})
	  .entries(awards_topo);
	  
	  var awardsbyCountrybyPartner = d3.nest()
	  .key(function(d){return d.properties.Country;})
	  .key(function(d){return d.properties.Partner;})
	  .entries(awards_topo);
	  
	  var awardsbyCountryAssist = d3.nest()
	  .key(function(d){return d.properties.NAME_0;})
	  .key(function(d){return d.properties.ASSIST;})
	  .entries(awards_topo);
	  
	  //console.log(awardsbyPartner);
	  //console.log(awardsbyCountryAssist);
	  //console.log(awardsbyCountrybyPartner);
	  //console.log(awards_topo);
	  
	  //nest data upfront
	  var byRegion = d3.nest()
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata_all);
	  
	  //console.log(byRegion);
	  
	  /*var byRegion_svl = d3.nest()
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata);*/
	  
	  //console.log(byRegion);
	  
	  var byCountrybyIndbyRegion = d3.nest()
	  .key(function(d){return d.country;})
	  .key(function(d){return d.data_field;})
	  .key(function(d){return d.fips;})
	  .entries(epidata_all.filter(function(v){return v.location_type != "country";}));//v.fips.indexOf("00") == -1;}));
  
	
	  /*var totalbyRegionbyYear = d3.nest()
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .key(function(d){return d.year;})
	  .rollup(function(d){return d3.max(d,function(v){return v.value;})})
	  .entries(epidata);
	  
	  var byDatebyRegion = d3.nest()
	  .key(function(d){return d.report_date;})
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata);*/
	  
	  var byCountrybyDatebyRegion = d3.nest()
	  .key(function(d){return d.country;})
	  .key(function(d){return d.report_date;})
	  .key(function(d){return d.fips;})
	  .key(function(d){return d.data_field;})
	  .entries(epidata_all);
	  
	  
	  var byCountrybyIndbyDate = d3.nest()
	  .key(function(d){return d.country;})
	  .key(function(d){return d.data_field;})
	  .key(function(d){return d.report_date;})
	  .entries(epidata_all.filter(function(v){return v.location_type != "country";}));

	  
	  
	  var povertyByCountryByRegion2 = d3.nest()
	  .key(function(d){
	  	var code = d.Country_Code.split("_");
		return code[0];
	  })
	  .key(function(d){
		  var code = d.Country_Code.split("_");
		  return code[code.length-1];})
		  .rollup(function(d){
			  //var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var year;
			  var latest_stat;
			  stats.forEach(function(l,i){
				  if(l!=undefined){
					  year = 1996+i;
					  latest_stat = l;
				  }
			  })
			  return {
				  all: d,
				  stats:stats,
				  latest: latest_stat,
				  latest_stat_year: year
			  }
		  })	  
		  .entries(poverty)
		  .sort(function(a, b){ return d3.descending(a.values[0].value.latest, b.values[0].value.latest); });
		  
	  
	  
	  
	  
	  
	  var povertyByCountryByRegion = d3.nest()
	  .key(function(d){
	  	var code = d.Country_Code.split("_");
		//if(code[0] == "HND"){console.log(code[0]);}
		return code[0];
	  })
	  .key(function(d){
		  var code = d.Country_Code.split("_");
		  var n = d.Country_Code.indexOf(".");
		  if(n == -1){
		  	return code[code.length-1];
		  }else{
		  return  d.Country_Code.substring(n-2,n+3); }
	  	  })
		  .rollup(function(d){
			  var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var year;
			  var latest_stat;
			  stats.forEach(function(l,i){
				  if(l!=undefined){
					  year = 1996+i;
					  latest_stat = l;
				  }
			  })
			  return {
				  all: d,
				  stats:stats,
				  latest: latest_stat,
				  latest_stat_year: year
			  }
		  })	  
		  .entries(poverty)
		  .sort(function(a, b){ return d3.descending(a.values[0].value.latest, b.values[0].value.latest); });
		  
		  //console.log(poverty.filter(function(v){return v.Country_Name.indexOf("Venezuela") != -1;}));
		  
		  //console.log(povertyByCountryByRegion);
	  
	  
	  //nest poverty data
	  var povertyByFips = d3.nest()
	  .key(function(d){
		  var code = d.Country_Code.split("_");
		  var n = d.Country_Code.indexOf(".");
		  if(n == -1){
		  	return code[code.length-1];
		  }else{
		  return  d.Country_Code.substring(n-2,n+3); }
	  	  })
		  .key(function(d){return d.Indicator_Name;})  
		  .rollup(function(d){
			  var stats = [d[0]._1996,d[0]._1997,d[0]._1998,d[0]._1999,d[0]._2000,d[0]._2001,d[0]._2002,d[0]._2003,d[0]._2004,d[0]._2005,d[0]._2006, d[0]._2007, d[0]._2008, d[0]._2009,d[0]._2010,d[0]._2011,d[0]._2012,d[0]._2013];
			  var year;
			  var latest_stat;
			  stats.forEach(function(l,i){
				  if(l!=undefined){
					  year = 1996+i;
					  latest_stat = l;
				  }
			  })
			  return {
				  all: d,
				  stats:stats,
				  latest: latest_stat,
				  latest_stat_year: year
			  }
		  })	  
		  .entries(poverty)
		  .sort(function(a, b){ return d3.descending(a.values[0].value.latest, b.values[0].value.latest); });
	  
	  
		  //console.log(povertyByFips);
		  //console.log(byRegion);
		  
	  //change this later - back to original data
		  //need to add actual cumulative
		  byRegion.forEach(function(d){
		  	d.values.forEach(function(e){
		  	  e.values.forEach(function(f,i){
				  if(i == 0){
					  f.new_cases = 0;
					  f.cum_cases = f.value;
					  tot_prev_years = 0;
				  }else if(i > 0){
					  if(f.year == prev_yr){//if in same year
				  
						  /*if(f.value+tot_last_year < cum_cases){
							  console.log(f.report_date)
							  console.log(f.value + " " +tot_last_year+" "+cum_cases);}*/
				  		  f.new_cases = (f.value != null) ? f.value-cum_cases_orig : 0;
						  //f.new_cases = (f.value != null) ? f.value+tot_prev_years-cum_cases : 0; //calc number of new cases
					  	  f.cum_cases = (f.value != "NA") ? f.value + tot_prev_years : tot_prev_years;
					  }else{//else across years
						  tot_prev_years = cum_cases;			  
					  	  f.new_cases = (f.value != null) ? f.value : 0;
						  f.cum_cases = (f.value != "NA") ? f.value + tot_prev_years : tot_prev_years;
					  }
				  }
				  //num = f.value;
				  prev_yr = f.year;
				  cum_cases = f.cum_cases; 
				  cum_cases_orig = f.value;
		  	  })
			  	e.max_cum_cases = d3.max(e.values, function(f){return f.cum_cases;});
				e.max_cum_cases_orig = d3.max(e.values, function(f){return f.value;});
				//hopefully not too expensive
				e.values.forEach(function(f,i){
					f.max_cum_cases = e.max_cum_cases;
					f.max_cum_cases_orig = e.max_cum_cases_orig;
				});
			   	//console.log(max_cum_cases);
			   	//d3.max(d,function(f){return f.cum_cases;
		  	});
		  });
		  
		  //console.log(byRegion);
		  
		  var totalByRegion = d3.nest()
		  .key(function(d){return d.fips;})
		  .rollup(function(v){
			  var t = byRegion.filter(function(e){return e.key == v[0].fips;});
			  var _pop = censusdata.filter(function(j){return j.fips == v[0].fips});
			  var pop = (_pop[0]!=undefined) ? _pop[0].population/100000 : 1;
			  //console.log(pop);
			  var max = 0;
			  var m = 0;
			  t.forEach(function(f,i){
				  //console.log(f.values);
				  f.values.forEach(function(g){
					  //console.log(g.values);
					  m = d3.max(g.values,function(h){return h.new_cases;});
					  max = (max > m) ? max : m;
				  })
			  })
	  
			  return {
				  //this is actually inaccurate because numbers reset each year
			    max_val: d3.max(v,function(f){return f.value;}),
				max_cumulative_orig: d3.max(v,function(f){return f.value;}),
				//max_cumulative: d3.max(v,function(f){return f.cum_cases;}),
				max_new: max,
				//cum_ht: d3.max(v,function(f){return f.cum_cases;})/pop,
				cum_ht_orig: d3.max(v,function(f){return f.value;})/pop,
				new_ht: max/pop,
				  _pop: pop    
			  };
		  })
		  .entries(epidata_all);	  
	  
	  
	  
	  
	  /***********end format data************/ 
	  
	  
	  //country variable
	  var ADM0 = "SLV";//"DOM";//"COL";//"HTI";//"COL";//"SLV";
	  var FIPS0 = "ES00";
	  var country_adm1_features; //prev el_salvador
	  var country_adm2_features;
	  var country_centroid;
	  var country_pop;
	  var country_places;
	  var country_pov;
	  var country_awards;
	  var country_awards_detail;
	  var country_awards_shapes;
	  var country_povbyfips;
	  var country_povbyfips2;
	  var country_byDatebyRegion;
	  //global variables
	  //var regions;
	  var sm_maps;	
	  var clinics;
	  var country_indicators;
	  var all_inds;
	  var all_inds_key;
	  var NAdiv; //for not available
	  var valueLine3;
	  var domains;
	  var mx_c = d3.max(epidata_all, function(v) { return v.value; });
	  var selection = false;
	  var country_title = "El Salvador";
	  var paho_sub;
	  var c_scale;
	  var prev_menu;
	  var bc_dx;
	  var bc_dy;
	  var sm_indicator;
	  
	  //var global_indicators_1;
	  //var global_indicators_2;
	  
	 var max_pop;
	 var min_pop;
	 var pop_range;
	 
	 //for zooming
	 var dx;
	 var dy;
	 
	 var mx_c_ht;
	 var mn_c_ht;
	 var choropleth4_ht;
	 var global_choropleth;
	 var global_choropleth_ht;
	 var country_choropleth;
	 var country_choropleth_ht;
	 var regional_choropleth;
	 var regional_choropleth_ht;
	  
	  
	//global extrema  
 	var mx = d3.max(globaldata,function(f){return f.autochthonous_cases_confirmed;});
 	var	mn = d3.min(globaldata,function(f){return f.autochthonous_cases_confirmed;});
	
 	var mx_ht = d3.max(globaldata,function(f){return f.autochthonous_cases_confirmed/f.pop_x_1000;});
 	var	mn_ht = d3.min(globaldata,function(f){return f.autochthonous_cases_confirmed/f.pop_x_1000;});  
	
	//regional extrama
	//(d3.max(globalbycountry, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});}));
	
 	var r_mx = d3.max(regionalData,function(v){return d3.max(v.values, function(f){return f.value.autochthonous_cases_confirmed;});});
 	var	r_mn = d3.min(regionalData,function(v){return d3.min(v.values, function(f){return f.value.autochthonous_cases_confirmed;});});
	
 	var r_mx_ht = d3.max(regionalData,function(v){return d3.max(v.values, function(f){return f.value.autochthonous_cases_confirmed/f.value.pop_x_1000;});});
 	var	r_mn_ht = d3.min(regionalData,function(v){return d3.min(v.values, function(f){return f.value.autochthonous_cases_confirmed/f.value.pop_x_1000;});});  
	 
	//console.log(r_mx+" "+r_mn+" "+r_mx_ht+" "+r_mn_ht);  
	  
 	
	var plotRange = globaldata;
	plotRange.sort(function(a,b){return a.autochthonous_cases_confirmed - b.autochthonous_cases_confirmed;});
	
	//console.log(plotRange);
	//console.log(mx);
	//console.log(mx_c);
	//console.log(globaldata);
	//console.log(d3.schemeReds[7]);
	
	//var gc = ["#ccebad","#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d"]
	
	var gc8 = ["#c7e9c0",	
"#fef0d9",
"#fdd49e",
"#fdbb84",
"#fc8d59",
"#ef6548",
"#d7301f",
	"#990000"];
	
	

		var gc9 = ["#c7e9c0",	
	"#fff7ec",
	"#fee8c8",
	"#fdd49e",
	"#fdbb84",
	"#fc8d59",
	"#ef6548",
	"#d7301f",
	"#990000"];	

	var gc10 =["#c7e9c0",
	"#fff7ec",
	"#fee8c8",
	"#fdd49e",
	"#fdbb84",
	"#fc8d59",
	"#ef6548",
	"#d7301f",
	"#b30000",
	"#7f0000"];
	
	
	var c_logScale;
	var c_colorScaleLog;
	var c_logScale_ht;
	var c_colorScaleLog_ht;
	
	choropleth_global = d3.scaleThreshold()//scaleLog()
 	.domain([0,1,100,500,1000,5000,10000, 50000, mx])
	//.range([d3.interpolateOrRd(0),d3.interpolateOrRd(1)]);
 	.range(gc9);//["#e1f7d5","#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d"]);
	//.range(['#fef0d9', '#b30000']);	
	
	//console.log(d3.interpolateReds(0));
	
	//console.log("max global: "+mx);
	
	choropleth_global_ht = d3.scaleThreshold()//scaleLog()
 	.domain([mx_ht/256,mx_ht/128,mx_ht/64,mx_ht/32,mx_ht/16,mx_ht/8,mx_ht/4,mx_ht/2,mx_ht])
	//.range([d3.interpolateOrRd(0),d3.interpolateOrRd(1)]);
 	.range(gc8);
	
	//console.log(mx_ht);
	//console.log(mx);

// Log Scale
    var logScale = d3.scaleLog()
      .domain([1, mx])
    var colorScaleLog = d3.scaleSequential(
        (d) => d3.interpolateReds(logScale(d))
      ); 
	
      var logScale_ht = d3.scaleLog()
        .domain([0.001, mx_ht])
      var colorScaleLog_ht = d3.scaleSequential(
          (d) => d3.interpolateReds(logScale_ht(d))
        );
		
	    var r_logScale = d3.scaleLinear()
	      .domain([r_mn, r_mx])
	    var r_colorScaleLog = d3.scaleSequential(
	        (d) => d3.interpolateOrRd(r_logScale(d))
	      ); 
		  
	    var r_linScale = d3.scaleLinear()
	      .domain([r_mn, r_mx])
		  .range(['#fdbb84','#b30000']);
		  
	    var r_linScale_ht = d3.scaleLinear()
	      .domain([r_mn_ht, r_mx_ht])
		  .range(['#fdbb84','#b30000']);
	
	      var r_logScale_ht = d3.scaleLinear()
	        .domain([r_mn_ht, r_mx_ht])
	      var r_colorScaleLog_ht = d3.scaleSequential(
	          (d) => d3.interpolateOrRd(r_logScale_ht(d))
	        );	
		
	//country_view
	
	
 	/*choropleth_global_ht = d3.scaleThreshold()//.scaleLog()
 	.domain([0.001,mx_ht])
 	.range(gc8);*/	  
	  
  	/*choropleth4 = d3.scaleLog()
  	.domain([1,mx_c])
  	.range(['#fee8c8','#b30000'])*/

var logScale_c = d3.scaleLog()
  .domain([0.001, 10000])
var colorScaleLog_c = d3.scaleSequential(
    (d) => d3.interpolateReds(logScale_c(d))
  ); 

  var logScale_c_ht = d3.scaleLog()
    .domain([0.001, 5000])
  var colorScaleLog_c_ht = d3.scaleSequential(
      (d) => d3.interpolateReds(logScale_c_ht(d))
    );	
	
	
choropleth4 = d3.scaleThreshold()
.domain([0,1,10,50,100,500,1000,5000])
	  .range(gc8);//["#ccebad","#fee5d9", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d"]);	 
	  

	  	//console.log(d3.schemeReds[8]);
		//console.log(d3.schemeReds[9]);
	  
choropleth4_ht = d3.scaleThreshold()//d3.scaleLog()
.domain([0,0.1,0.5,1,5,10,50,100,500,1000])
	  .range(gc10);//["#ccebad","#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#99000d"]);	  
	
	/*color4 = d3.scaleThreshold()
    .domain([1, 5, 10, 50, 100, 500, 1000, 5000, 25000])
	.range([d3.interpolateOrRd(0),d3.interpolateOrRd(1)]);*/
	
	
	color4 = d3.scaleThreshold()
    .domain([1, 5, 10, 50, 100, 500, 1000, 5000, 25000])
	.range(d3.schemeReds[9]);
	
	color_global = d3.scaleThreshold()
    .domain([0,1, 50, 100, 500, 1000, 10000, 50000, 100000, 150000])
	.range(gc10);//["#ccebad","#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#a50f15", "#67000d"]);
	//schemeReds
	//schemeOrRd
	global_choropleth = colorScaleLog;//choropleth_global;//colorScaleLog;//color_global;
	global_choropleth_ht = colorScaleLog_ht;//choropleth_global_ht;
	
	regional_choropleth = r_linScale;//r_colorScaleLog;
	regional_choropleth_ht = r_linScale_ht;//r_colorScaleLog_ht;
	
	country_choropleth = choropleth4;//color4;
	country_choropleth_ht = choropleth4_ht;//color4;
	 
	 draw_global_view();
	 //draw_country_view();
	 //draw_country_view();
	 //close_btn.dispatch("click");
	 //removePopup();
	 
	 
	 //var bchart_colors = ["#1b9e77","#e6ab02","#7570b3"];
	 //var bchart_colors =["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"];
	 
	 
	 function draw_country_view(){
	 initCountryView();	
	 countryProjections(); 
	 drawMenu();  
	 setLeaflet();
 	//overview_tab.selected = true;
 	//temporalview_tab.selected = false;
	 setCountry(ADM0);
	 }
	 
	 function setLeaflet(){
	 //need to set this up here
	 over_view = d3.select("#mapview").append("div")
	 	.attr("id","overview");
		
	 /*d3.select("#mapview").append("svg")
		.attr("width","200px")
		.attr("height","100px")
		.attr("x",375)
		.attr("y",10)
		.attr("id","legend_svg");*/
	
	 /*country_map = L.map('overview').setView([14, -89], 7)		
	 	.addLayer(new L.TileLayer("http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png?access_token={accessToken}",{
			id: 'your.mapbox.project.id',
    		accessToken: 'your.mapbox.public.access.token'
			//onEachFeature: onEachFeature
	 	}));*/
		
		country_map = L.map('overview').setView([14, -89], 7);
		//.addLayer(new L.tileLayer("http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png"));
		
		drawLegend_ht();
		
		var roads = L.gridLayer.googleMutant({
		    type: 'roadmap', // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
			styles: [
				//{elementType: 'labels', stylers: [{visibility: 'off'}]},
				{featureType: 'water', stylers: [{color: '#9fcdf1'}]},
				//{featureType: 'landscape', stylers: [{color: '#eeeeee'}]},
				{featureType: 'road', stylers: [{visibility: 'off'}]},
				{featureType: 'poi', stylers: [{visibility: 'off'}]},
				{featureType: 'transit', stylers: [{visibility: 'off'}]},
				//{featureType: 'administrative', stylers: [{visibility: 'off'}]},
				//{featureType: 'administrative.locality', stylers: [{visibility: 'off'}]}
			]
		}).addTo(country_map);
		
			
		
		//L.tileLayer("http://tile.mapzen.com/mapzen/vector/v1/{layers}/{z}/{x}/{y}.{format}?api_key={api_key}",{api_key:'mapzen-Kf6vk95'}).addTo(country_map);	
	 	/*.addLayer(new L.TileLayer("http://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png",{
			id: 'your.mapbox.project.id',
    		accessToken: 'your.mapbox.public.access.token'
			//onEachFeature: onEachFeature
	 	}))*/
		
		//bw-mapnik
		
		/*country_map = L.map('overview').setView([14, -89], 7)		
	 	.addLayer(new L.TileLayer('http://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png?access_token={accessToken}', {
			id: 'your.mapbox.project.id',
    		accessToken: 'your.mapbox.public.access.token',
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://www.openstreetmap.bzh/" target="_blank">Breton OpenStreetMap Team</a>',
			bounds: [[46.2, -5.5], [50, 0.7]]
		}));*/
		
/*country_map = L.map('overview').setView([14, -89], 7)		
	 	.addLayer(new L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
		    maxZoom: 18,
		    id: 'mapbox.streets',
		    accessToken: 'your.mapbox.access.token'
		}));*/
		
		/*var OpenStreetMap_BZH = L.tileLayer('http://tile.openstreetmap.bzh/br/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://www.openstreetmap.bzh/" target="_blank">Breton OpenStreetMap Team</a>',
			bounds: [[46.2, -5.5], [50, 0.7]]
		});*/
		
		//http://{s}.www.toolserver.org/tiles/bw-mapnik/
		
		//http://tile.openstreetmap.bzh/br/
		
		//init();
		
		//var footnotes = new L.FeatureGroup();
		
		/*footnote_data.each(function(d,i){
			console.log(d);
		})*/
		
		/*for(i = 0; i < footnote_data.length; i++){
			console.log(footnote_data[i]);
			//var marker = L.marker([])
		}*/
		
		//country_map.addLayer(footnotes);
		
		/*var drawnItems = new L.FeatureGroup();
		     
			 country_map.addLayer(drawnItems);
		     var drawControl = new L.Control.Draw({
		         edit: {
		             featureGroup: drawnItems
		         }
		     });
		     
			 country_map.addControl(drawControl);*/
		
		
		/*country_map.on('contextmenu',function(e){
			var marker = new L.marker(e.latlng).bindPopup('<form role="form" id="form" enctype="multipart/form-data" class = "form-horizontal" onsubmit="addMarker()">'+
              //...
              '<div class="form-group">'+
                  '<textarea class="form-control" rows="6" id="descrip" name="descript">add comment</textarea>'+
              '</div>'+
              '<div class="form-group">'+
                '<div style="text-align:center;" class="col-xs-4"><button type="submit" value="submit" class="btn btn-primary trigger-submit">Submit</button></div>'+
              '</div>'+
              '</form>').addTo(country_map);
		});*/
			
	  //create temp layer to store new features
	  //create temp layer to store new features
	        country_featureGroup = L.featureGroup().addTo(country_map);

	        //create drawing controls and toolbar
	        country_drawControl = new L.Control.Draw({
	          draw: {
	            circle: false,
				  marker: { 
					  interactive: false
					},
	            polyline: false, 
	            polygon: false,
	            rectangle: false
	          }/*,
	         edit: {
	             featureGroup: featureGroup
	         }*/
			  
	        }).addTo(country_map);	
			
		
		country_map.on('draw:created', function(e) {
		          var coords = e.layer._latlng;
		          //console.log(coords);
		          country_featureGroup.addLayer(e.layer);
		          //var popupContent = '<form action="https://docs.google.com/forms/d/e/1FAIpQLSe63rT_PcCjDCMebQ3ToqUU5TH9hacCR1Bcv76c-IY3oC_lZw/formResponse" target="formDestination" method="POST" id="mG61Hd" onsubmit="">'+
				  var popupContent = '<form target="_self" onsubmit="" action="javascript: postToGoogleC()">'+
		          '<div class="form-group">'+
		              //'<label class="control-label col-sm-5"><strong>Description: </strong></label>'+
		              '<textarea class="form-control" rows="6" id="comment" name="comment" placeholder="add comment"></textarea>'+
		          '</div>'+
		          '<input style="display: none;" type="text" id="lat" name="lat" value="'+coords.lat.toFixed(6)+'" />'+
		          '<input style="display: none;" type="text" id="lng" name="lng" value="'+coords.lng.toFixed(6)+'" />'+
				  '<input style="display: none;" type="text" id="country" name="country" value="'+ADM0+'" />'+
		          '<div class="form-group">'+
		            //'<div style="text-align:center;" class="col-xs-4 col-xs-offset-2"><button type="button" class="btn">Cancel</button></div>'+
		            '<div style="text-align:center;" class="col-xs-4"><button type="submit" value="submit" name="M2UYVd">Submit</button></div>'+
		          '</div>'+
		          '</form>';
				  
				  country_featureGroup.getLayers()[country_featureGroup.getLayers().length-1].bindPopup(popupContent,{
		            keepInView: true,
					  closeButton: true
		            }).openPopup();	
		      });
			  
			  //class="btn btn-primary trigger-submit"
		
		
			/*function highlightFeature(e) {
			    var layer = e.target;

			    layer.setStyle({
			        weight: 5,
			        color: '#666',
			        dashArray: '',
			        fillOpacity: 0.7
			    });

			    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
			        layer.bringToFront();
			    }
			}
			
			function resetHighlight(e) {
			    country_map.resetStyle(e.target);
			}
			
			function onEachFeature(feature, layer) {
			    layer.on({
			        mouseover: highlightFeature,
			        mouseout: resetHighlight,
			    });
			}*/
	 }
	 
 d3.select("#confCases")
 	.on("click",function(d){
 		gl_epi_tab = 0;
		gl_choroplethIndicator="autochthonous_cases_confirmed";
 		//console.log(gl_epi_tab);
 		d3.select("#byIndicator").style("background","none");
 		d3.select(this).style("background",tabColor);
		d3.select("#newConfirmedData").moveToFront();
		d3.select("#byIndicatorData").style("pointer-events","none");
		d3.select("#newConfirmedData").style("pointer-events","all");
 		draw_global_chartview();
		update_choropleths();
 	});		
	
 d3.select("#byIndicator")
 	.on("click",function(d){
 		gl_epi_tab = 1;
 		//console.log(gl_epi_tab);
		d3.select("#byIndicatorData").moveToFront();
		d3.select("#byIndicatorData").style("pointer-events","all");
		d3.select("#newConfirmedData").style("pointer-events","none");
 		d3.select("#confCases").style("background","none");
 		d3.select(this).style("background",tabColor);
 		draw_global_chartview();
 	});	
	
	 
	 function draw_global_view(){
		 init();
		 initGlobalView();
		 initCountryViewMerged();
		 countryProjections();
		 //globalProjections();
		 set_global_leaflet();
		 draw_global_mapview();
		 draw_subRegional_mapview(); 
		 draw_global_chartview();
		 draw_discrepancyview();
		 commentBtns();
		 
		 global_bcharts.moveToFront();
		 //draw_global_MessageBoard();
		 //draw_global_MessageForm();
		 //drawSubNatRegions();
		 
		 
		 //commentsOn_btn.moveToFront();
		 //commentsOff_btn.moveToFront();
	 	//global_svg.call(gl_zoom);
	 }

	 
	 
	 
function commentBtns(){
//	
var views = d3.select("#global_container").append("div")
	.attr("id","viewtabs")
	.attr("class","vbuttons")
	.style("margin-left","-5px")
	.style("margin-top","25px");
	
	var rviewbtn = views.append("div")
	.attr("class","viewbutton")
	.text("regional view");
	
	rviewbtn.on("click",function(){
		//only do if not already countryview
		if(!rview){
			rviewbtn.style("background",mapcolor);
			cviewbtn.style("background","white");
			scviewbtn.style("background","white");
			gview = false;
			cview = false;
			rview = true;
			changeView();
		}
	});
	
	var cviewbtn = views.append("div")
	.attr("class","viewbutton")
	.text("country view")
	.style("background",mapcolor);
	
	cviewbtn.on("click",function(){
		//only do if not already countryview
		if(!gview){
			rviewbtn.style("background","white");
			cviewbtn.style("background",mapcolor);
			scviewbtn.style("background","white");
			gview = true;
			cview = false;
			rview = false;
			changeView();
		}
	});
	
	
	var scviewbtn = views.append("div")
	.attr("class","viewbutton")
	.text("sub-country view (select country ->->)")
	.style("background","white");
	
	scviewbtn.on("click",function(){
		//only do if not already countryview
		if(!cview){
			rviewbtn.style("background","white");
			cviewbtn.style("background","white");
			scviewbtn.style("background",mapcolor);
			gview = false;
			cview = true;
			rview = false;
			
			var sel = d3.select("#selectCountry").node().value;
			console.log(sel);
			
			var ADM0 = ADM0_A3_lookup.filter(function(v){return v.key == sel;})[0].value;
			
			setCountry(ADM0);
			changeView();
			//gl_reset();
		}
	});
	

var selectCountry = views.append("select")
	.attr("class","viewbutton")
	.attr("id","selectCountry")
	.text("Sub-country view (select country)")
	.on("change",selectChange);
	
	/*selectCountry.append("option")
	.attr("value","all")
	.text("Sub-country view (select country)");*/
	
	selectCountry.selectAll("option")
	.data(got_data)
	.enter()
	.append("option")
	.attr("value",function(d){return d;})
	.text(function(d){return d;});
	
	function selectChange(){
		var sel = d3.select("#selectCountry").node().value;
		console.log(sel);
		//if already in country view
		if(cview){
		var ADM0 = ADM0_A3_lookup.filter(function(v){return v.key == sel;})[0].value;
		setCountry(ADM0);
		changeView();
		//var view = ADM1_lookup.filter(function(v){return v.value == ADM0;})[0];
		//global_map.setView([view.lat, view.lng],view.zoom);
		
		}
	}
	

var ch1 = d3.select("#global_container").append("div")
	.attr("id","checkbox1")
	.attr("class","checkboxes")
	.style("margin-left","10px")
	.style("margin-top","60px");
	
var ch2 = d3.select("#global_container").append("div")
	.attr("id","checkbox2")
	.attr("class","checkboxes")
	.style("margin-left","10px")
	.style("margin-top","75px");	
	
	
commentsCheckbox = ch1//d3.select("#global_container")
	.append("input")
	.attr("type","checkbox")
	.attr("id","commentsCheckbox")
	.property("checked",1)
	.on("change",function(){
		if(d3.select(this).property("checked")){
			showFootnotes();
			d3.select("#discrepancyView").style("opacity",1);
			d3.select("#discrepancyView").style("pointer-events","all");
		}else{
			hideFootnotes();
			d3.select("#discrepancyView").style("opacity",0);
			d3.select("#discrepancyView").style("pointer-events","none");
		}
	});
	
ch1.append("text")
	.attr("x",20)
	.attr("y",0)
	.text("Show discrepancies")
	.attr("class","gen_labels2")
	.attr("z-index",1);	


awardsCheckbox = ch2//d3.select("#global_container")
	.append("input")
	.attr("type","checkbox")
	.attr("id","awardsCheckbox")
	.property("checked",1)
	.on("change",function(){
		if(d3.select(this).property("checked")){
			awardsOn = true;
			global_bcharts.style("opacity",1);
			if(efforts!=null){efforts.style("opacity",1);efforts.style("pointer-events","all");}
			if(_g)d3.select("#gl_awardview").style("opacity",1);
			if(_c)d3.select("#awardview").style("opacity",1);
		}else{
			awardsOn = false;
			global_bcharts.style("opacity",0);
			if(efforts!=null){efforts.style("opacity",0);efforts.style("pointer-events","none");}
			if(_g)d3.select("#gl_awardview").style("opacity",0);
			if(_c)d3.select("#awardview").style("opacity",0);
		}
	});
	
ch2.append("text")
	.attr("x",20)
	.attr("y",0)
	.text("Show response data")
	.attr("class","gen_labels2")
	.attr("z-index",1);	
	
	
	
/*commentsOn_btn = d3.select("#global_container").append("div")
	.attr("id","commentsOn")
	.style("background","rgb(212,218,220)");
	//.attr("class","toggle");

	commentsOn_btn.text("comments on");	

commentsOff_btn = d3.select("#global_container").append("div")
	.attr("id","commentsOff");
	//.attr("class","toggle");	

	commentsOff_btn.text("off");*/
	
//per hundred thousand	
	
tot_btn = views.append("div")//d3.select("#global_container").append("div")
	.attr("id","perTotal")
	.style("background",mapcolor);
	//.attr("class","toggle");

	tot_btn.text("total cases");	

pht_btn = views.append("div")//d3.select("#global_container").append("div")
	.attr("id","perHT");
	//.attr("class","toggle");	

	pht_btn.text("per H.T.");	
	
	tot_btn.on("click",function(){
		ht = false;
		/*if(cview){
			clegend_ht.remove();
			clegend.addTo(global_map);
		}else if(gview){
			glegend_ht.remove();
			glegend.addTo(global_map);
		}else if(rview){
			rlegend_ht.remove();
			rlegend.addTo(global_map);
		}*/
		//clegend_ht.remove();
		//drawLegend();
		legend_all.remove();
		gl_update_legends();
		
		d3.select(this).style("background",mapcolor);
		pht_btn.style("background","white");
		if(regions!=null){
		  //update_c_choropleths();	
		  update_c_basecolor();
	  	}
	gl_updateCountries();
	
	if(!gview){
		PAHO_global_footnotes.removeFrom(global_map);
	}
	
	//updateSMs();
	});
	
	//tot_btn.dispatch("click");
 
 	pht_btn.on("click",function(){
 	   ht = true;
	   /*if(cview){
	   		clegend.remove();
	   	 	clegend_ht.addTo(global_map);
		}else if(gview){
			glegend.remove();
			glegend_ht.addTo(global_map);
		}else if(rview){
			rlegend.remove();
			rlegend_ht.addTo(global_map);
		}*/
	   //clegend.remove();
	   //drawLegend_ht();  
	legend_all.remove();
	gl_update_legends();
	
	     
	d3.select(this).style("background",mapcolor);
	tot_btn.style("background","white");
	if(regions!=null){
	  //update_c_choropleths();	
	  update_c_basecolor();
  	}
	  gl_updateCountries();
 	 //updateSMs();
 	if(!gview){
 		PAHO_global_footnotes.removeFrom(global_map);
 	}
 	});		
	
	
		 
 		/* commentsOn_btn.on("click",function(){
 			 if(!commentsState){
 				 commentsState = true;
 			 d3.select(this).style("background","rgb(212,218,220)");
 			 d3.select("#commentsOff").style("background","white");
 			 showFootnotes();
 	 		//draw_global_MessageBoard();
 	 		//draw_global_MessageForm();
 			//d3.select("#gl_comments").style("opacity",1);
 			//d3.select("#messageBoard").style("opacity",1);
 			//d3.select("#postMessage").style("opacity",1);
 		 	}
 		 });
		 
 		 commentsOff_btn.on("click",function(){
 			 if(commentsState){
 				 commentsState = false;
 			 d3.select(this).style("background","rgb(212,218,220)");
 			 d3.select("#commentsOn").style("background","white");
 			 hideFootnotes();
 	 		//d3.select("#gl_messageBoard").selectAll("*").remove();
 	 		//d3.select("#gl_postMessage").selectAll("*").remove();
 			//d3.select("#gl_comments").style("opacity",0);
 			//d3.select("#messageBoard").style("opacity",0);
 			//d3.select("#postMessage").style("opacity",0);
			
 		 	}
 		 });*/
		 
		 
 		 /*perTotal_btn.on("click",function(){
 			 if(!perState){
 				 perState = true;
 			 d3.select(this).style("background","rgb(212,218,220)");
 			 d3.select("#perHT").style("background","white");
 			// showFootnotes();
 	 		//draw_global_MessageBoard();
 	 		//draw_global_MessageForm();
 			//d3.select("#gl_comments").style("opacity",1);
 			//d3.select("#messageBoard").style("opacity",1);
 			//d3.select("#postMessage").style("opacity",1);
 		 	}
 		 });
		 
 		 perHT_btn.on("click",function(){
 			 if(perState){
 				 perState = false;
 			 d3.select(this).style("background","rgb(212,218,220)");
 			 d3.select("#perTotal").style("background","white");
 			// hideFootnotes();
 	 		//d3.select("#gl_messageBoard").selectAll("*").remove();
 	 		//d3.select("#gl_postMessage").selectAll("*").remove();
 			//d3.select("#gl_comments").style("opacity",0);
 			//d3.select("#messageBoard").style("opacity",0);
 			//d3.select("#postMessage").style("opacity",0);
			
 		 	}
 		 });*/
		 
		 
	 }
	 
	 
	 
 		function draw_regional_Legend(){
		rlegend = L.control({position: 'bottomleft'});
	
		var formatDate = d3.timeFormat("%m/%e/%y");

		rlegend.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info legend'),
		        grades = [0, 1, 50, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000],
			labels = ['<strong> Total cumulative Zika cases<br>As Of: '+formatDate(choropleth_date)+'</strong>'],
			from, to;
				for (var i = 0; i < grades.length; i++) {
				        from = grades [i];
				        to = grades[i+1]-1;

				    labels.push(
				        '<i style="background:' + regional_choropleth(from + 1) + '"></i> ' +
				        from + (to ? '&ndash;' + to : '+'));
				        }
				        div.innerHTML = labels.join('<br>');	

		    return div;
		};

		//rlegend.addTo(global_map);
 	}
	
 		function draw_regional_Legend_ht(){
		rlegend_ht = L.control({position: 'bottomleft'});
	
		var formatDate = d3.timeFormat("%m/%e/%y");

		rlegend_ht.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info legend'),
		        grades = [0, 0.1, 0.25, 0.5, 1, 5],
			labels = ['<strong> Zika cases per H.T. <br>As Of: '+formatDate(choropleth_date)+'</strong>'],
			from, to;
				for (var i = 0; i < grades.length; i++) {
				        from = grades [i];
				        to = grades[i+1];

				    labels.push(
				        '<i style="background:' + regional_choropleth_ht(from) + '"></i> ' +
				        from + (to ? '&ndash;' + to : '+'));
				        }
				        div.innerHTML = labels.join('<br>');	

		    return div;
		};

 	}
	 
	 	function draw_gl_Legend(){
			glegend = L.control({position: 'bottomleft'});
		
			var formatDate = d3.timeFormat("%m/%e/%y");

			glegend.onAdd = function (map) {

			    var div = L.DomUtil.create('div', 'info legend'),
			        grades = [0, 1, 50, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000],
				labels = ['<strong> Total cumulative Zika cases<br>As Of: '+formatDate(choropleth_date)+'</strong>'],
				from, to;
					for (var i = 0; i < grades.length; i++) {
					        from = grades [i];
					        to = grades[i+1]-1;

					    labels.push(
					        '<i style="background:' + global_choropleth(from + 1) + '"></i> ' +
					        from + (to ? '&ndash;' + to : '+'));
					        }
					        div.innerHTML = labels.join('<br>');	

			    return div;
			};

			glegend.addTo(global_map);
	 	}
		
	 	function draw_gl_Legend_ht(){
			glegend_ht = L.control({position: 'bottomleft'});
		
			var formatDate = d3.timeFormat("%m/%e/%y");

			glegend_ht.onAdd = function (map) {

			    var div = L.DomUtil.create('div', 'info legend'),
			        grades = [0, 0.1, 0.25, 0.5, 1, 5, 10, 20],
				labels = ['<strong> Zika cases per H.T. <br>As Of: '+formatDate(choropleth_date)+'</strong>'],
				from, to;
					for (var i = 0; i < grades.length; i++) {
					        from = grades [i];
					        to = grades[i+1];

					    labels.push(
					        '<i style="background:' + global_choropleth_ht(from) + '"></i> ' +
					        from + (to ? '&ndash;' + to : '+'));
					        }
					        div.innerHTML = labels.join('<br>');	

			    return div;
			};

	 	}
		
		
		function drawLegend(){
			clegend = L.control({position: 'bottomleft'});

			clegend.onAdd = function (map) {

			    var div = L.DomUtil.create('div', 'info legend'),
			        grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
				labels = ['<strong> Total ZIka Cases<br>As Of: 8/1/16 (PAHO)</strong>'],
				from, to;
					for (var i = 0; i < grades.length; i++) {
					        from = grades [i];
					        to = grades[i+1]-1;

					    labels.push(
					        '<i style="background:' + country_choropleth(from + 1) + '"></i> ' +
					        from + (to ? '&ndash;' + to : '+'));
					        }
					        div.innerHTML = labels.join('<br>');	

			    return div;
			};

			//clegend.addTo(global_map);
		}
	
		function drawLegend_ht(){
			clegend_ht = L.control({position: 'bottomleft'});

			clegend_ht.onAdd = function (map) {

			    var div = L.DomUtil.create('div', 'info legend'),
			        grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
					labels = ['<strong> Total ZIka Cases (per H.T.)<br>As Of: 8/1/16 (PAHO)</strong>'],
				from, to;

			    // loop through our density intervals and generate a label with a colored square for each interval
				for (var i = 0; i < grades.length; i++) {
				        from = grades [i];
				        to = grades[i+1]-1;

				    labels.push(
				        '<i style="background:' + country_choropleth_ht(from + 1) + '"></i> ' +
				        from + (to ? '&ndash;' + to : '+'));
				        }
				        div.innerHTML = labels.join('<br>');	

			    return div;
			};

			//clegend_ht.addTo(global_map);
		}
		
		
		function gl_update_legends(){
			
			
			legend_all = L.control({position: 'bottomleft'});
			
			var formatDate = d3.timeFormat("%m/%e/%y");
			
			legend_all.onAdd = function (map) {	
				
		if(gview){
			
				if(ht){
					var range = mx_ht/10;
				    var div = L.DomUtil.create('div', 'info legend'),
				        grades = [0, 0.1, 0.25, 0.5, 1, 5, 10, 20],
					labels = ['<strong>'+gl_choroplethIndicator+' per H.T. <br>As Of: '+formatDate(choropleth_date)+'</strong>'],
					from, to;
						for (var i = 0; i < grades.length; i++) {
						        from = grades [i];
						        to = grades[i+1];
						    labels.push(
						        '<i style="background:' + global_choropleth_ht(from) + '"></i> ' +
						        from + (to ? '&ndash;' + to : '+'));
						        }
						        div.innerHTML = labels.join('<br>');	
				    return div;	
				}else{
					var range = mx/10;
				    var div = L.DomUtil.create('div', 'info legend'),
				        grades = [0, 1, 50, 100, 500, 1000, 5000, 10000, 50000, 100000, 500000],
					labels = ['<strong>'+gl_choroplethIndicator+'<br>As Of: '+formatDate(choropleth_date)+'</strong>'],
					from, to;
						for (var i = 0; i < grades.length; i++) {
						        from = grades [i];
						        to = grades[i+1];

						    labels.push(
						        '<i style="background:' + global_choropleth(from + 1) + '"></i> ' +
						        from + (to ? '&ndash;' + to : '+'));
						        }
						        div.innerHTML = labels.join('<br>');	
				    return div;
				}
			}else if(rview){
				
				if(ht){
					var range = r_mx_ht/10;
				    var div = L.DomUtil.create('div', 'info legend'),
					grades = [0, range,range*2,range*3,range*4,range*5,range*6,range*7,range*8,range*9,range*10],
					//grades = [0, Math.round(100*range)/100, Math.round(100*range*2)/100, Math.round(100*range*3)/100, Math.round(100*range*4)/100, Math.round(100*range*5)/100],
					labels = ['<strong>'+gl_choroplethIndicator+'per H.T. <br>As Of: '+formatDate(choropleth_date)+'</strong>'],
					from, to;
						for (var i = 0; i < grades.length; i++) {
						        from = grades [i];
						        to = grades[i+1];

						    labels.push(
						        '<i style="background:' + regional_choropleth_ht(from) + '"></i> ' +
						        from + (to ? '&ndash;' + to : '+'));
						        }
						        div.innerHTML = labels.join('<br>');	

				    return div;
				}else{
					var range = r_mx/10;
					//console.log(range);
				    var div = L.DomUtil.create('div', 'info legend'),
					grades = [0, range, range*2,range*3,range*4,range*5,range*6,range*7,range*8,range*9,range*10],
					//grades = [0, Math.round(range/100)*100, Math.round(range*2/100)*100, Math.round(range*3/100)*100, Math.round(range*4/100)*100, Math.round(range*5/100)*100, Math.round(range*6/100)*100, Math.round(range*7/100)*100, Math.round(range*8/100)*100, Math.round(range*9/100)*100, Math.round(range*10/100)*100],
					labels = ['<strong>'+gl_choroplethIndicator+'<br>As Of: '+formatDate(choropleth_date)+'</strong>'],
					from, to;
						for (var i = 0; i < grades.length; i++) {
						        from = grades [i];
						        to = grades[i+1];

						    labels.push(
						        '<i style="background:' + regional_choropleth(from + 1) + '"></i> ' +
						        from + (to ? '&ndash;' + to : '+'));
						        }
						        div.innerHTML = labels.join('<br>');	

				    return div;
				}
				
			}else if(cview){
				
				if(ht){
					
					var range = c_mx_ht/10;
				    var div = L.DomUtil.create('div', 'info legend'),
				        grades = [0, 0.001,0.002,0.004,range*4,range*5,range*6,range*7,range*8,range*9,range*10],
						//grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
						labels = ['<strong>'+c_choroplethIndicator+'(per H.T.)<br>As Of:'+formatDate(c_choropleth_date)+'</strong>'],
					from, to;

				    // loop through our density intervals and generate a label with a colored square for each interval
					for (var i = 0; i < grades.length; i++) {
					        from = grades [i];
					        to = grades[i+1];

					    labels.push(
					        '<i style="background:' + country_choropleth_ht(from + 1) + '"></i> ' +
					        from + (to ? '&ndash;' + to : '+'));
					        }
					        div.innerHTML = labels.join('<br>');	

				    return div;
				}else{
					
					var range = c_mx/10;
					
				    var div = L.DomUtil.create('div', 'info legend'),
				        grades = [0, range,range*2,range*3,range*4,range*5,range*6,range*7,range*8,range*9,range*10],
						//grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
					labels = ['<strong>'+c_choroplethIndicator+'<br>As Of:'+formatDate(c_choropleth_date)+'</strong>'],
					from, to;
						for (var i = 0; i < grades.length; i++) {
						        from = grades [i];
						        to = grades[i+1];

						    labels.push(
						        '<i style="background:' + country_choropleth(from + 1) + '"></i> ' +
						        from + (to ? '&ndash;' + to : '+'));
						        }
						        div.innerHTML = labels.join('<br>');	

				    return div;
				}
			}
			
			
			
			
			}
			legend_all.addTo(global_map);
		}
		
		
		
		function set_global_leaflet(){
			
			
			width = 500,
		    height = 400;
	
			sm_width = 125,
			sm_height = 125;		

			gl_width = glMapview.clientWidth;
			gl_height = 800;//glMapview.clientHeight;	
	
		//setup topojson stuff -- paths and projections
		/************global projection**************/	
	
		//Map projection
		/*global_projection = d3.geoMercator()
		    .scale(500)
			//.scale(100)
		    .center([0,0]) //projection center
			.translate([1025,350]) //translate to center the map in view	
			//.translate([width/2,height/2]);

		//Generate paths based on projection
		global_path = d3.geoPath()
		    .projection(global_projection);	*/

			
		//	
			
			
			
			draw_leaflet_layer();
			
			
			function projectPoint(x, y) {
			  var point = global_map.latLngToLayerPoint(new L.LatLng(y, x));
			  this.stream.point(point.x, point.y);
			}	
	
			var transform = d3.geoTransform({point: projectPoint});
		    global_path = d3.geoPath().projection(transform);
			
			
			
		}
	 
	 
   	 function draw_leaflet_layer(){
		 
   		 //global_map = L.map('gl_mapview',{zoomControl:false,trackResize:false}).setView([0, 0], 3);
   		 global_map = L.map('gl_mapview',{zoomControl:false,trackResize:false,zoomSnap: 0.25}).setView([-15, -50], 3.75);
   		 zoomVal = 3.75;
		 
   		 /*draw_regional_Legend();
		 draw_regional_Legend_ht();
		 draw_gl_Legend();
		 draw_gl_Legend_ht();
		 drawLegend();
		 drawLegend_ht();*/
		 
		 gl_update_legends();
		 
   		 global_map.createPane('labels');
   		 global_map.getPane('labels').style.zIndex = 650;
		 
	 
   		//light_nolabels	vs. light_all
   		var positron = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
   				attribution: '©OpenStreetMap, ©CartoDB',
   				subdomains: 'abcd',
   				maxZoom: 19
   			}).addTo(global_map);
			
			
			var OpenStreetMap_DE = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			});//.addTo(global_map);
			
			var Esri_WorldGrayCanvas = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
				attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
				maxZoom: 16
			});//.addTo(global_map);	
			
			/*var Stamen_TonerLabels = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.{ext}', {
				attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
				subdomains: 'abcd',
				minZoom: 0,
				maxZoom: 20,
				ext: 'png'
			}).addTo(global_map)*/
			
			/*var OpenStreetMap_DE = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
			}).addTo(global_map);	*/
			
			
   	var positronLabels = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_only_labels/{z}/{x}/{y}.png', {
      		         attribution: '©OpenStreetMap, ©CartoDB',
      		         pane: 'labels'
      		 });//.addTo(global_map);
		
   		 global_map.touchZoom.disable();
   		 global_map.doubleClickZoom.disable();
   		 //global_map.scrollWheelZoom.disable();
   		 //global_map.dragging.disable();
   		 //global_map.trackResize.disable();
			
   		global_featureGroup = L.featureGroup().addTo(global_map);	
		
		//global_featureGroup.setZIndex(99);
		
          global_drawControl = new L.Control.Draw({
			position:'topright',
		  	//position: 'absolute', 
		  	//left: '765px',
		  	//top: '50px',
			 draw: {
               circle: false,
			   marker: {
				   	  bubblingMouseEvents:true
					},
               polyline: false, 
               polygon: false,
               rectangle: false
             },
   		  edit: {featureGroup: global_featureGroup },
   		  pane: 'tooltip'
           }).addTo(global_map);	
		
		
   		/*global_map.on('draw:created', function(e) {
   			  		          var coords = e.layer._latlng;
   			  		          global_featureGroup.addLayer(e.layer);
   			  				  var popupContent = '<form target="_self" onsubmit="" action="javascript: postToGoogleG()">'+
   			  		          '<div class="form-group">'+
   			  		              //'<label class="control-label col-sm-5"><strong>Description: </strong></label>'+
   			  		              '<textarea class="form-control" rows="6" id="comment" name="comment" placeholder="add comment"></textarea>'+
   			  		          '</div>'+
   			  		          '<input style="display: none;" type="text" id="lat" name="lat" value="'+coords.lat.toFixed(6)+'" />'+
   			  		          '<input style="display: none;" type="text" id="lng" name="lng" value="'+coords.lng.toFixed(6)+'" />'+
   			  				  '<input style="display: none;" type="text" id="country" name="country" value="ALL" />'+
   			  		          '<div class="form-group">'+
   			  		            //'<div style="text-align:center;" class="col-xs-4 col-xs-offset-2"><button type="button" class="btn">Cancel</button></div>'+
   			  		            '<div style="text-align:center;" class="col-xs-4"><button type="submit" value="submit" name="M2UYVd">Submit</button></div>'+
   			  		          '</div>'+
   			  		          '</form>';
   			  		          global_featureGroup.getLayers()[global_featureGroup.getLayers().length-1].bindPopup(popupContent,{
   			  		            keepInView: true, //pans to include comment
   								  closeButton: true,
   								  autoPan:true
   			  		            }).openPopup();
   			  		      });*/ 		
			
			global_map.on('draw:drawstart',function(e){
				//gl_countries.style("pointer-events","all");
				//console.log("hello");
				placeMarker = true;
				
				
			}); 						  
						  
						  //bubblingMouseEvents:true,
				     		global_map.on('draw:created', function(e) {			
								//gl_countries.style("pointer-events","all");
												  
				     			  		          var coords = e.layer._latlng;
				     			  		          global_featureGroup.addLayer(e.layer);
												  
												  var dates;
												  
												 
												  underlyingSubregion="";//ADM1_lookup.filter(function(d){return d.key == underlyingCountry;})[0].region;
											      
												
												  var checkboxIndicators = '';
												
												  if(cview){
													  //dates = c_choropleth_date;
													  console.log(country_indicators_template);
													  country_indicators_template.forEach(function(c,i){
														  if(c==c_choroplethIndicator){
															  checked = "checked='true'";
														  }else{
															  checked = "";
														  }
														  checkboxIndicators += '<br><input type="checkbox" id="indicators"'+i+'" class="indicators" name="indicators" value="'+c+'"'+checked+'> '+c.replace("_"," ").replace("_"," ")+' ';
													  });
													  
												  }else{
													  dates = choropleth_date;
													  console.log(global_indicators);
													  var checked = "";
													  global_indicators_template.forEach(function(c,i){
														  if(c==gl_choroplethIndicator){
															  checked = "checked='true'";
														  }else{
															  checked = "";
														  }
														  
														  checkboxIndicators += '<br><input type="checkbox" id="indicators"'+i+'" class="indicators" name="indicators" value="'+c+'"'+checked+'> '+c.replace("_"," ").replace("_"," ")+' ';
													  });
												  }
									
												  //zoomVal = 2;
												  
												
												
												 console.log(underlyingRegion);
												//console.log(zoomVal);
				  								//console.log(coords);
												placeMarker = false;
												
												  
				     			  				  var popupContent = '<form target="_self" onsubmit="" action="javascript: postToGoogleG()">'+
				     			  		          '<div class="form-group">'+
												  		'<strong>Flag Error</strong><br>knowledge of errors will vary, please fill out the following to the best of your knowledge.<br>(scroll down for additional form fields)<br><br>'+
												  		'<strong>Region:</strong><input type="text" id="region" name="region" value="'+underlyingRegion+'"><br>'+
												        //'<strong>Time period:</strong><input type="text" id="time" name="time"><br>'+
												  		'<br><strong>Description:</strong><br>'+
												  		'<textarea class="form-control" rows=4" cols="38" id="description" name="description" placeholder="please provide a description of the error, including any information surrounding its source and the magnitude of its impact"></textarea>'+
												  		//'<strong>Indicators:</strong><input type="text" id="indicators" name="indicators"><br>'+
														'<br><strong>Which indicator(s) does this error impact?</strong>'+
														checkboxIndicators+
												  		'<br><br><strong>Does the error seem systematic or random?</strong><br>'+
												  		'<input type="radio" id="stype1" class="stype" name="stype" value="systematic"> systematic '+
												  		'<input type="radio" id="stype2" class="stype" name="stype" value="random"> random '+
												  		'<input type="radio" id="stype3" class="stype" name="stype" value="unknown"> unknown'+
														'<br><br><strong>Error type:</strong><br>'+
												  		//'<input type="checkbox" id="type1" class="type" name="type" value="inconsistency"> <strong>Inconsistency:</strong> an idiosyncrasy of a specific region’s data generation pipeline, or a characteristic of the pipeline that varies across countries.<br>'+
  														//'<input type="checkbox" id="type2" class="type" name="type" value="greydata"> <strong>Grey data:</strong> reputed data that is omitted at some stage of the data generation pipeline.<br>'+ 
												  		//'<input type="checkbox" id="type3" class="type" name="type" value="adjustment"> <strong>Retrospective adjustments:</strong>  downstream updates to previously reported data.<br>'+
												  		'<input type="checkbox" id="type1" class="type" name="type" value="inconsistency"> errors due to inconsistencies in data acquisition or reporting across regions (e.g. indicator definitions), or to region-specific factors/events <br>'+
  														'<input type="checkbox" id="type2" class="type" name="type" value="greydata"> unofficial data/data omitted at some stage of the surveillance system (detection,recording, collection...etc) <br>'+ 
												  		'<input type="checkbox" id="type3" class="type" name="type" value="adjustment"> errors due to updates made retrospectively to the data'+
														'<br><br><strong>Which stage(s) of the surveillance system does this error impact?</strong><br>'+
												  		'<input type="checkbox" id="pipeline1" class="pipeline" name="pipeline" value="detection"> detection '+
  														'<input type="checkbox" id="pipeline2" class="pipeline" name="pipeline" value="recording"> recording '+ 
												  		'<input type="checkbox" id="pipeline3" class="pipeline" name="pipeline" value="collection"> collection '+
  														'<input type="checkbox" id="pipeline4" class="pipeline" name="pipeline" value="processing"> processing '+ 
												 	 	'<input type="checkbox" id="pipeline5" class="pipeline" name="pipeline" value="reporting"> reporting'+ 
												  		'<br><br><strong>How would you adjust the official data to reflect this?</strong><br>'+
												  		'<input type="radio" id="how1" class="how" name="how" value="higher">value(s) should be <strong>higher</strong><br> '+
												  		'<input type="radio" id="how2" class="how" name="how" value="lower">value(s) should be <strong>lower</strong><br>'+
												  		'<input type="radio" id="how3" class="how" name="how" value="unknown"><strong>unknown</strong><br>'+
												  		'<br><br><strong>How certain are you of the existence of this error?</strong><br>'+
												  		'<input type="radio" id="certainty1" class="certainty" name="certainty" value="low">just a hunch<br> '+
												  		'<input type="radio" id="certainty2" class="certainty" name="certainty" value="medium">fairly certain, but do not have all the details<br>'+
												  		'<input type="radio" id="certainty3" class="certainty" name="certainty" value="high">certain<br>'+
				     			  		          '</div>'+
				     			  		          '<input style="display: none;" type="text" id="lat" name="lat" value="'+coords.lat.toFixed(6)+'" />'+
				     			  		          '<input style="display: none;" type="text" id="lng" name="lng" value="'+coords.lng.toFixed(6)+'" />'+
												  '<input style="display: none;" type="text" id="time" name="time" value="tmp" />'+
												  '<input style="display: none;" type="text" id="zoom" name="zoom" value="'+zoomVal+'" />'+
												  '<input style="display: none;" type="text" id="zoomLevel" name="zoomLevel" value="'+zoomLevel+'" />'+
												  '<input style="display: none;" type="text" id="ucountry" name="ucountry" value="tmp" />'+
												  '<input style="display: none;" type="text" id="usubregion" name="usubregion" value="'+underlyingSubregion+'" />'+
				     			  		          '<div class="form-group">'+
				     			  		            '<div style="text-align:center;" class="col-xs-4"><button type="submit" value="submit" name="M2UYVd">Submit</button></div>'+
				     			  		          '</div>'+
				     			  		          '</form>';
				     			  		          global_featureGroup.getLayers()[global_featureGroup.getLayers().length-1].bindPopup(popupContent,{
				     			  		            keepInView: true, //pans to include comment
				     								  closeButton: true,
				     								  autoPan:true,
													  autoPanPadding:[100,0]
													  //autoClose:false
													  //minWidth:325
				     			  		            }).openPopup();
				     			  		      }); 							  
						  
						  
   		 global_map.on('viewreset', gl_reset);
   		 global_map.on('zoom',gl_reset);
		 
		 function gl_reset(){
			 var cZoom = global_map.getZoom();
			 if(cview){
				 console.log("yep");
				 regions.style("opacity",gl_op);
				 regions.style("pointer-events","all");
 				if(cZoom >= countryZoomVal+0.5 && subregions != null){
 						subregions.style("opacity",gl_op); 
 						subregions.style("pointer-events","all");
 						regions.style("stroke-width",2);
 						regions.style("pointer-events","none");
 				}else if(zoomVal > cZoom){
 					if(cZoom < countryZoomVal+0.5 && subregions != null){
 						subregions.style("opacity",0);
 						subregions.style("pointer-events","none");
 						regions.style("stroke-width",0.25);
 						regions.style("pointer-events","all");
 					}
 				}
			 	
			 }else if(gview){
			 	
			 }else if(rview){
			 	
				
			 }
			 
			 zoomVal = global_map.getZoom();
			 
		    var bounds = global_path.bounds(geodata_admin0),//country_adm1_features[0]),
				 topLeft = bounds[0],
				 bottomRight = bounds[1];
				 global_svg.attr("width", bottomRight[0] - topLeft[0])
				        .attr("height", bottomRight[1] - topLeft[1])
				        .style("left", topLeft[0] + "px")
				        .style("top", topLeft[1] + "px");  
			 
	  		global_features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");	  
	  		global_land.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	 		global_subregions.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	  		gl_countries.attr('d',global_path);
	 		gl_subregions.attr('d',global_path);
	 		discrepancy_points.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	 		d_points.attr("transform",function(d){
	 				return "translate("+global_map.latLngToLayerPoint(d.LatLng).x+","+global_map.latLngToLayerPoint(d.LatLng).y+")";
	 			});
		
	  		
			global_bcharts.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	  		global_labels.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	  		global_bcharts.selectAll("g").attr("transform", function(d) { return "translate(" +global_path.centroid(d)+ ")";});
			//global_labels.selectAll("text").attr("x", function(d) { return global_path.centroid(d)[0];});
	  		//global_labels.selectAll("text").attr("y", function(d) { return global_path.centroid(d)[1]+5;});
	  		  
	 		if(regions!=null){
	 		features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	 		regions.attr('d',global_path);
	 		awards_shp.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	 		efforts.attr('d',global_path);
	 		subfeatures.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	 		subregions.attr('d',global_path);
			}
		 }
		 
		 
		 
 		function gl_reset2() {
			
			if(commentsCheckbox.property("checked")){
			d3.select("#discrepancyView").style("opacity",1);
			d3.select("#discrepancyView").style("pointer-events","all");
			}
			
			//var g = 1;
 			//var c = 0;
			var sc = 0;
 			var cZoom = global_map.getZoom();
			var subregionalZoomVal = 3.75;
			//console.log(cZoom);
			//console.log(global_map.getCenter());
		
 			if(cZoom >= countryZoomVal){
				_g=0;
				_c=1;
				_r=0;
				zoomLevel = 3;
				if(zoomVal < cZoom){
				cview = true;
				rview = false;
				gview = false;	
 				gl_countries.style("opacity",0);
				global_bcharts.style("opacity",0);
				d3.select("#gl_chartview").style("opacity",0);
				d3.select("#gl_chartview").style("pointer-events","none");
				/*d3.select("#gl_awardview").style("opacity",0);
				d3.select("#gl_awardview").style("pointer-events","none");
				d3.select("#gl_awardview").style("opacity",0);
				d3.select("#gl_awardview").style("pointer-events","none");
				d3.select("#gl_awardview").style("opacity",0);
				d3.select("#gl_awardview").style("pointer-events","none");*/
				
				/*if(ht){
				glegend_ht.remove();
				clegend_ht.addTo(global_map);
				}else{
					glegend.remove();
					clegend.addTo(global_map);
				}*/
					legend_all.remove();
					gl_update_legends();	
				
				d3.select("#perTotal").style("pointer-events","all");
				d3.select("#perHT").style("pointer-events","all");
				d3.select("#commentsOn").style("pointer-events","all");
				d3.select("#commentsOff").style("pointer-events","all");
				commentsCheckbox.style("pointer-events","all");
				awardsCheckbox.style("pointer-events","all");
				
				if(regions != null)regions.style("opacity",gl_op);
				d3.select("#rsView").style("opacity",1);
				d3.select("#rsView").style("pointer-events","all");
				if(awardsOn)d3.select("#awardview").style("opacity",1);
				if(awardsOn)d3.select("#awardview").style("pointer-events","all");
				
				
				if(cZoom >= countryZoomVal+0.5 && subregions != null){
						subregions.style("opacity",gl_op); 
						subregions.style("pointer-events","all");
						regions.style("stroke-width",2);
						regions.style("pointer-events","none");
					}
				}else if(zoomVal > cZoom){
					if(cZoom < countryZoomVal+0.5 && subregions != null){
						subregions.style("opacity",0);
						subregions.style("pointer-events","none");
						regions.style("stroke-width",0.25);
						regions.style("pointer-events","all");
					}
				} //country view
 			}else if(cZoom < countryZoomVal && cZoom >= subregionalZoomVal){
				_c=0;
				_g=1;
				_r=0;
				zoomLevel = 2;
				cview = false;
				gview = true;
				rview = false;
				if(cZoom < zoomVal){
					cview = false;
 				gl_countries.style("opacity",gl_op);
				if(awardsCheckbox.property("checked"))global_bcharts.style("opacity",1);
				
				d3.select("#gl_chartview").style("opacity",1);
				d3.select("#gl_chartview").style("pointer-events","all");
				if(awardsOn)d3.select("#gl_awardview").style("opacity",1);
				if(awardsOn)d3.select("#gl_awardview").style("pointer-events","all");
				awardsCheckbox.style("pointer-events","all");
				commentsCheckbox.style("pointer-events","all");
				
				//gl_subregions.style("opacity",0);
				//gl_subregions.style("pointer-events","none");
				
				d3.select("#perTotal").style("pointer-events","all");
				d3.select("#perHT").style("pointer-events","all");
				d3.select("#commentsOn").style("pointer-events","all");
				d3.select("#commentsOff").style("pointer-events","all");
				
				/*if(ht){
				clegend_ht.remove();
				glegend_ht.addTo(global_map);
				}else{
					clegend.remove();
					glegend.addTo(global_map);
				}*/
					legend_all.remove();
					gl_update_legends();		
				
				
 				if(regions != null)regions.style("opacity",0);
				d3.select("#rsView").style("opacity",0);
				d3.select("#rsView").style("pointer-events","none");
				d3.select("#awardview").style("opacity",0);
				d3.select("#awardview").style("pointer-events","none");
				//regions.style("pointer-events",'none');
				}else{
					rview = false;
					//moving from subregional to country
					gl_subregions.style("opacity",0);
					gl_subregions.style("pointer-events","none");
					//turn on gl_countries
					gl_countries.style("opacity",gl_op);
					gl_countries.style("pointer-events","all");
					
					draw_global_chartview();
					
					/*if(ht){
					rlegend_ht.remove();
					glegend_ht.addTo(global_map);
					}else{
						rlegend.remove();
						glegend.addTo(global_map);
					}*/
						legend_all.remove();
						gl_update_legends();	
					
					
				}
 			}else if(cZoom < subregionalZoomVal){ //subregional view
				
				_c=0;
				_g=0;
				_r=1;
				zoomLevel = 1;
				cview = false;
				gview = false;
				rview = true;
				if(cZoom < zoomVal){
					gview = false;
 				gl_countries.style("opacity",0);
				gl_countries.style("pointer-events","none");
				
				gl_subregions.style("opacity",gl_op);
				gl_subregions.style("pointer-events","all");
				
				draw_global_chartview();
				
				/*if(ht){
				glegend_ht.remove();
				rlegend_ht.addTo(global_map);
				}else{
					glegend.remove();
					rlegend.addTo(global_map);
				}*/
					legend_all.remove();
					gl_update_legends();	
				
				
				}else{
					//already in subregional
				}
				
				
 			}
 			zoomVal = global_map.getZoom();
		
	
 		var bounds = global_path.bounds(geodata_admin0),//country_adm1_features[0]),
 						 topLeft = bounds[0],
 						 bottomRight = bounds[1];
 						 global_svg.attr("width", bottomRight[0] - topLeft[0])
 						        .attr("height", bottomRight[1] - topLeft[1])
 						        .style("left", topLeft[0] + "px")
 						        .style("top", topLeft[1] + "px"); 
  
		if(_g || _r){
 		global_features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");	  
 		global_land.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		global_subregions.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 		gl_countries.attr('d',global_path);
		gl_subregions.attr('d',global_path);
		discrepancy_points.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		d_points.attr("transform",function(d){
				return "translate("+global_map.latLngToLayerPoint(d.LatLng).x+","+global_map.latLngToLayerPoint(d.LatLng).y+")";
			});
		//d_points.attr("cx",function(d){return global_map.latLngToLayerPoint(d.LatLng).x;});
		//d_points.attr("cy",function(d){return global_map.latLngToLayerPoint(d.LatLng).y;});
		
 		//global_awards.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 		global_bcharts.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 		//global_bcharts.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 		global_labels.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 		global_labels.selectAll("text").attr("x", function(d) { return global_path.centroid(d)[0];});
 		global_labels.selectAll("text").attr("y", function(d) { return global_path.centroid(d)[1]+5;});
 		global_bcharts.selectAll("g").attr("transform", function(d) { return "translate(" +global_path.centroid(d)+ ")";}); 
		}
		if(_c){
		gl_countries.attr('d',global_path);
		gl_subregions.attr('d',global_path);
		features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		regions.attr('d',global_path);
		awards_shp.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		efforts.attr('d',global_path);
		discrepancy_points.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		//d_points.attr("cx",function(d){return global_map.latLngToLayerPoint(d.LatLng).x;});
		//d_points.attr("cy",function(d){return global_map.latLngToLayerPoint(d.LatLng).y;});
		
		d_points.attr("transform",function(d){
				return "translate("+global_map.latLngToLayerPoint(d.LatLng).x+","+global_map.latLngToLayerPoint(d.LatLng).y+")";
			});
		
		//clinics.attr("d",global_path.pointRadius(0.2));
		subfeatures.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
		subregions.attr('d',global_path);
		
		}
 		//console.log(zoomVal);
		}
 		
		 
	 }
   		 //global_map.on('pan',gl_reset);
		 
		 
		 
		 function changeView(){
		
			 //231
			 //from gl_reset
	    var bounds = global_path.bounds(geodata_admin0),//country_adm1_features[0]),
			 topLeft = bounds[0],
			 bottomRight = bounds[1];
			 global_svg.attr("width", bottomRight[0] - topLeft[0])
			        .attr("height", bottomRight[1] - topLeft[1])
			        .style("left", topLeft[0] + "px")
			        .style("top", topLeft[1] + "px");
			 
			 
			 
		 
			d3.select("#perTotal").style("pointer-events","all");
			d3.select("#perHT").style("pointer-events","all");
			d3.select("#commentsOn").style("pointer-events","all");
			d3.select("#commentsOff").style("pointer-events","all");
		 
			 if(cview){
				 if(marker_layers[0]!=undefined)marker_layers[0].removeFrom(global_map);
				 if(marker_layers[1]!=undefined)marker_layers[1].addTo(global_map);
				 if(marker_layers[2]!=undefined)marker_layers[2].removeFrom(global_map);
				 PAHO_global_footnotes.removeFrom(global_map);
			 	
				 if(discrepancyMode!=0){
				 	if(marker_layers[0]!=undefined)marker_layers[1].removeFrom(global_map);
				 }
				 
				 console.log("switching to sub-country view!");
				 console.log(regions);
			 
				 if(zoomLevel==2){
	  				gl_countries.style("opacity",0);
	 				global_bcharts.style("opacity",0);
	 				d3.select("#gl_chartview").style("opacity",0);
	 				d3.select("#gl_chartview").style("pointer-events","none");
					d3.select("#gl_awardview").style("opacity",0);
					d3.select("#gl_awardview").style("pointer-events","none");
				 	
				 }else if(zoomLevel==1){
					gl_subregions.style("opacity",0);
					gl_subregions.style("pointer-events","none");
	 				d3.select("#gl_chartview").style("opacity",0);
	 				d3.select("#gl_chartview").style("pointer-events","none");
					d3.select("#gl_awardview").style("opacity",0);
					d3.select("#gl_awardview").style("pointer-events","none");
				 }
			 
			 
 				if(regions != null){
					regions.style("opacity",gl_op);
					regions.style("pointer-events","all");
				}if(efforts != null){
					efforts.style("opacity",gl_op);
					efforts.style("pointer-events","all");
				}
				
				if(zoomLevel==3){
					console.log("Already");
					console.log(regions.style("opacity"));
					regions.style("opacity",gl_op);
					regions.style("pointer-events","all");
					
			 		features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
			 		regions.attr('d',global_path);
			 		awards_shp.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
			 		efforts.attr('d',global_path);
			 		subfeatures.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
			 		subregions.attr('d',global_path);
					
				}
				
				
					d3.select("#rsView").style("opacity",1);
					d3.select("#rsView").style("pointer-events","all");
					if(awardsOn)d3.select("#awardview").style("opacity",1);
					if(awardsOn)d3.select("#awardview").style("pointer-events","all");
		 	
				zoomLevel = 3;
				
				//legend_all.remove();
				//update_c_choropleths();
				//gl_update_legends();
				
				//update d_points
				//if(discrepancyMode!=0){
					d_points.each(function(d){
						if(d.dataObj.zoomLevel==3){
							d3.select(this).style("opacity",1);
							d3.select(this).style("pointer-events","all");
						}else{
							d3.select(this).style("opacity",0);
							d3.select(this).style("pointer-events","none");
						}
						
					});
					//}
				
			
			 }else if(gview){
				 
				 global_map.setView([-15, -50], 3.75);
				 
				 console.log("switching to country view!");
				 if(marker_layers[0]!=undefined)marker_layers[0].addTo(global_map);
				 if(marker_layers[1]!=undefined)marker_layers[1].removeFrom(global_map);
				 if(marker_layers[2]!=undefined)marker_layers[2].removeFrom(global_map);
				 PAHO_global_footnotes.addTo(global_map);
				 
				 if(discrepancyMode!=0){
				 	if(marker_layers[0]!=undefined)marker_layers[0].removeFrom(global_map);
					PAHO_global_footnotes.removeFrom(global_map);
				 }
			
					if(zoomLevel==3){
				//if moving from sub-national level 
	 				gl_countries.style("opacity",gl_op);
				
					d3.select("#gl_chartview").style("opacity",1);
					d3.select("#gl_chartview").style("pointer-events","all");
					if(awardsCheckbox.property("checked"))global_bcharts.style("opacity",1);
					if(awardsOn)d3.select("#gl_awardview").style("opacity",1);
					if(awardsOn)d3.select("#gl_awardview").style("pointer-events","all");
			
	 				if(regions != null){
						console.log("yes");
						regions.style("opacity",0);
						regions.style("pointer-events","none");
					}if(subregions !=null){
						subregions.style("opacity",0);
						subregions.style("pointer-events","none");
					}if(efforts != null){
						console.log("yes");
						efforts.style("opacity",0);
						efforts.style("pointer-events","none");
					}
					
					d3.select("#rsView").style("opacity",0);
					d3.select("#rsView").style("pointer-events","none");
					d3.select("#awardview").style("opacity",0);
					d3.select("#awardview").style("pointer-events","none");
				
				}else if(zoomLevel==1){
				//if moving from regional level 
						gl_subregions.style("opacity",0);
						gl_subregions.style("pointer-events","none");
						gl_countries.style("opacity",gl_op);
						gl_countries.style("pointer-events","all");
						
					}
			
				//update zoomLevel
				zoomLevel=2;  
				draw_global_chartview();
				
				legend_all.remove();
				gl_update_legends();
				
				
				//if(discrepancyMode!=0){
					d_points.each(function(d){
						if(d.dataObj.zoomLevel==2){
							d3.select(this).style("opacity",1);
							d3.select(this).style("pointer-events","all");
						}else{
							d3.select(this).style("opacity",0);
							d3.select(this).style("pointer-events","none");
						}
						
					});
					//}
		 	
			 }else if(rview){
				console.log("switching to regional view!");
				
				 if(marker_layers[0]!=undefined)marker_layers[0].removeFrom(global_map);
				 if(marker_layers[0]!=undefined)marker_layers[1].removeFrom(global_map);
				 if(marker_layers[0]!=undefined)marker_layers[2].addTo(global_map);
				 PAHO_global_footnotes.removeFrom(global_map);
				 
				 if(discrepancyMode!=0){
				 	if(marker_layers[0]!=undefined)marker_layers[2].removeFrom(global_map);
				 }
				
				global_map.setView([-15, -50], 3.75);
				 
	 			gl_subregions.style("opacity",gl_op);
	 			gl_subregions.style("pointer-events","all");
			 
			 
				 if(zoomLevel==3){
	 				d3.select("#gl_chartview").style("opacity",1);
	 				d3.select("#gl_chartview").style("pointer-events","all");
	 				if(awardsCheckbox.property("checked"))global_bcharts.style("opacity",1);
					if(awardsOn)d3.select("#gl_awardview").style("opacity",1);
	 				if(awardsOn)d3.select("#gl_awardview").style("pointer-events","all");
				
					//if(regions != null)regions.style("opacity",0);
					
	 				if(regions != null){
						regions.style("opacity",0);
						regions.style("pointer-events","none");
					}if(subregions !=null){
						subregions.style("opacity",0);
						subregions.style("pointer-events","none");
					}if(efforts != null){
						efforts.style("opacity",0);
						efforts.style("pointer-events","none");
					}
					
	  				d3.select("#rsView").style("opacity",0);
	  				d3.select("#rsView").style("pointer-events","none");
	  				d3.select("#awardview").style("opacity",0);
	  				d3.select("#awardview").style("pointer-events","none"); 
			 	
				 }else if(zoomLevel==2){
	  				gl_countries.style("opacity",0);
	 				gl_countries.style("pointer-events","none");
				 }
			 
				 
			 
				 zoomLevel = 1;
				 draw_global_chartview();
				 
 				legend_all.remove();
 				gl_update_legends();
				
				//if(discrepancyMode!=0){
					d_points.each(function(d){
						console.log(d);
						if(d.dataObj.zoomLevel==1){
							d3.select(this).style("opacity",1);
							d3.select(this).style("pointer-events","all");
						}else{
							d3.select(this).style("opacity",0);
							d3.select(this).style("pointer-events","none");
						}
						
					});
					//}
				
			 }
		 }		 
	 
	 
//draw global mapview
		 function draw_subRegional_mapview(){
		 global_subregions = global_svg.append("g")
      	   	.attr("class","gl_subland")
  			 .attr("id","gl_subregions");
			 
			 //console.log(subregions_shapes);
			 
		gl_subregions = global_subregions.selectAll("path")
			 .data(subregions_shapes)
			 .enter()
			 .append("path")
			 .attr("d",global_path)
			 .attr("id",function(d){return "gl_region"+d.properties.SUBREGION.replace(" ","");})
			 //.style("stroke-width",2)
			 .attr("basecolor", function(d){
	 			var c = regionalData.filter(function(v){return v.key == d.properties.SUBREGION;})[0].values;
	 			if(c[0] != undefined){
	 				if(ht){
	 				return regional_choropleth_ht(c[c.length-1].value.autochthonous_cases_confirmed/(c[c.length-1].value.pop_x_1000));	
	 					//return choropleth_global_ht(c[0].autochthonous_cases_confirmed/(c[0].pop_x_1000));
	 				}else{
						//console.log(c[c.length-1]);
						//console.log(regional_choropleth(c[c.length-1].value.autochthonous_cases_confirmed));	
	 				return regional_choropleth(c[c.length-1].value.autochthonous_cases_confirmed);	
	 				//return choropleth_global(c[0].autochthonous_cases_confirmed);
	 				}
	 			}else{
	 				return "rgb(220,220,220)";
	 			}
			})
			 .style("fill",function(d){return d3.select(this).attr("basecolor");})
			 .on("mouseover",function(d){
				 d3.select(this).style("fill","grey");
				 filtercharts(d);
			 })
			 .on("mouseout",function(d){
				 d3.select(this).style("fill",function(d){return d3.select(this).attr("basecolor");});
				 restorecharts();
			 })
 			.on("click",function(d){
				if(placeMarker){
	 				console.log(d);
	 				underlyingRegion = d.properties.SUBREGION;
	 				underlyingCountry = "";
	 			}
 			});
			 
			 gl_subregions.style("opacity",0);
			 gl_subregions.style("pointer-events","none");
			 
		 }	 
		 
		 
	 function draw_global_mapview(){
	 	//countries
 	 	var gl_regions;
 	 	var gl_efforts;
		
		
  global_svg = d3.select(global_map.getPanes().overlayPane).append("svg")
  	.attr("class","gl_mapview")
	  .attr("pointer-events","visible")
      .attr("width", gl_width-1)
	  .attr("height", gl_height-1);
  //var g = global_svg.append("g").attr("class", "leaflet-zoom-hide");  

  //Group for the map features
  global_land = global_svg.append("g")
      .attr("class","gl_land")
  	.attr("id","gl_regions");

  //Group for the map features
  global_features = global_svg.append("g")
      .attr("class","gl_features");

  //Group for the map features
  global_awards = global_svg.append("g")
  	.attr("class","gl_awards");		

  global_bcharts = global_svg.append("g")
  	.attr("class","gl_bcharts");	

  	global_labels = global_svg.append("g");	
		
		
		
		var vv2 = geodata_admin0.features.filter(function(d){return priority_countries.indexOf(d.properties.ADMIN) != -1;});
		
		
	  gl_countries = global_land.selectAll("path")
	      //.data(geodata_admin0.features.filter(function(d){return d.properties.CONTINENT == "North America" || d.properties.CONTINENT == "South America" || d.properties.CONTINENT == "Central America"; })) //generate features from TopoJSON
	  	.data(vv2)
		.enter()
	      .append("path")
	      .attr("id",function(d){return "gl_country"+d.properties.ADM0_A3;})
		//.attr("id",function(d){ console.log("m"); console.log(d); return "gl_country"+d.properties.ADMIN;})
	      .attr("class","country_paths")
	    .attr("d",global_path)
		.attr("selected",0)
		.attr("opacity",gl_op)
		.attr("basecolor",function(d){
			//if(priority_countries.indexOf(d.properties.ADMIN)==-1){return "rgb(220,220,220)";}
			var c = globaldata.filter(function(v){return v.country == d.properties.ADMIN;});
			if(priority_countries.indexOf(d.properties.ADMIN)!=-1){
			if(c[0] != undefined){
				//c.sort(function(a,b){return a.date - b.date;})
				//console.log(d.properties.ADMIN);
				//console.log(d.properties.ADM0_A3);
				//console.log(d.properties.ADMIN);
				//console.log(c);
				if(ht){
				return global_choropleth_ht(c[c.length-1][gl_choroplethIndicator]/(c[c.length-1].pop_x_1000));	
					//return choropleth_global_ht(c[0].autochthonous_cases_confirmed/(c[0].pop_x_1000));
				}else{
				return global_choropleth(c[c.length-1][gl_choroplethIndicator]);	
				//return choropleth_global(c[0].autochthonous_cases_confirmed);
				}
			}else{
				return "rgb(220,220,220)";
			}
			}	
		})
		.style("fill", function(d){return d3.select("#gl_country"+d.properties.ADM0_A3).attr("basecolor");})
		.style("pointer-events","all")
		.on("mouseover",function(d){
			//console.log(d);
			if(d3.select(this).attr("selected")==0 && !gl_selection){
			if(priority_countries.indexOf(d.properties.ADMIN)!=-1){
			//d3.select(this).style("fill",hover_color);
			d3.select(this).style("stroke-width",2);
			d3.select("#gl_scatter"+d.properties.ADMIN).moveToFront().style("stroke-width",2);
			filtercharts(d);
			}
		}
		})
		.on("mouseout",function(d){
			if(d3.select(this).attr("selected")==0 && !gl_selection){
			if(priority_countries.indexOf(d.properties.ADMIN)!=-1){
			//d3.select(this).style("stroke-width","0.25");	
			d3.select(this).style("stroke-width",0.25);
			/*d3.select(this).style("fill",function(d){
				//return d3.select("#gl_country"+d.properties.ADMIN).attr("basecolor");
				return d3.select("#gl_country"+d.properties.ADM0_A3).attr("basecolor");
			})*/
			d3.select("#gl_scatter"+d.properties.ADMIN).style("stroke-width",0);
			restorecharts();
			}
			}
		})
		/*.on("dblclick", function(d){
			if(priority_countries.indexOf(d.properties.ADMIN)!=-1 && got_data.indexOf(d.properties.ADMIN)!=-1){
				
				d3.select("#global_container").style("pointer-events","none");
				//global_featureGroup.bringToBack();
				filtercharts(d);
				
				ADM0 = 	d.properties.ADM0_A3;
				//d3.select("#"+d.properties.ADMIN.replace(" ","_")+"_0").dispatch("click");
				//console.log("#"+d.properties.ADMIN+"_0");
				console.log("setting country");
				
				cview = true;
				
				setCountry(ADM0);
			//d3.select("#popup").moveToFront();
			//hideGlobalFootnotes();
			}
		})*/
		.on("click",function(d){
			d3.event.preventDefault();
			//console.log("yay!!!");
			//only allowing one selection at a time to start.
			//console.log(d);
			if(placeMarker){
				console.log(d);
				underlyingRegion = d.properties.NAME;
				underlyingCountry = d.properties.NAME;
				//underlyingSubregion = d.properties.SUBREGION;
				//console.log(underlyingRegion);
			}else{
			
		  if(priority_countries.indexOf(d.properties.ADMIN)!=-1){
				
				
		  if(d3.select(this).attr("selected")==0){
			  //turn off any other selection
			  if(gl_selection_id != "" && d3.select("#"+gl_selection_id).attr("selected")==1){
  				d3.select("#"+gl_selection_id).style("fill",function(d){
  					//return d3.select("#gl_country"+d.properties.ADMIN).attr("basecolor");
  					return d3.select("#gl_country"+d.properties.ADM0_A3).attr("basecolor");
  				})
  				d3.select("#gl_scatter"+d.properties.ADMIN).style("stroke-width",0);
  				restorecharts();
  				d3.select("#"+gl_selection_id).attr("selected",0);	
			  }
			  //end turn off other selection
			  
			  
			  gl_selection = true;
			  gl_selection_id = d3.select(this).attr("id"); 	
			d3.select(this).style("fill",hover_color);
			d3.select("#gl_scatter"+d.properties.ADMIN).moveToFront().style("stroke-width",2);
			filtercharts(d);
			d3.select(this).attr("selected",1);
			}else if(d3.select(this).attr("selected")==1){	
			 gl_selection = false;  	
				d3.select(this).style("fill",function(d){
					//return d3.select("#gl_country"+d.properties.ADMIN).attr("basecolor");
					return d3.select("#gl_country"+d.properties.ADM0_A3).attr("basecolor");
				})
				d3.select("#gl_scatter"+d.properties.ADMIN).style("stroke-width",0);
				restorecharts();
			d3.select(this).attr("selected",0);
			gl_selection_id = "";
			}
		  }
	  	}  
		});
		
		
		//console.log(geodata_admin0.features);
		
		var vv = geodata_admin0.features.filter(function(d){return priority_countries.indexOf(d.properties.ADMIN) != -1;});
		//console.log(vv);
		
		var gl_labels = global_labels.selectAll("text")
		//.data(geodata_admin0.features)
		.data(vv)
		.enter()
		.append("text")
		.attr("class","gl_labels")
		.attr("id",function(d){return "label_"+d.properties.ADMIN;})
		.attr("x",function(d){
					return global_path.centroid(d)[0];
		})
		.attr("y",function(d){
			/*if(country_labels.filter(function(z){return z.country == d.properties.ADMIN;})[0]!=undefined){
			return global_path.centroid(d)[1]+3+country_labels.filter(function(z){return z.country == d.properties.ADMIN;})[0].dy;
		}else{
			return global_path.centroid(d)[1];
		}*/
				return global_path.centroid(d)[1];
		})
		//.attr("y",function(d){return global_path.centroid(d)[1]+3;})
		.text(function(d){
			return "";
			//return d.properties.ADMIN.replace("and","&");
			/*if(d.properties.ADMIN == "Saint Vincent and the Grenadines"){
				//console.log("yep...");
				return "Saint Vincent &"+"<br/>"+"the Grenadines"; 
				}else{
					return d.properties.ADMIN.replace("and","&");
				}*/
		})
		//.attr("length",function(d){
		//	return d3.select(this).getComputedTextLength();
		//})
		.on("mouseover",function(d){
			d3.select(this).attr("cursor","pointer");
			return d3.select("#gl_country"+d.properties.ADM0_A3).dispatch("mouseover");})
		.on("mouseout",function(d){
			d3.select(this).attr("cursor","default");
			return d3.select("#gl_country"+d.properties.ADM0_A3).dispatch("mouseout");});//trigger hover country

		//barcharts
		 var pp = global_bcharts.selectAll("g")
		  .data(vv)
		  .enter().append("g")
		  .attr("id",function(d){return "gl_bchart_"+d.properties.ADMIN})
		  .attr("transform", function(d) {//console.log(d.geometry.coordinates); 
			  if(d.properties.ADMIN == "Dominican Republic"){
				  var cc = global_path.centroid(d);
				  //console.log(cc);
				  return "translate(" +global_path.centroid(d)+ ")";//"translate(["+(cc[0]+100)+","+cc[1]+"])";
			  }else{
				  return "translate(" +global_path.centroid(d)+ ")";
				  }	  
		  		});  
				
			//add Caribbean	
	  		  /*global_bcharts.append("g")
	  		  .attr("id","gl_bchart_ES_Caribbean")
				.attr("transform", "translate(425,228)");*/
				
				
				var sz = 7;
				var r = 5;
		
		/*var lbs = gl_labels.nodes();
		
		var lbs = gl_labels.nodes();
		for(var i = 0; i < lbs.length;i++){
			console.log(lbs[i]);
			console.log(lbs[i].getComputedTextLength());
		}*/
		
		gl_symbols = pp.selectAll("svg")  
		  .data(function(d){
			  if(partnersbyCountrybyLinebyPartner.filter(function(v){return v.key == d.properties.ADMIN;})[0]!=undefined){
			  return partnersbyCountrybyLinebyPartner.filter(function(v){return v.key == d.properties.ADMIN;})[0].values;
		  	}else{
		  		return [];
		  	}
		  })
		  .enter()
		  .append("path")
		  .attr("d",d3.symbol().size(49).type(function(d){
			  //console.log(d);
			  if(d.key=="Programming level"){
				  return d3.symbolCircle;
			  }else if(d.key=="Research and Innovation"){
				  return d3.symbolStar;
			  }else{
				  return d3.symbolSquare;
			  }
		  }))	  	  	  
		  .attr("transform",function(d,i,j){//
			  var nm = j[i].parentNode.id.replace("gl_bchart_","");
			  var lb = country_labels.filter(function(z){return z.country == nm;})[0];
			  
			  var x = i*(sz+0.5)+sz/2+country_labels.filter(function(z){return z.country == nm;})[0].dx;	
			  var y = -sz-3+country_labels.filter(function(z){return z.country == nm;})[0].dy;
			  
			  if(lb.inline==true){
				 //x += nm.replace("and","&").length*5;
				 
				 //var lngth = d3.select("#label_"+nm).getBBox();
				  
				  x += lb.lngth;//nm.replace("and","&").length*5;
				  
				  y += sz+3;
			  }
			  
			  var cx = r/2+country_labels.filter(function(z){return z.country == nm;})[0].dx;
			  var cy = -r*2-15+country_labels.filter(function(z){return z.country == nm;})[0].dy;
			  
			  var sx = 5+country_labels.filter(function(z){return z.country == nm;})[0].dx;
			  var sy = 10+country_labels.filter(function(z){return z.country == nm;})[0].dy;	
			  
			  if(d.key=="Programming level"){
				  return "translate("+x+","+y+")";
			  }else if(d.key=="Research and Innovation"){
				  return "translate("+(x+7)+","+y+")";
			  }else{
				  return "translate("+(3+x)+","+y+")";	
			  }  
				  
		  })
		  .style("fill",function(d,i){
			  if(d.key == "SBCC"){return bchart_colors[0];}
			  if(d.key == "Service Delivery"){return bchart_colors[1];}
			  if(d.key == "Vector Control"){return bchart_colors[2];}
			  if(d.key == "Community Engagement"){return bchart_colors[3];}
			  if(d.key == "Research and Innovation"){return bchart_colors[4];}
			  if(d.values[0].key == "Full Programming"){return level_colors[0];}
			  if(d.values[0].key == "Moderate Programming"){return level_colors[1];}
			  if(d.values[0].key == "Limited/Community Programming"){return level_colors[2];}
			  if(d.values[0].key == "Research Collaborative"){return level_colors[3];}
		  })
		  .style("stroke","none")
		  .style("stroke-weight",0.25);
		 
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  var choropleth_date_formatted = formatDate(choropleth_date);
		  
		  
		  /*footnote_symbols = pp.selectAll("svg")
		  .data(function(d){
			 return globalbycountry.filter(function(e){return e.key == d.properties.ADMIN;});
		  })
		  .enter()
		  .append("text")
		  .text(function(d){
			  var formatDate = d3.timeFormat("%m/%e/%y");
			  var dd = d.values.filter(function(e){return formatDate(e.date)==choropleth_date_formatted;});
			  if(dd[0].footnotes[0]!=undefined){
				  return "";//"*";
			  }else{
				  return "";
			  }
		  })
		  .attr("class","footnoteSymbol")
		  .attr("transform",function(d,i){
			  var lb = country_labels.filter(function(z){return z.country == d.key;})[0];
			  //return "translate("+(lb.dx-8)+","+(lb.dy+5)+")";})
			  return "translate(-8,5)";})
		  .style("fill","black")
	      .on("mouseover",function(d){
			  //console.log(d);
	      });
		  
		  footnote_symbols.append("title")
		  .html(function(d){
			  var formatDate = d3.timeFormat("%m/%e/%y");
			  var dd = d.values.filter(function(e){return formatDate(e.date)==choropleth_date_formatted;});
			  //console.log(dd);
		   if(dd[0].footnotes[0]!=undefined){
			  var txt = "";
		  	  dd[0].footnotes[0].forEach(function(e,i){
		  		txt += e.date+": "+e.note+"<br />";
		  	});
			return txt;
			}
		  })  */
			  
		  var dd = partnersbyCountrybyLinebyPartner.filter(function(v){return v.key == "E/S Caribbean";})[0].values;
		  //console.log(dd);
		  
		  
		  
		  
		  //***********append caribbean bchart**********
		 
		  
		  /*d3.select("#gl_bchart_ES_Caribbean").selectAll("svg")
		  .data(dd)
		  .enter()
		  .append("path")
		  .attr("d",d3.symbol().size(49).type(function(d){
			  //console.log(d);
			  if(d.key=="Programming level"){
				  return d3.symbolCircle;
			  }else if(d.key=="Research and Innovation"){
				  return d3.symbolStar;
			  }else{
				  return d3.symbolSquare;
			  }
		  }))	  	  	  
		  .attr("transform",function(d,i){//
			  var nm = "E/S Caribbean";
			  var x = i*(sz+0.5)+sz/2+country_labels.filter(function(z){return z.country == nm;})[0].dx;	
			  var y = -sz-3+country_labels.filter(function(z){return z.country == nm;})[0].dy;
			  
			  var cx = r/2+country_labels.filter(function(z){return z.country == nm;})[0].dx;
			  var cy = -r*2-15+country_labels.filter(function(z){return z.country == nm;})[0].dy;
			  
			  var sx = 5+country_labels.filter(function(z){return z.country == nm;})[0].dx;
			  var sy = 10+country_labels.filter(function(z){return z.country == nm;})[0].dy;	
			  if(d.key=="Programming level"){
				  return "translate("+x+","+y+")";
			  }else if(d.key=="Research and Innovation"){
				  //return "translate("+sx+","+sy+")scale(0.8)";
				  return "translate("+(x+7)+","+y+")";
			  }else{
				  return "translate("+(3+x)+","+y+")";	
			  }  
				  
		  })
		  .style("fill",function(d){
			  if(d.key == "SBCC"){return bchart_colors[0];}
			  if(d.key == "Service Delivery"){return bchart_colors[1];}
			  if(d.key == "Vector Control"){return bchart_colors[2];}
			  if(d.key == "Community Engagement"){return bchart_colors[3];}
			  if(d.key == "Research and Innovation"){return bchart_colors[4];}
			  if(d.values[0].key == "Full Programming"){return level_colors[0];}
			  if(d.values[0].key == "Moderate Programming"){return level_colors[1];}
			  if(d.values[0].key == "Limited/Community Programming"){return level_colors[2];}
			  if(d.values[0].key == "Research Collaborative"){return level_colors[3];}
		  })
		  .style("stroke","none")
		  .style("stroke-weight",0.25);
		  
		  
  		global_labels.append("text")
  		.attr("class","gl_labels")
  		.attr("x",425)
  		.attr("y",230)
  		.text("E/S Caribbean")
  		.on("mouseover",function(){
			CR_ADM0.forEach(function(d){
				return d3.select("#gl_country"+d).style("fill",hover_color);
			});
			d3.select(this).attr("cursor","pointer");
			filterCaribbean();
  		})
  		.on("mouseout",function(){
			CR_ADM0.forEach(function(d){
				d3.select("#gl_country"+d).style("fill",function(){
					return d3.select("#gl_country"+d).attr("basecolor");
				});
			});
			d3.select(this).attr("cursor","default");
			restorecharts();
		});//trigger hover country*/
		  
		//draw_global_legend();
		draw_global_awards(partnersbyLinebyPartner);
		
		 
	}	//end draw country mapview 
	
	function draw_global_legend(){
		
		glegend = L.control({position: 'bottomleft'});
		
		var formatDate = d3.timeFormat("%m/%e/%y");

		glegend.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info legend'),
		        grades = [0, 1, 10, 50, 100, 500, 1000, 5000, 10000,13000],
			labels = ['<strong> Cumulative Zika cases<br>As Of: '+formatDate(choropleth_date)+'</strong>'],
			from, to;
				for (var i = 0; i < grades.length; i++) {
				        from = grades [i];
				        to = grades[i+1]-1;

				    labels.push(
				        '<i style="background:' + country_choropleth(from + 1) + '"></i> ' +
				        from + (to ? '&ndash;' + to : '+'));
				        }
				        div.innerHTML = labels.join('<br>');	

		    return div;
		};

		glegend.addTo(global_map);
	}
	
	
	function draw_global_MessageBoard(){
		//console.log("globalMessageBoard");
		d3.select("#gl_messageBoard").selectAll("*").remove();
		
		var postsG = d3.select("#gl_messageBoard").append("g");
		
		//if(comments_data==undefined){initComments();}
		//console.log(comments_data);
		
		
		
		var filteredCommentsG = comments_data.filter(function(d){return d.country=="all";});
		
		var pdivs = postsG.selectAll("div")
		.data(filteredCommentsG)
		.enter()
		.append("div")
		.attr("class","postsC")
		.attr("id", function(d,i){return "g_post_"+i;})
		.style("background", function(d,i){if(i%2==0){return "#dae4ed";}else{ return "none";}});
		
		pdivs.append("text")
		.html(function(d){return "<font color=\"#4e677c\">"+d.username+"</font>" + ": "+ d.comment;})
		.attr("x","0px")
		.attr("y","20px")
		.attr("class", "postText");
		
		
		/*var posts=feed.selectAll("div")
		.data(comments_data)
		.enter().append("div")
		.attr("class","post");
		
		posts.append("text")
		.text(function(d){return d.username + ": "+ d.comment;})
		.attr("class", "postText");*/
		
		//d3.select("#gl_messageBoard").attr("transform", "translate(0,100)");
	}
	
	
	function update_global_MessageBoard(new_comments_data){
		console.log("globalMessageBoard");
		
		comments_data = new_comments_data;
		
		d3.select("#gl_messageBoard").selectAll("*").remove();
		
		var postsG = d3.select("#gl_messageBoard").append("g");
		
		var filteredCommentsG = new_comments_data.filter(function(d){return d.country=="all";});
		
		var pdivs = postsG.selectAll("div")
		.data(filteredCommentsG)
		.enter()
		.append("div")
		.attr("class","postsC")
		.attr("id", function(d,i){return "g_post_"+i;})
		.style("background", function(d,i){if(i%2==0){return "#dae4ed";}else{ return "none";}});
		
		pdivs.append("text")
		.html(function(d){return "<font color=\"#4e677c\">"+d.username+"</font>" + ": "+ d.comment;})
		.attr("x","0px")
		.attr("y","20px")
		.attr("class", "postText");
		
	}
	
	function draw_global_MessageForm(){
		
		/*if(wait){
			console.log("waiting for database to update");
			wait = false;	
			setTimeout(function(){
				retrieveComments(update_global_MessageBoard);
			},1000);
			//setTimeout(draw_global_MessageBoard,200);
		}else{
		//retrieveComments(); 
		}*/
		d3.select("#gl_postMessage").selectAll("*").remove(); 
				  
				var form = d3.select("#gl_postMessage").append("form")
				.attr("id","gl_postComment");
				
				form.append("textarea")
				.attr("name","comment")
				.style("width","385px")
				.style("height","30px")
				.style("background","rgba(250,250,250,0.75)")
				.attr("placeholder","submit comment, (e.g.\"significant data missing from...\")");
	
				form.append("input")
				.attr("name","username")
				.attr("type","text")
				.style("background","rgba(250,250,250,0.75)")
				.attr("placeholder","username");
				
				form.append("input")
				.attr("name","country")
				.attr("type","hidden")
				.attr("value","all");
				
				form.append("button").attr('type', 'submit').attr("id","submit-global-form").text('post');	
				
				
				$("#submit-global-form").on("click", function(e){
					e.preventDefault();
				    var jqxhr = $.ajax({
				      url: 'https://script.google.com/macros/s/AKfycbyCpuPg6s5sqEAatoRYIRHygF-VV6Zx-PJU9pEAeXCrAQyrZkEx/exec',
				      method: "GET",
				      dataType: "json",
				      data: $('form#gl_postComment').serializeObject()
				    }).success(
				      // do something
				    );
					
					setTimeout(function(){
						retrieveComments(update_global_MessageBoard,comments_data.length);
					},150);
					
					draw_global_MessageForm();
					
					//updateMessageBoard();
					//wait = true;
					//draw_global_MessageForm();
					
			});
				   
			
		
	}
	
	
	function filtercharts(d){
		//console.log(d);
		//console.log(globalbycountry);
		//filter charts
		if(zoomLevel==2){
		var dd = globalbycountry.filter(function(c){return c.key == d.properties.ADMIN;});
		}else{
			var dd = globalbyregion.filter(function(c){return c.key == d.properties.SUBREGION;});
		}
		if(dd[0]!=undefined){
			if(gl_epi_tab==0){	
		draw_new_confirmed_chart(dd);
		draw_cumulative_confirmed_chart(dd);
		}else if(gl_epi_tab==1){
		draw_by_indicators(dd);
		}
		}
		//filter award data
		var da = partnersbyCountrybyLinebyPartner.filter(function(c){return c.key == d.properties.ADMIN;})
		//console.log(da[0].values);
		//console.log(partnersbyLinebyPartner);
		
		if(da[0]!=undefined){
			//console.log(da[0].values);
		draw_global_awards(da[0].values);
		}
		
		d3.selectAll("input[name='selind']").on("change", function(){
			gl_choroplethIndicator = this.value;
			console.log("indicator selection");
			console.log(this.value);
			//gl_updateCountries();
			update_choropleths();
		});	
		
	}
	
	function filterCaribbean(){
		//console.log(d);
		//console.log(globalbycountry);
		//filter charts
		var dd = globalbycountry.filter(function(c){return CR.indexOf(c.key)!=-1;});
		if(dd[0]!=undefined){
			if(gl_epi_tab==0){	
		draw_new_confirmed_chart(dd);
		draw_cumulative_confirmed_chart(dd);
		}else if(gl_epi_tab==1){
		draw_by_indicators(dd);
	}
		}
		//filter award data
		var da = partnersbyCountrybyLinebyPartner.filter(function(c){return c.key == "E/S Caribbean";})
		//console.log(da[0].values);
		//console.log(partnersbyLinebyPartner);
		
		if(da[0]!=undefined){
			//console.log(da[0].values);
		draw_global_awards(da[0].values);
		}
		
	}
	
	/*close_btn.on("click", function(d){
		restorecharts();
		d3.select("#overview").style("opacity",0); 
		d3.select("#global_container").style("pointer-events","all");
		d3.select("#global_container").moveToFront();
		showGlobalFootnotes();
	});*/
	
	function restorecharts(){
		//console.log("restoring");
		if(gl_epi_tab==0){
			
		if(zoomLevel==2){	
		draw_new_confirmed_chart(globalbycountry);
		draw_cumulative_confirmed_chart(globalbycountry);
		}else{
			draw_new_confirmed_chart(globalbyregion);
			draw_cumulative_confirmed_chart(globalbyregion);
		}
	}else if(gl_epi_tab==1){
		if(zoomLevel==2){	
		draw_by_indicators(globalbycountry);
		}else{
			draw_by_indicators(globalbyregion);
		}
	}
		draw_global_awards(partnersbyLinebyPartner);
		
		d3.selectAll("input[name='selind']").on("change", function(){
			gl_choroplethIndicator = this.value;
			console.log("indicator selection");
			console.log(this.value);
			//gl_updateCountries();
			update_choropleths();
		});	
		
	}
	
	
	function draw_global_awards(dat){
		/*var global_awards_svg = d3.select("#gl_awardview").append("svg")
		.attr("class","gl_awards_charts");*/ 
		
		var datum = partnersbyLinebyPartner;
		
		//console.log(datum);
		//console.log(dat);
		
		d3.select("#gl_awardview").selectAll("*").remove();
		
		/*d3.select("#gl_awardview").append("text")
		.text("USAID AWARDS")
		.attr("class","awardsTitle");*/
		
		d3.select("#gl_awardview").style("pointer-events","all");
		
		
	var awardsTitle = d3.select("#gl_awardview").append("div")
		//.attr("class","awardsTitle");
		.attr("class","chartTitle");
	
		awardsTitle.append("text")
		.attr("class","chartTitleText")
		.text("USAID Partnerships");	
	
		var infoImage4 = awardsTitle.append("svg")
		.attr("width",15)
		.attr("height",15);
	
		infoImage4.append("image")
		.attr("xlink:href","./images/infoIcon2.png")
		.attr("width",15)
		.attr("height",15)
		.on("mouseover",function(d){
			d3.select(this).attr("cursor","pointer");
			iDiv.moveToFront();
		
			iDiv.transition()		
	        .duration(200)		
	        .style("opacity", .9);		
  	  	
			iDiv.html(function(){
				var txt = data_info.filter(function(v){return v.info_id=="awardsInfo";})[0];
				return txt.src+"<br>"+txt.comments;
			})	
	        .style("left", (d3.event.pageX) + "px")		
	        .style("top", (d3.event.pageY - 28) + "px");
		})
		.on("mouseout",function(d){
			d3.select(this).attr("cursor","default");
			iDiv.transition()		
	        .duration(300)		
	        .style("opacity", 0);		
		});	
		
		
		//var bchart_colors = ["steelblue","orange","green"];
		//var bchart_colors = ["#1b9e77","#e6ab02","#7570b3"];
		//var bchart_colors =["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"];
		
		//var bchart_colors = ["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00"];
		
		var awardsDiv = d3.select("#gl_awardview").append("div")
		.attr("class","gl_awards_div");
		
		var award_efforts = awardsDiv.selectAll("svg")
		.data(datum)
		.enter()
		.append("svg")
		.attr("id",function(d,i){return "line_"+i;})
		.attr("class","award_effort")
		.attr("height",function(d,i){
			return d.values.length*15+20;
		});
		
		award_efforts.append("text")
		.text(function(d){return d.key.replace("and","&");})
		.attr("y","10px");
		/*.attr("fill",function(d,i,j){
			var n = j[i].parentNode.id.replace("line_","");
			console.log(n);
			return bchart_colors[n];
		});*/
		
		var line_partners = award_efforts.selectAll("g")
			.data(function(d){ 
				return d.values;//filter(function(g){return g.key != "Programming Level";})[0].values;
			})
		.enter()
		.append("g")
		.attr("id",function(d,i,j){return "line_"+j[i].parentNode.id.replace("line_","");})
		.attr("transform", function(d,i){return "translate(0,"+(i*15+20)+")";})
		.attr("opacity",function(d,i,j){
			if(dat == datum){
				return 1;
			}else{
		var n = j[i].parentNode.id.replace("line_","");
		//console.log(datum[n].key);
		dat2 = dat.filter(function(f){return f.key == datum[n].key;});
		if(dat2.length > 0 && dat2[0].values.filter(function(e){return e.key == d.key;}).length > 0){
			return 1;
		}else{
			return 0.2;
		}
	}
		});
		
		//.attr("d",d3.symbol().size(10).type(d3.symbolCross))
		
		
		//.attr("d",d3.symbol().size(10).type(d3.symbolCross))
		
		
line_partners.append("path")
		.attr("d",d3.symbol().size(49).type(function(d){
			if(d.values[0].values[0].line_of_effort=="Programming level"){
				return d3.symbolCircle;
			}else if(d.values[0].values[0].line_of_effort=="Research and Innovation"){
				return d3.symbolStar;
			}else{
				return d3.symbolSquare;
			}
		}))
		.attr("transform","translate(8,4)")//function(d){
			/*console.log(d.values[0].values[0].line_of_effort);
			if(d.values[0].values[0].line_of_effort=="Programming level"){
				return d3.symbol().size([100]).type(d3.symbolCircle);
			}else if(d.values[0].values[0].line_of_effort=="Research and Innovation"){
				return d3.symbol().size([100]).type(d3.symbolStar);
			}else{
				return d3.symbol().size([100]).type(d3.symbolSquare);
			}*/
		//	return d3.symbol().size([100]).type(d3.symbolSquare);
		//})	
		.attr("basecolor",function(d,i,j){
			var n = j[i].parentNode.id.replace("line_","");
			//console.log(n);
			//return bchart_colors[n];
			
			if(d.values[0].values[0].line_of_effort=="Programming level"){
				return level_colors[i];
			}else{
				return bchart_colors[n-1];
			}
			
			
			
		})
		.attr("fill",function(d,i,j){
			//console.log(d);
			return d3.select(this).attr("basecolor");
		})
		.on("mouseover",function(d){
			d3.select(this).attr("fill",hover_color);
			//console.log(d);
			d.values.forEach(function(f){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == f.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				d3.select("#gl_country"+ADM[0].value).style("fill",hover_color);//dispatch("mouseover");//style("stroke-width","2")//
				}
			});
		})
		.on("mouseout",function(d){
			d3.select(this).attr("fill",function(e){return d3.select(this).attr("basecolor");});
			d.values.forEach(function(f){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == f.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				//d3.select("#gl_country"+ADM[0].value).dispatch("mouseout");
				//d3.select("#gl_country"+ADM[0].value).style("stroke-width","0.25")
				d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});
				}
			});
		});
		
		
		/*line_partners.append("rect")
		.attr("width",function(d){
			//console.log(d.values[0].values[0].line_of_effort);
			if(d.values[0].values[0].line_of_effort=="Programming level"){return "0px";}else{return "8px";}
		})
		.attr("height","8px")
		.attr("id",function(d){
			var l = d.values[0].values[0].line_of_effort;
			return l+"_"+d.key;
		})
		.attr("basecolor",function(d,i,j){
			var n = j[i].parentNode.id.replace("line_","");
			//console.log(n);
			return bchart_colors[n];
		})
		.attr("fill",function(d,i,j){
			//console.log(d);
			return d3.select(this).attr("basecolor");
		})
		.on("mouseover",function(d){
			d3.select(this).attr("fill",hover_color);
			//console.log(d);
			d.values.forEach(function(f){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == f.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				d3.select("#gl_country"+ADM[0].value).style("fill",hover_color);//dispatch("mouseover");//style("stroke-width","2")//
				}
			});
		})
		.on("mouseout",function(d){
			d3.select(this).attr("fill",function(e){return d3.select(this).attr("basecolor");});
			d.values.forEach(function(f){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == f.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				//d3.select("#gl_country"+ADM[0].value).dispatch("mouseout");
				//d3.select("#gl_country"+ADM[0].value).style("stroke-width","0.25")
				d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});
				}
			});
		});*/
		
		line_partners.append("text")
		.attr("x","15px")
		.attr("y","8px")
		.text(function(d){return d.key;});
		
	}
	
	function draw_discrepancyview(){
		//var mode = d3.select("#discrepancyView").append("div")
		//.attr("id","mode");
		
		var Imode = divmode.append("div").attr("id","infoMode")
		.style("background","grey")
		.on("click",function(){
			if(discrepancyMode!=0)showFootnotes();
			discrepancyMode = 0;
			discrepancy_points.style("opacity",0);
			discrepancy_points.style("pointer-events","none");
			d_points.selectAll("circle").style("pointer-events","none");
			
			Imode.style("background","grey");
			DNmode.style("background","white");
			//DCmode.style("background","white");
		});
		
		var Isvg = Imode.append("svg")
			.attr("width",15)
			.attr("height",20);
			
		Isvg.append("image")
		.attr("xlink:href","./images/pin_marker-512.png")
		.attr("width",15)
		.attr("height",20)
			
			/*Isvg.append("text").attr("x",5).attr("y",15)
			.text("I")
			.attr("font-family", "serif")
			.attr("font-size", "12px")
			.attr("fill", "black");*/
		
			var Dmode = divmode.append("div").attr("id","dataMode");
			
		
		var DNmode = Dmode.append("div").attr("id","dataMode_node")
			.on("click",function(){
				if(discrepancyMode==0)hideFootnotes();
				discrepancyMode = 1;
				
				discrepancy_points.style("opacity",1);
				discrepancy_points.style("pointer-events","all");
				
				//turn_on_d_points();
				update_dpt_color();	
				
				Imode.style("background","white");
				DNmode.style("background","grey");
				//DCmode.style("background","white");
			});
		
		var DNsvg = DNmode.append("svg")
			.attr("width",15)
			.attr("height",20);
			
			DNsvg.selectAll("circle")
			.data([{cx:8,cy:6.5},{cx:10,cy:3},{cx:12,cy:6}])
			.enter()
			.append("circle")
			.attr("cx", function(d){return d.cx;})
			.attr("cy", function(d){return d.cy;})
			.attr("r",1)
			.style("fill","#303030");
			
		
		/*var DCmode = Dmode.append("div").attr("id","dataMode_cluster")
			.on("click",function(){
				if(discrepancyMode==0)hideFootnotes();
				discrepancyMode = 2;
				discrepancy_points.style("opacity",0);
				discrepancy_points.style("pointer-events","none");
				Imode.style("background","white");
				DNmode.style("background","white");
				DCmode.style("background","grey");
			});
		
		var DCsvg = DCmode.append("svg")
			.attr("width",15)
			.attr("height",10)
			.attr("id","dcsvg");
			
			DCsvg.selectAll("circle")
			.data([{cx:10,cy:5}])
			.enter()
			.append("circle")
			.attr("cx", function(d){return d.cx;})
			.attr("cy", function(d){return d.cy;})
			.attr("r",3)
			.style("fill","#303030");*/
			
			draw_discrepancy_charts();
			draw_discrepancy_points();
	}
	
	
	
	function reformat(array) {
	                var data = [];
	                array.map(function (d, i) {

	                    data.push({
	                        id: i,
	                        type: "Feature",
	                        geometry: {
	                            coordinates: [+d.lng, +d.lat],
	                            type: "Point"
	                        },
							dataObj:d
                       

	                    });
	                });
	                return data;
	            }
	
	
	function turn_on_d_points(){
					
			update_dpt_color();		
	}
	
	
	function draw_discrepancy_points(){
		//console.log("drawing");
		
		if(discrepancy_points!=undefined)discrepancy_points.selectAll("*").remove();
		
	  discrepancy_points = global_svg.append("g")
	  	.attr("class","d_points");
		
		var formatDate = d3.timeFormat("%m/%e/%y");
		
		var parseTime = d3.timeParse("%m/%e/%y");
		
		//console.log(choropleth_date);
		var geoData = { type: "FeatureCollection", features: reformat(discrepancy_data_filtered) };
		//console.log(geoData);
		
		geoData.features.forEach(function(d) {
		        d.LatLng = new L.LatLng(d.geometry.coordinates[1],
		          d.geometry.coordinates[0]);
		      });
		
	  //circles
	  /*d_points = discrepancy_points.selectAll("circle")
	  	.data(geoData.features)
		.enter()
	      .append("circle")
		.attr("class","dpts")
	      //.attr("id",function(d){return "gl_country"+d.properties.ADM0_A3;})
	    //.attr("d",global_path.pointRadius(3))
		.attr("r",7)
		.attr("cx",function(d){return global_map.latLngToLayerPoint(d.LatLng).x;})
		.attr("cy",function(d){return global_map.latLngToLayerPoint(d.LatLng).y;})
		.attr("fill","steelblue")
		//.style("filter", "url(#drop-shadow)")
		.attr("stroke","white")
		.attr("stroke-width",1);*/
		
		
	  d_points = discrepancy_points.selectAll("g")
	  	.data(geoData.features)
		.enter()
	    .append("g")
		.attr("class","dpts")
		.attr("transform",function(d){
				return "translate("+global_map.latLngToLayerPoint(d.LatLng).x+","+global_map.latLngToLayerPoint(d.LatLng).y+")";
			});
	      //.attr("id",function(d){return "gl_country"+d.properties.ADM0_A3;})
	    //.attr("d",global_path.pointRadius(3))
		var bullseye = d_points.selectAll("circle")
		.data([1,2,3,4,5,6])
		.enter()
		.append("circle")	
		.attr("r",function(d){return 5+d*2;})
		.attr("cx",0)
		.attr("cy",0)
		.attr("fill",function(d,i){if(i==0){return "steelblue";}else{return "none";}})
		//.style("filter", "url(#drop-shadow)")
		.attr("stroke","white")
		.attr("stroke-width",function(d,i){if(i==0){return 1;}else{return 3;}});
			  
		  /*var arc1 = d3.arc()
			.innerRadius(0)
		    .outerRadius(7)
		    .startAngle(0)
			  .endAngle(Math.PI);	  
			  
		//arcs	  
	  	  d_points = discrepancy_points.selectAll("path")
	  	  	.data(geoData.features)
	  		.enter()
	  	    .append("path")
	  		.attr("class","dpts")
	  		.attr("d",arc1)
			.attr("transform", function(d){
				return "translate("+global_map.latLngToLayerPoint(d.LatLng).x+","+global_map.latLngToLayerPoint(d.LatLng).y+")";
			})
			.attr("fill","steelblue")
	  		//.style("filter", "url(#drop-shadow)")
	  		.attr("stroke","white")
	  		.attr("stroke-width",1);*/	  
		
		d_points.append("title")
		.text(function(d){return d.dataObj.description;});
		
		update_dpt_color();
		
		//d_points.selectAll("circle").style("pointer-events","none");
		
		//because discrepancyMode default is I
		if(discrepancyMode!=1){
			d_points.selectAll("circle").style("pointer-events","none");
			discrepancy_points.style("opacity",0);
			discrepancy_points.style("pointer-events","none");
			/*d_points.each(function(d){
					d3.select(this).style("opacity",0);
					d3.select(this).style("pointer-events","none");
			});*/
		}
		
	}
	
	function update_dpt_color(){
		//total hack - clean this up!		
		d_points.each(function(d){
			//console.log(d);
			//this is each group
			var n=5;
			var m=0;
			if(dptMode=="type"){
				//if(discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[0];})[0]!=undefined)
				//n=discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[0];})[0].cI;
				//if(d.dataObj.discrepancy_type.length>1)m=discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[1];})[0].cI;
				//console.log("yes");
				//console.log(d.dataObj.discrepancy_type);
				//circle
				d3.select(this).selectAll("circle").each(function(f,i){
					
					d3.select(this).style("pointer-events","all");
				
					if(d.dataObj.discrepancy_type.length > i){
						d3.select(this).attr("r",5+i*2);
						if(discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[i];})[0]!=undefined)
						var l=discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[i];})[0].cI;
						if(i==0){d3.select(this).attr("fill",d2colors[l%d2colors.length]);
						d3.select(this).attr("stroke",d2colors[l%d2colors.length]);
						d3.select(this).attr("stroke-width",2);
						//if(d.dataObj.discrepancy_type.length==1){d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);}
					}else{
						    d3.select(this).attr("stroke-width",3);
							d3.select(this).attr("stroke",dcolors[l%dcolors.length]);
						}
					}else if(d.dataObj.discrepancy_type.length == i){ //outerborder
						var l=discrepancy_histogram[0].values.filter(function(e){return e.name == d.dataObj.discrepancy_type[i-1];})[0].cI;
						//console.log(l);
						d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);
						d3.select(this).attr("r",5+(i)*2-0.5);
						d3.select(this).attr("stroke-width",1);
						
					}else{
						//clear circle
						d3.select(this).attr("stroke","none");
						d3.select(this).style("pointer-events","none");
					}
					
					
					
				});
				
				
			}else if(dptMode=="pipeline"){
				//if(discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[0];})[0]!=undefined)
				//n=discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[0];})[0].cI;
				//if(d.dataObj.pipeline.length>1)m=discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[1];})[0].cI;
				
				d3.select(this).selectAll("circle").each(function(f,i){
					
					d3.select(this).style("pointer-events","all");
					
					d3.select(this).attr("r",5+i*2);
					if(d.dataObj.pipeline.length > i){
						if(discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[i];})[0]!=undefined)
						var l=discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[i];})[0].cI;
						if(i==0){d3.select(this).attr("fill",d2colors[l%d2colors.length]);
						d3.select(this).attr("stroke",d2colors[l%d2colors.length]);
						d3.select(this).attr("stroke-width",2);
						//d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);
					}else{
							d3.select(this).attr("stroke-width",3);
							d3.select(this).attr("stroke",dcolors[l%dcolors.length]);}
						}else if(d.dataObj.pipeline.length == i){ //outerborder
							var l=discrepancy_histogram[1].values.filter(function(e){return e.name == d.dataObj.pipeline[i-1];})[0].cI;
							//console.log(l);
							d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);
							d3.select(this).attr("r",5+(i)*2-0.5);
							d3.select(this).attr("stroke-width",1);
						}else{
						//clear circle
						d3.select(this).attr("stroke","none");
						d3.select(this).style("pointer-events","none");
					}
				});
				
			
			}else if(dptMode=="truevalue"){
				//if(discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value;})[0]!=undefined)
				//n=discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value;})[0].cI;
				
				d3.select(this).selectAll("circle").each(function(f,i){
					
					d3.select(this).style("pointer-events","all");
					
					if(d.dataObj.true_value.length > i){
						var l=0;
						//console.log(d.dataObj.true_value[i]);
						if(discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value[i];})[0]!=undefined){
						l=discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value[i];})[0].cI;
						}
						//console.log(l);
						if(i==0)d3.select(this).attr("fill",d2colors[l%d2colors.length]);
						d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);
					}else{
						//clear circle
						d3.select(this).attr("stroke","none");
						d3.select(this).style("pointer-events","none");
					}
				});
				
			}else if(dptMode=="stype"){
							//if(discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value;})[0]!=undefined)
							//n=discrepancy_histogram[2].values.filter(function(e){return e.name == d.dataObj.true_value;})[0].cI;
				
							d3.select(this).selectAll("circle").each(function(f,i){
								
								d3.select(this).style("pointer-events","all");
								
								if(d.dataObj.true_value.length > i){
									var l=0;
									//console.log(d.dataObj.true_value[i]);
									if(discrepancy_histogram[3].values.filter(function(e){return e.name == d.dataObj.true_value[i];})[0]!=undefined){
									l=discrepancy_histogram[3].values.filter(function(e){return e.name == d.dataObj.true_value[i];})[0].cI;
									}
									//console.log(l);
									if(i==0)d3.select(this).attr("fill",d2colors[l%d2colors.length]);
									d3.select(this).attr("stroke",dstrokecolors[l%dstrokecolors.length]);
								}else{
									//clear circle
									d3.select(this).attr("stroke","none");
									d3.select(this).style("pointer-events","none");
								}
							});
				
						}
						
						
						d_points.each(function(d){
							if(d.dataObj.zoomLevel==zoomLevel){
								d3.select(this).style("opacity",1);
								d3.select(this).style("pointer-events","all");
							}else{
								d3.select(this).style("opacity",0);
								d3.select(this).style("pointer-events","none");
								d3.select(this).selectAll("circle").style("pointer-events","none");
							}
						
						});			
			//d3.select(this).selectAll("circle").attr("fill",d2colors[n%d2colors.length]);//dcolors[n%dcolors.length]);
			//d3.select(this).selectAll("circle").attr("stroke",dstrokecolors[n%dstrokecolors.length]);
			//if(m!=0){d3.select(this).attr("stroke",dcolors[m%dcolors.length]);}else{d3.select(this).attr("stroke","none");}
		});
		
	}
	
	function update_discrepancy_charts(){
		
		//compute_histogram();
		
		var margin = {top: 10, right: 10, bottom: 50, left: 30},
	  	  width = 110 - margin.left - margin.right,
	  	  height = 100 - margin.top - margin.bottom;
		  
		  
		  var x = d3.scaleBand().range([0, width]).padding(0.1),
		  	  y = d3.scaleLinear().range([height, 0]);
		 
		
		//discrepancyType = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		//discrepancyType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","type");
		
		//if(discrepancyType!=undefined){discrepancyType.selectAll("*").remove();}
		
		var dtypesvg = discrepancyType.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_type_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		//console.log(discrepancy_histogram[0].values);
	   	x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
		x.domain(discrepancy_histogram[0].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[0].values,function(d){return d.count})]); 
		
		
	   dtypesvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(4));
	   
	   dtypesvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
		.selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-35)" 
                });
		
		
		dtypesvg.selectAll(".bar")
	 	.data(discrepancy_histogram[0].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
	   	.attr("height",function(d){return height - y(d.count);})
			
		
		//if(discrepancyPipeline!=undefined){discrepancyPipeline.selectAll("*").remove();}
		
		discrepancyPipeline = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyPipeline.append("input").attr("type","radio").attr("name","discr_ind").attr("value","pipeline");
		var dpsvg = discrepancyPipeline.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_pipeline_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		x = d3.scaleBand().range([0, width]).padding(0.1);
	   	x.domain(discrepancy_histogram[1].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[1].values,function(d){return d.count})]); 
		
		//console.log(discrepancy_histogram[1].values);
	   
	   dpsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(4));
		
	   dpsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
		.selectAll("text")	
     	   .style("text-anchor", "end")
      	  .attr("dx", "-.8em")
      	  .attr("dy", ".15em")
      	  .attr("transform", function(d) {
            return "rotate(-35)" 
            }); 
		
		dpsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[1].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
	   	.attr("height",function(d){return height - y(d.count);})
			
		//if(discrepancyTrueValue!=undefined){discrepancyTrueValue.selectAll("*").remove();}
		
		discrepancyTrueValue = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyTrueValue.append("input").attr("type","radio").attr("name","discr_ind").attr("value","truevalue").attr("checked",true);
		var dtvsvg = discrepancyTrueValue.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_truevalue_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
	   	x.domain(discrepancy_histogram[2].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[2].values,function(d){return d.count})]); 
	   	
	   dtvsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(4));
		
	   dtvsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
	.selectAll("text")	
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {
            return "rotate(-35)" 
            });
		
		dtvsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[2].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
			.attr("height",function(d){return height - y(d.count);});
			
		//stype
			discrepancySType = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
			discrepancySType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","truevalue").attr("checked",true);
			var dstsvg = discrepancySType.append("svg")
			.attr("id","discrepancy_truevalue_chart")	  
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
			x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
		   	x.domain(discrepancy_histogram[3].values.map(function(d) { return d.name; }));
			y.domain([0, d3.max(discrepancy_histogram[3].values,function(d){return d.count})]); 
	   	
		   dstsvg.append("g")
		         .attr("class", "axis")
			.call(d3.axisLeft(y).ticks(4));
		
		   dstsvg.append("g")
				.attr("class", "axis")
	      		.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x))
		.selectAll("text")	
	        .style("text-anchor", "end")
	        .attr("dx", "-.8em")
	        .attr("dy", ".15em")
	        .attr("transform", function(d) {
	            return "rotate(-35)" 
	            });
		
			dstsvg.selectAll(".bar")
		 	.data(discrepancy_histogram[3].values)
		   	.enter().append("rect")
		   	.attr("id",function(d){ 
		   		return "bb"+d.name;})
		 	.attr("x", function(d){return x(d.name);}) 
		 	.attr("y", function(d){return y(d.count);})
			.attr("width", x.bandwidth())
		   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
				.attr("height",function(d){return height - y(d.count);});
			//	
		
		
		
			
			
			d3.selectAll("input[name='discr_ind']").on("change", function(){
				dptMode=this.value;
				update_dpt_color();
				
			});	
			
		
	}
	
	function compute_histogram(){
		
		discrepancy_histogram = [{key:"discrepancy_type", values:[{name:"inconsistency", count:0, cI:0},{name:"greydata",count:0,cI:1},{name:"adjustment",count:0,cI:2}]},
		{key:"pipeline",values:[{name:"detection",count:0,cI:0},{name:"recording",count:0,cI:1},{name:"collection",count:0,cI:2},{name:"processing",count:0,cI:3},{name:"reporting",count:0,cI:4}]},
		{key:"true_value",values:[{name:"higher",count:0,cI:0},{name:"lower",count:0,cI:1},{name:"unknown",count:0,cI:2}]},
		{key:"stype",values:[{name:"systematic",count:0,cI:0},{name:"random",count:0,cI:1}]}];
		
		discrepancy_data_filtered.forEach(function(d){
			d.discrepancy_type = d.discrepancy_type.split(","); 
			d.pipeline = d.pipeline.split(",");
			d.true_value = d.true_value.split(",");
			d.stype = d.stype.split(","); 
			
			var res;
			
			d.discrepancy_type.forEach(function(e,i){
				res = discrepancy_histogram[0].values.filter(function(f){return f.name == e;})[0];
				if(res!=undefined)res.count++;
			});
			d.pipeline.forEach(function(e,i){
				res = discrepancy_histogram[1].values.filter(function(f){return f.name == e;})[0];
				if(res!=undefined)res.count++;
			});
				res = discrepancy_histogram[2].values.filter(function(f){return f.name == d.true_value;})[0];
				if(res!=undefined)res.count++;
				
				res = discrepancy_histogram[3].values.filter(function(f){return f.name == d.stype;})[0];
				if(res!=undefined)res.count++;
		});
		
		console.log(discrepancy_histogram);
		
  	 /* discrepancyByType = d3.nest()
  	  .key(function(d){return d.discrepancy_type;})
  	  .entries(discrepancy_data);
	  
	  discrepancyByPipeline = d3.nest()
	  .key(function(d){return d.pipeline;})
	  .entries(discrepancy_data);
	  
	  discrepancyByTrueValue = d3.nest()
	  .key(function(d){return d.true_value;})
	  .entries(discrepancy_data);*/
	  
	}
	
	function draw_discrepancy_charts2(){
		
		compute_histogram();
		
		var margin = {top: 10, right: 10, bottom: 30, left: 60},
	  	  width = 125 - margin.left - margin.right,
	  	  height = 100 - margin.top - margin.bottom;
		 
		  
		  var x = d3.scaleLinear().range([0,width]);
		  var y = d3.scaleBand().range([height,0]).padding(0.1);
		   	
		
		discrepancyType = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","discrepnacy_type").attr("checked",true);
		var dtypesvg = discrepancyType.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_type_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		//console.log(discrepancy_histogram[0].values);
	   	y.domain(discrepancy_histogram[0].values.map(function(d) { return d.name; }));
		x.domain([0, d3.max(discrepancy_histogram[0].values,function(d){return d.count})]); 
		
		
	   dtypesvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(5));
	   
	   dtypesvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x).ticks(5)); 
		
		
		dtypesvg.selectAll(".bar")
	 	.data(discrepancy_histogram[0].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("y", function(d){return y(d.name);}) 
	 	.attr("x", 1)
		.attr("height", y.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
		.attr("width",function(d){return x(d.count);});
			
			
margin = {top: 10, right: 10, bottom: 30, left: 60},
	  	  width = 125 - margin.left - margin.right,
	  	  height = 100 - margin.top - margin.bottom;
		 
		  
		  x = d3.scaleLinear().range([0,width]);
		  y = d3.scaleBand().range([height,0]).padding(0.1);	
			
		
		discrepancyPipeline = d3.select("#discrepancyView").append("div").attr("class","discr_charts1");
		discrepancyPipeline.append("input").attr("type","radio").attr("name","discr_ind").attr("value","pipeline");
		var dpsvg = discrepancyPipeline.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_pipeline_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		
	   	y.domain(discrepancy_histogram[1].values.map(function(d) { return d.name; }));
		x.domain([0, d3.max(discrepancy_histogram[1].values,function(d){return d.count})]); 
		
		//console.log(discrepancy_histogram[1].values);
	   
	   dpsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(6));
		
	   dpsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x).ticks(5)); 
		
		dpsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[1].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("y", function(d){return y(d.name);}) 
	 	.attr("x", 1)
		.attr("height", y.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
		.attr("width",function(d){return x(d.count);});
			
			
		/*dpsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[1].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){console.log(d.count); console.log(y(d.count)); return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill","steelblue")	
	   	.attr("height",function(d){return height - y(d.count);})*/	
		
		margin = {top: 10, right: 10, bottom: 30, left: 60},
	  	  width = 125 - margin.left - margin.right,
	  	  height = 100 - margin.top - margin.bottom;
		 
		  
		  x = d3.scaleLinear().range([0,width]);
		  y = d3.scaleBand().range([height,0]).padding(0.1);
		
		
		discrepancyTrueValue = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyTrueValue.append("input").attr("type","radio").attr("name","discr_ind").attr("value","true_value");
		var dtvsvg = discrepancyTrueValue.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_truevalue_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
	   	y.domain(discrepancy_histogram[2].values.map(function(d) { return d.name; }));
		x.domain([0, d3.max(discrepancy_histogram[2].values,function(d){return d.count})]); 
	   	
	   dtvsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y));
	   dtvsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x).ticks(5));
		
		dtvsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[2].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("y", function(d){return y(d.name);}) 
	 	.attr("x", 1)
		.attr("height", y.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
		.attr("width",function(d){return x(d.count);});
		
		
		//stype
		discrepancySType = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancySType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","stype");
		var dstsvg = discrepancySType.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_stype_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
	   	y.domain(discrepancy_histogram[3].values.map(function(d) { return d.name; }));
		x.domain([0, d3.max(discrepancy_histogram[3].values,function(d){return d.count})]); 
	   	
	   dtvsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y));
	   dtvsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x).ticks(5));
		
		dtvsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[3].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("y", function(d){return y(d.name);}) 
	 	.attr("x", 1)
		.attr("height", y.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
		.attr("width",function(d){return x(d.count);});
		
		
		
	}
	
	
	
	function draw_discrepancy_charts(){
		
		compute_histogram();
		
		var margin = {top: 10, right: 10, bottom: 55, left: 35},
	  	  width = 95 - margin.left - margin.right,
	  	  height = 100 - margin.top - margin.bottom;
		  
		  
		  var x = d3.scaleBand().range([0, width]).padding(0.1),
		  	  y = d3.scaleLinear().range([height, 0]);
		  
		
		var discrepancyType = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","type");
		discrepancyType.append("text").text(" Source Type");
		var dtypesvg = discrepancyType.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_type_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		//console.log(discrepancy_histogram[0].values);
	   	x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
		x.domain(discrepancy_histogram[0].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[0].values,function(d){return d.count})]); 
		
		
	   dtypesvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(5));
	   
	   dtypesvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
		.selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.5em")
            .attr("dy", ".15em")
            .attr("transform", function(d) {
                return "rotate(-45)" 
                });
		
		
		dtypesvg.selectAll(".bar")
	 	.data(discrepancy_histogram[0].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
	   	.attr("height",function(d){return height - y(d.count);})
			
			margin = {top: 10, right: 10, bottom: 55, left: 25};
			width = 110 - margin.left - margin.right;
  	  	  height = 100 - margin.top - margin.bottom;
		  
		  
  		  x = d3.scaleBand().range([0, width]).padding(0.1);
  		  	  y = d3.scaleLinear().range([height, 0]);	
			
		
		var discrepancyPipeline = d3.select("#discrepancyView").append("div").attr("class","discr_charts1");
		discrepancyPipeline.append("input").attr("type","radio").attr("name","discr_ind").attr("value","pipeline");
		discrepancyPipeline.append("text").text(" Pipeline");
		var dpsvg = discrepancyPipeline.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_pipeline_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		x = d3.scaleBand().range([0, width]).padding(0.1);
	   	x.domain(discrepancy_histogram[1].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[1].values,function(d){return d.count})]); 
		
		//console.log(discrepancy_histogram[1].values);
	   
	   dpsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(4));
		
	   dpsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
		.selectAll("text")	
     	   .style("text-anchor", "end")
      	  .attr("dx", "-.5em")
      	  .attr("dy", ".15em")
      	  .attr("transform", function(d) {
            return "rotate(-45)" 
            }); 
		
		dpsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[1].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
	   	.attr("height",function(d){return height - y(d.count);})
			
			
			
			margin = {top: 10, right: 10, bottom: 55, left: 25};
			width = 85 - margin.left - margin.right;
  	  	  height = 100 - margin.top - margin.bottom;
		  
		  
  		  x = d3.scaleBand().range([0, width]).padding(0.1);
  		  	  y = d3.scaleLinear().range([height, 0]);		
			
		
		var discrepancyTrueValue = d3.select("#discrepancyView").append("div").attr("class","discr_charts");
		discrepancyTrueValue.append("input").attr("type","radio").attr("name","discr_ind").attr("value","truevalue").attr("checked",true);
		discrepancyTrueValue.append("text").text(" True Value");
		var dtvsvg = discrepancyTrueValue.append("svg")
		//.attr("class","discr_charts")
		.attr("id","discrepancy_truevalue_chart")	  
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
		x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
	   	x.domain(discrepancy_histogram[2].values.map(function(d) { return d.name; }));
		y.domain([0, d3.max(discrepancy_histogram[2].values,function(d){return d.count})]); 
	   	
	   dtvsvg.append("g")
	         .attr("class", "axis")
		.call(d3.axisLeft(y).ticks(5));
		
	   dtvsvg.append("g")
			.attr("class", "axis")
      		.attr("transform", "translate(0," + height + ")")
		.call(d3.axisBottom(x))
	.selectAll("text")	
        .style("text-anchor", "end")
        .attr("dx", "-.5em")
        .attr("dy", ".15em")
        .attr("transform", function(d) {
            return "rotate(-45)" 
            });
		
		dtvsvg.selectAll(".bar")
	 	.data(discrepancy_histogram[2].values)
	   	.enter().append("rect")
	   	.attr("id",function(d){ 
	   		return "bb"+d.name;})
	 	.attr("x", function(d){return x(d.name);}) 
	 	.attr("y", function(d){return y(d.count);})
		.attr("width", x.bandwidth())
	   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
			.attr("height",function(d){return height - y(d.count);});
			
			
			
			margin = {top: 10, right: 10, bottom: 55, left: 30};
			width = 75 - margin.left - margin.right;
  	  	  height = 100 - margin.top - margin.bottom;
			
		//stype
			var discrepancySType = d3.select("#discrepancyView").append("div").attr("class","discr_charts2");
			discrepancySType.append("input").attr("type","radio").attr("name","discr_ind").attr("value","stype").attr("checked",true);
			discrepancySType.append("text").text(" Error Type");
			var dstsvg = discrepancySType.append("svg")
			//.attr("class","discr_charts")
			.attr("id","discrepancy_stype_chart")	  
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform","translate(" + margin.left + "," + margin.top + ")");
		
			x = d3.scaleBand().range([0, width*0.75]).padding(0.1);
		   	x.domain(discrepancy_histogram[3].values.map(function(d) { return d.name; }));
			y.domain([0, d3.max(discrepancy_histogram[3].values,function(d){return d.count})]); 
	   	
		   dstsvg.append("g")
		         .attr("class", "axis")
			.call(d3.axisLeft(y).ticks(5));
		
		   dstsvg.append("g")
				.attr("class", "axis")
	      		.attr("transform", "translate(0," + height + ")")
			.call(d3.axisBottom(x))
		.selectAll("text")	
	        .style("text-anchor", "end")
	        .attr("dx", "-.5em")
	        .attr("dy", ".15em")
	        .attr("transform", function(d) {
	            return "rotate(-45)" 
	            });
		
			dstsvg.selectAll(".bar")
		 	.data(discrepancy_histogram[3].values)
		   	.enter().append("rect")
		   	.attr("id",function(d){ 
		   		return "bb"+d.name;})
		 	.attr("x", function(d){return x(d.name);}) 
		 	.attr("y", function(d){return y(d.count);})
			.attr("width", x.bandwidth())
		   	.style("fill",function(d,i){return dcolors[i%dcolors.length];})	
				.attr("height",function(d){return height - y(d.count);});	
			
			
			d3.selectAll("input[name='discr_ind']").on("change", function(){
				dptMode=this.value;
				update_dpt_color();
				
			});	
			
		
	}
	
	
	
	function draw_global_chartview(){  
		if(gl_epi_tab==0){	
		d3.select("#byIndicatorData").selectAll("*").remove();
		if(zoomLevel==2){
			draw_new_confirmed_chart(globalbycountry);
			draw_cumulative_confirmed_chart(globalbycountry);
			draw_gl_scatter(globaldataF);
		}else if(zoomLevel==1){
			draw_new_confirmed_chart(globalbyregion);//globalbycountry);
			draw_cumulative_confirmed_chart(globalbyregion);//globalbycountry);
			draw_gl_scatter(regionaldataF);
		}
	}else if(gl_epi_tab ==1){
		d3.select("#cum_conf").selectAll("*").remove();	
		d3.select("#new_conf").selectAll("*").remove();	
		d3.select("#gl_scatter").selectAll("*").remove();
		if(zoomLevel==2){
			draw_by_indicators(globalbycountry);
		}else if(zoomLevel==1){
			draw_by_indicators(globalbyregion);
		}
	}
	
	d3.selectAll("input[name='selind']").on("change", function(){
		gl_choroplethIndicator = this.value;
		console.log("indicator selection");
		console.log(this.value);
		//gl_updateCountries();
		update_choropleths();
	});	
	
	}
	
	
	function update_choropleths(){
		
		//update global extrema  
	 	mx = d3.max(globaldata,function(f){return f[gl_choroplethIndicator];});
	 	mn = d3.min(globaldata,function(f){return f[gl_choroplethIndicator];});
	
	 	mx_ht = d3.max(globaldata,function(f){return f[gl_choroplethIndicator]/f.pop_x_1000;});
	 	mn_ht = d3.min(globaldata,function(f){return f[gl_choroplethIndicator]/f.pop_x_1000;}); 
		
		
		//set color maps
	    logScale = d3.scaleLog()
	      .domain([1, mx])
	    colorScaleLog = d3.scaleSequential(
	        (d) => d3.interpolateReds(logScale(d))
	      ); 
	
	    logScale_ht = d3.scaleLog()
	        .domain([0.001, mx_ht])
	     colorScaleLog_ht = d3.scaleSequential(
	          (d) => d3.interpolateReds(logScale_ht(d))
	        );
			
			global_choropleth = colorScaleLog;//choropleth_global;//colorScaleLog;//color_global;
			global_choropleth_ht = colorScaleLog_ht;//choropleth_global_ht;		
				
		//update regional		
		 r_mx = d3.max(regionalData,function(v){return d3.max(v.values, function(f){return f.value[gl_choroplethIndicator];});});
		 r_mn = d3.min(regionalData,function(v){return d3.min(v.values, function(f){return f.value[gl_choroplethIndicator];});});
	
		 r_mx_ht = d3.max(regionalData,function(v){return d3.max(v.values, function(f){return f.value[gl_choroplethIndicator]/f.value.pop_x_1000;});});
		 r_mn_ht = d3.min(regionalData,function(v){return d3.min(v.values, function(f){return f.value[gl_choroplethIndicator]/f.value.pop_x_1000;});}); 	
		
		
    	 r_linScale = d3.scaleLinear()
      	.domain([r_mn, r_mx])
	  	.range(['#fdbb84','#b30000']);
	  
    	r_linScale_ht = d3.scaleLinear()
      	.domain([r_mn_ht, r_mx_ht])
	  	.range(['#fdbb84','#b30000']);
				
		
	 	regional_choropleth = r_linScale;//r_colorScaleLog;
	 	regional_choropleth_ht = r_linScale_ht;//r_colorScaleLog_ht;		
				
				
		gl_updateCountries();	
		legend_all.remove();
		gl_update_legends();
		
	}
	
	
	
	function draw_gl_scatter(dat){
	  d3.select("#gl_scatter").selectAll("*").remove();
		
	  var formatDate = d3.timeFormat("%m/%e/%y");
	  var choropleth_date_formatted = formatDate(choropleth_date);
	  var datedDat = dat.filter(function(e){return formatDate(e.date)==choropleth_date_formatted;});
	  
	  console.log("again");
	  //console.log(datedDat);
		
  	  var margin = {top: 20, right: 10, bottom: 30, left: 50},
      	width = 300 - margin.left - margin.right,
      	height = 100 - margin.top - margin.bottom;
		
		x_gl_scatter = d3.scalePow().exponent(0.5).range([0, width]);
		//var y = d3.scaleLog().range([height, 0]);
		y_gl_scatter = d3.scaleLinear().range([height, 0]);
		
		x_gl_scatter.domain(d3.extent(datedDat, function(v) {return (v.autochthonous_cases_suspected); }));
		y_gl_scatter.domain(d3.extent(datedDat, function(v) {return (v.autochthonous_cases_suspected/v.pop_x_1000); }));
		
		//x_gl_scatter.ticks(5).map(x_gl_scatter.tickFormat(6));
		
  var scatterplot_svg = d3.select("#gl_scatter").append("svg")
	.attr("class","gl_ind_charts")
	.attr("id","gl_inds_scatter")	  
   	.attr("width", width + margin.left + margin.right)
   	.attr("height", height + margin.top + margin.bottom)
 	.append("g")
  	 .attr("transform",
    	"translate(" + margin.left + "," + margin.top + ")");
		
	scatterplot_svg.append("text")
		.attr("class","chart_labels")
		.attr("id","gl_scatterplot_label")
		.attr("x",-10)
		.attr("y",-10)
		.text("total suspected cases vs. cases p.h.t ("+choropleth_date_formatted+")");
		
	gl_scatterpoints = scatterplot_svg.selectAll("circle")
		.data(datedDat)
		.enter().append("circle")
		.attr("id",function(d,i){return "gl_scatter"+d.country})
		.attr("r",2)
		.attr("cx",function(d){return x_gl_scatter(d.autochthonous_cases_suspected);})
		.attr("cy",function(d){return y_gl_scatter(d.autochthonous_cases_suspected/d.pop_x_1000);})
		.style("fill",function(d,i){return colors[i%colors.length];})
		.style("stroke","white")
		.style("stroke-width",0)
		.on("mouseover",function(d,i){	
			d3.select(this).style("stroke-width",2).style("cursor","pointer");
			var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.country;});
			if(ADM[0]!=undefined && ADM[0].value !=undefined){
			d3.select("#gl_country"+ADM[0].value).style("fill",hover_color);//dispatch("mouseover");//style("stroke-width","2")//
			}
		})
		.on("mouseout",function(d,i){
			d3.select(this).style("stroke-width",0).style("cursor","default");
			var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.country;});
			if(ADM[0]!=undefined && ADM[0].value !=undefined){
			//d3.select("#gl_country"+ADM[0].value).dispatch("mouseout");
			d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});
			}
		});
		
		gl_scatterpoints.append("title")
		.text(function(d){return d.country+" ["+d.autochthonous_cases_suspected+"; "+(d.autochthonous_cases_suspected/d.pop_x_1000)+"]";});
		
var xaxis = scatterplot_svg.append("g")
.attr("class","axis")	
	  .attr("transform", "translate(0,"+height+")")  
	  .call(d3.axisBottom(x_gl_scatter).ticks(5,"s"));
	  
var yaxis = scatterplot_svg.append("g")
.attr("class","axis")	  
	  .call(d3.axisLeft(y_gl_scatter).ticks(4));	
			
	}
	
	function draw_cumulative_confirmed_chart(dat){
		var mode = 1;
		
		/*if(global_indicators_1 != undefined){
		d3.select("#gl_inds_cum").selectAll("*").remove();
		}*/
		d3.select("#cum_conf").selectAll("*").remove();	
		d3.select("#cum_conf").append("div").append("input").attr("type","radio").attr("name","selind").attr("value","autochthonous_cases_confirmed").attr("class","checkbox").attr("checked",true);
		
  	  var margin = {top: 20, right: 10, bottom: 30, left: 50},
      	width = 300 - margin.left - margin.right,
      	height = 100 - margin.top - margin.bottom;
		
		var x = d3.scaleTime().range([0, width]);
		var y = d3.scalePow().exponent(0.5).range([height, 0]);
		
		//var y = d3.scaleLinear().range([height, 0]);
		
		
		var valueline = d3.line()
		.x(function(d){return x(d.date);})
		.y(function(d){if(mode){return y(d.autochthonous_cases_confirmed);}else{return y(d.autochthonous_cases_suspected);}})
		//.curve(d3.curveCardinal);
		.curve(d3.curveCatmullRom);
		
		//console.log(d3.max(globalbycountry, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});}));
		//console.log(globalbycountry);
		
		x.domain(d3.extent(dat[0].values, function(v) {return v.date; }));
		
		var min = d3.min(dat, function(v){return d3.min(v.values,function(g){if(mode){return g.autochthonous_cases_confirmed;}else{return g.autochthonous_cases_suspected;}});});
		var max = d3.max(dat, function(v){return d3.max(v.values,function(g){if(mode){return g.autochthonous_cases_confirmed;}else{return g.autochthonous_cases_suspected;}});});
		if(min!=max){
		y.domain([min,max]);
		}else{
			y.domain([0,max*2]);
		}
		//d3.min(dat, function(v){return d3.min(v.values,function(g){return g.autochthonous_cases_confirmed;});})
		//var gl_inds = d3.select("#newConfirmedData").append("div");
		
	  var global_indicators_1b = d3.select("#cum_conf").append("svg")
		.attr("class","gl_ind_charts")
		.attr("id","gl_inds_cum")	  
 	   	.attr("width", width + margin.left + margin.right)
 	   	.attr("height", height + margin.top + margin.bottom);
		
	 var global_indicators_1 = global_indicators_1b.append("g")
 	  	 .attr("transform",
        	"translate(" + margin.left + "," + margin.top + ")");
			
		global_indicators_1.append("text")
			.attr("class","chart_labels")
			.attr("x",-10)
			.attr("y",-10)
			.text(function(){if(mode){return "cumulative confirmed cases";}else{return "cumulative suspected cases";}});
		
		
		var linegraph = global_indicators_1.selectAll("path")
			.data(dat)
			.enter()
			.append("path")
			.attr("id",function(d,i){return "line"+d.key})
			.attr("class","line")
			.style("stroke",function(d,i){return colors[i%colors.length];})
			.style("fill","none")	
			.attr("d", function(d){ 
				//console.log(d.values);
				return valueline(d.values);})
				.on("mouseover",function(d){
					//console.log(d);
					if(!gl_selection){
					d3.select(this).style("stroke-width",3);
					
					if(zoomLevel==2){
					var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
					if(ADM[0]!=undefined && ADM[0].value !=undefined){
					//d3.select("#gl_country"+ADM[0].value).dispatch("mouseover");
					d3.select("#gl_country"+ADM[0].value).style("fill",hover_color);
					}
				}else{
					d3.select("#gl_region"+d.key.replace(" ","")).style("fill",hover_color);
				}
				}
				})
				.on("mouseout",function(d){
					if(!gl_selection){
					d3.select(this).style("stroke-width",0.75);
					if(zoomLevel==2){
					var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
					if(ADM[0]!=undefined && ADM[0].value !=undefined){
					//d3.select("#gl_country"+ADM[0].value).dispatch("mouseout");
					d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});
					}
					}else{
						d3.select("#gl_region"+d.key.replace(" ","")).style("fill",function(e){return d3.select("#gl_region"+d.key.replace(" ","")).attr("basecolor");});
					}
				}
				});
				
				if(discrepancyMode==1 && gview){
					//add footnotes!!
					
					//console.log(dat[0].values);
					//console.log(dat);
					var footnotes = global_indicators_1.selectAll("g")
					.data(dat[0].values)
					.enter().append("g");
					
					//var footnotes = global_indicators_1.selectAll("circle")
					//.data(dat[0].values)
					//.enter()
					footnotes.append("text")
					.attr("class",function(d,i){
						if(d.footnotes[0]!=undefined){
							if(i > 0 && dat[0].values[i-1].footnotes[0] != undefined && d.footnotes[0][0].note != dat[0].values[i-1].footnotes[0][0].note){
								return "footnoteSymbol2";
							}else if(i==0 || dat[0].values[i-1].footnotes[0] == undefined){ //show first visible or first after a break
							return "footnoteSymbol2";
						}else{
							return "footnoteSymbol_repeat";
						}
					}else{
						return "footnoteSymbol2";
					}
					})
					//.attr("id",function(d,i){return "gl_scatter"+d.country})
					.text(function(d,i){
						if(d.footnotes[0]!=undefined){
							//return "*";
							if(i > 0 && dat[0].values[i-1].footnotes[0] != undefined && d.footnotes[0][0].note != dat[0].values[i-1].footnotes[0][0].note){
								return "*";
							}else if(i==0 || dat[0].values[i-1].footnotes[0] == undefined){ //show first visible or first after a break
								return "*";
							}else{
								return "*";
							}
							
						}else{
							return "";
						}
					})
					.style("stroke-width",0)
					.attr("x",function(d){return x(d.date);})
					.attr("y",function(d,i){if(i%2==0){
						if(mode){return y(d.autochthonous_cases_confirmed)-8;}else{return y(d.autochthonous_cases_suspected)-8;}
					}else{
						if(mode){return y(d.autochthonous_cases_confirmed)+18;}else{return y(d.autochthonous_cases_suspected)+18;}
					}})
					.on("mouseover",function(d){
						d3.select(this).style("stroke-width",1).style("cursor","pointer");
						//console.log(d.footnotes[0][0].note);
					})
					.on("mouseout",function(d){
						d3.select(this).style("stroke-width",0).style("cursor","default");
					});
					
					
					footnotes.append("line")
					.attr("class",function(d,i){
						if(d.footnotes[0]!=undefined){
							if(i > 0 && dat[0].values[i-1].footnotes[0] != undefined && d.footnotes[0][0].note != dat[0].values[i-1].footnotes[0][0].note){
								return "labelLine";
							}else if(i==0 || dat[0].values[i-1].footnotes[0] == undefined){
								return "labelLine";
							}else{
								return "nullLine";
							}
						}else{
								return "nullLine";
							}
							
							
						/*return "labelLine";
						}else{
							return "nullLine";
						}*/
					})
					.attr("x1",function(d){return x(d.date)+1;})
					.attr("y1", function(d,i){
						if(i%2==0){
						if(mode){return y(d.autochthonous_cases_confirmed)-10;}else{return y(d.autochthonous_cases_suspected)-10;}
					}else{
						if(mode){return y(d.autochthonous_cases_confirmed)+10;}else{return y(d.autochthonous_cases_suspected)+10;}
					}
					})
					.attr("x2",function(d){return x(d.date)+1;})
					.attr("y2", function(d,i){if(mode){return y(d.autochthonous_cases_confirmed);}else{return y(d.autochthonous_cases_suspected);}});	
					
					
					footnotes.append("title")
					.text(function(d){if(d.footnotes[0]!=undefined){return d.footnotes[0][0].note;}});
					
					
				}				
				
		
	  var xaxis = global_indicators_1.append("g")
		.attr("class","axis")	
	      .attr("transform", "translate(0,"+height+")")
		.call(d3.axisBottom(x)
			.ticks(7)
				. tickFormat(d3.timeFormat("%-m/%y")));
			//.selectAll("text")	
	          //.attr("dy", ".15em");
	  
	  var yaxis = global_indicators_1.append("g")
		.attr("class","axis")	  
			  .call(d3.axisLeft(y).ticks(4));	
			  
			  
	  var selector = global_indicators_1.append("g")
			  .attr("id","selector1");
			  
		 selector.append("rect")
		 .attr("x",x(choropleth_date))
		 .attr("y",-5)
		 .attr("width",5)
		 .attr("height",height+10)
		 .attr("fill",mapcolor)//"#9fcdf1")
	     .attr("stroke","black")	 
		 .on("mouseover",function(){ 
			 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
		 }) 
		 .on("mouseout",function(){
			 if(d3.select(this).classed("active")==false)
			 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
		 })  
		 .call(d3.drag()
			  .on("start",dragstarted)
			  .on("drag",dragged)
		 	  .on("end",dragended));	
			  
			  
		  	function dragstarted(d) {
		  	  d3.select(this).raise().classed("active", true);
			  linegraph.attr("pointer-events","none");
			  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
			  d3.select(this).attr("cursor","pointer").attr("stroke","none");
		  	}

		  	function dragged(d) {
				if(d3.event.x<=width && d3.event.x>=0){	
		  	  d3.select(this).attr("x", d3.event.x);
			  //update_gl_basecolor();
			  //have to calculate date - for fill
			  choropleth_date = x.invert(d3.event.x);// - new fill date
			  update_gl_basecolor(x.invert(d3.event.x));
			  var formatDate = d3.timeFormat("%m/%e/%y");
			  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(choropleth_date);});
			  update_gl_footnotes(formatDate(choropleth_date));
			  //update_gl_scatter(formatDate(choropleth_date));
		  	  }
		  	}

		  	function dragended(d) {
		  	  d3.select(this).classed("active", false);
			  linegraph.attr("pointer-events","all");
			  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
			  d3.select(this).attr("cursor","pointer").attr("stroke","black");
		  	}	
			
			
	//update in case the slider is set
			//console.log(choropleth_date);
			  //update_gl_basecolor(x.invert(x(choropleth_date)));
			  
    /////////	
			  	  
			  
	}	
	
	
	function draw_new_confirmed_chart(dat){
		var mode = 1;
		
		/*if(global_indicators_2 != undefined){
		d3.select("#gl_inds").selectAll("*").remove();
		}*/	
		d3.select("#new_conf").selectAll("*").remove();	
		d3.select("#new_conf").append("div").append("input").attr("type","radio").attr("name","selind").attr("value","new_autochthonous_cases_confirmed").attr("class","checkbox");
		
		
  	  var margin = {top: 20, right: 10, bottom: 30, left: 50},
      	width = 300 - margin.left - margin.right,
      	height = 100 - margin.top - margin.bottom;
		
		var x = d3.scaleTime().range([0, width]);
		var y = d3.scalePow().exponent(0.5).range([height, 0]);
		//var y = d3.scaleLinear().range([height, 0]);
		
		var valueline = d3.line()
		.x(function(d){return x(d.date);})
		.y(function(d){if(mode){return y(d.new_autochthonous_cases_confirmed);}else{return y(d.new_autochthonous_cases_suspected);}})
		//.curve(d3.curveCardinal);
		.curve(d3.curveCatmullRom);
		
		//console.log(d3.max(globalbycountry, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});}));
		//console.log(globalbycountry);
		
		x.domain(d3.extent(dat[0].values, function(v) {return v.date; }));
		y.domain([0,d3.max(dat, function(v){return d3.max(v.values,function(g){if(mode){return g.new_autochthonous_cases_confirmed;}else{return g.new_autochthonous_cases_suspected;}});})]);
		/*var min = d3.min(dat, function(v){return d3.max(v.values,function(g){return g.new_autochthonous_cases_confirmed;});});
		var max = d3.max(dat, function(v){return d3.max(v.values,function(g){return g.new_autochthonous_cases_confirmed;});});
		if(min!=max){
		y.domain([0,max]);
		}else{
			y.domain([0,max*2]);
		}*/
		
		
		y.domain([0,d3.max(dat, function(v){return d3.max(v.values,function(g){if(mode){return g.new_autochthonous_cases_confirmed;}else{return g.new_autochthonous_cases_suspected;}});})]);
		
		//var gl_inds = d3.select("#newConfirmedData").append("div");
		
	  var global_indicators_2 = d3.select("#new_conf").append("svg")
		.attr("class","gl_ind_charts")
		.attr("id","gl_inds")	  
 	   	.attr("width", width + margin.left + margin.right)
 	   	.attr("height", height + margin.top + margin.bottom)
	 	.append("g")
 	  	 .attr("transform",
        	"translate(" + margin.left + "," + margin.top + ")");
			
		
		
		global_indicators_2.append("text")
			.attr("class","chart_labels")
			.attr("x",-10)
			.attr("y",-10)
			.text(function(){if(mode){return "new confirmed cases";}else{return "new suspected cases";}});	
		
		
		var linegraph = global_indicators_2.selectAll("path")
			.data(dat)
			.enter()
			.append("path")
			.attr("id",function(d,i){return "line"+d.key})
			.attr("class","line")
			.style("stroke",function(d,i){return colors[i%colors.length];})
			.style("stroke-width",1)
			.style("fill","none")	
			.attr("d", function(d){ 
				//console.log(d.values);
				return valueline(d.values);
			});
			
			linegraph.on("mouseover",function(d){
				if(!gl_selection){
					d3.select(this).style("stroke-width",3);
					if(zoomLevel==2){
					var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
					if(ADM[0]!=undefined && ADM[0].value !=undefined){
					d3.select("#gl_country"+ADM[0].value).style("fill",hover_color)//dispatch("mouseover");
						}
						}else{
							d3.select("#gl_region"+d.key.replace(" ","")).style("fill",hover_color);
						}
					}
				})
			.on("mouseout",function(d){
				if(!gl_selection){
					d3.select(this).style("stroke-width",1);
					if(zoomLevel==2){
					var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
					if(ADM[0]!=undefined && ADM[0].value !=undefined){
					d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});//dispatch("mouseout");
					}
					}else{
						d3.select("#gl_region"+d.key.replace(" ","")).style("fill",function(e){return d3.select("#gl_region"+d.key.replace(" ","")).attr("basecolor");});
					}
					
					}
				});
		
	  var xaxis = global_indicators_2.append("g")
		.attr("class","axis")	
	      .attr("transform", "translate(0,"+height+")")
		.call(d3.axisBottom(x)
			.ticks(7)
				. tickFormat(d3.timeFormat("%-m/%y")));
			//.selectAll("text")	
	          //.attr("dy", ".15em");
	  
	  var yaxis = global_indicators_2.append("g")
		.attr("class","axis")	  
			  .call(d3.axisLeft(y).ticks(4));
			  
			  
			    
	}
	
	function update_gl_basecolor(max_date){
		
		//update countries
		gl_countries.each(function(d){
			var c = priorityCountryData.filter(function(v){return v.country == d.properties.ADMIN && v.date < max_date;});
			if(c[0]!=undefined){
				var color;
				if(ht){
					color = global_choropleth_ht(c[c.length-1][gl_choroplethIndicator]/(c[c.length-1].pop_x_1000));
				//return global_choropleth_ht(c[c.length-1].autochthonous_cases_confirmed/(c[c.length-1].pop_x_1000));	
				}else{
				color = global_choropleth(c[c.length-1][gl_choroplethIndicator]);	
				//color = global_choropleth(c[c.length-1].new_autochthonous_cases_confirmed);	
				//return global_choropleth(c[c.length-1].autochthonous_cases_confirmed);	
				}
				if(d3.select("#gl_country"+d.properties.ADM0_A3).attr("selected")!=1){
				d3.select("#gl_country"+d.properties.ADM0_A3).style("fill",color);
				}
				return color;
			}
		});
		
		//update regions
		 var formatDate = d3.timeFormat("%m/%e/%y");
		 //console.log(max_date);
		
		gl_subregions.each(function(d){	
			var cp = regionalData.filter(function(v){return v.key == d.properties.SUBREGION;})[0].values;
			//console.log(cp);
			var c = cp.filter(function(v){return formatDate(new Date(v.key)) <= formatDate(max_date);});
			//console.log(c);
			if(c[0]!=undefined){
				var color;
				if(ht){
					color = regional_choropleth_ht(c[c.length-1].value[gl_choroplethIndicator]/(c[c.length-1].value.pop_x_1000));	
				}else{
					color = regional_choropleth(c[c.length-1].value[gl_choroplethIndicator]);		
				}
				if(d3.select(this).attr("selected")!=1){
					d3.select(this).attr("basecolor",color); 
					d3.select(this).style("fill",d3.select(this).attr("basecolor"));
				}
				return color;
			}
		});
	}
	
	function gl_updateCountries(){	
		//countries
		//var indicator = "autochthonous_cases_confirmed";
		//console.log(gl_choroplethIndicator);
		
		gl_countries.each(function(d){
			var c = globaldata.filter(function(v){return v.country == d.properties.ADMIN;});
			if(priority_countries.indexOf(d.properties.ADMIN)!=-1){
			if(c[0] != undefined){
				
			//new_autochthonous_cases_confirmed	
			//autochthonous_cases_confirmed
			//autochthonous_cases_suspected
			//confirmed_congenital_syndrome
			//death_among_zika_cases
			//imported_cases
			//incidence_rate	
				
				// Mar 14 -- change c[c.length-1].autochthonous_cases_confirmed to c[c.length-1]["autochthonous_cases_confirmed"] - to pass as argument
				
			var color;
				if(ht){
					color = global_choropleth_ht(c[c.length-1][gl_choroplethIndicator]/(c[c.length-1].pop_x_1000));
				//return global_choropleth_ht(c[c.length-1].autochthonous_cases_confirmed/(c[c.length-1].pop_x_1000));	
				}else{
					//console.log("fingers crossed");
					//console.log(c[c.length-1].autochthonous_cases_confirmed);
					//console.log(c[c.length-1][indicator]);	
					
				color = global_choropleth(c[c.length-1][gl_choroplethIndicator]);	
				//color = global_choropleth(c[c.length-1].new_autochthonous_cases_confirmed);	
				//return global_choropleth(c[c.length-1].autochthonous_cases_confirmed);	
				}
				if(d3.select("#gl_country"+d.properties.ADM0_A3).attr("selected")!=1){
				d3.select("#gl_country"+d.properties.ADM0_A3).attr("basecolor",color);
				d3.select("#gl_country"+d.properties.ADM0_A3).style("fill",color);
				}
				return color;
			}
			}
		});
		//regions
		gl_subregions.each(function(d){	
			var c = regionalData.filter(function(v){return v.key == d.properties.SUBREGION;})[0].values;
			if(c[0]!=undefined){
				var color;
				if(ht){
					color = regional_choropleth_ht(c[c.length-1].value[gl_choroplethIndicator]/(c[c.length-1].value.pop_x_1000));	
				}else{
					color = regional_choropleth(c[c.length-1].value[gl_choroplethIndicator]);		
				}
				if(d3.select(this).attr("selected")!=1){
					d3.select(this).attr("basecolor",color); 
					d3.select(this).style("fill",d3.select(this).attr("basecolor"));
				}
				return color;
			}
		});
		update_gl_basecolor(choropleth_date);
	  var formatDate = d3.timeFormat("%m/%e/%y");
	  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(choropleth_date);});
	  update_gl_footnotes(formatDate(choropleth_date));
	}
	
	
	
	function update_gl_footnotes2(max_date){
	  var formatDate = d3.timeFormat("%m/%e/%y");
	  var formatYear = d3.timeFormat("%y");
	  
	  var yr = formatYear(choropleth_date);
	  
	  footnote_symbols.each(function(d){
	  	d3.select(this)
		  .text(function(d){
  		  var dd = d.values.filter(function(e){return formatDate(e.date)<=max_date && formatYear(e.date) == yr;});
		  //console.log(dd[dd.length-1]);
  		  if(dd[dd.length-1].footnotes[0]!=undefined){
  			  return "*";
  		  }else{
  			  return "";
  		  }
	  	})
	});
	
  footnote_symbols.each(function(d){
  	d3.select(this)
	  .text(function(d){
		  var dd = d.values.filter(function(e){return formatDate(e.date)<=max_date && formatYear(e.date) == yr;});
	  //console.log(dd[dd.length-1]);
		  if(dd[dd.length-1].footnotes[0]!=undefined){
			  return "*";
		  }else{
			  return "";
		  }
  	})
});

	
	footnote_symbols.append("title")
	.html(function(d){
  		  var dd = d.values.filter(function(e){return formatDate(e.date)<=max_date && formatYear(e.date) == yr;});
		  //console.log(max_date);
		  //console.log(dd);
  		  if(dd[dd.length-1].footnotes[0]!=undefined){
			  var txt = "";
		  	  dd[dd.length-1].footnotes[0].forEach(function(e,i){
		  		txt += e.date+": "+e.note+"<br />";
		  	});
			return txt;
  		 }
	});
	
	update_gl_scatter(max_date);
	
}
	
	
	
	function update_gl_footnotes(max_date){
	  var formatDate = d3.timeFormat("%m/%e/%y");
	  var formatYear = d3.timeFormat("%y");
	  
	  var parseTime = d3.timeParse("%m/%e/%y");
	  var parseYear = d3.timeFormat("%y");
	  
	  var yr = formatYear(choropleth_date);
	  
	//var current = globalbyDatebyCountry.filter(function(e){return e.key==choropleth_date;})[0].values.filter(function(e){return e.values[0].footnotes.length > 0;});
	
	var tmp_current = globalbyDatebyCountry.filter(function(e){return formatDate(new Date(e.key))<=max_date && formatYear(new Date(e.key)) == yr;});//[0].values.filter(function(e){return e.values[0].footnotes.length > 0;});
	
	if(tmp_current[tmp_current.length-1]!=undefined){
		var newdate = tmp_current[tmp_current.length-1].key;
	var current = tmp_current[tmp_current.length-1].values.filter(function(e){return e.values[0].footnotes.length > 0;});
	
	//FIX
	//override exPAHO_global_footnotesisting featuregroup
	PAHO_global_footnotes.clearLayers();
	discrepancy_histogram[0].values.filter(function(f){return f.name == "adjustment";})[0].count=0;
	
	
	current.forEach(function(e){
		//var v = e.values[0].footnotes[0];
		//console.log(e.values[0].footnotes[0][0].note);
		var dd = ADM1_lookup.filter(function(f){return f.key==e.key;})[0];
		if(dd!=undefined){
			//console.log(dd);
			_marker = L.marker([+dd.lat2,+dd.lng2],{icon:greyIcon}).bindPopup("<strong>"+e.key+"</strong>"+": "+e.values[0].date+"<br>"+e.values[0].footnotes[0][0].note);
			PAHO_global_footnotes.addLayer(_marker);
			discrepancy_histogram[0].values.filter(function(f){return f.name == "adjustment";})[0].count++;
		}
	});
	
	if(gview){
	PAHO_global_footnotes.addTo(global_map);
	}
	//this is a problem...gotta find the workaround can't grab last then. have to find the closest previous date
	//console.log(newdate);
	//console.log(formatDate(new Date(newdate)));
	
	discrepancy_data_filtered = discrepancy_data.filter(function(e){/*console.log(formatDate(parseTime(e.date)));*/ return e.date=="" || formatDate(parseTime(e.date))==formatDate(new Date(newdate));});
	
	
	if(discrepancyMode!=0)hideFootnotes();
	//console.log(discrepancy_data_filtered);
	draw_discrepancy_points();
	
	//update_discrepancy_charts();
	
	}
	  
	  /*footnote_symbols.each(function(d){
	  	d3.select(this)
		  .text(function(d){
  		  var dd = d.values.filter(function(e){return formatDate(e.date)<=max_date && formatYear(e.date) == yr;});
		  //console.log(dd[dd.length-1]);
  		  if(dd[dd.length-1].footnotes[0]!=undefined){
  			  return "*";
  		  }else{
  			  return "";
  		  }
	  	})
	});
	
		
		footnote_symbols.append("title")
		.html(function(d){
    		  var dd = d.values.filter(function(e){return formatDate(e.date)<=max_date && formatYear(e.date) == yr;});
			  //console.log(max_date);
			  //console.log(dd);
    		  if(dd[dd.length-1].footnotes[0]!=undefined){
				  var txt = "";
			  	  dd[dd.length-1].footnotes[0].forEach(function(e,i){
			  		txt += e.date+": "+e.note+"<br />";
			  	});
				return txt;
    		 }
		});*/
		
		update_gl_scatter(max_date);
		
	  }
	  
	  function update_gl_scatter(max_date){
	  	//just need to change cx and cy for each
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  
		  d3.select("#gl_scatterplot_label").text("total suspected cases vs. cases p.h.t ("+max_date+")");
		  //console.log(max_date);
		  //console.log(globalbyDatebyCountry.filter(function(e){return formatDate(e.key)<=formatDate(choropleth_date);}));
		  var dd = globalbyDatebyCountry.filter(function(e){return formatDate(new Date(e.key))<=max_date;});
		  
		  //console.log(dd);
		  
		  if(dd[dd.length-1]!=undefined){
		  gl_scatterpoints.each(function(d,i){
			  var id = d3.select(this).attr("id").replace("gl_scatter","");
			  //console.log(id);
			  var val = dd[dd.length-1].values.filter(function(e){return e.key == id;})[0];
			  //console.log(val);
			  if(val!=undefined){
				  val = val.values;
			  
		  		  d3.select(this)
				  .attr("cx",function(d,i){return x_gl_scatter(val[0].autochthonous_cases_suspected);})
				  .attr("cy",function(d,i){return y_gl_scatter(val[0].autochthonous_cases_suspected/val[0].pop_x_1000);});
		  
		  		d3.select(this).selectAll("title").remove();
		  	  
    			d3.select(this).append("title")
    				.text(val[0].country+" ["+val[0].autochthonous_cases_suspected+"; "+(val[0].autochthonous_cases_suspected/d.pop_x_1000)+"]");
				}
		   
		  });
	  }
	  }
	  
	  /*footnote_symbols.append("title")
	  .html(function(d){
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  var dd = d.values.filter(function(e){return formatDate(e.date)==choropleth_date_formatted;});
		  console.log(dd);
	   if(dd[0].footnotes[0]!=undefined){
		  var txt = "";
	  	  dd[0].footnotes[0].forEach(function(e,i){
	  		txt += e.date+": "+e.note+"<br />";
	  	});
		return txt;
		}
	  })*/ 
	  
	  
  	function update_c_choropleths(){
		
  		//update global extrema  
		var cef = country_epi.filter(function(f){return f.data_field==c_choroplethIndicator && f.location_type!="country";});
		
	 	c_mx = d3.max(cef,function(f){return f.value;});
	 	c_mn = d3.min(cef,function(f){return f.value;});
		
		console.log(c_mx+" "+c_mn);
	
	 	c_mx_ht = d3.max(cef,function(f){return f.value/(f.pop/1000);});
	 	c_mn_ht = d3.min(cef,function(f){return f.value/(f.pop/1000);}); 
		
		console.log(c_mx_ht+" "+c_mn_ht);
		
	    var c_logScale = d3.scaleLog()
	      .domain([1, c_mx])
	    var c_colorScaleLog = d3.scaleSequential(
	        (d) => d3.interpolateReds(c_logScale(d))
	      ); 
	
	      var c_logScale_ht = d3.scaleLog()
	        .domain([0.001, c_mx_ht])
	      var c_colorScaleLog_ht = d3.scaleSequential(
	          (d) => d3.interpolateReds(c_logScale_ht(d))
	        );
			
			country_choropleth = c_colorScaleLog;
		  	country_choropleth_ht = c_colorScaleLog_ht;
				
				
  		//gl_updateCountries();	
  		//legend_all.remove();
  		legend_all.remove();
		gl_update_legends();
		update_c_basecolor(c_choropleth_date);
		
  	}
	  
	  
  	function update_c_basecolor(max_date){	
  		//update countries
		var v_data = country_byDatebyRegion.filter(function(c){return new Date(c.key) <= new Date(formatDate(new Date(c_choropleth_date)));});
		//console.log(d_data);
		var d_data = v_data[v_data.length-1];
		
		
  		regions.each(function(d){
			var dd_data = d_data.values.filter(function(c){return c.key == d.properties.fips;})[0];
			var ddd_data;
			if(dd_data!=undefined){
				var ddd_data_0 = dd_data.values.filter(function(g){return g.key == c_choroplethIndicator;})[0];
				if(ddd_data_0!=undefined){
				 ddd_data = ddd_data_0.values[0];
				}else{
					return undefined;
				}
				
				
				//ddd_data = dd_data.values.filter(function(g){return g.key == c_choroplethIndicator;})[0].values[0];
			}
			
			
			d3.select(this).attr("basecolor",function(e){
				
				//var dd_data = d_data.values.filter(function(c){return c.key == d.properties.fips;})[0];
				//console.log(dd_data);
				if(ddd_data!=undefined){
					//var ddd_data = dd_data.values.filter(function(g){return g.key == c_choroplethIndicator;})[0].values[0];
					
					if(ht){
						return country_choropleth_ht(ddd_data.value/(ddd_data.pop/1000));
					}else{
						return country_choropleth(ddd_data.value);
					}
				}else{
					return "gray";
				}
	  		});
			d3.select(this).select("title").text(function(d){
				if(ddd_data!=undefined){
			return d.properties.NAME_1+": "+ddd_data.value+
				"(total) "+ddd_data.value/(ddd_data.pop/1000)+" (per H.T)";
				}else{
					return d.properties.NAME_1+": (unknown)";
				}
			});
			d3.select(this).style("fill",d3.select(this).attr("basecolor"));
				
			});
  	}  
		
	//regions.append("title")
	//.text(function(d){
	//	return d.properties.NAME_1+": "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value")+
	//	"(total) "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value_ht")+" (per H.T)";
	//});
	
	function draw_by_indicators(dat){
		
		//console.log(dat);
	
		d3.select("#byIndicatorData").selectAll("*").remove();	
		
		/*d3.select("#byIndicatorData").append("text")
		.text("BY INDICATOR")
		.attr("class","subtitle");	*/
	  //pass filtered data	
		//console.log(globalbycountry);
		
			
  	  var margin = {top: 25, right: 10, bottom: 30, left: 50},
      	width = 175 - margin.left - margin.right,
      	height = 100 - margin.top - margin.bottom;
		
		var x = d3.scaleTime().range([0, width]);
		//var y = d3.scaleLog().range([height, 0]);
		var y = d3.scaleLinear().range([height, 0]);
		
		var valueline = d3.line()
		.x(function(d){return x(d.date);})
		.y(function(d){
			var i = d.current_ind;
			//console.log(i);
			y.domain([doms_min[i],doms[i]]);
			
			if(i==0){
			return y(d.autochthonous_cases_confirmed);
			}else
			if(i==1){
			return y(d.autochthonous_cases_suspected);
			}else
			if(i==2){
			return y(d.confirmed_congenital_syndrome);
			}else
			if(i==3){
			return y(d.death_among_zika_cases);
			}else
			if(i==4){
			return y(d.imported_cases);
			}else
			if(i==5){
			return y(d.incidence_rate);
			}
		});
				
		
		x.domain(d3.extent(dat[0].values, function(v) {return v.date; }));
		//y.domain([0,d3.max(globalbycountry, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});})]);
		
		//VARY - have to automate this. 
		var doms = [];
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.autochthonous_cases_confirmed;})}));
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.autochthonous_cases_suspected;})}));
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.confirmed_congenital_syndrome;})}));
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.death_among_zika_cases;})}));
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.imported_cases;})}));
		doms.push(d3.max(dat, function(v){return d3.max(v.values,function(f){return f.incidence_rate;})}));
		
		var doms_min = [];
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.autochthonous_cases_confirmed;})}));
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.autochthonous_cases_suspected;})}));
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.confirmed_congenital_syndrome;})}));
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.death_among_zika_cases;})}));
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.imported_cases;})}));
		doms_min.push(d3.min(dat, function(v){return d3.min(v.values,function(f){return f.incidence_rate;})}));
		
		
		//y.domain([0,doms[5]]);
		
		//console.log(doms);
		
		var global_indicators_3a = d3.select("#byIndicatorData")
		.selectAll("svg")
		.data(global_indicators)
		.enter().append("div").attr("class","small_charts");
		
		/* || (this.value=="autochthonous_cases_confirmed" && gl_choroplethIndicator=="new_autochthonous_cases_confirmed")*/
		
		global_indicators_3a.append("input").attr("type","radio").attr("name","selind").attr("value",function(d,i){return d;}).attr("class","checkbox");//.attr("checked",function(){ if(this.value==gl_choroplethIndicator){console.log(this.value); console.log(gl_choroplethIndicator); return false;}else{return true;}});
		//COMEBACK
		global_indicators_3a.selectAll("input").each(function(){
			if(this.value==gl_choroplethIndicator || (this.value=="autochthonous_cases_confirmed" && gl_choroplethIndicator=="new_autochthonous_cases_confirmed")){
				d3.select(this).attr("checked",true);	
			}
		})
		
		
		var global_indicators_3 = global_indicators_3a.append("svg")
		.attr("class","globalCharts")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.bottom)
	  .append("g")
		.attr("id",function(d,i){return "ind_"+i;})
	    .attr("transform",
		"translate(" + margin.left + "," + margin.top + ")");
		
		
	global_indicators_3.append("text")
		.attr("class","chart_labels")
		.attr("x",-25)
		.attr("y",-18)
		.text(function(d){return d;});
		
		linegraph = global_indicators_3.selectAll("path")
		.data(dat)
		.enter()
		.append("path")
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")
		.attr("d", function(d,i,j){
			k = +j[i].parentNode.id.replace("ind_","");
			//console.log(k);
			
			d.values.forEach(function(c){
				c.current_ind = k;	
			})
			//console.log(d.values);
			//y.domain([0,9000]);
			
			/*var vline = d3.line()
			.x(function(f){return x(f.date);})
			.y(function(f){
				var global_indicators_n = [f.autochthonous_cases_confirmed,f.autochthonous_cases_suspected,f.confirmed_congenital_syndrome,f.death_among_zika_cases,f.imported_cases,f.incidence_rate];
				
				return y(global_indicators_n[i]);
			});*/
			
			//return vline(d.values)
			return valueline(d.values)
		;})
			.on("mouseover",function(d){
				//console.log(d);
				if(!gl_selection){
				d3.select(this).style("stroke-width",3);
				if(zoomLevel==2){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				//d3.select("#gl_country"+ADM[0].value).dispatch("mouseover");
				d3.select("#gl_country"+ADM[0].value).style("fill",hover_color);
				}
				}else{
					d3.select("#gl_region"+d.key.replace(" ","")).style("fill",hover_color);
				}
			}
				
			})
			.on("mouseout",function(d){
				if(!gl_selection){
				
				d3.select(this).style("stroke-width",0.75);
				if(zoomLevel==2){
				var ADM = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
				if(ADM[0]!=undefined && ADM[0].value !=undefined){
				//d3.select("#gl_country"+ADM[0].value).dispatch("mouseout");
				d3.select("#gl_country"+ADM[0].value).style("fill",function(e){return d3.select("#gl_country"+ADM[0].value).attr("basecolor");});
				}
			}else{
				d3.select("#gl_region"+d.key.replace(" ","")).style("fill",function(e){return d3.select("#gl_region"+d.key.replace(" ","")).attr("basecolor");});
			}
				
			   }
			});
			
			
  var selector = global_indicators_3.append("g")
		  .attr("id","selector1");
		  
	 selector.append("rect")
	 .attr("x",x(choropleth_date))
	 .attr("y",-5)
	 .attr("width",5)
	 .attr("height",height+10)
	 .attr("fill",mapcolor)//"#9fcdf1")
     .attr("stroke","black")	 
	 .on("mouseover",function(){ 
		 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
	 }) 
	 .on("mouseout",function(){
		 if(d3.select(this).classed("active")==false)
		 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
	 })  
	 .call(d3.drag()
		  .on("start",dragstarted)
		  .on("drag",dragged)
	 	  .on("end",dragended));	
		  
		  
	  	function dragstarted(d) {
	  	  d3.select(this).raise().classed("active", true);
		  linegraph.attr("pointer-events","none");
		  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
		  d3.select(this).attr("cursor","pointer").attr("stroke","none");
	  	}

	  	function dragged(d) {
			if(d3.event.x<=width && d3.event.x>=0){	
	  	  d3.select(this).attr("x", d3.event.x);
		  //update_gl_basecolor();
		  //have to calculate date - for fill
		  choropleth_date = x.invert(d3.event.x);// - new fill date
		  update_gl_basecolor(x.invert(d3.event.x));
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(choropleth_date);});
		  update_gl_footnotes(formatDate(choropleth_date));
		  update_gl_scatter(formatDate(choropleth_date));
		  
		  selector.selectAll("rect").each(function(){
			  d3.select(this).attr("x",x(choropleth_date));
		  })
		  
	  	  }
	  	}

	  	function dragended(d) {
	  	  d3.select(this).classed("active", false);
		  linegraph.attr("pointer-events","all");
		  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
		  d3.select(this).attr("cursor","pointer").attr("stroke","black");
	  	}	  	  
			
			
	  
	  var formatDate = d3.timeFormat("%m/%e/%y");
	  update_gl_basecolor(choropleth_date);
	  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(choropleth_date);});
	  update_gl_footnotes(formatDate(choropleth_date));	
			
			
			if(discrepancyMode==1){
				//var mode = 1;
				
				var footnotes = global_indicators_3.selectAll("g")
				.data(dat[0].values)
				.enter().append("g")
				.attr("id",function(d,i,j){
					return j[i].parentNode.id;
				});
				
				footnotes.append("text")
				.attr("class","footnoteSymbol2")
				.text(function(d,i){
					if(d.footnotes[0]!=undefined){
						if(i > 0 && dat[0].values[i-1].footnotes[0] != undefined && d.footnotes[0][0].note != dat[0].values[i-1].footnotes[0][0].note){
							return "*";
						}else if(i==0 || dat[0].values[i-1].footnotes[0] == undefined){ //show first visible or first after a break
							return "*";
						}else{
							return "";//"."
						}
					}else{
						return "";
					}
				})
				.style("stroke-width",0)
				.attr("x",function(d){return x(d.date);})
				.attr("y", function(d,i,j){
					var g = 0;
					if(i%2==0){
						g = 18;
					}else{
						g = -8;
					}
					
					var k = +j[i].parentNode.id.replace("ind_","");
							//console.log(d3.select(this).attr("ind"));
							
							var v = dat[0].values.filter(function(g,l){
								return g.date == d.date;
							});
							//console.log(v);
							y.domain([doms_min[k],doms[k]]);
			
							if(k==0){
							return y(v[0].autochthonous_cases_confirmed)+g;
							}else
							if(k==1){
							return y(v[0].autochthonous_cases_suspected)+g;
							}else
							if(k==2){
							return y(v[0].confirmed_congenital_syndrome)+g;
							}else
							if(k==3){
							return y(v[0].death_among_zika_cases)+g;
							}else
							if(k==4){
							return y(v[0].imported_cases)+g;
							}else
							if(k==5){
							return y(v[0].incidence_rate)+g;
							}
						}
				)
				.on("mouseover",function(d){
					d3.select(this).style("stroke-width",1).style("cursor","pointer");
					//console.log(d.footnotes[0][0].note);
				})
				.on("mouseout",function(d){
					d3.select(this).style("stroke-width",0).style("cursor","default");
				});
				
				
				
				footnotes.append("line")
				.attr("class",function(d,i){
					if(d.footnotes[0]!=undefined){
						if(i > 0 && dat[0].values[i-1].footnotes[0] != undefined && d.footnotes[0][0].note != dat[0].values[i-1].footnotes[0][0].note){
							return "labelLine";
						}else if(i==0 || dat[0].values[i-1].footnotes[0] == undefined){
							return "labelLine";
						}else{
							return "nullLine";
						}
					}else{
							return "nullLine";
						}
				})
				.attr("x1",function(d){return x(d.date)+1;})
				.attr("y1", function(d,i,j){
					var k = +j[i].parentNode.id.replace("ind_","");
							//console.log(d3.select(this).attr("ind"));
							
							var v = dat[0].values.filter(function(g,l){
								return g.date == d.date;
							});
							//console.log(v);
							y.domain([doms_min[k],doms[k]]);
			
							if(k==0){
							return y(v[0].autochthonous_cases_confirmed);
							}else
							if(k==1){
							return y(v[0].autochthonous_cases_suspected);
							}else
							if(k==2){
							return y(v[0].confirmed_congenital_syndrome);
							}else
							if(k==3){
							return y(v[0].death_among_zika_cases);
							}else
							if(k==4){
							return y(v[0].imported_cases);
							}else
							if(k==5){
							return y(v[0].incidence_rate);
							}
						}
			
				)
				.attr("x2",function(d){return x(d.date)+1;})
				.attr("y2",function(d,i,j){
					var g = 0;
					if(i%2==0){
						g = 8;
					}else{
						g = -8;
					}
					
					var k = +j[i].parentNode.id.replace("ind_","");
							//console.log(d3.select(this).attr("ind"));
							
							var v = dat[0].values.filter(function(g,l){
								return g.date == d.date;
							});
							//console.log(v);
							y.domain([doms_min[k],doms[k]]);
			
							if(k==0){
							return y(v[0].autochthonous_cases_confirmed)+g;
							}else
							if(k==1){
							return y(v[0].autochthonous_cases_suspected)+g;
							}else
							if(k==2){
							return y(v[0].confirmed_congenital_syndrome)+g;
							}else
							if(k==3){
							return y(v[0].death_among_zika_cases)+g;
							}else
							if(k==4){
							return y(v[0].imported_cases)+g;
							}else
							if(k==5){
							return y(v[0].incidence_rate)+g;
							}
						} 
				);
				
				footnotes.append("title")
				.text(function(d){if(d.footnotes[0]!=undefined){return d.footnotes[0][0].note;}});
				
			}
			
		
var xaxis = global_indicators_3.append("g")
.attr("class","axis")	
    .attr("transform", "translate(0,"+height+")")
.call(d3.axisBottom(x)
	.ticks(5)
	.tickFormat(d3.timeFormat("%-m/%y")))		
	.selectAll("text")	
    .attr("dy", ".35em");
		
		
		global_indicators.forEach(function(d,i){
			//var yy = d3.scaleLog().range([height, 0]).domain([0.1,doms[i]]);
			var yy = d3.scaleLinear().range([height, 0]).domain([0,doms[i]]);//domain([doms_min[i],doms[i]]);
			
			d3.select("#ind_"+i+"").append("g")
			.attr("class","axis")
			.call(d3.axisLeft(yy).ticks(4));
			
			
		})
		
	}
	 
	 //console.log(topojson.feature(awards,awards.objects.usaidawards).features);	 

//draw menu
  function drawMenu(){
 //global view button	  
	var global_view_btn = d3.select("#mapheader").append("button")
	  .text("Global View")
	  .on("click", function(d){
		d3.select("#overview").style("opacity",0);  
	  	d3.select("#global_container").moveToFront();
	  });
  	}
	 
	  function drawMenu2(){
	 //global view button	  
		var global_view_btn = d3.select("#menu").append("button")
		  .text("Global View")
		  .on("click", function(d){
			d3.select("#overview").style("opacity",0);  
		  	d3.select("#global_container").moveToFront();
		  });
		  
		  
	  //from https://bl.ocks.org/caravinden/eb0e5a2b38c8815919290fa838c6b63b	  
	  // set the dimensions and margins of the graph
	  var margin = {top: 20, right: 10, bottom: 30, left: 5},
	      width = 100 - margin.left - margin.right,
	      height = 500 - margin.top - margin.bottom;
		  // set the ranges
		  var y = d3.scaleBand()
      		.range([height, 0])
     		 .padding(0.5);

		 var x = d3.scalePow(3)
      		.range([0, width]);
			
		 var x_ht = d3.scalePow(3)
      		.range([0, width]);	
			
			var b_colors = ["#808080","#D3D3D3"];//["#2ca25f","#99d8c9"];	
		
  // append the svg object to the body of the page
  // append a 'group' element to 'svg'
  // moves the 'group' element to the top left margin
  var menu_svg = d3.select("#menu").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", 
            "translate(" + margin.left + "," + margin.top + ")");
			
		  // Scale the range of the data in the domains
		    x.domain([0, d3.max(globaldataFS, function(d){ return d.autochthonous_cases_confirmed; })])
		    y.domain(globaldataFS.map(function(d) { return d.country; }));
			
			x_ht.domain([0, d3.max(globaldataFS, function(d){ return (d.autochthonous_cases_confirmed/d.pop_x_1000); })])	
			
			
			//console.log(globalbycountry);
	  // append the rectangles for the bar chart
	   var gs = menu_svg.append("g")
			.selectAll("g")
			.data(globalbycountryS)
			.enter().append("g")
			.attr("transform", function(d) { return "translate(0," + y(d.key) + ")"; });
			
			gs.append("text")
			.attr("y","-2px")
			.attr("class","gl_country_labels")
			.attr("cursor","pointer")
			//.text(function(d){return "h";});
			.text(function(d){return d.key;})
			.on("click",function(d,i){
				//console.log(d.key);
				//var t = ADM0_A3_lookup.filter(function(v){//console.log(v.key); 
				//	return v.key == d.key;});
				//var t2 = ADM0_A3_lookup.filter(function(v){return v.key == "Venezuela";});
				//var title = ADM0_A3_lookup.filter(function(v){return v.value == adm0;})[0].key;
				
				
				//ADM0 = t[0].value;
				
				//setCountry(ADM0);
				d3.select("#"+d.key.replace(" ","_")+"_0").dispatch("click");
			});
			
			gs.selectAll(".bar")
	        .data(function(d){
				//console.log(d.values.length);
				var n = d.values.length-1;
				return [{key:d.key,value:d.values[n].autochthonous_cases_confirmed},{key:d.key,value:(d.values[n].autochthonous_cases_confirmed/d.values[n].pop_x_1000)}];})
	      .enter().append("rect")
			//.attr("id",function(d){return "b1"+d.country;})
	        .attr("class", "bar")
			.attr("id",function(d,i){//console.log(d.key.replace(" ","_")+"_"+i); 
			return d.key.replace(" ","_")+"_"+i;})	
	        //.attr("x", function(d) { return x(d.sales); })
			.attr("width", function(d,i) {
				if(i==0){
				return x(d.value);
				}else if(i==1){
					return x_ht(d.value);
				}
			})
	        //.attr("width", function(d) {return x(d.autochthonous_cases_confirmed); } )
	        .attr("y", function(d,i) { return i*((y.bandwidth()/2)); })
			.style("fill", function(d,i){
				return b_colors[i];
				/*var t = ADM0_A3_lookup.filter(function(v){return v.key == d.key;});
				if(t[0].value == ADM0){
					d.selected = true;
					return hover_color;
				}else{
					d.selected = false;
				return b_colors[i];}*/
			})
	        .attr("height", y.bandwidth()/2)
			.on("mouseover",function(d,i){
				if(d.key.replace(" ","_")+"_"+i!=prev_menu){
				d3.select(this).style("fill",hover_color);
				}
			})
			.on("mouseout",function(d,i){
				if(d.key.replace(" ","_")+"_"+i!=prev_menu){
				d3.select(this).style("fill",b_colors[i]);
				}
			})
			.on("click",function(d,i){
				d.selected = !d.selected;
				
				if(prev_menu!=undefined){
					var g = prev_menu.split("_")
					var c = +g[g.length-1];
					
					d3.select("#"+prev_menu).style("fill",b_colors[c]);
				}
				
				prev_menu = d.key.replace(" ","_")+"_"+i;
				d3.select("#"+prev_menu).style("fill",hover_color);
				
				//console.log(d.key);
				var t = ADM0_A3_lookup.filter(function(v){//console.log(v.key); 
					return v.key == d.key;});
				//var t2 = ADM0_A3_lookup.filter(function(v){return v.key == "Venezuela";});
				//console.log(t[0].value+" "+i);
				//d3.select(this).style("fill","steelblue");
				
				ADM0 = t[0].value;
				
				if(i==0){
					ht = false;
					tot_btn.style("background","#ccc");
					pht_btn.style("background","none");
				}else{
					ht = true;
					pht_btn.style("background","#ccc");
					tot_btn.style("background","none");
				}
				
				setCountry(ADM0);
			});
			
		/*menu_svg.append("g")
			.selectAll("g")
			.data(globaldataF)
			.enter().append("g")
			//.attr("transform", function(d) { return "translate(" + x0(d.State) + ",0)"; })
			.selectAll(".bar")
	        .data(function(d){return {key:d.key, values:[d.autochthonous_cases_confirmed, d.autochthonous_cases_confirmed/d.pop_x_1000]}; )
	      .enter().append("rect")
			.attr("id",function(d,i){console.log(d); return "b1"+d.key+"_"+i;})
	        .attr("class", "bar")
	        //.attr("x", function(d) { return x(d.sales); })
	        .attr("width", function(d) {return x(d.value); } )
	        .attr("y", function(d) { return y(d.key); })
	        .attr("height", "10px");//y.bandwidth());*/	
			
	    
	    // add the x Axis
	    menu_svg.append("g")
	        //.attr("transform", "translate(0,50px)")
			.attr("class","axis1")
	        .call(d3.axisTop(x).ticks(2));
			
	    menu_svg.append("g")
	        .attr("transform", "translate(0," + height + ")")
			.attr("class","axis2")
	        .call(d3.axisBottom(x_ht).ticks(2));	

	    // add the y Axis
	    /*menu_svg.append("g")
	        .call(d3.axisLeft(y));*/
			
		  /*menu_svg.append("text")
			.text(function(d){return d.country;})
			.attr("class","date-labels");*/	
		
	  }


//setup based on country
	  function setCountry(adm0){
		  	
		  
		  console.log(adm0);
		  //console.log(footnote_data);
		  //clear things
		  if(mapview_svg != undefined){
		  mapview_svg.selectAll("g").remove();
	  	  }
		  d3.select("#censusData").selectAll("*").remove();
		  
		  if(sm_view !=undefined){
			  d3.select("#smview").remove();
		  }
		  
		  if(sm_legend !=undefined){
			  d3.select("#smlegend").remove();
		  }
		  
		  
		  
		  if(regions!=null){
			  features.selectAll("*").remove();
		  }if(subregions!=null){
		  	  subfeatures.selectAll("*").remove();
		  }if(efforts!=null){
		  	  awards_shp.selectAll("*").remove();
		  }
		  
		  
		  	  
		
		if(footnote_data !=undefined){
		footnotes.removeFrom(country_map);
		footnotes.clearLayers();
		
  		footnotes = new L.FeatureGroup();
  		for(i=0;i<footnote_data.length;i++){
  			//console.log(footnote_data[i]);
  		  	if(footnote_data[i].lat != "" && footnote_data[i].lng != "" && footnote_data[i].comment != "" && footnote_data[i].country == adm0){
				_marker = L.marker([+footnote_data[i].lat,+footnote_data[i].lng],{icon:L.icon.Default, iconSize:[20,20]}).bindPopup(footnote_data[i].comment);
  			//console.log(_marker);
  			footnotes.addLayer(_marker);
  			}
  		}
  		//console.log("break");
  		//console.log(country_map);
  		if(country_map != undefined){
  		footnotes.addTo(country_map);
  		}
		}	
			  
		  //console.log(places_topo);
		  //console.log(adm0);
		  
		  //filter data to country
		  //country_adm1_features = geodata_admin1.features.filter(function(d){return d.properties.adm0_a3 == adm0;}); 
		  //country_adm2_features = adm2_shapes2.filter(function(d){return d.key == adm0;})[0].value; 
		  country_adm1_features = adm1g.features.filter(function(d){return d.properties.ISO == adm0;}); 
		  country_adm2_features = adm2g.features.filter(function(d){return d.properties.ISO == adm0;});
		  
		  country_centroid = geodata_admin0.features.filter(function(d){return d.properties.ADM0_A3 == adm0;});
		  country_pop = pop_pls.features.filter(function(d){return d.properties.ADM0_A3 == adm0;});
		  country_pov = poverty.filter(function(d){return d.Country_Code.indexOf(adm0) != -1;})
		  country_title = ADM0_A3_lookup.filter(function(v){return v.value == adm0;})[0].key;
		  country_awards = award_shapes.filter(function(v){return v.properties.ISO == adm0;});
		  
		  
		  //console.log(country_adm1_features);
		  //console.log(country_adm2_features);
		  
		  country_awards_shapes = filtered_awards.filter(function(v){return v!=undefined && v.properties.NAME_0==country_title;});
		  country_awards_info = filtered_awards_detail.filter(function(v){return v.Country == country_title;});

		  country_povbyfips = povertyByCountryByRegion.filter(function(d){return d.key == adm0;})[0];
		  if(country_povbyfips != undefined){country_povbyfips = country_povbyfips.values.sort(function(a, b){ return d3.descending(a.value.latest,b.value.latest);});}else{country_povbyfips = [];};
		  country_povbyfips2 = povertyByCountryByRegion2.filter(function(d){return d.key == adm0;})[0];
		  if(country_povbyfips2 != undefined){ country_povbyfips2 = country_povbyfips2.values.sort(function(a, b){ return d3.descending(a.value.latest,b.value.latest);});}else{country_povbyfips2 = [];};
		  
		  paho_sub = pahobycountry.filter(function(d){return d.key == adm0;})[0];
		  FIPS0 = fips.filter(function(d){return strip(d.subnational_name) == strip(country_title);})[0].fips;
		  country_epi = epidata_all.filter(function(d){return d.country == country_title;});
		  
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  
		  country_byDatebyRegion = byCountrybyDatebyRegion.filter(function(d){return d.key == country_title;})[0].values;
		  
		  country_byDatebyRegion.sort(function(a,b){
			  var d1 = new Date(b.key);
			  var d2 = new Date(a.key);
			  //console.log(d1+" - "+d2);
			  return d2-d1;});

		bc_dx = 0;
		bc_dy = 0; 
		
		
		
		
		
		//legend_all.remove();
		//gl_update_legends();
		//console.log(country_epi);
		
		//console.log(country_byDatebyRegion);
		//console.log(byCountrybyIndbyDate);
		
		var view = ADM1_lookup.filter(function(v){return v.value == adm0;})[0];
		global_map.setView([view.lat, view.lng],view.zoom);
		
		countryZoomVal = view.zoom;
		console.log("zoomval: "+countryZoomVal);
		
		var indstmp = ["all"];
		byCountrybyIndbyRegion.filter(function(v){return v.key == country_title;})[0].values.forEach(function(c){
			indstmp.push(c.key);
		})
		
		country_indicators_template = indstmp;
		
		//remember, all is first!!
		c_choroplethIndicator = indstmp[1];
		
		
		//get latest date with data for indstmp[1]
		var country_byIndbyDate = byCountrybyIndbyDate.filter(function(d){return d.key == country_title;})[0].values[0].values;
				
				
				
		c_choropleth_date = new Date(country_byIndbyDate[country_byIndbyDate.length-1].key);
		
		//console.log(c_choropleth_date);
		//console.log(country_byDatebyRegion);
		
		//console.log("DATE STUFF");
		c_d_data = country_byDatebyRegion.filter(function(c){return formatDate(new Date(c.key)) == formatDate(new Date(c_choropleth_date));})[0].values;
		
		//console.log(d_data);
		
		//c_choroplethIndicator = d_data[0].values[0].key;
		//console.log(c_choroplethIndicator);
		//console.log(country_epi);
		
		var cef = country_epi.filter(function(f){return f.data_field==c_choroplethIndicator && f.location_type!="country";});
		
	 	c_mx = d3.max(cef,function(f){return f.value;});
	 	c_mn = d3.min(cef,function(f){return f.value;});
		
		//console.log(c_mx+" "+c_mn);
	
	 	c_mx_ht = d3.max(cef,function(f){return f.value/(f.pop/1000);});
	 	c_mn_ht = d3.min(cef,function(f){return f.value/(f.pop/1000);}); 
		
	    var c_logScale = d3.scaleLog()
	      .domain([1, c_mx])
	    var c_colorScaleLog = d3.scaleSequential(
	        (d) => d3.interpolateReds(c_logScale(d))
	      ); 
	
	      var c_logScale_ht = d3.scaleLog()
	        .domain([0.001, c_mx_ht])
	      var c_colorScaleLog_ht = d3.scaleSequential(
	          (d) => d3.interpolateReds(c_logScale_ht(d))
	        );
			
			country_choropleth = c_colorScaleLog;
		  	country_choropleth_ht = c_colorScaleLog_ht;
		//console.log(country_indicators_template);
		  
		  /*if(country_title=="Colombia"){
		  	global_map.setView([4.5, -74],5);
			sm_indicator = "zika_suspected_pregnant";
		  }else if(country_title=="El Salvador"){
		  	global_map.setView([14, -89],7);
			bc_dy = 25;
			sm_indicator = "cumulative_suspected_total";
		  }else if(country_title=="Venezuela"){
		  	global_map.setView([6.4, -67],5);
			sm_indicator = "paho";
		  }else if(country_title=="Honduras"){
		  	global_map.setView([15, -86],5.5);
			bc_dy = -25;
			sm_indicator = "paho";
		  }else if(country_title=="Guatemala"){
		  	global_map.setView([16, -90],5.5);
			bc_dy = 10;
			sm_indicator = "total_zika_suspected";
		  }else if(country_title=="Dominican Republic"){
		  	global_map.setView([19, -70],7);
			bc_dx = 50;
			sm_indicator = "zika_suspected_cumulative";
		  }else if(country_title=="Nicaragua"){
		  	global_map.setView([13, -85],6);
			bc_dy = 25;
			sm_indicator = "total_zika_confirmed";
		  }else if(country_title=="Ecuador"){
		  	global_map.setView([-1.8, -83],5);
			sm_indicator="total_zika_suspected_cumulative";
			
		  }else if(country_title=="Peru"){
		  	global_map.setView([-9, -75],4.25);
			bc_dx = -10;
			sm_indicator = "paho";
		  }else if(country_title=="Jamaica"){
		  	global_map.setView([18, -77],8);
			bc_dy = -10;
			sm_indicator = "paho";
		  }else if(country_title=="Haiti"){
		  	global_map.setView([19, -72],6.5);
			sm_indicator = "paho";
		  }*/
		  
		  
		 // country_map.setView([30, -89],5);
		  
		
		  d3.select("#maptitle").selectAll("text").remove();
		
		d3.select("#maptitle")
  	  	.append("text")
		  .text(country_title);
		  
		  mx_c = d3.max(paho_sub.values, function(v){return d3.max(v.values,function(g){return g.Cases;});});
		  mx_c_ht = d3.max(paho_sub.values, function(v){return d3.max(v.values,function(g){return g.Rate;});});
		 
		  
   choropleth4 = d3.scaleLog()
  	.domain([0.1,10,50,100,500,1000,5000])
		  .range(d3.schemeReds[7]);	  
		  
		  
  	choropleth4_ht = d3.scaleLog()
  	.domain([0.1,0,5,1,5,10,50,100,500])
		  .range(d3.schemeReds[8]);	
	  
	  projection_census
	  .scale(1)
	  .translate([0,0]);
	  
	  var w1 = 100,
	  h1 = 90;
	  
var b = path_census.bounds(country_centroid[0]),
      s = .9 / Math.max((b[1][0] - b[0][0]) / w1, (b[1][1] - b[0][1]) / h1),
      t = [(w1 - s * (b[1][0] + b[0][0])) / 2, (h1 - s * (b[1][1] + b[0][1])) / 2];	
		  
	  projection_census
	  .scale(s)
	  .translate(t);
		  
  var w2 = 500,
	  h2 = 400;
	  
//set small multiples projection	
	  projection_sm
	  .scale(1)
	  .translate([0,0]);
	  
	  var w3 = 155,
	  h3 = 100;
	  
var b3 = path_sm.bounds(country_centroid[0]),
      s3 = .9 / Math.max((b3[1][0] - b3[0][0]) / (w3-25), (b3[1][1] - b3[0][1]) / h3),
      t3 = [(w3 - s3 * (b3[1][0] + b3[0][0])) / 2, (h3 - s3 * (b3[1][1] + b3[0][1])) / 2];	
		  
	  projection_sm
	  .scale(s3)
	  .translate(t3);	  
//end proj	    
  
  /*projection
	.scale(1)
	.translate([0,0]);*/
	

var b2 = path.bounds(country_centroid[0]),
      s2 = .9 / Math.max((b2[1][0] - b2[0][0]) / (w2-150), (b2[1][1] - b2[0][1]) / (h2-50)),
	  //s2 = 24000
	t2 = [(w2 - s2 * (b2[1][0] + b2[0][0])) / 2, (h2 - s2 * (b2[1][1] + b2[0][1])) / 2];	
	  
	  //console.log(s2);
	 
	  c_scale = s2;
	  
	  
	  //set info popup
  	/*infoImage2.on("mouseover",function(){
  		d3.select(this).attr("cursor","pointer");
  		iDiv1.moveToFront();
		
  		iDiv1.transition()		
          .duration(200)		
          .style("opacity", 1);		
  	  	
  		iDiv1.html(function(){
  			var txt = data_info.filter(function(v){return v.info_id=="censusData_"+ADM0;})[0];
  			return txt.src+"<br>"+txt.link;
  		})	
          .style("left", (d3.event.pageX) + "px")		
          .style("top", (d3.event.pageY - 28) + "px");	
  	})
  	.on("mouseout",function(){
  		d3.select(this).attr("cursor","default");
  				iDiv1.transition()		
                  .duration(500)		
                  .style("opacity", 0);
  	});
	
	infoImage3.on("mouseover",function(d){
		d3.select(this).attr("cursor","pointer");
		iDiv2.moveToFront();
		iDiv2.transition()		
        .duration(200)		
        .style("opacity", 1);		
  	  	
		iDiv2.html(function(){
			var txt = data_info.filter(function(v){return v.info_id=="weekylEpiData_"+ADM0;})[0];
			return txt.src+"<br>"+txt.link;
		})	
        .style("left", (d3.event.pageX) + "px")		
        .style("top", (d3.event.pageY - 28) + "px");	
	})
	.on("mouseout",function(d){
		d3.select(this).attr("cursor","default");
		iDiv2.transition()		
        .duration(300)		
        .style("opacity", 0);		
	});*/
	
	
	//overview_tab.selected = true;
	//temporalview_tab.selected = false;
		  
	  	//start with overview 
	/*if(overview_tab.selected){
		drawOverview();
		drawTemporalView();	   
		d3.select("#overview").moveToFront();
		overview_tab.style("background","white");
		temporalview_tab.style("background","#ccc");
	}else if(temporalview_tab.selected){
		drawOverview();
		drawTemporalView();
		overview_tab.style("background","#ccc");
		temporalview_tab.style("background","white");
	}*/
	 
	 	drawSubNatRegions();
		drawSubSubNatRegions();
	  	drawChartView();
		//drawLegend();
		//drawMessageBoard();
		//drawMessageForm();	
		
		legend_all.remove();
		gl_update_legends();	
}
	  
	
	//.addLayer(new L.TileLayer("http://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png"/*"http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png""http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png" "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"*/));
	
//functions!	
	function drawOverview(){	
		function projectPoint(x, y) {
		  var point = country_map.latLngToLayerPoint(new L.LatLng(y, x));
		  this.stream.point(point.x, point.y);
		}	
	
		var transform = d3.geoTransform({point: projectPoint});
	    path_leaflet = d3.geoPath().projection(transform);
		
	
		mapview_svg = d3.select(country_map.getPanes().overlayPane)
		.append("svg")
		.attr("class","mapview_svg")
		.attr("pointer-events","visible");
		
		drawRegions();
		//layerAwards();
		//layerClinics();
	  
 	     country_map.on('viewreset', reset);
		 country_map.on('zoom', reset);
   	   	 reset();
		 
	     function reset() {
			 //console.log("reset");
			 var bounds = path_leaflet.bounds(country_centroid[0]),//country_adm1_features[0]),
	     	      topLeft = bounds[0],
	     	      bottomRight = bounds[1];
				  
				  //console.log(bounds);

	     	  mapview_svg.attr("width", bottomRight[0] - topLeft[0])
	     	      .attr("height", bottomRight[1] - topLeft[1])
	     	      .style("left", topLeft[0] + "px")
	     	      .style("top", topLeft[1] + "px");

	     	  features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	     	  regions.attr("d", path_leaflet);
			  awards_shp.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
			  efforts.attr("d", path_leaflet); 
	     	}
	}				
	
	//SLV 15, PER 2, COL 2.5, DOM 10, HTI 10, HND 8, GTM 8, NIC 8, ECU
	
	function drawTemporalView(){
		
		//mapview_svg.selectAll("*").remove();
		
		/*if(mapview_svg != null){
		mapview_svg.remove();
		}
		
		if(sm_multiples != null){
		sm_multiples.selectAll("*").remove();
		}*/
		//build view
		/*mapview_svg.append("text")
		.attr("x","20px")
		.attr("y","20px")
		.text("small multiples!");*/
		drawSmallMultiples();
		
	}
	
	
	//var messageBoardURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0s8uAHDAqWdg1Kb3iK4rFbFuXOW2IjVtD3WV_RLSb5PDfvc0f2UA8YIbbn3ZYq3ve8AooO-nuIwjY/pubhtml';
	  
	  
  	/*function initMessageBoard() {
  	    Tabletop.init( { key: messageBoardURL,
  	                     callback: drawMessageBoard, 
                   		 simpleSheet: true })
  	  }*/
		
	
	
	function drawMessageBoard(){
		d3.select("#messageBoard").selectAll("*").remove();
		
		//console.log("messageBoard");
		//console.log(comments_data);
		if(comments_data==undefined){initComments();};
		
		var filteredComments = comments_data.filter(function(d){return d.country==ADM0;});
		
		/*if(comments_data==undefined){console.log("second try...");
		retrieveComments();
		//setTimeout(function(){filteredComments = comments_data.filter(function(d){return d.country==ADM0;});},3000);	
		}else{
			filteredComments = comments_data.filter(function(d){return d.country==ADM0;});
		}*/
		
		//console.log("filteredComments");
		//console.log(filteredComments);
		
		var postsC = d3.select("#messageBoard").append("g")
		.attr("id","thisone");
		
		var pdivs = postsC.selectAll("div")
		.data(filteredComments)
		.enter()
		.append("div")
		.attr("class","postsC")
		.attr("id", function(d,i){return "c_post_"+i;})
		.style("background", function(d,i){if(i%2==0){return "#e1ecf4";}else{ return "white";}});
		
		pdivs.append("text")
		.html(function(d){return "<font color=\"#3f596f\">"+d.username + "</font>: "+ d.comment;})
		.attr("x","0px")
		.attr("y","20px")
		.attr("class", "postText");
		
		
		/*var pdivs = posts.append("div")
		.attr("class","postsC")
		.attr("id", function(d,i){return "c_post_"+i;})*/
		
		
		/*pdivs.append("text")
		.text(function(d){return d.username + ": "+ d.comment;})
		.attr("class", "postText");*/
		/*var post = feed.selectAll("div")
		.data(comments_data)
		.enter().append("div")
		.attr("class","post");
		
		post.append("text")
		.text(function(d){return d.username + ": "+ d.comment;})
		.attr("class", "postText");*/
		
		d3.select("#messageBoard").attr("transform", "translate(0,100)");
}
	
	
	function drawMessageForm(){
		/*if(wait){
			console.log("waiting for database to update");
			wait = false;	
			retrieveComments(drawMessageBoard);	
		//setTimeout(retrieveComments,1000);
		//setTimeout(drawMessageBoard,200);
		//drawMessageBoard();
		}else{
		}*/	
		d3.select("#postMessage").selectAll("*").remove();
				  
				var form = d3.select("#postMessage").append("form")
				.attr("id","postComment");
				
				form.append("textarea")
				.attr("name","comment")
				.style("width","515px")
				.style("height","30px")
				.attr("placeholder","submit comment, (e.g.\"significant data missing from...\")")				
				//.text("submit comment, (e.g.\"significant data missing from...\")");
	
				form.append("input")
				.attr("name","username")
				.attr("type","text")
				.attr("placeholder","username");
				
				form.append("input")
				.attr("name","country")
				.attr("type","hidden")
				.attr("value",ADM0);
				
				form.append("button").attr('type', 'submit').attr("id","submit-form").text('post');
				
				
				$("#submit-form").on("click", function(e){
					e.preventDefault();
				    var jqxhr = $.ajax({
				      url: 'https://script.google.com/macros/s/AKfycbyCpuPg6s5sqEAatoRYIRHygF-VV6Zx-PJU9pEAeXCrAQyrZkEx/exec',
				      method: "GET",
				      dataType: "json",
				      data: $('form#postComment').serializeObject()
				    }).success(
				    );
					//updateMessageBoard();
					//console.log("rerun messageBoard")
					//wait = true;
					setTimeout(function(){
						retrieveComments(update_MessageBoard,comments_data.length);
					},150);
					
					drawMessageForm();
					
			});
	}
	
	function update_MessageBoard(new_comments_data){
		
		console.log("updateding messageBoard");
		comments_data = new_comments_data;
		//d3.select("body").style("cursor","wait");
		d3.select("#messageBoard").selectAll("*").remove();
		
		var filteredComments = new_comments_data.filter(function(d){return d.country==ADM0;});
		
		var postsC = d3.select("#messageBoard").append("g")
		.attr("id","thisone");
		
		var pdivs = postsC.selectAll("div")
		.data(filteredComments)
		.enter()
		.append("div")
		.attr("class","postsC")
		.attr("id", function(d,i){return "c_post_"+i;})
		.style("background", function(d,i){if(i%2==0){return "#e1ecf4";}else{ return "white";}});
		
		pdivs.append("text")
		.html(function(d){return "<font color=\"#3f596f\">"+d.username + "</font>: "+ d.comment;})
		.attr("x","0px")
		.attr("y","20px")
		.attr("class", "postText");
		
	}
	
	function drawChartView(){
		censusCharts();
		nationalCharts();
		//c_new_confirmed_paho();
		/*if(ADM0=="SLV"){
			c_new_confirmed();
		}else{
		c_new_confirmed_paho();
		}*/
		c_new_confirmed_paho();
		subnationalCharts();
		awardsCharts();
		//d3.select("#rsView").style("opacity",0);
		//d3.select("#rsView").style("pointer-events","none");
	}
	
	
//subfunctions - overview
	function drawBasemap(){
	land = mapview_svg.append("g")
	    .attr("class","land");
		
	  var countries = land.selectAll("path")
	      .data(geodata_admin0.features) //generate features from TopoJSON
	  	.enter()
	      .append("path")
	      .attr("id",function(d){return "country"+d.properties.ADM0_A3;})
	      .attr("class","country_paths")
	    .attr("d",path)
	    .style("fill","rgba(220,220,220,1)");	
	}
	
	
	/*function drawLegend(){
		clegend = L.control({position: 'bottomleft'});

		clegend.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info legend'),
		        grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
			labels = ['<strong> Total ZIka Cases<br>As Of: 8/1/16 (PAHO)</strong>'],
			from, to;
				for (var i = 0; i < grades.length; i++) {
				        from = grades [i];
				        to = grades[i+1]-1;

				    labels.push(
				        '<i style="background:' + country_choropleth(from + 1) + '"></i> ' +
				        from + (to ? '&ndash;' + to : '+'));
				        }
				        div.innerHTML = labels.join('<br>');	

		    return div;
		};

		//clegend.addTo(global_map);
	}
	
	function drawLegend_ht(){
		clegend_ht = L.control({position: 'bottomleft'});

		clegend_ht.onAdd = function (map) {

		    var div = L.DomUtil.create('div', 'info legend'),
		        grades = [0,1,10, 50, 100, 200, 500, 1000, 5000],
				labels = ['<strong> Total ZIka Cases (per H.T.)<br>As Of: 8/1/16 (PAHO)</strong>'],
			from, to;

		    // loop through our density intervals and generate a label with a colored square for each interval
			for (var i = 0; i < grades.length; i++) {
			        from = grades [i];
			        to = grades[i+1]-1;

			    labels.push(
			        '<i style="background:' + country_choropleth_ht(from + 1) + '"></i> ' +
			        from + (to ? '&ndash;' + to : '+'));
			        }
			        div.innerHTML = labels.join('<br>');	

		    return div;
		};

		//clegend_ht.addTo(global_map);
	}*/
	
	function drawSubSubNatRegions(){
		subfeatures = global_svg.append("g")
		.attr("class","subfeatures");
		
		subregions = subfeatures.selectAll("path")
		.data(country_adm2_features)
		.enter()
		.append("path")
		.attr("class","subregion")
		.style("pointer-events","none")
		.attr("d",global_path)
		.style("fill","none")
		.style("stroke","white")
		.style("stroke-width",0.25)
		.style("opacity",0)
		.on("mouseover", function(){
			d3.select(this).style("stroke-width",2);
		})
		.on("mouseout", function(){
			d3.select(this).style("stroke-width",0.25);
		})
		.on("click",function(d){
			if(placeMarker){
				console.log(d);
				underlyingRegion = d.properties.NAME_2;
				underlyingCountry = d.properties.NAME_0;
			}
		});
		
		
		subregions.append("title")
		.text(function(d){
			return d.properties.NAME_2;
		});
		efforts.moveToFront();
	}
	
	
	function drawSubNatRegions(){
	
		console.log("current regions");
		console.log(regions);
		
		
	var formatDate = d3.timeFormat("%m/%e/%y");	
	//console.log();	
	//console.log(country_adm1_features);
	//console.log(country_byDatebyRegion);
	//console.log(c_choropleth_date);
	var d_data = country_byDatebyRegion.filter(function(c){return formatDate(new Date(c.key)) == formatDate(new Date(c_choropleth_date));})[0].values;
	//console.log(d_data);
	
		
	features = global_svg.append("g")
		.attr("class","features");
		
	 regions = features.selectAll("path")
	    .data(country_adm1_features)
		.enter()
	    .append("path")
		//.attr("id",function(d){return "region"+d.properties.code_hasc.replace(".","");})
		.attr("id",function(d){return "region"+d.properties.code_hasc.replace(".","");})
	    .attr("class","region")
		.attr("selected",0)
		.style("pointer-events","all")
		.style("stroke-width",0.25)
	    .attr("d",global_path)
		.attr("opacity",1)
		.attr("value2","")
		.attr("value2_ht","")
		.attr("value",function(d){
			//var vv = d.properties.gn_a1_code.split(".")[1];
			var vv = d.properties.ID_1;
			if(vv/10 < 1.0){
				vv = d.properties.ISO+"00"+vv;
				//vv = d.properties.adm0_a3+"0"+vv;
			}else if(vv/100 < 1.0){
				vv = d.properties.ISO+"0"+vv;
			}else{
				vv = d.properties.ISO+vv;
				//vv = d.properties.adm0_a3+vv;
			}
			
			//var n = d.properties.name.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			var n = d.properties.NAME_1.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			
			var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
				
					var dist = paho_sub.values.filter(function(v){return v.key == vv;});
				
						if(dist[0]!= undefined){return dist[0].values[0].Cases;}
						else if(dist2[0]!= undefined){return dist2[0].values[0].Cases;}else{
							return null;
						}
									
		})
		.attr("value_ht",function(d){
			var vv = d.properties.ID_1;
			//var vv = d.properties.gn_a1_code.split(".")[1];
			if(vv/10 < 1.0){
				vv = d.properties.ISO+"00"+vv;
				//vv = d.properties.adm0_a3+"0"+vv;
			}else if(vv/100 < 1.0){
				vv = d.properties.ISO+"0"+vv;
			}else{
				vv = d.properties.ISO+vv;
				//vv = d.properties.adm0_a3+vv;
			}
			
			//var n = d.properties.NAME_1.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			var n = d.properties.NAME_1.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			
			var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
				
					var dist = paho_sub.values.filter(function(v){return v.key == vv;});
		
						if(dist[0]!= undefined){return dist[0].values[0].Rate;}
						else if(dist2[0]!= undefined){return dist2[0].values[0].Rate;}else{
							return null;
						}
									
		})		
		.attr("basecolor",function(d){
			
				/*var val = d3.select(this).attr("value");
				
				if(val!=undefined){
				if(ht){
					return (val<0.1) ? "#ccebad":country_choropleth_ht(val);
				}else{
					return (val==0) ? "#ccebad":country_choropleth(val);
				}
				}else{
					return "gray";
				}*/
				var dd_data = d_data.filter(function(c){return c.key == d.properties.fips;})[0];
				//console.log(dd_data);
				//console.log(c_choroplethIndicator);
				if(dd_data!=undefined){
					//console.log(dd_data);
					//console.log(c_choroplethIndicator);
					var ddd_data_0 = dd_data.values.filter(function(g){return g.key == c_choroplethIndicator;})[0];
					if(ddd_data_0!=undefined){
					var ddd_data = ddd_data_0.values[0];
					}else{
						return "gray";
					}
				if(ht){
					return country_choropleth_ht(ddd_data.value/(ddd_data.pop/1000));
				}else{
					return country_choropleth(ddd_data.value);
				}
			}else{
				return "gray";
			}
					
			})		
		.style("fill", function(d){return /*d3.select("#region"+d.properties.code_hasc.replace(".",""))*/d3.select(this).attr("basecolor");})
		.on("mouseover",function(d){
			//console.log(this);
			if(!selection){
			d3.select(this).style("opacity",gl_op);
			//d3.select(this).style("stroke-width",2);
			d3.select(this).style("fill",hover_color);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",hover_color);
			show_charts2(d,null);
			}
		})
		.on("mouseout",function(d){
			if(!selection){
			d3.select(this).style("fill",function(d){
				return /*d3.select("#region"+d.properties.code_hasc.replace(".",""))*/d3.select(this).attr("basecolor");
			})
			d3.select(this).style("opacity",gl_op);
			//d3.select(this).style("stroke-width",0.25);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",d3.select("#bb"+d.properties.code_hasc.replace(".","")).attr("basecolor"));
			dists_charts_mout(d);
			}
		})
		.on("click",function(d){
			
			if(!selection){
			d3.select(this).style("opacity",gl_op);
			d3.select(this).style("stroke-width",2);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",hover_color);
			show_charts2(d,null);
			}
			
			
			if(placeMarker){
				console.log(d);
				underlyingRegion = d.properties.NAME_1;
				underlyingCountry = d.properties.NAME_0;
			}
		});
		
		
		var formatDate = d3.timeFormat("%m/%e/%y");
		
		regions.append("title")
		.text(function(d){
			var dd_data = d_data.filter(function(c){return c.key == d.properties.fips;})[0];
			if(dd_data!=undefined){
				var ddd_data = dd_data.values.filter(function(g){return g.key == c_choroplethIndicator;});
				
				return d.properties.NAME_1+": "+ddd_data.value+
				"(total) "+ddd_data.value/(ddd_data.pop/1000)+" (per H.T)";
				
			}else{
				return d.properties.NAME_1+": (unknown)";
			}
			
			//return d.properties.NAME_1+": "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value")+
			//"(total) "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value_ht")+" (per H.T)";
		});
		
		layerAwards();
		layerClinics();
	}
	
	function drawRegions(){
		
	 features = mapview_svg.append("g")
			//.attr("class", "leaflet-zoom-hide");
	    	.attr("class","features");
		
			//console.log(country_adm1_features);	
			
			//console.log(paho_sub.values);
		
	 regions = features.selectAll("path")
	    .data(country_adm1_features)
		.enter()
	    .append("path")
		.attr("id",function(d){return "region"+d.properties.code_hasc.replace(".","");})
	    .attr("class","region")
		.style("pointer-events","all")
	    .attr("d",path_leaflet)
		.attr("opacity",0.80)
		.attr("value",function(d){
			var vv = d.properties.gn_a1_code.split(".")[1];
			if(vv/100 < 1.0){
				vv = d.properties.adm0_a3+"0"+vv;
			}else{
				vv = d.properties.adm0_a3+vv;
			}
			
			var n = d.properties.name.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			
			var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
				//console.log(vv);
				
					var dist = paho_sub.values.filter(function(v){return v.key == vv;});
				
						if(dist[0]!= undefined){return dist[0].values[0].Cases;}
						else if(dist2[0]!= undefined){return dist2[0].values[0].Cases;}else{
							return null;
						}
									
		})
		.attr("value_ht",function(d){
			var vv = d.properties.gn_a1_code.split(".")[1];
			if(vv/100 < 1.0){
				vv = d.properties.adm0_a3+"0"+vv;
			}else{
				vv = d.properties.adm0_a3+vv;
			}
			
			var n = d.properties.name.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
			
			var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
				//console.log(vv);
				
					var dist = paho_sub.values.filter(function(v){return v.key == vv;});
		
						if(dist[0]!= undefined){return dist[0].values[0].Rate;}
						else if(dist2[0]!= undefined){return dist2[0].values[0].Rate;}else{
							return null;
						}
									
		})		
		//.attr("basecolor","steelblue")
			.attr("basecolor",function(d){
				
				var val = d3.select(this).attr("value");
				
				if(val!=undefined){
				if(ht){
					return (val<0.1) ? "#ccebad":country_choropleth_ht(val);
				}else{
					return (val==0) ? "#ccebad":country_choropleth(val);
				}
				}else{
					return "gray";
				}
				
				/*var vv = d.properties.gn_a1_code.split(".")[1];
				if(vv/100 < 1.0){
					vv = d.properties.adm0_a3+"0"+vv;
				}else{
					vv = d.properties.adm0_a3+vv;
				}
				
				var n = d.properties.name.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
				
				var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
					//console.log(vv);
					
						var dist = paho_sub.values.filter(function(v){return v.key == vv;});
						//console.log(dist);
						if(ht){
							//return d3.interpolateOrRd(scale_cases(max[0].value.cum_ht));
							//return choropleth4(dist[0].value.Rate);
							//return color4(dist[0].value.Rate);
							//return choropleth(x3(max[0].value.cum_ht));
							if(dist[0]!= undefined){
								return (dist[0].values[0].Rate<0.1) ? "#ccebad":country_choropleth_ht(dist[0].values[0].Rate);
							//return (dist[0].values[0].Rate<0.1) ? "#ccebad":choropleth4_ht(dist[0].values[0].Rate); //color4(dist[0].values[0].Rate);
							d3.select(this).attr("value",dist[0].values[0].Rate);
							
							}else if(dist2[0]!= undefined){
								return (dist2[0].values[0].Rate<0.1) ? "#ccebad":country_choropleth_ht(dist2[0].values[0].Rate);
								//return (dist2[0].values[0].Rate<0.1) ? "#ccebad":choropleth4_ht(dist2[0].values[0].Rate);//color4(dist2[0].values[0].Rate);
								d3.select(this).attr("value",dist2[0].values[0].Rate);
							}else{
								return "grey";
							}
							
						}else{
							//choropleth1 is actually is ineffective, because we need to see finer grain differences
							//return d3.interpolateOrRd(scale_cases(max[0].value.max_cumulative));
							if(dist[0]!= undefined){
							return (dist[0].values[0].Cases==0) ? "#ccebad":country_choropleth(dist[0].values[0].Cases);//color4(dist[0].values[0].Cases);
								d3.select(this).attr("value",dist[0].values[0].Rate);
							}else if(dist2[0]!= undefined){
								return (dist2[0].values[0].Cases==0) ? "#ccebad":country_choropleth(dist2[0].values[0].Cases);//color4(dist2[0].values[0].Cases);
								d3.select(this).attr("value",dist2[0].values[0].Rate);
							}else{
								return "grey";
							}
						}*/
					})	
					
		/*.attr("basecolor",function(d){
			var max = totalByRegion.filter(function(v){return v.key == d.properties.fips;});
			if(ht){
				//return d3.interpolateOrRd(scale_cases(max[0].value.cum_ht));
				return choropleth4(max[0].value.cum_ht_orig);
				//return choropleth(x3(max[0].value.cum_ht));
			}else{
				//choropleth1 is actually is ineffective, because we need to see finer grain differences
				//return d3.interpolateOrRd(scale_cases(max[0].value.max_cumulative));
				return choropleth4(max[0].value.max_cumulative_orig);
			}
		})*/
		.style("fill", function(d){return d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");})
		//.style("opacity",0.5)	
	    /*.on("click", function(d){
			d.selected = !d.selected;
			var color = (d.selected) ? hover_color: d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");
			d3.select(this).style("fill",color);
			show_charts2(d,null);
			//console.log(d);
			//only allow one at a time? for now
			selection = d.selected;
	  })*/
		.on("mouseover",function(d){
			if(!selection){
			//d3.select(this).style("stroke-width","2px");	
			//d3.select(this).style("fill",hover_color);
			d3.select(this).style("opacity",1);
			d3.select(this).style("stroke","white");
			//console.log(d.properties.code_hasc);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",hover_color);
			show_charts2(d,null);
			}
		})
		.on("mouseout",function(d){
			if(!selection){
			d3.select(this).style("fill",function(d){
				return d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");
			})
			d3.select(this).style("opacity",0.80);
			d3.select(this).style("stroke","none");
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",d3.select("#bb"+d.properties.code_hasc.replace(".","")).attr("basecolor"));
			dists_charts_mout(d);
			}
			//show_charts(d);
		});
		
		
		var formatDate = d3.timeFormat("%m/%e/%y");
		
		regions.append("title")
		.text(function(d){
			return d.properties.name+": "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value")+
			"(total) "+d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("value_ht")+" (per H.T)";
		})
		/*mapview_svg.append("text")
		.attr("id","c_legend")
		.attr("class","mapview_title")
		.attr("x",10)
		.attr("y",365)
		.text("Cumulative Zika cases as of 8/1/2016");
		//.text(function(d){ return formatDate(new Date(""+d.key+""));});
		
	  mapview_svg.append("g")
	    .attr("class", "legendLog")
	    .attr("transform", "translate(10,375)");

	  var logLegend_c = d3.legendColor()
		  .shapeWidth(20)
		  .shapeHeight(5)
		  .shapePadding(0.5)
		  .orient('horizontal')
		  .labelOffset(5)
		  .labelFormat(d3.format(""))
		  //.cells(10)
		  .cells([0.1,10,50,100,500,1000,5000])
	      .scale(country_choropleth);

	  mapview_svg.select(".legendLog")
	    .call(logLegend_c);*/
		
		
		
		//var t = (ht)?"Cumulative Zika cases (per 100,000) as of 8/1/2016":"Cumulative Zika cases (per 100,000) as of 8/1/2016";
		
		
		//var key = mapview_svg.append("g");
		
		//var key_svg = key.append("svg");
		
		/*var key = mapview_svg.selectAll("rect")
  	  	.data(color4.range().map(function(color) {
    		var d = color4.invertExtent(color);
    		if (d[0] == null) d[0] = x_key.domain()[0];
    		if (d[1] == null) d[1] = x_key.domain()[1];
    		return d;
  	 	 }))
 	 	.enter().insert("rect", ".tick")
		 .attr("x", function(d,i){return 225+15*i;})
		 .attr("y", 380)
  	 	 .attr("height", 6)
  	 	 .attr("width",20)
  	 	 .attr("fill", function(d) { console.log(d); return color4(d[0]); });*/
		 
		 /*mapview_svg.selectAll("text")
		 .data(function(d){return d;})
		 .enter().append("text")
		 .attr("class","date_labels")
		 .attr("x", function(d,i){return 225+15*i;})
		 .attr("y",370)
		 .text(function(d){return d[0];})*/
		 
		 		
		//key.call(xAxis);
		
		/*key.selectAll("rect")
  	  	.data(color4.range().map(function(color) {
    		var d = color4.invertExtent(color);
    		if (d[0] == null) d[0] = x_key.domain()[0];
    		if (d[1] == null) d[1] = x_key.domain()[1];
    		return d;
  	  }))
 	 .enter().insert("rect", ".tick")
  	  .attr("height", 8)
  	  .attr("x", function(d) { return x_key(d[0]); })
  	  .attr("width", function(d) { return x_key(d[1]) - x_key(d[0]); })
  	  .attr("fill", function(d) { return color4(d[0]); });*/
		
	//		
	}
	
	function layerLabels(){
		var country_labels2 = mapview_svg.append("g");
			var c_labels = country_labels2.selectAll("text")
			.data(country_adm1_features)
			.enter()
			.append("text")
			.attr("class","c_labels")
			.attr("x",function(d){return path.centroid(d)[0];})
		.attr("y",function(d){return path.centroid(d)[1];});
			//.text(function(d){return d.properties.name;});
	}
	
	function layerPlaces(){
		var country_places = mapview_svg.append("g");
			country_places.selectAll("path")
			.data(country_pop.filter(function(d){return d.properties.SCALERANK < 4;}))
			//.data(country_pop)
			.enter()
			.append("path")
			.attr("d",path.pointRadius(0.05))
			.attr("fill","black")
		.attr("class","place");
		
		//console.log(country_pop);
		
		country_places.selectAll(".place_label")
		.data(country_pop.filter(function(d){return d.properties.SCALERANK < 4;}))
		//.data(country_pop)
		.enter().append("text")
		.attr("class","place-label")
		.attr("transform",function(d){return "translate(" + projection(d.geometry.coordinates) + ")";})
		.attr("dy", ".35em")
		.text(function(d) { return d.properties.NAME; });
			//.text(function(d){return d.properties.name;});
	}
	
	function layerClinics(){
	clinics_pts = global_svg.append("g")
		//.attr("class", "leaflet-zoom-hide")
		.attr("class","clinics");
		
		//console.log(topojson.feature(IPPFclinics,IPPFclinics.objects.IPPFClinics).features);
		
		
		//FIX
	    clinics = clinics_pts.selectAll("path")
	     .data(topojson.feature(IPPFclinics,IPPFclinics.objects.IPPFClinics).features)
	     .enter()
	     .append("path")
		.style("fill","steelblue")
		.style("stroke","white")
		//.style("stroke-width",0.75/c_scale)
		.style("stroke-width",1)
		//.attr("d",global_path.pointRadius(0.2))
		//.attr("transform", function(d) {return "translate(" + projection(d.geometry.coordinates) + ")"; })
		.attr("d",d3.symbol().size(10).type(d3.symbolCross))
		//.attr("d",d3.symbol().size(0.75/c_scale).type(d3.symbolCross))
		.on("mouseover",function(d){
			d3.select(this).style("stroke-width","0.05");
		})
		.on("mouseout",function(d){
			d3.select(this).style("stroke-width","0.025");
		});	
	}
	
	
	function layerAwards(){
		awards_shp = global_svg.append("g")
			.attr("class", "leaflet-zoom-hide");
			
			//.attr("class","awards_shp");
			
			//d3.select("#diagonalHatch").attr("transform", "translate([0,0])"+"scale(0.5)");	
		//console.log(country_awards);	
		//console.log(country_awards_info);
		
		//console.log(country_awards);
		/*efforts = awards_shp.selectAll("path")
		.data(country_awards_detail)
		.enter()
		.append("path")
		.attr("id", function(d){return "award"+d.properties.HASC_2;})
		.style("pointer-events","all")
		.attr("d",path_leaflet)*/
		
		
efforts = awards_shp.selectAll("path")
		.data(country_awards_shapes)
		.enter()
		.append("path")
		.attr("id", function(d,i){//console.log("award_"+d.properties.HASC_2.replace(".","_")); 
		return "award_"+d.properties.HASC_2.replace(".","_").replace(".","_");})
		.style("pointer-events","all")
		.attr("d",global_path)
		.style("stroke",texcolor)
		.style("stroke-width","0.5")
		//.attr("basecolor","url(#diagonalHatch)")
		.attr("basecolor",function(d,i){
			/*if(country_awards_info[i].program == "ASSIST" ||  country_awards_info[i].program == "ASSIST/URC"){
				//return "url(#diagonalHatch)";
				return "url(#pattern2)"
			}else if(country_awards_info[i].program == "null"){
				return "url(#diagonalHatch)";
			}else{
				return "url(#diagonalHatch)";
			}*/
				var k = l_o_efs.indexOf(country_awards_info[i].line_of_effort);
				
				return (k!=-1) ? fills_t[k].url() : fills_t[0].url();
					
		})
		.style("fill",function(d,i){
			return d3.select(this).attr("basecolor");
		})	
		.on("click", function(d){
			console.log(d);	
		})
		.on("mouseover",function(d){
			d3.select(this).style("fill",hover_color);
		} )
		.on("mouseout",function(d){
			d3.select(this).style("fill",function(c){return d3.select(this).attr("basecolor");});
		})
		
		efforts.append("title")
		.text(function(d,i){
			var str = country_awards_info.filter(function(v){return v.Municpality == country_awards_info[i].Municpality && v.Municpality!="";});
			if(str!=undefined){
				var ps = [];
				//console.log(str);
				str.forEach(function(c){
					ps.push(c.program);
				});
			return country_awards_info[i].Department + ", "+country_awards_info[i].Municpality + " - Program: "+ps;
			}else{
			return country_awards_info[i].Department + ", "+country_awards_info[i].Municpality + " - Program: "+country_awards_info[i].program;
			}
		});
		
		if(awardsOn){
			efforts.style("opacity",1).style("pointer-events","all");
		}else{
			efforts.style("opacity",0).style("pointer-events","none");
		}
			
		/*efforts = awards_shp.selectAll("path")
		.data(country_awards)
		.enter()
		.append("path")
		.attr("id", function(d){return "award"+d.properties.OBJECTID;})
		.style("pointer-events","all")
		.attr("d",path_leaflet)
		.style("stroke","white")
		.style("stroke-width","0.25")
		.attr("basecolor",function(d,i){
			if(country_awards_info[i].Program=="ASSIST"){
				//return "url(#diagonalHatch)";
				return "url(#pattern2)"
			}else if(country_awards_info[i].Program == "0"){
				return "url(#diagonalHatch)";
			}
		})
		.style("fill",function(d,i){
			return d3.select(this).attr("basecolor");
		})	
		//.style("fill",function(d){return "url(#diagonalHatch)";})	
				
		//.style("opacity","0.5")
		.on("click", function(d){
			console.log(d);	
		})
		.on("mouseover",function(d){
			d3.select(this).style("fill",hover_color);
		} )
		.on("mouseout",function(d){
			d3.select(this).style("fill",function(c){return d3.select(this).attr("basecolor");});
		})*/
	}


function layerAwards_sm(){
		sm_awards_shp = mapview_svg.append("g")
			.attr("class","awards_shp");
			
			//d3.select("#diagonalHatch").attr("transform", "translate([0,0])"+"scale(0.5)");	
		
	sm_efforts = awards_shp.selectAll("path")
		.data(country_awards_shapes)
		.enter()
		.append("path")
		.attr("id", function(d,i){return "award"+d.properties.HASC_2;})
		.style("pointer-events","all")
		.attr("d",path_sm)
		/*.attr("d",function(d){
			console.log(d.shape);
			return path_leaflet(d.shape);
		})*/
		.style("stroke","white")
		.style("stroke-width","0.25")
		//.attr("basecolor","url(#diagonalHatch)")
		.attr("basecolor",function(d,i){
			if(d.properties.award_info.program=="ASSIST"){
				//return "url(#diagonalHatch)";
				return "url(#pattern2)"
			}else if(d.properties.award_info.program == "null"){
				return "url(#diagonalHatch)";
			}
		})
		.style("fill",function(d,i){
			return d3.select(this).attr("basecolor");
		})	
		.on("click", function(d){
			console.log(d);	
		})
		.on("mouseover",function(d){
			d3.select(this).style("fill",hover_color);
		} )
		.on("mouseout",function(d){
			d3.select(this).style("fill",function(c){return d3.select(this).attr("basecolor");});
		})
		
		efforts.append("title")
		.text(function(d){return "Dept_Tpop: "+d.properties.award_info.Dept_Tpop + " Program: "+d.properties.award_info.program;});
		
		
	}

	
	

//subfunctions - temporal view
	/*function drawBasemap(){
		
	}
	function drawRegions(){
		
	}
	function layerClinics(){
		
	}
	function layerAwards(){
		
	}*/	

//chartview functions
		/*function color_pov3(t){
		var x_pov = d3.scaleLinear()
		    .domain([1, 100]) //domain to be mapped
		    .rangeRound([0, 1]); //range to be mapped to
			
			return d3.interpolateBlues(x_pov(t));
			
		}*/		
		
function censusCharts(){
	
	var x_pov = d3.scaleLinear()
	    .domain([1, 100]) //domain to be mapped
	    .rangeRound([1, 10]); //range to be mapped to
	
	var color_pov = d3.scaleThreshold()
	    .domain(d3.range(1, 10))
	    .range(d3.schemeBlues[9]);	
		
	//pop map
	 max_pop = d3.max(country_pop,function(f){return f.properties.POP_MAX;});
	 min_pop = d3.min(country_pop,function(f){return f.properties.POP_MAX;});
	 pop_range = d3.scaleLinear().domain([min_pop,max_pop]).range([0.2,1]); 
	 
	 popMap();
	 povMap(color_pov,x_pov);
	 povChart(color_pov,x_pov);	
		   
	}
	
	//census subfunctions
function popMap(){
   var pop_map = d3.select("#censusData").append("div")
		.attr("class","minimap")
		.attr("id","popmap");
		
		var pop_map_svg = pop_map.append("svg")
		.attr("width", "600px")
		.attr("height", "600px");
		//.attr("class","minimap");		
		
		//pop_map_svg.call(popmap_zoom);	
   
		var pop_land = pop_map_svg.append("g");
	   
   pop_land.selectAll("path")
	   .data(country_adm1_features)
	   .enter()
	   .append("path")
	   .attr("id",function(d){return "country"+d.properties.fips;})
	   .attr("d",path_census)
	   .style("fill","white");
	
	   var pop_places = pop_map_svg.append("g");
	
	pop_places.selectAll("path")
	     .data(country_pop)
	     .enter()
	     .append("path")
	    .attr("d",path_census.pointRadius(3))
	    .attr("fill","rgb(150,150,150)")
	    .attr("opacity",function(d){
	  	  return pop_range(d.properties.POP_MAX);
	    })
	    .attr("path.pointRadius","2");
		
		pop_map_svg.append("text")
   	  .attr("class", "axis")
   	  .attr("x",0)
   	  .attr("y",10)
   	  .text("Pop density map");	
			
	}
	
function povMap(color_pov, x_pov){
	
	
	var pov_map = d3.select("#censusData").append("div")
		.attr("class","minimap")
		.attr("id","povmap");
	   
		var pp = pov_map.append("svg");
		//.attr("class","minimap")
		pp.selectAll("path")
		.data(country_adm1_features)
		.enter()
       .append("path")
		.attr("id",function(d){return "pov_map"+d.properties.code_hasc.replace(".","");})
       .attr("d",path_census)
       .attr("basecolor", function(d){
       	//var latest = povertyByFips.filter(function(v){return v.key.replace(".","") == d.properties.code_hasc.replace(".","");});
     	var latest = country_povbyfips.filter(function(v){return v.key.replace(".","") == d.properties.code_hasc.replace(".","");});
		
		
		var vv = d.properties.ID_1;
		if(vv/100 < 1.0){
			vv = d.properties.ISO+"0"+vv;
			//vv = d.properties.adm0_a3+"0"+vv;
		}else if(vv/10 < 1.0){
			vv = d.properties.ISO+"00"+vv;
		}else{
			vv = d.properties.ISO+vv;
			//vv = d.properties.adm0_a3+vv;
		}
		//console.log(vv);
		
		var latest2 = country_povbyfips2.filter(function(v){return v.key == vv;});
		
		if(latest[0]!= undefined){
		return color_pov(x_pov(latest[0].value.latest));
		}else if(latest2[0]!= undefined){
			return color_pov(x_pov(latest2[0].value.latest));
		}else{
      		console.log(d);
			console.log(d.properties.code_hasc);
			return "gray";
		}
       })
	   .style("fill",function(d){return d3.select(this).attr("basecolor");})
      	.on("mouseover", function(d){ //console.log(this); 
			if(!selection){
      		d3.select(this).style("fill",hover_color);
      		d3.select("#region"+d.properties.code_hasc.replace(".","")).dispatch("mouseover");//style("fill",hover_color);
      		}
      	})
      	.on("mouseout", function(d){if(!selection){
      		d3.select(this).style("fill", function(c){return d3.select(this).attr("basecolor");});
      		//d3.select("#"+d.id).attr("basecolor"));
      		d3.select("#region"+d.properties.code_hasc.replace(".","")).dispatch("mouseout");
      		}
      	});
	   
	
	   
   	  pp.append("text")
   	  .attr("class", "axis")
   	  .attr("x",0)
   	  .attr("y",10)
   	  .text("Poverty map");
	}
	
function povChart(color_pov,x_pov){

var c_margin = {top: 20, right: 10, bottom: 10, left: 20},
		c_width = 125 - c_margin.left - c_margin.right,
	 	c_height = 75 - c_margin.top - c_margin.bottom;
	
	 var pov_chart = d3.select("#censusData").append("div")
 	   .attr("class","minimap")
 	   .attr("id","povchart");
	      
     var pc_svg = d3.select("#povchart").append("svg")
     .attr("width", c_width + c_margin.left + c_margin.right)
     .attr("height", c_height + c_margin.top + c_margin.bottom)
 	   .append("g")
     .attr("transform",
        "translate(" + c_margin.left + "," + c_margin.top + ")");
	    
  	  pc_svg.append("text")
  	  .attr("class", "axis")
  	  .attr("x",-20)
  	  .attr("y",-10)
  	  .text("% Pop over national poverty line");
	  
  	if(country_povbyfips.filter(function(d){return d.key.indexOf(".") != -1;}).length==0){
		pc_svg.append("div")
		.attr("class","NAdiv")
		.append("text")
  	    .text("NOT AVAILABLE")
		.attr("class","NAtext");
		
  	}else{
	   
   var x = d3.scaleBand().rangeRound([0, c_width]).padding(0.1),
       y = d3.scaleLinear().rangeRound([c_height, 0]);
	  
 	x.domain(country_povbyfips.filter(function(d){return d.key.indexOf(".") != -1;}).map(function(d) { return d.key; }));  
 	y.domain([0, d3.max(country_povbyfips,function(d){return d.value.latest})]);
	  
   pc_svg.append("g")
         .attr("class", "axis")
         .call(d3.axisLeft(y)
   		.ticks(5))
       .append("text")
         .attr("transform", "rotate(-90)")
         .attr("dy", "0.71em")
   	.attr("text-anchor", "end");  
	
   	pc_svg.selectAll(".bar")
 	.data(country_povbyfips.filter(function(d){return d.key.indexOf(".") != -1;}))
   	.enter().append("rect")
   	.attr("id",function(d){//console.log("bb"+d.key.replace(".","")); 
   		return "bb"+d.key.replace(".","");})
 	.attr("x", function(d){return x(d.key);}) 
 	.attr("y", function(d){return y(d.value.latest)})
	.attr("width", x.bandwidth())//function(){if(x.bandwidth() > 5){return 5;}else{return x.bandwidth();}})
 	.attr("basecolor",function(d){
   			return color_pov(x_pov(d.value.latest));})
   	.style("fill",function(d){
   			return d3.select("#bb"+d.key.replace(".","")).attr("basecolor");
   	})	
   	.attr("height",function(d){return c_height - y(d.value.latest);})
   	.on("mouseover", function(d){ //console.log(this); 
   		if(!selection){
   		d3.select(this).style("fill",hover_color);
   		d3.select("#region"+d.key.replace(".","")).dispatch("mouseover");//style("fill",hover_color);
		d3.select("#pov_map"+d.key.replace(".","")).style("fill",hover_color);
   		}
   	})
   	.on("mouseout", function(d){if(!selection){
   		d3.select(this).style("fill",
   		function(d){return d3.select("#bb"+d.key.replace(".","")).attr("basecolor");});
   		d3.select("#region"+d.key.replace(".","")).dispatch("mouseout");
		d3.select("#pov_map"+d.key.replace(".","")).style("fill",function(d){return d3.select("#pov_map"+d.properties.code_hasc.replace(".","")).attr("basecolor"); });
   		}
   	});
}
}
	
	
	
	function c_new_confirmed(){
		
		var dat = byRegion.filter(function(v){return v.key == FIPS0;})[0];
		
		var pp = dat.values.filter(function(v){return v.key == "cumulative_confirmed";})[0];
		
	var margin = {top: 20, right: 20, bottom: 30, left: 40},
  		width = 125 - margin.left - margin.right,
  		height = 100 - margin.top - margin.bottom;
		
		//console.log(pp);
		
		
	  var new_confirmed = d3.select("#pahoData").append("div")
	  .attr("class","epichart");
	  
	  var cum_confirmed = d3.select("#pahoData").append("div")
	  .attr("class","epichart");
	  
		
	  var conf_cases = new_confirmed.append("svg")
	  .attr("id","conf_cases")
 	   .attr("width", width + margin.left + margin.right)
 	   .attr("height", height + margin.top + margin.bottom)
	 .append("g")
 	   .attr("transform",
        "translate(" + margin.left + "," + margin.top + ")");
		
		conf_cases.append("text").attr("class","axis").attr("x",-10).attr("y",-10).text("new confirmed");
			
		  var x = d3.scaleTime().range([0, width]);
		  var y = d3.scaleLinear().range([height, 0]);
		  
		x.domain(d3.extent(country_epi, function(v) { return v.report_date; }));
		y.domain([0,d3.max(pp.values,function(v){return v.new_cases;})]);
		  
  	var valueline = d3.line()
  	  	.x(function(d) { return x(d.report_date); })
  	  	.y(function(d) { return y(d.new_cases);})
		.curve(d3.curveCardinal);
		//.curve(d3.curveCatmullRom);
		
	
  		linegraph = conf_cases.append("path")
		.data([pp.values])
  		.attr("class","line")
  		//.style("stroke","red")
		.attr("d", valueline);	
		
		var rain = rainfall.filter(function(d){return d.Country == country_title;})[0];	
		var ms = [rain.JANUARY,rain.FEBRUARY,rain.MARCH,rain.APRIL,rain.MAY,rain.JUNE,rain.JULY,rain.AUGUST,rain.SEPTEMBER,rain.OCTOBER,rain.NOVEMBER,rain.DECEMBER];
		
		console.log
		
		var avg = d3.mean(ms);
		
	  	var valueline_rain = d3.line()
	  	  	.x(function(d) { return x(d.date); })
	  	  	.y(function(d) { 
				if(ms[d.month-1]>=avg){
					return y_rain(1);
				}else{
					return y_rain(0);	
				}
			})
			.curve(d3.curveCatmullRom);	
		
		// define the area
		var area = d3.area()
		    .x(function(d) { return x(d.date); })
		    .y0(height)
		    .y1(function(d) { 
				/*if(ms[d.month-1]>=avg){
					return y_rain(1);
				}else{
					return y_rain(0);	
				}*/
				return y_rain(ms[d.month-1]); 
			});
	 	    
	  var xaxis = conf_cases.append("g")
		.attr("class","axis")	
	      .attr("transform", "translate(0,"+height+")")
		  //.tickFormat(d3.timeFormat("%B"))
		.call(d3.axisBottom(x)
			.ticks(5)
			. tickFormat(d3.timeFormat("%-m/%y")))
			.selectAll("text")	
	          //.style("text-anchor", "end")
	          //.attr("dx", ".9em")
	          .attr("dy", ".15em");	  	 
			  
	  var yaxis = conf_cases.append("g")
		.attr("class","axis")	
		.call(d3.axisLeft(y)
			  .ticks(5));	  	 	   	
		
	}
	
	
	
	function c_new_confirmed_paho(){
		
		if(c_new_confirmed != undefined){
		d3.select("#c_new_confirmed").remove();
		}
		if(c_cum_confirmed != undefined){
		d3.select("#c_cum_confirmed").remove();
		}
		
		//d3.select("#epichart").selectAll("*").remove();	
		
		//globalbycountry.filter(function(c){return c.key == d.properties.ADMIN;});
		
		var dat = globalbycountry.filter(function(d){return d.key == country_title;});
			//var adm_t = ADM0_A3_lookup.filter(function(v){return v.value == d.key;});
			
			//return d.key == "SLV";});
			//console.log("now");
			//console.log(dat);

		
  	  c_new_confirmed = d3.select("#pahoData").append("div")
  	  .attr("id","c_new_confirmed");
	  
	  
	  c_cum_confirmed = d3.select("#pahoData").append("div")
	  .attr("id","c_cum_confirmed");
		
		
  	  
	  
	  var margin = {top: 20, right: 40, bottom: 30, left: 30},
      	width = 175 - margin.left - margin.right,
      	height = 150 - margin.top - margin.bottom;
		
		var x = d3.scaleTime().range([0, width]);
		var y = d3.scaleLinear().range([height, 0]);
		var y_cum = d3.scaleLinear().range([height, 0]);
		var y_rain = d3.scaleLinear().range([height, 0]);
		
		var valueline = d3.line()
		.x(function(d){return x(d.date);})
		.y(function(d){return y(d.new_autochthonous_cases_confirmed);})
		//.curve(d3.curveCardinal);
		.curve(d3.curveCatmullRom);
		
		
		var valueline_cum = d3.line()
		.x(function(d){return x(d.date);})
		.y(function(d){return y_cum(d.autochthonous_cases_confirmed);})
		//.curve(d3.curveCardinal);
		.curve(d3.curveCatmullRom);
		
		
		//console.log("rain...?");
		//console.log(rainfall);
		
		var rain = rainfall.filter(function(d){return d.Country == country_title;})[0];	
		var ms = [rain.JANUARY,rain.FEBRUARY,rain.MARCH,rain.APRIL,rain.MAY,rain.JUNE,rain.JULY,rain.AUGUST,rain.SEPTEMBER,rain.OCTOBER,rain.NOVEMBER,rain.DECEMBER];
		
		//console.log(ms);
		
		var avg = d3.mean(ms);
		
	  	var valueline_rain = d3.line()
	  	  	.x(function(d) { return x(d.date); })
	  	  	.y(function(d) { 
				//console.log(d.month);
				//console.log(ms[d.month-1]);
				//return y_rain(ms[d.month-1]);
				if(ms[d.month-1]>=avg){
					return y_rain(1);
				}else{
					return y_rain(0);	
				}
			})
			//.curve(d3.curveCardinal);
			.curve(d3.curveCatmullRom);	
		
		// define the area
		var area = d3.area()
		    .x(function(d) { return x(d.date); })
		    .y0(height)
		    .y1(function(d) { return y_rain(ms[d.month-1]); 
				/*if(ms[d.month-1]>=avg){
					return y_rain(1);
				}else{
					return y_rain(0);	
				}*/
				//return y_rain(ms[d.month-1]); 
			});
			
			
		
		//console.log(d3.max(globalbycountry, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});}));
		//console.log(globalbycountry);
		
		x.domain(d3.extent(dat[0].values, function(v) {return v.date; }));
		y.domain([0,d3.max(dat, function(v){return d3.max(v.values,function(g){return g.new_autochthonous_cases_confirmed;});})]);
		y_cum.domain([0,d3.max(dat, function(v){return d3.max(v.values,function(g){return g.autochthonous_cases_confirmed;});})]);
		y_rain.domain([0,d3.max(ms)]);
		//y_rain.domain([0,1]);
		
		//console.log("max ms");
		//console.log(d3.max(ms));
		//console.log(d3.max(dat, function(v){return d3.max(v.values,function(g){return g.new_autochthonous_cases_confirmed;});}));
		//var gl_inds = d3.select("#newConfirmedData").append("div");
		
	  var global_indicators_2 = d3.select("#c_new_confirmed").append("svg")
		.attr("class","c_ind_charts")
		.attr("id","c_inds")	  
 	   	.attr("width", width + margin.left + margin.right)
 	   	.attr("height", height + margin.top + margin.bottom)
	 	.append("g")
 	  	 .attr("transform",
        	"translate(" + margin.left + "," + margin.top + ")");
			
		global_indicators_2.append("text")
			.attr("class","chart_labels")
			.attr("x",-10)
			.attr("y",-10)
			.text("new confirmed cases");	
			
			
		var rainF = global_indicators_2.append("path")
			.data(dat)
			.attr("class","line")
			.style("stroke","none")
			.style("fill","#ccc")
			.attr("opacity",0.5)
			.attr("d", function(d){ 
				//console.log(d.values);
				return area(d.values);});
				
				global_indicators_2.append("text")
				.text("avg rainfall (inches)")
				.attr("x",0)
				.attr("y",0)
				.attr("transform", "translate(165,10)rotate(90)")
				//.attr("transform","translate(100,0)")
				.style("fill","grey");
		
		
var linegraph = global_indicators_2.append("path")
			.data(dat)
			.attr("id",function(d,i){return "line"+d.key})
			.attr("class","line")
			.style("stroke",function(d,i){return colors[i%colors.length];})
			.style("fill","none")	
			.attr("d", function(d){ 
				//console.log(d.values);
				return valueline(d.values);});
			
				
				
		/*var linegraph = global_indicators_2.selectAll("path")
			.data(dat)
			.enter()
			.append("path")
			.attr("id",function(d,i){return "line"+d.key})
			.attr("class","line")
			.style("stroke",function(d,i){return colors[i%colors.length];})
			.style("fill","red")	
			.attr("d", function(d){ 
				//console.log(d.values);
				return valueline(d.values);});
				
			var rainfall = global_indicators_2.append("path")
				.data(dat)
				.enter()
				.append("path")
				.attr("class","line")
				.style("stroke",function(d,i){return colors[i%colors.length];})
				.style("fill","red")	
				.attr("d", function(d){ 
					//console.log(d.values);
					return valueline(d.values);});*/		
				
				
		
	  var xaxis = global_indicators_2.append("g")
		.attr("class","axis")	
	      .attr("transform", "translate(0,"+height+")")
		.call(d3.axisBottom(x)
			.ticks(6)
				. tickFormat(d3.timeFormat("%-m/%y")));
			//.selectAll("text")	
	         // .attr("dy", ".20em");
	  
	  var yaxis = global_indicators_2.append("g")
		.attr("class","axis")	  
			  .call(d3.axisLeft(y).ticks(4));
			  
	  var yaxis = global_indicators_2.append("g")
		.attr("class","axisR")
			  .attr("transform","translate("+width+",0)")	  
			  .call(d3.axisRight(y_rain).ticks(4));		  
			  
			  
			  
  	  var global_indicators_3 = d3.select("#c_cum_confirmed").append("svg")
  		.attr("class","c_ind_charts")
  		.attr("id","c_inds")	  
   	   	.attr("width", width + margin.left + margin.right)
   	   	.attr("height", height + margin.top + margin.bottom)
  	 	.append("g")
   	  	 .attr("transform",
          	"translate(" + margin.left + "," + margin.top + ")");
			
  		global_indicators_3.append("text")
  			.attr("class","chart_labels")
  			.attr("x",-10)
  			.attr("y",-10)
  			.text("cumulative confirmed cases");	
		
  var linegraph_cum = global_indicators_3.append("path")
  			.data(dat)
  			.attr("id",function(d,i){return "line"+d.key})
  			.attr("class","line")
  			.style("stroke",function(d,i){return colors[i%colors.length];})
  			.style("fill","none")	
  			.attr("d", function(d){ 
  				//console.log(d.values);
  				return valueline_cum(d.values);});	
				
				
  	  var xaxis_cum = global_indicators_3.append("g")
  		.attr("class","axis")	
  	      .attr("transform", "translate(0,"+height+")")
  		.call(d3.axisBottom(x)
  			.ticks(6)
				. tickFormat(d3.timeFormat("%-m/%y")));
  			//.selectAll("text")	
  	          //.attr("dy", ".15em");
	  
  	  var yaxis_cum = global_indicators_3.append("g")
  		.attr("class","axis")	  
  			  .call(d3.axisLeft(y_cum).ticks(4));		  
			   
			  	
	}
	
//national charts	
	function nationalCharts(){
		//countryInds
		var graph3_margin = {top: 20, right: 20, bottom: 30, left: 40},
      		graph3_width = 250 - graph3_margin.left - graph3_margin.right,
      		graph3_height = 150 - graph3_margin.top - graph3_margin.bottom;
			
			if(all_inds!=undefined){
				d3.select("#all_inds").remove();
			}
			if(all_inds_key!=undefined){
				d3.select("#countryChartKey").remove();
			}
			if(NAdiv!=undefined){
				d3.select("#NAdiv").remove();
			}
			
			if(sm_indicator=="paho"){
			NAdiv = d3.select("#nationalData").append("div")
				.attr("id","NAdiv")
				.attr("class","NA")
				.append("text")
				.text("DATA NOT AVAILABLE")
				.attr("class","NAtext");
			  /*country_indicators.append("text")
				.text("NOT AVAILABLE");*/
			}else{	
		  
		  //all indicators with cumulative unchecked
		all_inds = d3.select("#nationalData").append("div")
			.attr("id","all_inds")
			.attr("class","epichart");
		  
		  country_indicators = all_inds.append("svg")
  	   .attr("class","country_inds")
			.attr("id","countryinds")	  
     	   .attr("width", graph3_width + graph3_margin.left + graph3_margin.right)
     	   .attr("height", graph3_height + graph3_margin.top + graph3_margin.bottom)
   		 .append("g")
     	   .attr("transform",
            "translate(" + graph3_margin.left + "," + graph3_margin.top + ")");
		//check if no data available	
			//country_indicators.append("text").attr("class","axis").attr("x",-10).attr("y",-10).text("all indicators");
			
  		  // set the ranges
  		  var x = d3.scaleTime().range([0, graph3_width]);
  		  var y = d3.scaleLinear().range([graph3_height, 0]);  		
		  
		  country_indicators.append("text").attr("class","axis").attr("x",-10).attr("y",10).text("all indicators");  
		  
  	  //line charts
  	  valueline3 = d3.line()
  	    	.x(function(d) { return x(d.report_date); })
  	    	.y(function(d) { //console.log(d.report_date+" "+d.cum_cases); 
  				//return y(d.cum_cases); });
				//console.log(d.value);
				return y(d.value); });
				
				var dd = byRegion.filter(function(v){return v.key == FIPS0;});	
				
				//console.log(FIPS0);
				//console.log(dd);
				//console.log(byRegion);
				
				//scale domain		
				var max = totalByRegion.filter(function(v){return v.key == FIPS0;});	
				//console.log(max);	
		
				x.domain(d3.extent(country_epi, function(v) { return v.report_date; }));
				y.domain([0,max[0].value.max_cumulative_orig+10]);

				//console.log(dd[0].values);
				//have to redraw the map. that's fine. 

				domains = [];
				dd[0].values.forEach(function(v,i){
					domains.push(v.max_cum_cases_orig);
				})		
				
		drawCountryLines(dd, x, y, graph3_height); 				
		  
    	  //all indicators with cumulative unchecked
	  all_inds_key = d3.select("#nationalData").append("div")
		.attr("class","epichart")
		.attr("id","countryChartKey");  
		  
		var key = all_inds_key.append("svg")
		.attr("width",175)
		.attr("height",300);
			//.attr("id","countryChartKey");
			
	var key_labels = key.selectAll("g")
			.data(dd[0].values, function(d,i){//console.log(d.key); 
				return d;})
			.enter()
				.append("g")
				.attr("id",function(d){return "label"+d.key});
				//.attr("class","ind_keys");
		
			key_labels.append("text")
			.attr("id",function(d){return "label"+d.key})
			.attr("class","key_labels")
			.attr("x",10)
			.attr("y",function(d,i){return i*12+10;})
			.text(function(d){return d.key;});
			
			
			//.replace("cumulative","cmltv").replace("suspected","sspctd")
			key_labels.append("circle")
				.attr("id",function(d){return "circle"+d.key})
				.attr("cx",5)
				.attr("cy",function(d,i){return i*12+8;})
				.attr("r",2)
				.attr("fill",function(d,i){
					if(d.selected){
						return "grey";
					}else{
						return colors[i%colors.length];
					}
				});	
		
				key_labels.on("click",function(d,i){
					d.selected = !d.selected;
					var op = (d.selected)?0:1;
					var opL = (d.selected)?0.25:1;
				
					d3.select("#circle"+d.key).style("opacity",opL);
					d3.select("#label"+d.key).style("opacity",opL);
				
					d3.select("#line"+d.key).style("opacity",op);
					//redraw graph with new axis
					if(d.selected){
						//console.log(d.max_cum_cases);
						domains[i] = 0;
						//console.log(domains[i]);
						y.domain([0,d3.max(domains,function(v){return v;})])
						drawCountryLines(dd, x, y, graph3_height);
					}else{
						domains[i] = d.max_cum_cases_orig;
						y.domain([0,d3.max(domains,function(v){return v;})])
						drawCountryLines(dd, x, y, graph3_height);
						//console.log(domains);
					}
				})
				.on("mouseover", function(d){
						d3.select("#line"+d.key).dispatch("mouseover");
					})
				.on("mouseout", function(d){
						d3.select("#line"+d.key).dispatch("mouseout");
					})	
					
					d3.select("#labelcumulative_suspected_total").dispatch("click");	
				}//endelse
	}
	
	function drawCountryLines(dd, x, y, graph3_height){
	
		country_indicators.selectAll("*").remove();
		//console.log(dd);
	
		linegraph3 = country_indicators.selectAll("path")
		.data(dd[0].values, function(d,i){return d.values;})
		.enter()
		.append("path")
		.attr("id",function(d,i){return "line"+d.key})
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")	
		.style("opacity",function(d,i){
			if(domains[i]==0){
				return 0;
			}else{
				return 1;
			}
		})
		.attr("d", function(d){
			//console.log(d.key); 
			return valueline3(d.values);})
			.on("mouseover",function(d){
				d3.select(this).style("stroke-width",3);
			})
			.on("mouseout",function(d){
				d3.select(this).style("stroke-width",0.75);
			});	
	
		// Add the X Axis
		  var xaxis = country_indicators.append("g")
			.attr("class","axis")	
		      .attr("transform", "translate(0,"+graph3_height+")")
			  //.tickFormat(d3.timeFormat("%B"))
			.call(d3.axisBottom(x)
				.ticks(5)
				. tickFormat(d3.timeFormat("%-m/%y")))
				.selectAll("text")	
		          //.style("text-anchor", "end")
		          //.attr("dx", ".9em")
		          .attr("dy", ".15em");
		          //.attr("transform", function(d) {
		            //  return "rotate(-65)" 
		              //});

		  // Add the Y Axis
		  var yaxis = country_indicators.append("g")
			.attr("class","axis")
		      .call(d3.axisLeft(y)
					  .ticks(5));
	  
		linegraph3.append("title")
				.text(function(d){return d.key;});
	
	}
	
	function subnationalCharts(){
		show_charts();
		//show_charts2(country_adm1_features);
	}
	
	
	
	function awardsCharts(){
		
		d3.select("#awardData").selectAll("*").remove();
		
		
		var headline = d3.select("#awardData").append("div")
		.attr("class","subtitle");
		
		
		headline.append("text")
		.text("USAID AWARDS")
		.attr("class","award_subtitle");
		
		/*var checkbox = d3.select("#awardData").append("svg")
		.attr("class","subtitle")
		.attr("width",12)
		.attr("height",12);
		
		checkbox.append("rect")
		.attr("width",10)
		.attr("height",10)
		.attr("fill","steelblue");*/
		
		/*show_awards = headline.append("div")
		.attr("class","toggle_button")
		.style("background","lightblue");
	
		show_awards.append("text")
		.text("show awards");
		
		show_awards.on("click", function(){
			s_a = !s_a;
			var op = (s_a)?1:0;
			if(s_a){
				d3.select(this).style("background","lightblue");
			}else{
				d3.select(this).style("background","none");
			}
			//change opacity of shapes
			efforts.each(function(){
				d3.select(this).attr("opacity",op);
				if(op==0){
					d3.select(this).style("pointer-events","none");
				}else{
					d3.select(this).style("pointer-events","all");
				}
			});	
		});*/
		var da;
		var da_0 = partnersbyCountrybyLinebyPartner_country.filter(function(c){return c.key == country_title;})[0];
		if(da_0!=undefined){
		da = partnersbyCountrybyLinebyPartner_country.filter(function(c){return c.key == country_title;})[0].values;
		}
		
		
		//console.log(da);
		//console.log(partnersbyLinebyPartner);
		
			//d3.select("#awardData").append("text")
			//.text("USAID AWARDS");
		
		
			//var bchart_colors = ["steelblue","orange","green"];
			//var bchart_colors =["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"];
			//var bchart_colors =["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854"];
			//var bchart_colors = ["#1b9e77","#e6ab02","#7570b3"];
		
		
			var award_efforts = d3.select("#awardData").selectAll("svg")
			.data(da)
			.enter()
			.append("svg")
			.attr("height",function(d){return 50+d.values.length*10;})
			.attr("id",function(d,i){return "line_"+i;})
			.attr("class","award_effort2");
		
			award_efforts.append("text")
			.text(function(d){return d.key.replace("and","&");})
			.attr("y","20px");
			/*.attr("fill",function(d,i,j){
				var n = j[i].parentNode.id.replace("line_","");
				console.log(n);
				return bchart_colors[n];
			});*/
		
			var line_partners = award_efforts.selectAll("g")
				.data(function(d){//console.log(d.values); 
					return d.values;})
			.enter()
			.append("g")
			.attr("id",function(d,i,j){return "line_"+j[i].parentNode.id.replace("line_","");})
			.attr("transform", function(d,i){return "translate(0,"+(i*25+30)+")";});
		
			line_partners.append("rect")
			.attr("width","15px")
			.attr("height","15px")
			.attr("id",function(d){
				var l = d.values[0].values[0].line_of_effort;
				return l+"_"+d.key;
			})
			.attr("basecolor",function(d,i,j){
				var n = j[i].parentNode.id.replace("line_","");
				//console.log(n);
				var k = l_o_efs.indexOf(d.values[0].values[0].line_of_effort);
				
				return (k!=-1)?fills_tb[k].url():bchart_colors[n];//bchart_colors[n];
				//FIX
			})
			.attr("fill",function(d){
				return d3.select(this).attr("basecolor");
			})
			.on("mouseover",function(d){
				//console.log(d.values[0].values);
				d3.select(this).style("cursor","pointer");
				d3.select(this).style("fill",hover_color);
				d.values[0].values.forEach(function(f){
					console.log(f.HASC);
					d3.select("#award_"+f.HASC.replace(".","_").replace(".","_")).style("fill",hover_color);
				})
			})
			.on("mouseout",function(d){
				d3.select(this).style("cursor","default");
				d3.select(this).style("fill",d3.select(this).attr("basecolor"));
				d.values[0].values.forEach(function(f){
					d3.select("#award_"+f.HASC.replace(".","_").replace(".","_")).style("fill",function(e){return d3.select("#award_"+f.HASC.replace(".","_").replace(".","_")).attr("basecolor");});
				})
			});
		
			line_partners.append("text")
			.attr("x","20px")
			.attr("y","10px")
			.text(function(d){return d.key;});
		
	}
	
	function dists_charts_mout(d){
		d.hover = false;
		
		show_charts();
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").append("text")
		//.text("SUBNATIONAL")
		//.attr("class","subtitle"); //may have to do this separately. This is overkill
	}
	
	
	function show_charts(){
	var graph_margin = {top: 20, right: 20, bottom: 50, left: 35},
	    graph_width = 150 - graph_margin.left - graph_margin.right,
	    graph_height = 150 - graph_margin.top - graph_margin.bottom;
	
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").selectAll("*").remove();
		
		if(sm_indicator=="paho"){
		d3.select("#subnationalData").selectAll("*").remove();	
		NAdiv = d3.select("#subnationalData").append("div")
			.attr("id","subNAdiv")
			.attr("class","NA")
			.append("text")
			.text("DATA NOT AVAILABLE")
			.attr("class","NAtext");
		  /*country_indicators.append("text")
			.text("NOT AVAILABLE");*/
		}else{	
		
			if(dist_charts!=undefined){
				d3.select("#districtData").selectAll("*").remove();	
			}else{
				d3.select("#subnationalData").append("div")
				.attr("id","districtData");
			}
				
				//console.log("null div?");
				//console.log(d3.select("#districtData"));	
			//d3.select("#districtData").selectAll("svg").remove();	
			/*d3.select("#subnationalData").append("div")
			.attr("id","districtData");*/
		
			/*d3.select("#subnationalData").append("div")
			.attr("id","districtData");*/
		/*d3.select("#subnationalData").append("text")
		.text("SUBNATIONAL")
		.attr("class","subtitle");*/
		
		/*d3.select("#subnationalData").append("div")
		.attr("id","districtData");*/
		
		//console.log(byCountrybyIndbyRegion);
	
		var dd = byCountrybyIndbyRegion.filter(function(v){return v.key == country_title && v.location_type!="country";})[0];
		
		//console.log(dd);
		//dd = dd.values.filter(function(v){return })
		
		//dd.values.sort(function(a,b){return b.values.length - a.values.length;});
		
		var doms = [];
		dd.values.forEach(function(v){
			doms.push(
				d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values, function(z){return z.values[0].max_cum_cases_orig;})])
			);
		});
		
		//console.log("ok");
		//console.log(byCountrybyIndbyRegion);
		//console.log(dd);
		
		var x = d3.scaleTime().range([0, graph_width]);
		var y = d3.scaleLinear().range([graph_height, 0]);
		
		x.domain(d3.extent(epidata_all, function(v) { return v.report_date; }));
		
	var valueline_dists = d3.line()
	  	.x(function(d) { return x(d.report_date); })
	  	.y(function(d) { 
			//y.domain([0,d.max_cum_cases_orig]);
			return y(d.value); });
			//.curve(d3.curveCardinal);
		
		var dist_charts_a = d3.select("#districtData")
		.selectAll("svg")
		.data(dd.values, function(d,i,j){return d;})
		.enter().append("div").attr("class","small_charts");
		
		//.attr("id",function(d,i){return fips+"_"+d.key;})
		
		dist_charts_a.append("input").attr("type","radio").attr("name","c_selInd").attr("value",function(d){return d.key;}).attr("class","checkbox");
	
		dist_charts_a.selectAll("input").each(function(){
			if(this.value==c_choroplethIndicator){
				d3.select(this).attr("checked",true);	
			}
		});
		
		
		
		
		
		var el = document.querySelector("#districtData");
		
		dist_charts = dist_charts_a.append("svg")
		.attr("class","distCharts")
	    .attr("width", graph_width + graph_margin.left + graph_margin.right)
	    .attr("height", graph_height + graph_margin.top + graph_margin.bottom)
		.append("g")
		//.attr("id",function(d){return "chart_"+d.key;})
	    .attr("id",function(d,i){return "chart_"+i;})
		.attr("transform",
		"translate(" + graph_margin.left + "," + graph_margin.top + ")")
		.on("mouseover",function(){
			//console.log(el.scrollTop);
		});
		
	dist_charts.append("text")
		.attr("class","chart_labels")
		.attr("x",-10)
		.attr("y",-10)
		.text(function(d){return d.key;});
		
		linegraph = dist_charts.selectAll("path")
		.data(function(d){//console.log(d); 
			return d.values;})
		.enter()	
		.append("path")
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")
		.attr("d", function(d,i,j){
			if(d.key!="null"){
				y = doms[+j[i].parentNode.id.replace("chart_","")];	
			return valueline_dists(d.values);
		}
		});
		
		dist_charts.append("g")
		.attr("class","axis")	
  	  .attr("transform", "translate(0,"+graph_height+")")
		.call(d3.axisBottom(x)
			.tickFormat(d3.timeFormat("%-m-%y"))
			.ticks(6))
			.selectAll("text")	
   		  .style("text-anchor", "end")
    		.attr("dx", "-.8em")
   		 .attr("dy", ".15em")
    		.attr("transform", function(d) {return "rotate(-65)" 
            });	
			
			//the solution!!
			dd.values.forEach(function(v,i){
				var yy = d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values,function(c){
					var m = d3.max(c.values, function(e){return e.value;});
					return m+m*0.1;})]);
				
				//console.log(v);
			
			  d3.select("#chart_"+i).append("g")
				.attr("class","axis")
				.call(d3.axisLeft(yy).ticks(5));
			})
			
	linegraph.append("title")
			.text(function(d){return d.key;});	
			
			
			
    var selector = dist_charts.append("g")
  		  .attr("id","selector1");
		  
  	 selector.append("rect")
  	 .attr("x",x(c_choropleth_date))
  	 .attr("y",-5)
  	 .attr("width",5)
  	 .attr("height",height)
  	 .attr("fill",mapcolor)//"#9fcdf1")
       .attr("stroke","black")	 
  	 .on("mouseover",function(){ 
  		 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
  	 }) 
  	 .on("mouseout",function(){
  		 if(d3.select(this).classed("active")==false)
  		 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
  	 })  
  	 .call(d3.drag()
  		  .on("start",dragstarted)
  		  .on("drag",dragged)
  	 	  .on("end",dragended));	
		  
		  
  	  	function dragstarted(d) {
  	  	  d3.select(this).raise().classed("active", true);
  		  linegraph.attr("pointer-events","none");
  		  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
  		  d3.select(this).attr("cursor","pointer").attr("stroke","none");
  	  	}

  	  	function dragged(d) {
  			if(d3.event.x<=width && d3.event.x>=0){	
  	  	  d3.select(this).attr("x", d3.event.x);
  		  //update_gl_basecolor();
  		  //have to calculate date - for fill
  		  c_choropleth_date = x.invert(d3.event.x);// - new fill date
  		  update_c_basecolor(x.invert(d3.event.x));
  		  var formatDate = d3.timeFormat("%m/%e/%y");
  		  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(c_choropleth_date);});
  		  //update_gl_footnotes(formatDate(choropleth_date));
  		  //update_gl_scatter(formatDate(choropleth_date));
		  
  		  selector.selectAll("rect").each(function(){
  			  d3.select(this).attr("x",x(c_choropleth_date));
  		  })
		  
  	  	  }
  	  	}

  	  	function dragended(d) {
  	  	  d3.select(this).classed("active", false);
  		  linegraph.attr("pointer-events","all");
  		  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
  		  d3.select(this).attr("cursor","pointer").attr("stroke","black");
  	  	}	  	  
  
  
  
			
			d3.selectAll("input[name='c_selInd']").on("change", function(){
				c_choroplethIndicator = this.value;
				console.log("indicator selection 2");
				console.log(this.value);
				update_c_choropleths();
			});	
			
			
		}
	}
	
	
	
	function show_charts5(){
	var graph_margin = {top: 20, right: 20, bottom: 50, left: 35},
	    graph_width = 150 - graph_margin.left - graph_margin.right,
	    graph_height = 150 - graph_margin.top - graph_margin.bottom;
	
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").selectAll("*").remove();
		
		if(sm_indicator=="paho"){
		d3.select("#subnationalData").selectAll("*").remove();	
		NAdiv = d3.select("#subnationalData").append("div")
			.attr("id","subNAdiv")
			.attr("class","NA")
			.append("text")
			.text("DATA NOT AVAILABLE")
			.attr("class","NAtext");
		  /*country_indicators.append("text")
			.text("NOT AVAILABLE");*/
		}else{	
		
			if(dist_charts!=undefined){
				d3.select("#districtData").selectAll("*").remove();	
			}else{
				d3.select("#subnationalData").append("div")
				.attr("id","districtData");
			}
				
				//console.log("null div?");
				//console.log(d3.select("#districtData"));	
			//d3.select("#districtData").selectAll("svg").remove();	
			/*d3.select("#subnationalData").append("div")
			.attr("id","districtData");*/
		
			/*d3.select("#subnationalData").append("div")
			.attr("id","districtData");*/
		/*d3.select("#subnationalData").append("text")
		.text("SUBNATIONAL")
		.attr("class","subtitle");*/
		
		/*d3.select("#subnationalData").append("div")
		.attr("id","districtData");*/
		
		//console.log(byCountrybyIndbyRegion);
	
		var dd = byCountrybyIndbyRegion.filter(function(v){return v.key == country_title && v.location_type!="country";})[0];
		
		
		var doms = [];
		dd.values.forEach(function(v){
			doms.push(
				d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values, function(z){return z.values[0].max_cum_cases_orig;})])
			);
		});
		
		//console.log(dd);
		//dd = dd.values.filter(function(v){return })
		
		//dd.values.sort(function(a,b){return b.values.length - a.values.length;});
		
		
		//console.log("ok");
		//console.log(byCountrybyIndbyRegion);
		//console.log(dd);
		
		var x = d3.scaleTime().range([0, graph_width]);
		var y = d3.scaleLinear().range([graph_height, 0]);
		
		x.domain(d3.extent(epidata_all, function(v) { return v.report_date; }));
		
	var valueline_dists = d3.line()
	  	.x(function(d) { return x(d.report_date); })
	  	.y(function(d) { 
			//y.domain([0,d.max_cum_cases_orig]);
			return y(d.value); });
			//.curve(d3.curveCardinal);
		
		var dist_charts_a = d3.select("#districtData")
		.selectAll("svg")
		.data(dd.values, function(d,i,j){return d;})
		.enter().append("div").attr("class","small_charts");
		
		//.attr("id",function(d,i){return fips+"_"+d.key;})
		
		dist_charts_a.append("input").attr("type","radio").attr("name","c_selInd").attr("value",function(d){return d.key;}).attr("class","checkbox");
	
		dist_charts_a.selectAll("input").each(function(){
			if(this.value==c_choroplethIndicator){
				d3.select(this).attr("checked",true);	
			}
		});
		
		
		
		
		
		var el = document.querySelector("#districtData");
		
		dist_charts = dist_charts_a.append("svg")
		.attr("class","distCharts")
	    .attr("width", graph_width + graph_margin.left + graph_margin.right)
	    .attr("height", graph_height + graph_margin.top + graph_margin.bottom)
		.append("g")
		.attr("id",function(d){return "chart_"+d.key;})
	    .attr("transform",
		"translate(" + graph_margin.left + "," + graph_margin.top + ")")
		.on("mouseover",function(){
			//console.log(el.scrollTop);
		});
		
	dist_charts.append("text")
		.attr("class","chart_labels")
		.attr("x",-10)
		.attr("y",-10)
		.text(function(d){return d.key;});
		
		linegraph = dist_charts.selectAll("path")
		.data(function(d){//console.log(d); 
			return d.values;})
		.enter()	
		.append("path")
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")
		.attr("d", function(d,i){
			if(d.key!="null"){
				//console.log(d);
				//y.domain([0,d3.max(d.values, function(e){return e.value;})]);	
				y = doms[i];
			return valueline_dists(d.values);
		}
		});
		
		dist_charts.append("g")
		.attr("class","axis")	
  	  .attr("transform", "translate(0,"+graph_height+")")
		.call(d3.axisBottom(x)
			.tickFormat(d3.timeFormat("%-m-%y"))
			.ticks(6))
			.selectAll("text")	
   		  .style("text-anchor", "end")
    		.attr("dx", "-.8em")
   		 .attr("dy", ".15em")
    		.attr("transform", function(d) {return "rotate(-65)" 
            });	
			
			//the solution!!
			dd.values.forEach(function(v){
				var yy = d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values,function(c){
					var m = d3.max(c.values, function(e){return e.value;});
					return m+m*0.1;})]);
				
				//console.log(v);
			
			  d3.select("#chart_"+v.key).append("g")
				.attr("class","axis")
				.call(d3.axisLeft(yy).ticks(5));
			})
			
	linegraph.append("title")
			.text(function(d){return d.key;});	
			
			
			
    var selector = dist_charts.append("g")
  		  .attr("id","selector1");
		  
  	 selector.append("rect")
  	 .attr("x",x(c_choropleth_date))
  	 .attr("y",-5)
  	 .attr("width",5)
  	 .attr("height",height)
  	 .attr("fill",mapcolor)//"#9fcdf1")
       .attr("stroke","black")	 
  	 .on("mouseover",function(){ 
  		 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
  	 }) 
  	 .on("mouseout",function(){
  		 if(d3.select(this).classed("active")==false)
  		 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
  	 })  
  	 .call(d3.drag()
  		  .on("start",dragstarted)
  		  .on("drag",dragged)
  	 	  .on("end",dragended));	
		  
		  
  	  	function dragstarted(d) {
  	  	  d3.select(this).raise().classed("active", true);
  		  linegraph.attr("pointer-events","none");
  		  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
  		  d3.select(this).attr("cursor","pointer").attr("stroke","none");
  	  	}

  	  	function dragged(d) {
  			if(d3.event.x<=width && d3.event.x>=0){	
  	  	  d3.select(this).attr("x", d3.event.x);
  		  //update_gl_basecolor();
  		  //have to calculate date - for fill
  		  c_choropleth_date = x.invert(d3.event.x);// - new fill date
  		  update_c_basecolor(x.invert(d3.event.x));
  		  var formatDate = d3.timeFormat("%m/%e/%y");
  		  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(c_choropleth_date);});
  		  //update_gl_footnotes(formatDate(choropleth_date));
  		  //update_gl_scatter(formatDate(choropleth_date));
		  
  		  selector.selectAll("rect").each(function(){
  			  d3.select(this).attr("x",x(c_choropleth_date));
  		  })
		  
  	  	  }
  	  	}

  	  	function dragended(d) {
  	  	  d3.select(this).classed("active", false);
  		  linegraph.attr("pointer-events","all");
  		  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
  		  d3.select(this).attr("cursor","pointer").attr("stroke","black");
  	  	}	  	  
  
  
  
			
			d3.selectAll("input[name='c_selInd']").on("change", function(){
				c_choroplethIndicator = this.value;
				console.log("indicator selection 2");
				console.log(this.value);
				update_c_choropleths();
			});	
			
			
		}
	}
	
	
	function show_charts2(d,date_id){
	var graph_margin = {top: 20, right: 20, bottom: 50, left: 35},
	    graph_width = 150 - graph_margin.left - graph_margin.right,
	    graph_height = 150 - graph_margin.top - graph_margin.bottom;
	
		
	var fips = d.properties.fips;
	//console.log(fips);	
		
		if(sm_indicator=="paho"){
		d3.select("#subnationalData").selectAll("*").remove();	
		NAdiv = d3.select("#subnationalData").append("div")
			.attr("id","subNAdiv")
			.attr("class","NA")
			.append("text")
			.text("DATA NOT AVAILABLE")
			.attr("class","NAtext");
		  /*country_indicators.append("text")
			.text("NOT AVAILABLE");*/
		}else{	
		
			if(dist_charts!=undefined){
				d3.select("#districtData").selectAll("*").remove();	
			}else{
				d3.select("#subnationalData").append("div")
				.attr("id","districtData");
			}
	
		
		var dd = byCountrybyIndbyRegion.filter(function(v){return v.key == country_title && v.location_type!="country";})[0];
		
		//console.log(dd);
		//dd = dd.values.filter(function(v){return })
		
		//dd.values.sort(function(a,b){return b.values.length - a.values.length;});
		var doms = [];
		dd.values.forEach(function(v){
			doms.push(
				d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values, function(z){return z.values[0].max_cum_cases_orig;})])
			);
		});
		
		
		//console.log("ok");
		//console.log(byCountrybyIndbyRegion);
		//console.log(dd);
		
		var x = d3.scaleTime().range([0, graph_width]);
		var y = d3.scaleLinear().range([graph_height, 0]);
		
		x.domain(d3.extent(epidata_all, function(v) { return v.report_date; }));
		
	var valueline_dists = d3.line()
	  	.x(function(d) { return x(d.report_date); })
	  	.y(function(d) { 
			//y.domain([0,d.max_cum_cases_orig]);
			return y(d.value); });
			//.curve(d3.curveCardinal);
		
		var dist_charts_a = d3.select("#districtData")
		.selectAll("svg")
		.data(dd.values, function(d,i,j){return d;})
		.enter().append("div").attr("class","small_charts");
		
		//.attr("id",function(d,i){return fips+"_"+d.key;})
		
		dist_charts_a.append("input").attr("type","radio").attr("name","c_selInd").attr("value",function(d){return d.key;}).attr("class","checkbox");
	
		dist_charts_a.selectAll("input").each(function(){
			if(this.value==c_choroplethIndicator){
				d3.select(this).attr("checked",true);	
			}
		});
		
		
		var el = document.querySelector("#districtData");
		
		dist_charts = dist_charts_a.append("svg")
		.attr("class","distCharts")
	    .attr("width", graph_width + graph_margin.left + graph_margin.right)
	    .attr("height", graph_height + graph_margin.top + graph_margin.bottom)
		.append("g")
		.attr("id",function(d,i){return "chart_"+i;})
	    .attr("transform",
		"translate(" + graph_margin.left + "," + graph_margin.top + ")")
		.on("mouseover",function(){
			//console.log(el.scrollTop);
		});
		
	dist_charts.append("text")
		.attr("class","chart_labels")
		.attr("x",-10)
		.attr("y",-10)
		.text(function(d){return d.key;});
		
		linegraph = dist_charts.selectAll("path")
		.data(function(d){//console.log(d); 
			
			return d.values.filter(function(c){return c.key==fips;});})
		.enter()	
		.append("path")
		.attr("class","line")
		.style("stroke",function(d,i){return colors[i%colors.length];})
		.style("fill","none")
		.attr("d", function(d,i,j){
			if(d.key!="null"){
				y = doms[+j[i].parentNode.id.replace("chart_","")];
				//console.log(d);
				//y.domain([0,d3.max(d.values, function(e){return e.value;})]);
				//y.domain(doms[i]);	
			return valueline_dists(d.values);
		}
		});
		
		dist_charts.append("g")
		.attr("class","axis")	
  	  .attr("transform", "translate(0,"+graph_height+")")
		.call(d3.axisBottom(x)
			.tickFormat(d3.timeFormat("%-m-%y"))
			.ticks(6))
			.selectAll("text")	
   		  .style("text-anchor", "end")
    		.attr("dx", "-.8em")
   		 .attr("dy", ".15em")
    		.attr("transform", function(d) {return "rotate(-65)" 
            });	
			
			//the solution!!
			dd.values.forEach(function(v,i){
				var yy = d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values,function(c){
					var m = d3.max(c.values, function(e){return e.value;});
					return m+m*0.1;})]);
				
				//console.log(v);
			
			  d3.select("#chart_"+i).append("g")
				.attr("class","axis")
				.call(d3.axisLeft(yy).ticks(5));
			})
			
	linegraph.append("title")
			.text(function(d){return d.key;});	
			
			
			
  /*var selector = dist_charts.append("g")
		  .attr("id","selector3");
		  
	 selector.append("rect")
	 .attr("x",x(choropleth_date))
	 .attr("y",-5)
	 .attr("width",5)
	 .attr("height",height+10)
	 .attr("fill",mapcolor)//"#9fcdf1")
     .attr("stroke","black")	 
	 .on("mouseover",function(){ 
		 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
	 }) 
	 .on("mouseout",function(){
		 if(d3.select(this).classed("active")==false)
		 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
	 })  
	 .call(d3.drag()
		  .on("start",dragstarted)
		  .on("drag",dragged)
	 	  .on("end",dragended));	
		  
		  
	  	function dragstarted(d) {
	  	  d3.select(this).raise().classed("active", true);
		  linegraph.attr("pointer-events","none");
		  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
		  d3.select(this).attr("cursor","pointer").attr("stroke","none");
	  	}

	  	function dragged(d) {
			if(d3.event.x<=width && d3.event.x>=0){	
	  	  d3.select(this).attr("x", d3.event.x);
		  //update_gl_basecolor();
		  //have to calculate date - for fill
		  choropleth_date = x.invert(d3.event.x);// - new fill date
		  //update_gl_basecolor(x.invert(d3.event.x));
		  var formatDate = d3.timeFormat("%m/%e/%y");
		  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(choropleth_date);});
		  //update_gl_footnotes(formatDate(choropleth_date));
		  //update_gl_scatter(formatDate(choropleth_date));
	  	  }
	  	}

	  	function dragended(d) {
	  	  d3.select(this).classed("active", false);
		  linegraph.attr("pointer-events","all");
		  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
		  d3.select(this).attr("cursor","pointer").attr("stroke","black");
	  	}	*/
			
      var selector = dist_charts.append("g")
    		  .attr("id","selector1");
		  
    	 selector.append("rect")
    	 .attr("x",x(c_choropleth_date))
    	 .attr("y",-5)
    	 .attr("width",5)
    	 .attr("height",height)
    	 .attr("fill",mapcolor)//"#9fcdf1")
         .attr("stroke","black")	 
    	 .on("mouseover",function(){ 
    		 d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");//"#78bcf0");
    	 }) 
    	 .on("mouseout",function(){
    		 if(d3.select(this).classed("active")==false)
    		 d3.select(this).attr("cursor","default").attr("fill",mapcolor);//"#9fcdf1");
    	 })  
    	 .call(d3.drag()
    		  .on("start",dragstarted)
    		  .on("drag",dragged)
    	 	  .on("end",dragended));	
		  
		  
    	  	function dragstarted(d) {
    	  	  d3.select(this).raise().classed("active", true);
    		  linegraph.attr("pointer-events","none");
    		  d3.select(this).attr("cursor","pointer").attr("fill","#bbc1c3");
    		  d3.select(this).attr("cursor","pointer").attr("stroke","none");
    	  	}

    	  	function dragged(d) {
    			if(d3.event.x<=width && d3.event.x>=0){	
    	  	  d3.select(this).attr("x", d3.event.x);
    		  //update_gl_basecolor();
    		  //have to calculate date - for fill
    		  c_choropleth_date = x.invert(d3.event.x);// - new fill date
    		  update_c_basecolor(x.invert(d3.event.x));
    		  var formatDate = d3.timeFormat("%m/%e/%y");
    		  d3.select("#global_as_of").text(function(){return "As of: "+formatDate(c_choropleth_date);});
    		  //update_gl_footnotes(formatDate(choropleth_date));
    		  //update_gl_scatter(formatDate(choropleth_date));
		  
    		  selector.selectAll("rect").each(function(){
    			  d3.select(this).attr("x",x(c_choropleth_date));
    		  })
		  
    	  	  }
    	  	}

    	  	function dragended(d) {
    	  	  d3.select(this).classed("active", false);
    		  linegraph.attr("pointer-events","all");
    		  d3.select(this).attr("cursor","default").attr("fill",mapcolor);
    		  d3.select(this).attr("cursor","pointer").attr("stroke","black");
    	  	}	
			
			
			/*d3.selectAll("input[name='c_selInd']").on("change", function(){
				c_choroplethIndicator = this.value;
				//console.log("indicator selection");
				//console.log(this.value);
				update_c_choropleths();
			});*/	
			
			
		}
	}
	
	
	function show_charts3(d,date_id){
		
		//console.log(d);
		//console.log(date_id);
		
		
	var graph_margin = {top: 20, right: 20, bottom: 50, left: 35},
	    graph_width = 150 - graph_margin.left - graph_margin.right,
	    graph_height = 150 - graph_margin.top - graph_margin.bottom;
		
		var fips = d.properties.fips;
	
		//console.log(d3.select("#districtData").scrollTop);
	
		//d3.select("#subnationalData").selectAll("*").remove();
		//d3.select("#subnationalData").selectAll("*").remove();
		
		d3.select("#districtData").selectAll("*").remove();
		
		if(sm_indicator=="paho"){
		d3.select("#subnationalData").selectAll("*").remove();	
		NAdiv = d3.select("#subnationalData").append("div")
			.attr("id","subNAdiv")
			.attr("class","NA")
			.append("text")
			.text("DATA NOT AVAILABLE")
			.attr("class","NAtext");
		  /*country_indicators.append("text")
			.text("NOT AVAILABLE");*/
		}else{
		
		/*d3.select("#subnationalData").append("text")
		.text("SUBNATIONAL")
		.attr("class","subtitle");*/
			
			//var dd = byCountrybyIndbyRegion.filter(function(v){return v.key == country_title;})[0];
		
			//console.log(dd);
			//dd = dd.values.filter(function(v){return })
		
			//dd.values.sort(function(a,b){return b.values.length - a.values.length;});
			
			//don't filter length on the filtered values....sort on the whole array and then filter	
	
		/*var cc = byCountrybyIndbyRegion.filter(function(v){return v.key == country_title;})[0];
		console.log(cc);*/
		
		var dd = byRegion.filter(function(v){return v.key == d.properties.fips;});
		
		//console.log(dd);
		
		//if(dd[0]!=undefined){dd[0].values.sort(function(a,b){return b.values.length - a.values.length;});};
	
		var max = totalByRegion.filter(function(v){return v.key == d.properties.fips;});
		
		var x = d3.scaleTime().range([0, graph_width]);
		var y = d3.scaleLinear().range([graph_height, 0]);
		
		x.domain(d3.extent(epidata_all, function(v) { return v.report_date; }));
	
	
		var m1 = d3.max(dd[0].values[0].values, function(v){return v.max_cum_cases_orig;});
		var m2 = d3.max(dd[0].values[1].values, function(v){return v.max_cum_cases_orig;})
		//var yt = d3.scaleLinear().range([graph_height, 0]);
		//console.log();
		var y1 = d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(dd[0].values[0].values, function(v){return v.max_cum_cases_orig;})]);
		var y2 = d3.scaleLinear().range([graph_height, 0]).domain([0,m2]);
		
		//console.log(dd[0]);
		
	var valueline_dists = d3.line()
	  	.x(function(d) { return x(d.report_date); })
	  	.y(function(d) { 
			//console.log(d.max_cum_cases);
			y.domain([0,d.max_cum_cases_orig]);
			return y(d.value); })
			//.curve(d3.curveCardinal);
	
		//d3.scaleLinear().range([graph_height, 0]).domain([0,max[0].value.max_cumulative+10])
		var doms = [];
		dd[0].values.forEach(function(v){
			doms.push(
				d3.scaleLinear().range([graph_height, 0]).domain([0,d3.max(v.values, function(v){return v.max_cum_cases_orig;})])
			);
		})
		
		/*d3.select("#subnationalData").append("div")
		.attr("id","districtData");*/
		
		//move this earlier to save compute time. 
		var dist_charts_a = d3.select("#districtData")
		.selectAll("svg")
		.data(dd[0].values, function(d,i,j){return d;})
		.enter().append("div").attr("class","small_charts");
		
		dist_charts_a.append("input").attr("type","radio").attr("name","c_selInd").attr("value",function(d){return d.key;}).attr("class","checkbox");
		
		dist_charts = dist_charts_a.append("svg")
		//.attr("id",function(d,i){return fips+"_"+d.key;})
		.attr("class","distCharts")
	    .attr("width", graph_width + graph_margin.left + graph_margin.right)
	    .attr("height", graph_height + graph_margin.top + graph_margin.bottom)
	 	.append("g")
		.attr("id",function(d,i){return fips+"_"+d.key;})
	    .attr("transform",
		"translate(" + graph_margin.left + "," + graph_margin.top + ")");
	
	
	dist_charts.append("text")
		.attr("class","chart_labels")
		.attr("x",-10)
		.attr("y",-10)
		.text(function(d){return d.key;});
		
	var buttons = dist_charts.append("button")
		.attr("x",-10)
		.attr("y",-10)
		.attr("id", function(d,i){return "toggle_"+d.key})
		.text("");
	
	
		linegraph = dist_charts.append("path")
		.attr("class","line")
		.style("stroke","steelblue")
		.style("fill","none")
		.attr("d", function(d){
			//x.domain(d3.extent(d.values, function(v) { return v.report_date; }));
			return valueline_dists(d.values);});
			
		
	  // Add the scatterplot
	  if(date_id!=null){
			
	    dist_charts.selectAll("dot")
		  .data(function(d){return d.values;})
	      .enter().append("circle")
	        .attr("r", function(d,i){if(i==date_id){return 2;}else{return 0;}})
	        .attr("cx", function(d) { return x(d.report_date); })
	        .attr("cy", function(d) { 
			y.domain([0,d.max_cum_cases_orig]);
			return y(d.value);});
		}
			
		
		dist_charts.append("g")
			.attr("class","axis")	
	        .attr("transform", "translate(0,"+graph_height+")")
			.call(d3.axisBottom(x)
				.tickFormat(d3.timeFormat("%-m-%y"))
				.ticks(8))
				.selectAll("text")	
	            .style("text-anchor", "end")
	            .attr("dx", "-.8em")
	            .attr("dy", ".15em")
	            .attr("transform", function(d) {return "rotate(-65)" 
	                });	
				
		var axis1 = [d3.axisLeft(doms[0]).ticks(5),d3.axisLeft(doms[1]).ticks(5)];
		
			//the solution!!
			dd[0].values.forEach(function(v){
				var yy = d3.scaleLinear().range([graph_height, 0]).domain([0,v.max_cum_cases_orig]);
			
			  d3.select("#"+fips+"_"+v.key).append("g")
				.attr("class","axis")
				.call(d3.axisLeft(yy).ticks(5));
			})
		}
	}

	function getY(d){
		//console.log(d);
		return d3.axisLeft(d3.scaleLinear().range([graph_height, 0]).domain([0,10]))
		.ticks(5);
	}		
	
	
//button functionality
	/*overview_tab.on("click",function(){
		d3.select(this).selected = true;
		d3.select(this).style("background","white");
		
		temporalview_tab.selected = false;
		temporalview_tab.style("background","#ccc");
		
		//swap svg to front
		d3.select("#overview").moveToFront();
		d3.select("#overview").style("opacity",1);
		//mapview_svg.moveToFront();
		//d3.select("#overview_svg").parentNode.appendChild(this)
		
		//console.log(d3.select("#overview_svg").parentNode.appendChild(this));//.parentElement.appendChild(this);
		//can we instead just swap the order so that we don't have to redraw???
		//drawOverview();
	});
	
	temporalview_tab.on("click",function(){
		d3.select(this).selected = true;
		d3.select(this).style("background","white");
		
		overview_tab.selected = false;
		overview_tab.style("background","#ccc");
		
		//swap div to front
		d3.select("#smview").moveToFront();
		d3.select("#smlegend").moveToFront();
		d3.select("#overview").style("opacity",0);
		
		
		//drawTemporalView();
	});*/
		

	function updateRegions(){
		regions.each(function(){
			d3.select(this).attr("basecolor",function(d){	
				var val = (ht)? d3.select(this).attr("value_ht"):d3.select(this).attr("value");
				
				if(val!=undefined){
				if(ht){
					return (val<0.1) ? "#ccebad":country_choropleth_ht(val);
				}else{
					return (val==0) ? "#ccebad":country_choropleth(val);
				}
			}else{
				return "gray";
			}
				/*var vv = d.properties.gn_a1_code.split(".")[1];
				if(vv/100 < 1.0){
					vv = d.properties.adm0_a3+"0"+vv;
				}else{
					vv = d.properties.adm0_a3+vv;
				}
				
				
				
				var n = d.properties.name.replace("ó","o").replace("í","i").replace("á","a").replace("ñ","n").replace("é","e").toLowerCase();
				
				var dist2 = paho_sub.values.filter(function(v){return v.values[0].ADM1_NAME.toLowerCase() == n;});
					//console.log(vv);
					
						var dist = paho_sub.values.filter(function(v){return v.key == vv;});
						
						//console.log(dist);
						if(ht){
							if(dist[0]!= undefined){
							return (dist[0].values[0].Rate<0.1) ? "#ccebad":country_choropleth_ht(dist[0].values[0].Rate); //color4(dist[0].values[0].Rate);
							
							}else if(dist2[0]!= undefined){
								return (dist2[0].values[0].Rate<0.1) ? "#ccebad":country_choropleth_ht(dist2[0].values[0].Rate);//color4(dist2[0].values[0].Rate);
							}else{
								return "grey";
							}
						}else{
							if(dist[0]!= undefined){
							return (dist[0].values[0].Cases==0) ? "#ccebad":country_choropleth(dist[0].values[0].Cases);//color4(dist[0].values[0].Cases);
							
							}else if(dist2[0]!= undefined){
								return (dist2[0].values[0].Cases==0) ? "#ccebad":country_choropleth(dist2[0].values[0].Cases);//color4(dist2[0].values[0].Cases);
							}else{
								return "grey";
							}
						}*/
					})	
			.style("fill", function(d){return d3.select("#region"+d.properties.code_hasc.replace(".","")).attr("basecolor");});
		})
		
		//need to update tagline
		d3.select("#tagline").selectAll("text").remove();
		
	}	
	
	function updateSMs(){		
			sm_maps.each(function(){
				d3.select(this).attr("basecolor",function(d,i,j){
			var c = +j[i].parentNode.id;
			
			var num = country_byDatebyRegion[c].values.filter(function(v){return v.key == d.properties.fips;})[0];
			
			if(num!=undefined){
				if(ht){
					if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth_ht(num.values[0].values[0].p_ht);}
				}else{
					if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth(num.values[0].values[0].value);}
				}
				//return choropleth4(num.values[0].values[0].value);} //add green for 0 cases
			}else{
				return "#ccc";
			}
		})
			.style("fill", function(d,i,j){
				if(d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id)!=undefined){
					return d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id).attr("basecolor");}else{return "#ccc";}});
				})
				
				if(ht){
					draw_sm_legend_ht();
				}else{
					draw_sm_legend();
				}		
	}


function drawSmallMultiples(){	
	
	if(sm_NAdiv!=undefined){
		d3.select("#sm_NAdiv").remove();
	}
	
	if(sm_indicator=="paho"){
	sm_NAdiv = d3.select("#mapview").append("div")
		.attr("id","sm_NAdiv")
		.attr("class","NA")
		.append("text")
		.text("DATA NOT AVAILABLE")
		.attr("class","NAtext");
	  /*country_indicators.append("text")
		.text("NOT AVAILABLE");*/
	}else{	
		
		//console.log(sm_indicator);
		//console.log(country_byDatebyRegion);	
	
	sm_view = d3.select("#mapview").append("div")
	//mapview_svg.append("div")
		.attr("id","smview");
		
		//console.log(country_byDatebyRegion);	
	
	sm_multiples = d3.select("#smview")
		.selectAll("svg")
		.data(country_byDatebyRegion)
		.enter()
		.append("svg")
		.attr("id",function(d,i){//console.log(i); 
			return i;})
		//.attr("class","sm_mults")
		.attr("class","sm_mults")
		.attr("width", 155)
		.attr("height", 100);
		
		//really need to modify choropleth;
		
		var formatDate = d3.timeFormat("%m/%e/%y");
		
		sm_multiples.append("text")
		.attr("class","date_labels")
		.attr("x",5)
		.attr("y",95)
		.text(function(d){ return formatDate(new Date(""+d.key+""));});
		
	sm_maps = sm_multiples.selectAll("path")
		.data(country_adm1_features, function(d,i,j){return d;})	
		.enter()
	    .append("path")
		.attr("id",function(d,i,j){ //console.log(j[i].parentNode.id);
			//console.log("sm_region"+d.properties.adm1_code+j[i].parentNode.id); 
			return "sm_region"+d.properties.adm1_code+j[i].parentNode.id;})
	    .attr("class","region_sm")
	    .attr("d",path_sm)
		//.attr("basecolor","steelblue")
		.attr("basecolor",function(d,i,j){
			var c = +j[i].parentNode.id;
			var num = country_byDatebyRegion[c].values.filter(function(v){return v.key == d.properties.fips;})[0];
			if(num!=undefined){
				if(sm_indicator=="paho"){
					if(ht){
						if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth_ht(num.values[0].values[0].p_ht);}
					}else{
						if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth(num.values[0].values[0].value);}
					}
				}else{
					var sus = num.values.filter(function(v){return v.key == sm_indicator;});
					if(sus[0]!=undefined){
						if(ht){
							if(sus[0].values[0].value==0){return "#ccebad";}else{return country_choropleth_ht(sus[0].values[0].p_ht);}
						}else{
							if(sus[0].values[0].value==0){return "#ccebad";}else{return country_choropleth(sus[0].values[0].value);}
						}
					}else{
					if(ht){
						if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth_ht(num.values[0].values[0].p_ht);}
					}else{
						if(num.values[0].values[0].value==0){return "#ccebad";}else{return country_choropleth(num.values[0].values[0].value);}
					}	
				}
			}//end sm_indicator else
		}else{
				return "#ccc";
			}
		})
			.style("fill", function(d,i,j){
				//console.log(d.properties.adm1_code+" "+j[i].parentNode.id);
				if(d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id)!=undefined){
					return d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id).attr("basecolor");}else{return "#ccc";}
			})
		.on("mouseover",function(d,i,j){
			d3.select(this).style("fill",hover_color);
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",hover_color);
			if(!selection){
				show_charts2(d,j[i].parentNode.id); //add date
			}
		})
		.on("mouseout",function(d,i,j){
			d3.select(this).style("fill",function(d){
				return d3.select("#sm_region"+d.properties.adm1_code+j[i].parentNode.id).attr("basecolor");
			})
			d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill",d3.select("#bb"+d.properties.code_hasc.replace(".","")).attr("basecolor"));
			//d3.select("#bb"+d.properties.code_hasc.replace(".","")).style("fill","steelblue");
			if(!selection){
				dists_charts_mout(d);
			}
		});
		
		sm_maps.append("title")
		.text(function(d){return d.properties.name;});
		
		draw_sm_legend();
		
	}//end else
	
	 //layerAwards_sm();
		//layer awards	
	}
	
	function draw_sm_legend_ht(){
		
		if(sm_legend!=undefined){
			d3.select("#smlegend").remove();
		}
		
		sm_legend = d3.select("#mapview").append("div")
		.attr("id","smlegend");
		
		var legend_svg = sm_legend.append("svg")
		.attr("height",200);
		
		
		var _x = 10;//450;
		var _y = 40;//400;
		
		legend_svg.append("rect")
		.attr("class","sm_legend_rect")
		.attr("x",_x-10)
		.attr("y",_y-30)
		.attr("width",135)
		.attr("height",160);
		
		
	  legend_svg.append("g")
	    .attr("class", "legendLog")
	    .attr("transform", "translate("+_x+","+_y+")");//"translate(240,500)");
		
		//console.log("choropleth");
		//console.log(global_choropleth.domain());

	  var logLegend = d3.legendColor()
		  .shapeWidth(10)
		  .shapeHeight(10)
		  .shapePadding(0.25)
		  .orient('vertical')
		  .labelOffset(5)
		  .labelFormat(d3.format(""))
		  .cells([0,1, 10, 50, 100, 500, 1000, 5000, 10000,13000])
		//.cells([0.1, 10, 100, 1000, 10000, 13000])
		//.cells(function(){return global_choropleth.domain();});
		  .scale(country_choropleth_ht);
		  /*.scale(function(){
			  if(ht){
				  return global_choropleth;
			  }else{
				  return global_choropleth;
			  }
		  });*/

	  legend_svg.select(".legendLog")
	    .call(logLegend);
		
legend_svg.append("div")
		.attr("class","legend")
		.attr("width",100)
		.attr("height",100)
				
		
legend_svg.append("text")
		.attr("id","tagline")
		.attr("class","legend_title")
		.attr("x",_x)
		.attr("y",_y-10)
		.text(sm_indicator+"(per H.T.)");
}	
	
	function draw_sm_legend(){
		
		if(sm_legend!=undefined){
			d3.select("#smlegend").remove();
		}
		
		sm_legend = d3.select("#mapview").append("div")
		.attr("id","smlegend");
		
		var legend_svg = sm_legend.append("svg")
		.attr("height",200);
		
		
		var _x = 10;//450;
		var _y = 40;//400;
		
		legend_svg.append("rect")
		.attr("class","sm_legend_rect")
		.attr("x",_x-10)
		.attr("y",_y-30)
		.attr("width",135)
		.attr("height",160);
		
		
	  legend_svg.append("g")
	    .attr("class", "legendLog")
	    .attr("transform", "translate("+_x+","+_y+")");//"translate(240,500)");
		
		//console.log("choropleth");
		//console.log(global_choropleth.domain());

	  var logLegend = d3.legendColor()
		  .shapeWidth(10)
		  .shapeHeight(10)
		  .shapePadding(0.25)
		  .orient('vertical')
		  .labelOffset(5)
		  .labelFormat(d3.format(""))
		  .cells([0,1, 10, 50, 100, 500, 1000, 5000, 10000,13000])
		//.cells([0.1, 10, 100, 1000, 10000, 13000])
		//.cells(function(){return global_choropleth.domain();});
		  .scale(country_choropleth);
		  /*.scale(function(){
			  if(ht){
				  return global_choropleth;
			  }else{
				  return global_choropleth;
			  }
		  });*/

	  legend_svg.select(".legendLog")
	    .call(logLegend);
		
legend_svg.append("div")
		.attr("class","legend")
		.attr("width",100)
		.attr("height",100)
				
		
legend_svg.append("text")
		.attr("id","tagline")
		.attr("class","legend_title")
		.attr("x",_x)
		.attr("y",_y-10)
		.text(sm_indicator);
}	



function draw_key(){
var formatPercent = d3.format(".0%"),
    formatNumber = d3.format(".0f");

var spectrum = d3.scaleThreshold()
    .domain([0.11, 0.22, 0.33, 0.50])
    .range(["#6e7c5a", "#a0b28f", "#d8b8b3", "#b45554", "#760000"]);
	
	
	var x = d3.scaleLinear()
	    .domain([0, 1])
	    .range([0, 240]);
		
	var xAxis = d3.axisBottom(x)
	    .tickSize(13)
	    .tickValues(spectrum.domain())
	    .tickFormat(function(d) { return d === 0.5 ? formatPercent(d) : formatNumber(100 * d); });
		
		var g = d3.select("#overview_svg").select("g").call(xAxis);

		g.select(".domain")
		    .remove();

		g.selectAll("rect")
		  .data(spectrum.range().map(function(color) {
		    var d = spectrum.invertExtent(color);
		    if (d[0] == null) d[0] = x.domain()[0];
		    if (d[1] == null) d[1] = x.domain()[1];
		    return d;
		  }))
		  .enter().insert("rect", ".tick")
		    .attr("height", 8)
		    .attr("x", function(d) { return x(d[0]); })
		    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
		    .attr("fill", function(d) { return spectrum(d[0]); });

		g.append("text")
		    .attr("fill", "#000")
		    .attr("font-weight", "bold")
		    .attr("text-anchor", "start")
		    .attr("y", -6)
		    .text("Percentage of stops that involved force");	
		
	}
	
//end ready	
		
		function removePopup(){
			restorecharts();
			d3.select("#overview").style("opacity",0); 
			d3.select("#global_container").style("pointer-events","all");
			d3.select("#global_container").moveToFront();
			//showGlobalFootnotes();
		};
}		


function popmap_zoomed(){
	pop_map_svg.selectAll("g").attr("transform", d3.event.transform);
}

function gl_zoomed(){
	
}

/*function gl_reset() {
var bounds = global_path.bounds(geodata_admin0),//country_adm1_features[0]),
      topLeft = bounds[0],
      bottomRight = bounds[1];
	  
  global_svg.attr("width", bottomRight[0] - topLeft[0])
      .attr("height", bottomRight[1] - topLeft[1])
      .style("left", topLeft[0] + "px")
      .style("top", topLeft[1] + "px"); 
	  
	
	global_features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");	  
	global_land.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	global_awards.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
    global_bcharts.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
    global_labels.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
 
}*/

/*country_map.on('zoom', reset);
reset();

function reset() {
 //console.log("reset");
 var bounds = path_leaflet.bounds(country_centroid[0]),//country_adm1_features[0]),
	      topLeft = bounds[0],
	      bottomRight = bounds[1];
	  
	  //console.log(bounds);

	  mapview_svg.attr("width", bottomRight[0] - topLeft[0])
	      .attr("height", bottomRight[1] - topLeft[1])
	      .style("left", topLeft[0] + "px")
	      .style("top", topLeft[1] + "px");

	  features.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
	  regions.attr("d", path_leaflet);
  awards_shp.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
  efforts.attr("d", path_leaflet); 
	}*/


function zoomed() {
	mapview_svg.selectAll("g").attr("transform", d3.event.transform);
	//console.log(d3.event.transform.k);
	/*features.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );
	  
	  land.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );	  
	  
	  awards_shp.attr("transform", d3.event.transform);
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );	
	  
	  clinics_pts.attr("transform", d3.event.transform);*/
      //.selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );		  
	
	/*up_land.attr("transform", d3.event.transform)
      .selectAll("path").style("stroke-width", 0.5 / d3.event.transform.k + "px" );*/  
}	

d3.selection.prototype.moveToFront = function() {
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};

/*var svg_p1 = d3.select("body").append("svg").attr("id", "p3");
//Pattern injection
var pattern1 = svg_p1.append("defs")
	.append("pattern")
		.attr({ id:"diagonalHatch", width:"0.6", height:"0.6", patternUnits:"userSpaceOnUse", patternTransform:"scale(0.1)"})
	.append("path")
		.attr("d","M-0.15,0.15 l0.3,-0.3, M0,0.6 l0.6,-0.6, M0.45,1 l0.3,-0.3");*/

function retrieveComments2(){
	console.log("retrieving comments");
	//https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/edit?usp=sharing
	//https://docs.google.com/spreadsheets/d/e/2PACX-1vR0s8uAHDAqWdg1Kb3iK4rFbFuXOW2IjVtD3WV_RLSb5PDfvc0f2UA8YIbbn3ZYq3ve8AooO-nuIwjY/pubhtml
	
	d3.csv("https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/export?format=csv", function(error,data){
		console.log(data);
		//drawMessageBoard(data);
	})
}

function updateTempMarkerC(comment){
	country_featureGroup.getLayers()[country_featureGroup.getLayers().length-1].bindPopup(comment).openPopup();
}

function updateTempMarkerG(comment){
	global_featureGroup.getLayers()[global_featureGroup.getLayers().length-1].bindPopup(comment).openPopup();
}

function updateTempMarkerAll(description){
	global_featureGroup.getLayers()[global_featureGroup.getLayers().length-1].bindPopup(description,{minWidth:0}).openPopup();
}

function retrieveFootnotes(){
	
	//console.log("retrieving Footnotes");
	/*if(global_featureGroup!=undefined){
	global_featureGroup.eachLayer(function(layer){
		global_featureGroup.removeLayer(layer);
	});}*/
	//https://docs.google.com/spreadsheets/d/1sIihpy3w0_-PG5l7JMVjlygtb60A50UWvTpCKqmj-R0/edit?usp=sharing
	//https://docs.google.com/spreadsheets/d/e/2PACX-1vR0s8uAHDAqWdg1Kb3iK4rFbFuXOW2IjVtD3WV_RLSb5PDfvc0f2UA8YIbbn3ZYq3ve8AooO-nuIwjY/pubhtml
	//https://docs.google.com/spreadsheets/d/18xaJk0uObdu5WNgd2yMSxzgyS3Oz2oJ5qBMEkR0z1QI/export?format=csv
	
	d3.csv("https://docs.google.com/spreadsheets/d/126Bf_7QZ-_KiUERy8ktQhH7UavD27IrpT4z8IiGuDnc/export?format=csv", function(error,data){
		//console.log(data);
		addMarkers(data);
	})
		//addMarkers(data);
		
}

</script>

</body>