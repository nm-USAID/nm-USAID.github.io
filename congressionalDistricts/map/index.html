<!DOCTYPE html>
<meta charset="utf-8">
<style>

path {
  stroke-linejoin: round;
  stroke-linecap: round;
}

/*.districts {
  fill: #bbb;
}*/

/*.districts :hover {
  fill: orange;
}*/

div.barchart {
  font: 9px sans-serif;
  background-color: steelblue;
  text-align: left;
  text-indent: -30px;
  padding: 3px;
  margin: 1px;
  margin-left:40px;
  color: "#bbb";
}

.barchart_labels {
	font: 10px sans-serif;
	text-align: left;
	color: black;
}

div.exit {
float:right;
width:10px;
height:10px;
background-color:grey;
text-align:center;	
}

/*div.profile {
float:left;
width:500px;
height:50px;
text-align:left;
	/overflow: scroll;	
}*/

div.chart {
	width: 300px;
	height: 570px;
	margin-top: 10px;
	margin-right: 10px;
}

.district-boundaries {
  pointer-events: none;
  fill: none;
  stroke: white;
  stroke-width: .4px;
}

.state-boundaries {
  pointer-events: none;
  fill: none;
  stroke: white;
  stroke-width: 1px;
}

/*background:#ccc;*/

.rows {
	border-style: solid;
	border-width: 0.5px;	
    border-color: #ccc;		
    border-radius: 0px;			
    pointer-events: none;
	padding-left:5px;
	padding-right:5px;
	padding-top:3px;
	padding-bottom:3px;	
}

div.tooltip {	
    position: absolute;			
    text-align: left;		
    width: 200px;					
    height: 100px;					
    padding: 10px;				
    font: 12px sans-serif;		
    background: white;
	border-style: solid;
	border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;			
    pointer-events: none;		
}

div.chart_tooltip {	
    position: absolute;			
    text-align: left;		
    width: 100px;					
    height: 15px;					
    padding: 5px;				
    font: 12px sans-serif;		
    background: white;
	border-style: solid;
	border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;			
    pointer-events: none;		
}

div.popup {	
    position: absolute;			
    text-align: left;		
    width: 700px;					
    height: 300px;					
    padding: 10px;				
    font: 12px sans-serif;		
    background: white;	
	border-style: solid;
	border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;				
    pointer-events: none;		
}

div.awards {
	width: 700px;
	height: 250px;
	border: solid;
	border-width: 1px;
	border-color: #ccc;
	overflow:scroll;
}

div.mote {
	position: absolute;
	width:width;
	height:height;
	background:red;
}

div.vis{
	float:left;
	padding:5px;
    border-style: solid;
    border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;
}

.container {
  float: left;				
}

#stateMenu {
	padding-left:10px;
}

#dropdown {
	padding-left:20px;
}

.menus {
	float:left;
	padding-right:10px;
}

div.button{
	width:width;
	height:0px;
}

#chart1 {
	background:#FFF;
}

.banner {
	padding:5px;
}

.banner h1{
	font-size:large;
	line-height:0pt;
}
.banner h2{
	font-size:small;
	font-weight:normal;
	line-height:8pt;
}


</style>
<body>
	<div class="banner">
		<h1>Map of USAID Global Health Investments</h1>
		<h2>Advancing American Institutions</h2>
	</div>
	<div class="header" id="dropdowns">
	</div>
	<div class="vis">
	<div class="button"><button>&#127968;</button></div>
	<div class="container" id="chart1">
	</div>
	<div class="container" id="chart2">
		<div id="stateMenu"></div>
	</div>
</div>

<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>

<script>

d3.select("button").on("click", reset);

var dispatch = d3.dispatch("load", "statechange");


//"#f0f0f0";
//"#ccc"; 
var cl = "e6e6e6"; 
    //"#f0f0f0"; 
//"#d9d9d9";
//"#e6e6e6";//"#bbb";//"#ccc";

var width = 800,
    height = 600;			

var projection = d3.geoAlbersUsa()
	//d3.geo.albersUsa()
    //.scale(4000)
	.scale(1050)
    .translate([width / 2, (height / 2)-20]);
	//.translate([-500, height / 2]);

var path = d3.geoPath()
    .projection(projection);
	
var zoom = d3.zoom()
	.scaleExtent([1, 10])
	.on("zoom", zoomed);	

var svg = d3.select("body").select("#chart1").append("svg")
    .attr("width", width)
    .attr("height", height)
	/*.call(zoom.on("zoom", function () {
		console.log();
	            svg.attr("transform", d3.event.transform)
	        }))*/
	.call(zoom)	
	.append("g");			
	
var chart_tooltip = d3.select("body").append("div")	
    .attr("class", "chart_tooltip")				
    .style("opacity", 0);	
	
	
var chart = d3.select("body").select("#chart2").append("div")
	.attr("class","chart");  
	
	//var bchart;	
//var bchart = chart.selectAll("g");		
	
var tooltip = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);	
	
var pic = tooltip.append("svg");
  //.attr("width", 100)
  //.attr("height", 50);
  
  //profile info
var pDist = pic.append("text")
  .attr("fill","black")
  .attr("x",0)//60
  .attr("y",10);
  //.style("font-weight", "bold");
  
var pRep = pic.append("text")
  .attr("fill","black")
  .attr("x",0) //60
  .attr("y",25);
  
var pTotal = pic.append("text")
  .attr("fill","black")
  .attr("x",0)//60
  .attr("y",40);  
  //.text(congress.objects.districts.geometries[i].rep.State);
  
 var img = pic.append("svg:image")
  //.attr("xlink:href", "/imgs/Nancy_Pelosi.jpg")
  .attr("width", 0)
  .attr("height", 0);
  //.attr("width", 50)
  //.attr("height", 75); 	
  
	
	//popup divs

var popup = d3.select("body").append("div")	
    .attr("class", "popup")	
    .style("opacity", 0);	
	
	
	var popupOn = false;
	var awardsTotalByDistId_0;
	var awardsTotalByDistId_2;//temp
	var awardsTotalByState_0;
	var awardsByYear_0;
	var awardsByElement_0;
	var awardsTotalByStateDist_0;
	var awardsByDist_0;	
	var choropleth;
	var dists;
	var formatNumber = d3.format(",.2f");
	var barchart = d3.select("body").select("#chart2").append("div");	
	
	var fYear = "Filter by Year";
	var fElement = "Filter by Program Element";
	var fType = "Filter by Vendor Type";
	var fPship = "Filter by PPP/FBO";
	var fState = "Filter by State";
	
	var fYear_0 = "Filter by Year";
	var fElement_0 = "Filter by Program Element";
	var fType_0 = "Filter by Vendor Type";
	var fPship_0 = "Filter by PPP/FBO";
	var fState_0 = "Filter by State";

			
//load data
queue()
    .defer(d3.json, "../us.json")
    .defer(d3.json, "../us-congress-114.json")
	.defer(d3.json, "../reps2.json")
	.defer(d3.json, "../awards_USAID_latest.json")
	.defer(d3.json, "../state_ids2.json")
    .await(ready);

function ready(error, us, congress, reps, awards, ids) {
  if (error) throw error;
  
  /******* filter out nulls and non us ******/
  awards = awards
  //.filter(function(d){return d.CD_ID != "null"})
  .filter(function(d){return d.Zip_Code!="(blank)"})
  .filter(function(d){return d.Vendor_State!="(blank)"});
  //.filter(function(d){return d3.format(d.Obligated.replace(/,/g,"")) < 1000});
  
  awards = awards
  .filter(function(d){return d.CD_ID!="1198"})
  .filter(function(d){return d.Obligated.replace(/,/g,"") >= 1000 || d.Obligated.replace(/,/g,"") == 0});
  
  //awards = awards.filter(function(d){return d.Original_FY == "2010"});
  
  /******* nested data *******/
  //for menus
  awardsTotalByState_0 = d3.nest()
  .key(function(d){return d.Vendor_State;})
  .rollup(function(v){ //return d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");})
	  var t = [];
	  v.forEach(function(e,i){if(t.indexOf(e.CD_ID) == -1){t.push(e.CD_ID)};});
	  //console.log(t);
	  return{
		  ids: t, 
	  total:d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");})
  };
  })
  .entries(awards)
  .sort(function(a, b){ return d3.descending(a.value.total, b.value.total); });
  //console.log(awardsTotalByState_0);
  //console.log(JSON.stringify(awardsTotalByState));
  awardsByYear_0 = d3.nest()
  .key(function(d){return d.Original_FY;})
  .rollup(function(v){return d3.sum(v,function(d){return d3.format(d.Obligated.replace(/,/g,""));}); })
  .sortKeys(d3.ascending)
  .entries(awards);
  awardsByElement_0 = d3.nest()
  .key(function(d){return d.PROGRAM_ELEMENT;})
  .rollup(function(v){return d3.sum(v,function(d){return d3.format(d.Obligated.replace(/,/g,""));}); })
  .sortKeys(d3.ascending)
  .entries(awards);
  awardsByVendorType_0 = d3.nest()
  .key(function(d){return d.Vendor_Category;})
  //.rollup(function(v){return d3.sum(v,function(d){return d3.format(d.Obligated.replace(/,/g,""));}); })
  .sortKeys(d3.ascending)
  .entries(awards);
  
  
  //these are data being pulled
  awardsByDist_0 = d3.nest()
  .key(function(d){return d.CD_ID;})
  .entries(awards);
  //console.log(awardsByDist);
  awardsTotalByStateDist_0 = d3.nest()
  .key(function(d){return d.Vendor_State;})
  .key(function(d){return d.CD_ID;})
  .rollup(function(v){return d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");}); })
  .map(awards);
  //console.log(JSON.stringify(awardsTotalByDist));
  awardsTotalByDistId_0 = d3.nest()
  //.key(function(d){return d.Original_FY;})
  .key(function(d){return d.CD_ID;})
  .rollup(function(v){return d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");}); })
  .entries(awards)
  .sort(function(a, b){ return d3.descending(a.value, b.value); });  
  /*****end******/
  
  
  dispatch.call("load");
  everythingelse(us, congress, reps, awards, ids);
}

function everythingelse(us, congress, reps, awards_0, ids){
	
	//awards = awards.filter(function(d){return d.state == "NY"})
	
	var awardsTotalByState = awardsTotalByState_0;
	var awardsByYear = awardsByYear_0;
	var awardsByElement = awardsByElement_0;
	var awardsByVendorType = awardsByVendorType_0;
	var awardsByDist = awardsByDist_0;
	
	//var awards = awards_0.filter(function(d){return d.state == "NY"});
	var awardsTotalByDistId = awardsTotalByDistId_0;
	
	var awardsTotalByStateDist = awardsTotalByStateDist_0;	
	
	//console.log(awardsTotalByStateDist);
	
    //add rep objects to geometries
    congress.objects.districts.geometries.forEach(function(district){
  	  var result = reps.filter(function(rep){
  		  return rep.CD_ID === district.id;
  	  });
  	  //if(result[0] == undefined){console.log(district.id)};
	  
  	  district.rep = (result[0] != undefined) ? result[0] : null;
    });
	
     var minDollars = d3.min(awardsTotalByDistId, function(d){return d.value;});
     var maxDollars = d3.max(awardsTotalByDistId, function(d){return d.value;});
     var meanDollars = d3.mean(awardsTotalByDistId, function(d){return d.value;});
  	 
	 //console.log(minDollars+","+maxDollars);
	
	dispatch.on("load.menu", loadMenu());
	dispatch.on("load.map", loadMap());
	dispatch.on("load.chart", loadChart(awardsTotalByState));
	
	//dispatch.on("statechange.chart", loadChart(awardsTotalByDistId));
	
	
	function loadMenu(){
		//console.log("load menu");
	  	  /*********dropdown menus************/
	  	var year_filter = d3.select("body").select("#dropdowns").append("select").on("change", function() { fYear = this.value; dispatch.call("statechange", this, awards_0);});
	  	var element_filter = d3.select("body").select("#dropdowns").append("select").on("change", function() { fElement = this.value; dispatch.call("statechange", this, awards_0);});
	  	var vendor_type_filter = d3.select("body").select("#dropdowns").append("select").on("change", function() { fType = this.value; dispatch.call("statechange", this, awards_0);});
	  	var pship_filter = d3.select("body").select("#dropdowns").append("select").on("change", function() { fPship = this.value; dispatch.call("statechange", this, awards_0);});
		var state_filter = d3.select("body").select("#stateMenu").append("select").on("change", function() { fState = this.value; dispatch.call("statechange", this, awards_0);});
	
	  	
		year_filter.selectAll("option")
	  	.data([{key: "Filter by Year", value: 10000}].concat(awardsByYear)) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
	  	.text(function(d){return d['key'];});
		
		element_filter.selectAll("option")
	  	.data([{key: "Filter by Program Element", value: 10000}].concat(awardsByElement)) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
	  	.text(function(d){return d['key'];});
		
		vendor_type_filter.selectAll("option")
	  	.data([{key: "Filter by Vendor Type", value: 10000}].concat(awardsByVendorType)) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
	  	.text(function(d){return d['key'];});
		
		pship_filter.selectAll("option")
	  	.data([{key: "Filter by PPP/FBO", value: 10000},{key: "PPP", value: "PPP"},{key: "Faith-based", value: "Faith-based"} ]) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
	  	.text(function(d){return d['key'];});
		
		state_filter.selectAll("option")
	  	.data([{key: "Filter by State", value: 10000}].concat(awardsTotalByState)) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
		.style("padding-left","10px")
	  	.text(function(d){return d['key'];});
	  	/***********/
		  
	    dispatch.on("statechange.menu", function(awards_init) {
		  		  //console.log("changed menu!"+state);
		  		  var awards_tmp = awards_init;
				  
				 
				 //filter on each catergory
					  if(fState != fState_0){
						  awards_tmp = awards_tmp.filter(function(d){return d.Vendor_State == fState});
					  } 
					  if(fYear != fYear_0){
					  	 awards_tmp = awards_tmp.filter(function(d){return d.Original_FY == fYear});
					  } 
					  if(fElement != fElement_0){
					  	 awards_tmp = awards_tmp.filter(function(d){return d.PROGRAM_ELEMENT == fElement});
					  }
					  if(fPship != fPship_0){
					  	 awards_tmp = awards_tmp.filter(function(d){return d.FBO_or_PPPs == fPship});
					  }
					  if(fType != fType_0){
					  	 awards_tmp = awards_tmp.filter(function(d){return d.Vendor_Category == fType});
					  }
				 
				 //recompile data (there must be a more efficient way, but this seems to work fine...)
				 awardsTotalByDistId = d3.nest()
					  .key(function(d){return d.CD_ID;})
					  .rollup(function(v){return d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");}); })
					  .entries(awards_tmp)
					  .sort(function(a, b){ return d3.descending(a.value, b.value); }); 
				  
		  
		  		  awardsByDist = d3.nest()
  						.key(function(d){return d.CD_ID;})
  						.entries(awards_tmp);	
						
						
				  awardsTotalByState = d3.nest()
					    .key(function(d){return d.Vendor_State;})
					    .rollup(function(v){ //return d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");})
					  	  var t = [];
					  	  v.forEach(function(e,i){if(t.indexOf(e.CD_ID) == -1){t.push(e.CD_ID)};});
					  	  //console.log(t);
					  	  return{
					  		  ids: t, 
					  	  total:d3.sum(v,function(d){return d.Obligated.replace(/,/g,"");})
					    };
					    })
					    .entries(awards_tmp)
					    .sort(function(a, b){ return d3.descending(a.value.total, b.value.total); });	
							
		  	  
	  
						if(fState != fState_0){
			  loadDistChart(awardsTotalByDistId);
		  }else{
			  loadChart(awardsTotalByState);
		  }
		  	  updateMap();
	  
		  	  });
		
	}
	
	function loadMap(){
		
		//console.log("load map");
	//choropleth = d3.scaleLog()
		choropleth = d3.scaleLog()
		.domain([1000000,maxDollars]) //temp fix - start at 1000000
	    //.domain([100,5600])
		//.range(['#a1dab4', '#253494']);
		.range(['#c6dbef', '#08519c']);
		//.range(['#eff3ff', '#08519c']);
		//.range(['#e0f3db', '#08519c']);

	  svg.append("defs").append("path")
	      .attr("id", "land")
	      .datum(topojson.feature(us, us.objects.land))
	      .attr("d", path);

	  svg.append("clipPath")
	      .attr("id", "clip-land")
	    .append("use")
	      .attr("xlink:href", "#land");  
	
		//join data

	  var dd = svg.append("g")
		  .attr("class", "districts")
		  .attr("clip-path", "url(#clip-land)")
		  .selectAll("path");
		  
		 dists = dd.data(topojson.feature(congress, congress.objects.districts).features)
		  .enter().append("path")
		  .attr("d", path)
		  .attr("id", function(d){return "district"+d.id;})
		  .attr("basecolor", function(d){
			  var c = getVal(d.id);
			  if(c == 0){
				  return "#e0f3db"; //"#a8ddb5";//"#fff";
			  }else if(c != undefined){
				  return choropleth(c);
			  }else{
				  return cl;
			  }
		  })
		  .style("fill", function(d){return d3.select("#district"+d.id).attr("basecolor");})
		  .on("click", function(d,i){
			  if(getVal(d.id) != undefined){	  
			  var obj = congress.objects.districts.geometries[i].rep;
		  
			  		  d.active = !d.active;
			  		  var active  = d.active ? true : false,
			  		  op = active ? 1 : 0;  
			  		  popup.transition()		
			  		  .duration(400)		
			  		  .style("opacity", op)
			  		  .style("left", (width/2)-350+"px")		
			  		  .style("top", (height/2)-150+"px");
				  
					  popup.html(obj.State +" - "+obj.District + "<br/>" 
					  + obj.Representative +" ("+ obj.Party 
					  + ")"+"<br/>"+"$"+formatNumber(getVal(d.id))+"<br/>"+"<br/>");
				  
					  var datT = awardsByDist.filter(function(v){
						  return v.key == ""+d.id+"";})[0]['values'];		 
					  var awards = popup.append("div")
					  .attr("class","awards");
				  
					  var rows = awards.selectAll("text")
					  .data(datT)
					  .enter()
					  .append("tr");
					  //.attr("class","rows");
					  //.attr("style", "background: #cccc");
				  
					  var cells = rows.selectAll("td")
					  /*.data(["FY","Element","Vendor Name","Vendor Type","Obligation"].concat(function(d) {
						  //return [d.contractactiontype,d.vendor_name,"$"+formatNumber(d.dollars_obligated), d.signed_date];
						  return [d.Original_FY, d.PROGRAM_ELEMENT,d.Vendor_Name,d.Vendor_Category,"$"+formatNumber(d.Obligated.replace(/,/g,""))];});
					  )*/
					  .data(function(d) {
							  //return [d.contractactiontype,d.vendor_name,"$"+formatNumber(d.dollars_obligated), d.signed_date];
							  return [d.Original_FY, d.PROGRAM_ELEMENT,d.Vendor_Name,d.Vendor_Category,"$"+formatNumber(d.Obligated.replace(/,/g,"")),d.FBO_or_PPPs,d.PPP_Project_Name];}
						  )	  
					  .enter()
					  .append("td")
					  .attr("class","rows")
					  //.attr("style", "padding: 3px")
					  .html(function(d) { return d; });
				  
					  popupOn = d.active;
				  
					  if(popupOn){
						  tooltip.transition()
						  .duration(400)		
						  .style("opacity", 0);
					  }
				  }
		  
		  })
		  .on("mouseover", function(d,i) {
			  var g = getVal(d.id);
				  if(!popupOn && g != undefined){// && getVal(d.id) > 0){
			  
					  //d3.select("#"+this.id).style("fill", "orange");
					  d3.select(this).style("fill", "orange");		
					  tooltip.transition()		
					  .duration(200)		
					  .style("opacity", 1);
             	 	  
					  tooltip.style("left", (d3.event.pageX) + "px")		
					  .style("top", (d3.event.pageY) + "px");		 
					  
					  var obj = congress.objects.districts.geometries[i].rep;
					  
					  if(obj == undefined){console.log(this); }

					  pDist.text(obj.State +" - "+obj.District);
					  pRep.text(obj.Representative);
					  pTotal.text("$"+formatNumber(getVal(d.id)));
					  //img.attr("xlink:href", "/imgs/Nancy_Pelosi.jpg") 
					  
				  }	
			  })					
		  .on("mouseout", function(d) {	
				  if(!popupOn && getVal(d.id) != undefined){// && getVal(d.id) > 0){	
					  d3.select(this).style("fill", function(d){return d3.select("#district"+d.id).attr("basecolor");});
					  tooltip.transition()		
					  .duration(200)		
					  .style("opacity", 0);
				  }	
			  });		  
	  

	  svg.append("path")
	      .attr("class", "district-boundaries")
	      .datum(topojson.mesh(congress, congress.objects.districts, function(a, b) { 
			  return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
	      .attr("d", path);

	  svg.append("path")
	      .attr("class", "state-boundaries")
	      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	      .attr("d", path); 	    
	}
	
	function updateMap(){
		dists.each(function(){
			d3.select(this).attr("basecolor", function(d){
				//console.log(d.id);
  			  var c = getVal(d.id);
			  if(c == 0){
				  return "#e0f3db";//"#a8ddb5";//"#fff";
			  }else if(c != undefined){
  				  return choropleth(c);
  			  }else{
  				  return cl;
  			  }
			})
			.style("fill", function(d){return d3.select("#district"+d.id).attr("basecolor");});
		});
	}
	
	function loadChart(data){
		
	//console.log("loading chart");
	//console.log(data);
	
	var min = d3.min(data, function(d){return d.value.total;});
	var max = d3.max(data, function(d){return d.value.total;});
	  
	 var x = d3.scaleLinear()
	      .domain([min,max])
		  //.domain([minDollars, maxDollars])
	      .range([0, 200]);	
		  
		  
		  chart.attr("overflow", "none"); 	  
    var bchart = chart.selectAll("g")
		  //.data(data);
		  .data(data, function(d){return d;});  
		  
		bchart.enter()
		  .append("g")
		  //.attr("id",function(d){return "bar"+d.key;})
		  .append("div")
		  .attr("class","barchart")
		  .attr("id",function(d){return "bar"+d.key;})
		  .style("width", function(d){return x(d.value.total)+"px";})
		  .style("text-indent", "-30px")
		  .style("margin-left", "40px")
		  //.text(function(d){return "$"+formatNumber(d.value);})
		  .text(function(d){return d.key;})// + " $"+formatNumber(d.value);})
		  .on("mouseover",function(d){
			  //console.log(d.key);
			  d3.select(this)
			  .style("background-color","orange");
			  
			  if(!popupOn){
				  var value = d['value'];
				  
				  //console.log(d);
				  	
				  chart_tooltip.transition()		
				  .duration(200)		
				  .style("opacity", 1);
				  
				  chart_tooltip.style("left", (d3.event.pageX) + "px")		
				  .style("top", (d3.event.pageY) + "px");	
				  
				  chart_tooltip.text(function(d){return "$"+formatNumber(value.total);});	 
			  }	
			  
			  d.value.ids.forEach(function(e,i){
				  //console.log(e);
					  d3.select("#district"+e)
					  .style("fill","orange");
			  });
		  
			  /*d3.select("#district"+d.key)
			 //d3.select("#district"+"4823")
			  .style("fill","orange");*/
		  })
		  .on("mouseout",function(d){
			  d3.select(this)
			  .style("background-color","steelblue");
		  
			  /*d3.select("#district"+d.key)
			  .style("fill", function(v){return d3.select("#district"+d.key).attr("basecolor");});*/
			  
			  d.value.ids.forEach(function(e,i){
				  //console.log(e);
					  d3.select("#district"+e)
					  .style("fill", function(f){return d3.select("#district"+e).attr("basecolor");});
			  });
			  
			  
			  if(!popupOn){	
				  chart_tooltip.transition()		
				  .duration(200)		
				  .style("opacity", 0);
			  }	
		  })
		   
		   bchart.exit().remove();	 
	  	  
		  /*dispatch.on("statechange.chart", function(state) {
			  //console.log("changed chart!"+state);
			  
			  loadChart(awardsTotalByDistId);
			  //bchart.data(awardsTotalByDistId);
			  //.exit().remove();
			  
			  //bchart.exit().remove();
			 
			  
	  	  });*/  
	}

	function loadDistChart(data){
		
	//console.log("loading chart");
	
	var min = d3.min(data, function(d){return d.value;});
	var max = d3.max(data, function(d){return d.value;});
	  
	 var x = d3.scaleLinear()
	      .domain([min, max])
	      .range([0, 200]);	
		   	  
   //console.log(data);

    var bchart = chart.selectAll("g")
		  //.data(data);	  
		  .data(data, function(d){ 
			  return (d);});    
		  
		bchart.enter()
		  .append("g")
		  //.attr("id",function(d){return "bar"+d.key;})
		  .append("div")
		  .attr("class","barchart")
		  .attr("id",function(d){return "bar"+d.key;})
		  .style("width", function(d){ //console.log(d.key); 
			  return x(d.value)+"px";})
		  .style("text-indent", "-45px")
		  .style("margin-left", "50px")
		  //.text(function(d){return "$"+formatNumber(d.value);})
		  .text(function(d){return getDist(d.key,1);})
		  .on("mouseover",function(d){
			  //console.log(d.key);
			  d3.select(this)
			  .style("background-color","orange");
			  
			  if(!popupOn){
				  var value = d['value'];
				  
				  //console.log(d);
				  	
				  chart_tooltip.transition()		
				  .duration(200)		
				  .style("opacity", 1);
				  
				  chart_tooltip.style("left", (d3.event.pageX) + "px")		
				  .style("top", (d3.event.pageY) + "px");	
				  
				  chart_tooltip.text(function(d){return "$"+formatNumber(value);});	 
			  }
		  
			  d3.select("#district"+d.key)
			 //d3.select("#district"+"4823")
			  .style("fill","orange");
		  })
		  .on("mouseout",function(d){
			  d3.select(this)
			  .style("background-color","steelblue");
		  
			  d3.select("#district"+d.key)
			  .style("fill", function(v){return d3.select("#district"+d.key).attr("basecolor");});
			  
			  if(!popupOn){	
				  chart_tooltip.transition()		
				  .duration(200)		
				  .style("opacity", 0);
			  }	
		  })
		   

		   bchart.exit().remove();
		   //console.log(bchart);
		   
		   //bchart.exit().remove();	 
		   //bchart.selectAll("#div").remove();
	  	  
		  /*dispatch.on("statechange.chart", function(state) {
			  //console.log("changed chart!"+state);
			  
			  loadChart(awardsTotalByDistId);
			  //bchart.data(awardsTotalByDistId);
			  //.exit().remove();
			  
			  //bchart.exit().remove();
			 
			  
	  	  });*/  
	}
	
	function getDist(v,n){
			  if(v==1100){return "DC";}
			
		  	var result = reps.filter(function(d){ return d.CD_ID == v;});
			
			if(result.length == 0) {
				//console.log(v);
				return null;	
			}
			
		  	//var c = (result[0] != undefined) ? Math.abs(result[0]['values']) : null;
		  	var a = (result != undefined) ? result[0]['State_code'] +" - "+result[0]['District'] : null;
			var b = (result != undefined) ? result[0]['State_code'] : null;	
		  	return (n==1)?a:b;
		  }
	function getVal(v){
			  var k = ""+v+"";
			  var result = awardsTotalByDistId.filter(function(d){ return d.key == k;});
			  var c = (result[0] != undefined) ? result[0]['value'] : null;	
			  return c;
		  }
	  	function getStateId(v){
	  			  var k = ""+v+"";
	  			  var result = ids.filter(function(d){ return d.key == k;});
	  			  var c = (result[0] != undefined) ? result[0]['value'] : null;	
	  			  return c;
	  		  }	  
  
}

/*function zoomed() {
	console.log(svg.attr("scale"));
	svg.attr("transform", d3.event.transform);
}*/

function zoomed(){
	
	
	svg.attr("transform", d3.event.transform);
	//console.log("k: "+d3.event.transform.k);
	
	//do this later
	/*if(d3.event.transform.k > 1.25){
    d3.selectAll(".state-boundaries").style("stroke-width", ".75px");
	d3.selectAll(".district-boundaries").style("stroke-width", ".5px");
	}*/
	
}

function reset() {
	  svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
	  //svg.attr("transform", d3.zoomIdentity);
	  //console.log("k: "+d3.event.transform.k);
	  console.log("svg: "+svg.attr("transform")); 
}


d3.select(self.frameElement).style("height", height + "px");

</script>
