<!DOCTYPE html>
<meta charset="utf-8">
<style>

path {
  stroke-linejoin: round;
  stroke-linecap: round;
}

/*.districts {
  fill: #bbb;
}*/

/*.districts :hover {
  fill: orange;
}*/

div.barchart {
  font: 9px sans-serif;
  background-color: steelblue;
  text-align: left;
  text-indent: -45px;
  padding: 3px;
  margin: 1px;
  margin-left:50px;
  color: "#bbb";
}

.barchart_labels {
	font: 10px sans-serif;
	text-align: left;
	color: black;
}

div.exit {
float:right;
width:10px;
height:10px;
background-color:grey;
text-align:center;	
}

/*div.profile {
float:left;
width:500px;
height:50px;
text-align:left;	
}*/

div.chart {
	width: 300px;
	height: 500px;
	overflow: scroll;
	margin-top: 50px;
}

.district-boundaries {
  pointer-events: none;
  fill: none;
  stroke: #fff;
  stroke-width: .4px;
}

.state-boundaries {
  pointer-events: none;
  fill: none;
  stroke: #fff;
  stroke-width: 1px;
}

div.tooltip {	
    position: absolute;			
    text-align: left;		
    width: 200px;					
    height: 100px;					
    padding: 10px;				
    font: 12px sans-serif;		
    background: white;
	border-style: solid;
	border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;			
    pointer-events: none;		
}

div.popup {	
    position: absolute;			
    text-align: left;		
    width: 700px;					
    height: 300px;					
    padding: 10px;				
    font: 12px sans-serif;		
    background: white;	
	border-style: solid;
	border-width: 0.5px;	
    border-color: grey;		
    border-radius: 3px;				
    pointer-events: none;		
}

div.awards {
	width: 700px;
	height: 250px;
	border: solid;
	border-width: 1px;
	border-color: #ccc;
	overflow:scroll;
}

div.mote {
	position: absolute;
	width:width;
	height:height;
	background:red;
}

.container {
  float: left;
}
#dropdown {
	padding-left:20px;
}

.menus {
	float:left;
	padding-right:10px;
}

</style>
<body>
	<div class="header" id="dropdowns">
	</div>
	<div class="container" id="chart1">
	</div>
	<div class="container" id="chart2">
	</div>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-dispatch.v1.min.js"></script>

<script>

var dispatch = d3.dispatch("load", "statechange");

var cl = "#bbb";//"#ccc";

var width = 800,
    height = 600;			

var projection = d3.geoAlbersUsa()
	//d3.geo.albersUsa()
    //.scale(4000)
	.scale(1100)
    .translate([width / 2, height / 2]);
	//.translate([-500, height / 2]);

var path = d3.geoPath()
    .projection(projection);

var svg = d3.select("body").select("#chart1").append("svg")
    .attr("width", width)
    .attr("height", height);	
	
var tooltip = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);	
	
var pic = tooltip.append("svg");
  //.attr("width", 100)
  //.attr("height", 50);
  
  //profile info
var pDist = pic.append("text")
  .attr("fill","black")
  .attr("x",60)
  .attr("y",10);
  //.style("font-weight", "bold");
  
var pRep = pic.append("text")
  .attr("fill","black")
  .attr("x",60)
  .attr("y",25);
  
var pTotal = pic.append("text")
  .attr("fill","black")
  .attr("x",60)
  .attr("y",40);  
  //.text(congress.objects.districts.geometries[i].rep.State);
  
 var img = pic.append("svg:image")
  //.attr("xlink:href", "/imgs/Nancy_Pelosi.jpg")
  .attr("width", 50)
  .attr("height", 75); 	
  
	
	//popup divs

var popup = d3.select("body").append("div")	
    .attr("class", "popup")	
    .style("opacity", 0);	
	
	
	var popupOn = false;
	var awardsTotalByDistId_0;
	var awardsTotalByState_0;
	var awardsTotalByStateDist_0;
	var awardsByDist_0;	
	var choropleth;
	var formatNumber = d3.format(",.2f");
	var barchart = d3.select("body").select("#chart2").append("div");	
		
			
//load data
queue()
    .defer(d3.json, "us.json")
    .defer(d3.json, "us-congress-114.json")
	.defer(d3.json, "reps2.json")
	.defer(d3.json, "awards_concat2.json")
    .await(ready);

function ready(error, us, congress, reps, awards) {
  if (error) throw error;
  
  /******* nested data *******/
  awardsTotalByState_0 = d3.nest()
  .key(function(d){return d.state;})
  .rollup(function(v){return d3.sum(v,function(d){return d.dollars_obligated;}); })
  .sortKeys(d3.ascending)
  .entries(awards);
  //console.log(JSON.stringify(awardsTotalByState));
  awardsByDist_0 = d3.nest()
  .key(function(d){return d.cd_ID;})
  .entries(awards);
  //console.log(awardsByDist);
  awardsTotalByStateDist_0 = d3.nest()
  .key(function(d){return d.state;})
  .key(function(d){return d.cd_ID;})
  .rollup(function(v){return d3.sum(v,function(d){return d.dollars_obligated;}); })
  .map(awards);
  //console.log(JSON.stringify(awardsTotalByDist));
  awardsTotalByDistId_0 = d3.nest()
  .key(function(d){return d.cd_ID;})
  .rollup(function(v){return d3.sum(v,function(d){return d.dollars_obligated;}); })
  .entries(awards)
  .sort(function(a, b){ return d3.descending(a.value, b.value); });  
  /*****end******/
  
  dispatch.call("load");
  //dispatch.call("statechange", this, 36);
  everythingelse(us, congress, reps, awards);
}

function everythingelse(us, congress, reps, awards_0){
	
	//awards = awards.filter(function(d){return d.state == "NY"})
	
	var awardsTotalByState = awardsTotalByState_0;
	var awardsByDist = awardsByDist_0;
	
	//var awards = awards_0.filter(function(d){return d.state == "NY"});
	var awardsTotalByDistId = awardsTotalByDistId_0;
	
	var awardsTotalByStateDist = awardsTotalByStateDist_0;	
	
	//console.log(awardsTotalByStateDist);
	
    //add rep objects to geometries
    congress.objects.districts.geometries.forEach(function(district){
  	  var result = reps.filter(function(rep){
  		  return rep.CD_ID === district.id;
  	  });
  	  //if(result[0] == undefined){console.log(district.id)};
	  
  	  district.rep = (result[0] != undefined) ? result[0] : null;
    });
	
     var minDollars = d3.min(awardsTotalByDistId, function(d){return d.value;});
     var maxDollars = d3.max(awardsTotalByDistId, function(d){return d.value;});
     var meanDollars = d3.mean(awardsTotalByDistId, function(d){return d.value;});
  	//	
	
	dispatch.on("load.menu", loadMenu());
	dispatch.on("load.map", loadMap());
	dispatch.on("load.chart", loadChart());
	
	
	function loadMenu(){
		//console.log("load menu");
	  	  /*********dropdown menus************/
	  	var year_filter = d3.select("body").select("#dropdowns").append("select");
	  	var element_filter = d3.select("body").select("#dropdowns").append("select");
	  	var org_type_filter = d3.select("body").select("#dropdowns").append("select");
	  	var state_filter = d3.select("body").select("#dropdowns").append("select");
	
	  	state_filter.selectAll("option")
	  	.data([{key: "ALL", value: 10000}].concat(awardsTotalByState)) 
	  	.enter().append("option")
	  	.attr("value",function(d){return d['key'];})
	  	.text(function(d){return d['key'];})
		.on("change", function() { console.log("change!"); dispatch.call("statechange", this, 36 );});
	  	/***********/
	}
	
	function loadMap(){
		//console.log("load map");
	choropleth = d3.scaleLog()
		.domain([minDollars,maxDollars])
	    //.domain([100,5600])
		.range(['white', 'steelblue']);

	  svg.append("defs").append("path")
	      .attr("id", "land")
	      .datum(topojson.feature(us, us.objects.land))
	      .attr("d", path);

	  svg.append("clipPath")
	      .attr("id", "clip-land")
	    .append("use")
	      .attr("xlink:href", "#land");  
	
		//join data

	  svg.append("g")
		  .attr("class", "districts")
		  .attr("clip-path", "url(#clip-land)")
		  .selectAll("path")
		  .data(topojson.feature(congress, congress.objects.districts).features)
		  .enter().append("path")
		  .attr("d", path)
		  .attr("id", function(d){return "district"+d.id;})
		  .attr("basecolor", function(d){
			  var c = getVal(d.id);
			  if(c != undefined){
				  return choropleth(c);
			  }else{
				  return cl;
			  }
		  })
		  .style("fill", function(d){return d3.select("#district"+d.id).attr("basecolor");})
		  .on("click", function(d,i){
			  var obj = congress.objects.districts.geometries[i].rep;
		  
			  		  d.active = !d.active;
			  		  var active  = d.active ? true : false,
			  		  op = active ? 1 : 0;  
			  		  popup.transition()		
			  		  .duration(400)		
			  		  .style("opacity", op)
			  		  .style("left", (width/2)-350+"px")		
			  		  .style("top", (height/2)-150+"px");
				  
					  popup.html(obj.State +" - "+obj.District + "<br/>" 
					  + obj.Representative +" ("+ obj.Party 
					  + ")"+"<br/>"+"$"+formatNumber(getVal(d.id))+"<br/>"+"<br/>");
				  
					  var datT = awardsByDist.filter(function(v){
						  return v.key == ""+d.id+"";})[0]['values'];		 
					  var awards = popup.append("div")
					  .attr("class","awards");
				  
					  var rows = awards.selectAll("text")
					  .data(datT)
					  .enter()
					  .append("tr");
				  
					  var cells = rows.selectAll("td")
					  .data(function(d) {
						  return [d.contractactiontype,d.vendor_name,"$"+formatNumber(d.dollars_obligated), d.signed_date];
					  })
					  .enter()
					  .append("td")
					  .attr("style", "padding: 3px")
					  .html(function(d) { return d; });
				  
					  popupOn = d.active;
				  
					  if(popupOn){
						  tooltip.transition()
						  .duration(400)		
						  .style("opacity", 0);
					  }
		  
		  })
		  .on("mouseover", function(d,i) {
				  if(!popupOn){
			  
					  //d3.select("#"+this.id).style("fill", "orange");
					  d3.select(this).style("fill", "orange");		
					  tooltip.transition()		
					  .duration(400)		
					  .style("opacity", 1);
             	 	  
					  tooltip.style("left", (d3.event.pageX) + "px")		
					  .style("top", (d3.event.pageY) + "px");		 
					  
					  var obj = congress.objects.districts.geometries[i].rep;
					  
					  if(obj == undefined){console.log(this); }

					  pDist.text(obj.State +" - "+obj.District);
					  pRep.text(obj.Representative);
					  pTotal.text("$"+formatNumber(getVal(d.id)));
					  img.attr("xlink:href", "/imgs/Nancy_Pelosi.jpg") 
					  
				  }	
			  })					
		  .on("mouseout", function(d) {	
				  if(!popupOn){	
					  d3.select(this).style("fill", function(d){return d3.select("#district"+d.id).attr("basecolor");});
					  tooltip.transition()		
					  .duration(200)		
					  .style("opacity", 0);
				  }	
			  });		  
	  

	  svg.append("path")
	      .attr("class", "district-boundaries")
	      .datum(topojson.mesh(congress, congress.objects.districts, function(a, b) { 
			  return a !== b && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
	      .attr("d", path);

	  svg.append("path")
	      .attr("class", "state-boundaries")
	      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
	      .attr("d", path);	    
	
	  dispatch.on("statechange.menu", function(state) {
		      var awardsTotalByDistId = awardsTotalByDistId_0.filter(function(d){return Math.floor(d.key/100) == state});
	  });
	
	
	}
	
	function loadChart(){
		console.log("load chart");
	    chart = d3.select("body").select("#chart2").append("div")
	  	.attr("class","chart");
	  
	 var x = d3.scaleLinear()
	      .domain([minDollars, maxDollars])
	      .range([0, 200]);

	 var bchart = chart.selectAll("g")
		  .data(awardsTotalByDistId)
		  .enter()
		  .append("g");
	  
		  bchart.append("div")
		  .attr("class","barchart")
		  .attr("id",function(d){return "bar"+d.key;})
		  .style("width", function(d){return x(d.value)+"px";})
		  .text(function(d){return "$"+formatNumber(d.value);})
		  .text(function(d){return getDist(d.key,1);})
		  .on("mouseover",function(d){
			  //console.log(d.key);
			  d3.select(this)
			  .style("background-color","orange");
		  
			  d3.select("#district"+d.key)
			 //d3.select("#district"+"4823")
			  .style("fill","orange");
		  })
		  .on("mouseout",function(d){
			  d3.select(this)
			  .style("background-color","steelblue");
		  
			  d3.select("#district"+d.key)
			  .style("fill", function(v){return d3.select("#district"+d.key).attr("basecolor");});
		  
		  }) 
	}

    
	function getDist(v,n){
			  if(v==1100){return "DC";}
			
		  	var result = reps.filter(function(d){ return d.CD_ID == v;});
			
			if(result.length == 0) {
				//console.log(v);
				return null;	
			}
			
		  	//var c = (result[0] != undefined) ? Math.abs(result[0]['values']) : null;
		  	var a = (result != undefined) ? result[0]['State_code'] +" - "+result[0]['District'] : null;
			var b = (result != undefined) ? result[0]['State_code'] : null;	
		  	return (n==1)?a:b;
		  }
	function getVal(v){
			  var k = ""+v+"";
			  var result = awardsTotalByDistId.filter(function(d){ return d.key == k;});
			  var c = (result[0] != undefined) ? result[0]['value'] : null;	
			  return c;
		  }
  
}


d3.select(self.frameElement).style("height", height + "px");

</script>
